<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weidanli.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>

  <meta name="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
<meta property="og:type" content="website">
<meta property="og:title" content="丹崽的技术博客">
<meta property="og:url" content="http://weidanli.github.io/page/5/index.html">
<meta property="og:site_name" content="丹崽的技术博客">
<meta property="og:description" content="计算机基础 计算机网络 Java Vue 前端 后端">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Weidan">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://weidanli.github.io/page/5/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>丹崽的技术博客</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">丹崽的技术博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">丹崽的计算机知识博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Weidan</p>
  <div class="site-description" itemprop="description">计算机基础 计算机网络 Java Vue 前端 后端</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-cloud/springcloud%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8protolbuffer%E7%BC%96%E7%A0%81%E8%BF%9B%E8%A1%8C%E4%BC%A0%E5%80%BC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-cloud/springcloud%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8protolbuffer%E7%BC%96%E7%A0%81%E8%BF%9B%E8%A1%8C%E4%BC%A0%E5%80%BC/" class="post-title-link" itemprop="url">SpringCloud服务使用ProtolBuffer编码进行传值</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-16 15:18:45" itemprop="dateCreated datePublished" datetime="2019-04-16T15:18:45+08:00">2019-04-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:43:20" itemprop="dateModified" datetime="2020-11-10T16:43:20+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-cloud/" itemprop="url" rel="index"><span itemprop="name">spring-cloud</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们知道，使用 <code>SpringCloud</code> 技术栈，上下游传值的方式一般使用 <code>form</code> 表单或者使用 <code>JSON</code> 格式进行传值。但是我感觉，我们内部服务进行传值的时候，还使用这两种类型的方式，显得有点重。所以在查询了 <code>Java</code> 界以及其他语言序列化对象的时候，查询到了几个常用的序列化工具：<code>kryo</code> <code>Hession</code> <code>JSON</code> <code>XML</code> <code>Protocol Buffers</code> <code>JSON</code> <code>XML</code> 就不必多言，使用 <code>Java</code> 语言开发的基本都知道。 <code>kryo</code> 效率高，使用二进制文件进行传递，但是有个缺点就是不能跨语言。 <code>Hession</code> 效率稍稍差一点。 那么剩下的 <code>Protocol Buffers</code> 就是能够弥补上面的缺点，并且带来一个新的缺点：需要编写静态的 <code>.proto</code> 文件使其项目启动的时候，静态编译映射规格。不过速度高，跨语言，这点缺陷我还是可以接受的。 基本确定方向以后，那么本文就从怎么使用 <code>.proto</code> 将其整合到我们常用的 <code>SpringMVC</code> 中去，使其序列化和反序列化的过程对我们业务开发不可见。</p>
<h2 id="ProtocolBuffers入门"><a href="#ProtocolBuffers入门" class="headerlink" title="ProtocolBuffers入门"></a>ProtocolBuffers入门</h2><p><code>ProtocolBuffers</code> 规则是这样的：编辑 <code>.proto</code> 文件，使用编译器编译不同语言的 <code>ClassObject</code> 。有点类似于 <code>Thift</code> 。所以一开始我们需要的是 <code>ProtocolBuffer编译器</code> 。</p>
<h3 id="下载ProtocolBuffer编译器"><a href="#下载ProtocolBuffer编译器" class="headerlink" title="下载ProtocolBuffer编译器"></a>下载ProtocolBuffer编译器</h3><p><a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/releases/tag/v3.7.1">下载地址</a> 根据自己所使用的系统版本，下载对应的编译器。 下载完成以后，进入 <code>protoc-3.7.1-osx-x86_64/bin</code> 运行 <code>./protoc --version</code> 如果能够打印版本号则说明安装成功。</p>
<h3 id="编写简单的proto文件"><a href="#编写简单的proto文件" class="headerlink" title="编写简单的proto文件"></a>编写简单的proto文件</h3><p>现在开始尝试生成类似于以下 <code>Java</code> 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> Integer id;</span><br><span class="line">  <span class="comment">// 省略 getter setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据谷歌官方提供的 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3#scalar">规范文档</a> 进行编写：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;<span class="comment">// 类似于xml声明一样放于第一行，指定编译源protobuf文件的版本号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> tutorial;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">&quot;com.microorder.test.dto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="comment">// required 表示构造的时候这个值必须传递</span></span><br><span class="line">    <span class="comment">// = 后面的值需要每个属性都是唯一的</span></span><br><span class="line">  <span class="keyword">required</span> <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">required</span> <span class="built_in">int32</span> id = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>后面的 id 号是protocolBuffer用来编码的方式，1-15是使用1个字节，16-2047是使用两个字节。 1-15常用来定义经常发生变化的元素，在使用的时候记得需要保留一下以供后面的属性加入。 19000-19999 不应该使用，因为这个是框架内部使用的。</p>
</blockquote>
<h3 id="编译生成对象"><a href="#编译生成对象" class="headerlink" title="编译生成对象"></a>编译生成对象</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./protoc -I../proto/ --java_out=./ ../proto/user.proto</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令开头    proto文件夹      生成放的文件夹       源文件</span></span><br></pre></td></tr></table></figure>

<p>生成的类就不打开了，看不懂… 生成对象先放入项目中，后面使用。</p>
<h2 id="配置SpringMVC"><a href="#配置SpringMVC" class="headerlink" title="配置SpringMVC"></a>配置SpringMVC</h2><h3 id="开发MessageConverter"><a href="#开发MessageConverter" class="headerlink" title="开发MessageConverter"></a>开发MessageConverter</h3><blockquote>
<p>SpringMVC 官方自带了 ProtocolBuffer 的消息转换器，不过我写都写了，放上来吧… 官方的名字和我取的名字是一样的，如果需要使用官方的，直接导入官方包即可。 调用头使用 x-protobuf 即可接收，不过还是需要在配置中配置，因为默认没有启用。</p>
</blockquote>
<p>我们知道开发 <code>SpringMVC</code> 的消息转换器需要继承 <code>AbstractHttpMessageConverter</code> 传递类型的泛型。 然后使用配置类将此转换器加入 <code>SpringMVC</code> 的转换器列表中即可.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.protobuf.GeneratedMessageV3;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpInputMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpOutputMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.AbstractHttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageNotReadableException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageNotWritableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：将SpringMVC接收和输出对象转换成protobuf格式的转换器.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-04-15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtobufHttpMessageConverter</span> <span class="keyword">extends</span> <span class="title">AbstractHttpMessageConverter</span>&lt;<span class="title">GeneratedMessageV3</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ProtobufHttpMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//设置该转换器支持的媒体类型</span></span><br><span class="line">    <span class="keyword">super</span>(<span class="keyword">new</span> MediaType(<span class="string">&quot;application&quot;</span>, <span class="string">&quot;protobuf&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 支持的对象类型.</span></span><br><span class="line"><span class="comment">   * 如果一个对象的父类是GeneratedMessageV3，就执行该转换器</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> assignableFrom</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; assignableFrom)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> GeneratedMessageV3.class.isAssignableFrom(assignableFrom);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> GeneratedMessageV3 <span class="title">readInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          Class&lt;? extends GeneratedMessageV3&gt; genMsgClazz, HttpInputMessage httpInputMessage)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line">    Method parseMethod;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//利用反射机制获得parseFrom方法</span></span><br><span class="line">      parseMethod = genMsgClazz.getDeclaredMethod(<span class="string">&quot;parseFrom&quot;</span>, InputStream.class);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException  NoSuchMethodException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//调用parseFrom方法从InputStream中反序列化PB对象</span></span><br><span class="line">      <span class="keyword">return</span> (GeneratedMessageV3) parseMethod.invoke(genMsgClazz, httpInputMessage.getBody());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException  IllegalAccessException  InvocationTargetException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          GeneratedMessageV3 generatedMessageV3, HttpOutputMessage httpOutputMessage)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> IOException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line">    OutputStream outputStream = httpOutputMessage.getBody();</span><br><span class="line">    generatedMessageV3.writeTo(outputStream);</span><br><span class="line">    outputStream.flush();</span><br><span class="line">    outputStream.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>代码来源于 CSDN 某个博主，因为记录到笔记，原地址没了…</p>
</blockquote>
<h3 id="配置到MVC中"><a href="#配置到MVC中" class="headerlink" title="配置到MVC中"></a>配置到MVC中</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">    converters.add(<span class="keyword">new</span> ProtobufHttpMessageConverter());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开发接口层"><a href="#开发接口层" class="headerlink" title="开发接口层"></a>开发接口层</h3><p>接口层我放了两个接口，目的是为了测试 <code>ProtocolBuffer</code> 是否真的比 <code>JSON</code> 优秀</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 protocolBuffer 传递</span></span><br><span class="line">  <span class="meta">@GetMapping</span></span><br><span class="line">  <span class="keyword">public</span> User.<span class="function">Person <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User.Person build = User.Person.newBuilder().setId(<span class="number">222</span>).setName(<span class="string">&quot;23232&quot;</span>).build();</span><br><span class="line">    System.out.println(Arrays.toString(build.toByteArray()));</span><br><span class="line">    <span class="keyword">return</span> build;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 JSON 传递</span></span><br><span class="line">  <span class="meta">@GetMapping(&quot;json&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PersonJson <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonJson(<span class="string">&quot;ssss&quot;</span>, <span class="number">22</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口调用测试"><a href="#接口调用测试" class="headerlink" title="接口调用测试"></a>接口调用测试</h2><p>测试方式是粗略测试，在本机运行。 测试方式是：调用 <code>1_000_000</code> 此接口，除去前面 <code>10_000</code> 此预热的结果，使用后面 <code>990_000</code> 计算均值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSON 方式</span></span><br><span class="line">List&lt;Long&gt; timeList = Lists.newArrayListWithCapacity(<span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">  URL target = <span class="keyword">new</span> URL(<span class="string">&quot;http://localhost:8080/json&quot;</span>);</span><br><span class="line">  HttpURLConnection conn = (HttpURLConnection) target.openConnection();</span><br><span class="line">  conn.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">  conn.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">  conn.setRequestProperty(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">  InputStream inputStream = conn.getInputStream();</span><br><span class="line">  <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">  inputStream.read(b);</span><br><span class="line">  inputStream.close();</span><br><span class="line">  PersonJson personJson = JsonMapper.defaultMapper().fromJson(<span class="keyword">new</span> String(b), PersonJson.class);</span><br><span class="line">  timeList.add(System.nanoTime() - start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Long sum = <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">10000</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">  Long aLong = timeList.get(i);</span><br><span class="line">  sum += aLong;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;平均时间：&quot;</span> + (sum / <span class="number">990000</span>));</span><br><span class="line"><span class="comment">// 平均时间：825082 0.825082毫秒(ms)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ProtocolBuffer方式</span></span><br><span class="line">List&lt;Long&gt; timeList = Lists.newArrayListWithCapacity(<span class="number">1000000</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">  URL target = <span class="keyword">new</span> URL(<span class="string">&quot;http://localhost:8080/&quot;</span>);</span><br><span class="line">  HttpURLConnection conn = (HttpURLConnection) target.openConnection();</span><br><span class="line">  conn.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">  conn.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/protobuf&quot;</span>);</span><br><span class="line">  conn.setRequestProperty(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;application/protobuf&quot;</span>);</span><br><span class="line">  InputStream inputStream = conn.getInputStream();</span><br><span class="line">  User.Person person = User.Person.parseFrom(inputStream);</span><br><span class="line">  timeList.add(System.nanoTime() - start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Long sum = <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">10000</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">  Long aLong = timeList.get(i);</span><br><span class="line">  sum += aLong;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;平均时间：&quot;</span> + (sum / <span class="number">990000</span>));</span><br><span class="line"><span class="comment">// 平均时间：316688 0.316688毫秒(ms)</span></span><br></pre></td></tr></table></figure>

<p>结果很明显了，<code>ProtocolBuffer</code> 方式调用使用的时间更短。</p>
<h2 id="Feign整合ProtocolBuffer"><a href="#Feign整合ProtocolBuffer" class="headerlink" title="Feign整合ProtocolBuffer"></a>Feign整合ProtocolBuffer</h2><p>用过 <code>SpringCloud</code> 基本都知道 <code>OpenFeign</code> 这个项目，此项目是可以通过编写接口的方式，让框架封装我们需要调用的 <code>HTTP</code> 请求，然后经过一系列的序列化反序列化从而取出我们需要的结果的一个开源框架。 那么上面我们已经将 <code>SpringMVC</code> 封装 <code>ProtocolBuffer</code> 数据输出，那么 <code>Feign</code> 也需要做相对应的配置使其支持。</p>
<h3 id="配置Encoder和Decoder"><a href="#配置Encoder和Decoder" class="headerlink" title="配置Encoder和Decoder"></a>配置Encoder和Decoder</h3><p><code>OpenFeign</code> 其实底层就是 <code>HttpClient</code> 去进行封装，那么要解码和编码数据就是通过修改 <code>Feign</code> 底层的解码器和编码器即可。 那么在项目中配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 如果使用了RestTemplate，进行以下配置.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    List&lt;HttpMessageConverter&lt;?&gt;&gt; of = <span class="keyword">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;();</span><br><span class="line">    of.add(<span class="keyword">new</span> ProtobufHttpMessageConverter());</span><br><span class="line">    restTemplate.setMessageConverters(of);</span><br><span class="line">    <span class="keyword">return</span> restTemplate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Decoder <span class="title">protolDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntityDecoder(<span class="keyword">new</span> SpringDecoder(() -&gt; <span class="keyword">new</span> HttpMessageConverters(<span class="keyword">new</span> ProtobufHttpMessageConverter())));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Encoder <span class="title">protolEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringEncoder(() -&gt; <span class="keyword">new</span> HttpMessageConverters(<span class="keyword">new</span> ProtobufHttpMessageConverter()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserFeign"><a href="#UserFeign" class="headerlink" title="UserFeign"></a>UserFeign</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(url = &quot;http://localhost:8080/&quot;, name = &quot;userFeign&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeign</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span></span><br><span class="line">  User.<span class="function">Person <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="meta">@RequestBody</span> User.Person param)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFeignTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> UserFeign userFeign;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User.Person test = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/&quot;</span>, User.Person.class);</span><br><span class="line">    assertNotNull(<span class="string">&quot;传递对象不能为空&quot;</span>, test);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFeign</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User.Person test = userFeign.test();</span><br><span class="line">    assertNotNull(<span class="string">&quot;传递对象不能为空&quot;</span>, test);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAdd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User.Person weoda = User.Person.newBuilder().setName(<span class="string">&quot;Weoda&quot;</span>).setId(<span class="number">2000</span>).build();</span><br><span class="line">    userFeign.add(weoda);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="项目说明"><a href="#项目说明" class="headerlink" title="项目说明"></a>项目说明</h2><p><a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-cloud-with-protol">示例代码</a> 项目没有特别规范，随便写写 调用测试写在了 <code>com.microorder.test.Config#main</code> <code>feign</code> 测试放在 <code>test</code> 包下，先启动项目再测试 <code>feign</code> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-cloud/springcloud%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-cloud/springcloud%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">SpringCloud介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-06 14:25:13" itemprop="dateCreated datePublished" datetime="2019-04-06T14:25:13+08:00">2019-04-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:45:03" itemprop="dateModified" datetime="2020-11-10T16:45:03+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-cloud/" itemprop="url" rel="index"><span itemprop="name">spring-cloud</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="微服务是什么"><a href="#微服务是什么" class="headerlink" title="微服务是什么"></a>微服务是什么</h2><h3 id="单体项目"><a href="#单体项目" class="headerlink" title="单体项目"></a>单体项目</h3><p>在互联网刚开始的年代，传统的单体项目，一般是一个服务器，对少量的用户足矣。这时候，开发一套系统，可以提供少量的(相比于现在)服务。并发性不大，服务器性能不需要太好都可以跑得好好的。这个时代我没有经历过。 </p>
<h2 id="微服务是什么-1"><a href="#微服务是什么-1" class="headerlink" title="微服务是什么"></a>微服务是什么</h2><h3 id="单体项目-1"><a href="#单体项目-1" class="headerlink" title="单体项目"></a>单体项目</h3><p>在互联网刚开始的年代，传统的单体项目，一般是一个服务器，对少量的用户足矣。这时候，开发一套系统，可以提供少量的(相比于现在)服务。并发性不大，服务器性能不需要太好都可以跑得好好的。这个时代我没有经历过。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164344.png"></p>
<h3 id="单体项目分布式"><a href="#单体项目分布式" class="headerlink" title="单体项目分布式"></a>单体项目分布式</h3><p>互联网稍稍发展起来了，一台服务器好像支撑不大住。这时候，聪明的程序员们就说，如果一个系统撑不住，那就启动两个来为客户服务呀。所以架构就变成这样，用户，可以把请求落到两个随便一毛一样的系统上面，提供服务是一致的。这时候一般考虑 <code>sessionid</code> 的共享。<br><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164357.png"></p>
<h3 id="初代前后端分离"><a href="#初代前后端分离" class="headerlink" title="初代前后端分离"></a>初代前后端分离</h3><p>下一个发展阶段，即很多企业发现，如果一台机器，需要做数据库操作，还需要做界面层的渲染，服务器的压力太大。这时候出现了初代前后端分离，后端访问数据库的速度可以使用 <code>redis</code> 加成，而前端项目，大部分是渲染成页面提供给用户。所以这时候的架构演变成下面：这种情况可以根据不同的需求进行拓展，拓展前端，拓展后端都还行。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164416.png"></p>
<h3 id="微服务时代"><a href="#微服务时代" class="headerlink" title="微服务时代"></a>微服务时代</h3><p>很快，需求出现爆炸性的增长，后端服务器如果还是单体项目，无论是部署，拓展都显得特别笨重。如果后端服务需要新增一个实例，那么我们都需要手动重新配置前端服务。如果突然之间需要新增多个实例，那么程序猿将会累死累活。所以这时候，急需一个可以自治的生态系统，将拓展的事情交给程序去设定。 这时候，<code>Java</code> 界男神 <strong>Martin Fowler</strong> 提出了 <code>microservice</code> 架构(<a target="_blank" rel="noopener" href="https://www.martinfowler.com/articles/microservices.html">原文链接</a>)。即我们将公司所在领域，按照一定的子域进行划分，每个子域自成一个小服务。此时，拓展就变得简单，我们可以给并发量大的服务拓展多几个服务，而并发小的，或者任务不重但是缺一不可的，单机或者少一点服务存在。而上一层路由层，通过网络与不同服务之间进行通讯，共同服务于用户。 而微服务还有另外一个元素，那就是自治能力、监控能力。打个比方，如果前端服务需要增加多台，系统可以自动发现，并将其加入”服务团队”中，快速的进入工作状态。 所以微服务架构急切需要一种，自带管理者，统一入口的软件架构。而在当今社会，常见的就有 <code>Dubbo</code> <code>SpringCloud</code> 以及 <code>SpringCloudAlibaba</code> 等一系列的生态框架出现。 那么架构现状，也发生了质的变化： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164430.png"></p>
<h3 id="最终前后端分离"><a href="#最终前后端分离" class="headerlink" title="最终前后端分离"></a>最终前后端分离</h3><p>正在此时，前端由于 <code>vue</code> <code>AngularJS</code> <code>react</code> 的兴起，也没闲住，也发生了剧烈的变化。<code>ES</code> (<code>JS</code> 的现代叫法)不再单纯的操作 <code>document</code> 而是将 <code>document</code> 交给框架，开发者只需要关注数据的变化即可，框架会自动根据数据的变化去修改 <code>document</code> 的展示。所以这时候，会出现前端直接分离出来，由前端开发者自己开发，自己编织架构，后端只提供数据服务的局面。走到这里，前端真正的独立出来，后端开发者不再需要编写 <code>MVC</code> 的页面。前端开发者后期维护也变得简单，因为一个前端项目修改不再需要前端和后端结对编程了。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164447.png"></p>
<h3 id="微前端化"><a href="#微前端化" class="headerlink" title="微前端化"></a>微前端化</h3><p>由于业务量爆棚，前端也出现了后端的老路。然后前端也就走了后端的发展路线，一个前端再也支撑不住，所以前端也要分出来不同的业务团队，这时候，前端也就进行了微服务化。不同的业务有不同的模块，然后一个总视图进入前端，统领所有的业务服务模块。这块就不画出来了。</p>
<h2 id="SpringCloud是什么"><a href="#SpringCloud是什么" class="headerlink" title="SpringCloud是什么"></a>SpringCloud是什么</h2><p><code>SpringCloud</code> 是一系列套件的统称，不单单是一门技术框架。而这些套件，恰好是我们做微服务系统的时候，常常使用的套件，包含 <strong>注册中心</strong> <strong>配置中心</strong> <strong>路由器</strong> <strong>熔断器</strong> <strong>监控</strong> 等微服务所需要的框架。套件什么的，做好部署运维，那么就可以将精力集中在业务服务的开发。</p>
<h2 id="为什么选择SpringCloud"><a href="#为什么选择SpringCloud" class="headerlink" title="为什么选择SpringCloud"></a>为什么选择SpringCloud</h2><p>常见的面试题就是：为什么使用 <code>SpringBoot</code> ？ 标准答案：因为 <code>Spring</code> 官方提供了自动装配的规范，由第三方框架(<code>MyBatis</code> 等)去实现。然后版本号规约放置于 <code>SpringBoot</code> 的顶级父类里，这样当我们使用对应版本的 <code>SpringBoot</code> 的时候，依赖进来的需要使用的第三方框架也是框架官方提供的，兼容性不错的版本。 而恰恰好，<code>SpringCloud</code> 就是这样集成而来的，所以兼容性问题，并不需要关心太多。 当初选择这个框架，是因为我感觉上手简单，而且套件齐全。公司项目肯定想要稳定，拓展性好的框架。因为 <code>Spring</code> 框架让我放心，因为他是 <code>Spring</code> 公司的。其二，官方提供套件的合成，也不会出现有些不兼容的现象。因为 <code>SpringBoot</code> 的加成，统一的父类，放心的整合。 在快速做一个小服务也是十分的方便，只要把统一的配置放置于 <code>config-server</code> 我在开发新的业务服务的时候，不需要过多的关注他的配置的东西 (比起 <code>Spring</code> 时代的 <code>xml</code> 地狱简直不要太方便)</p>
<h2 id="SpringCloud常用组件"><a href="#SpringCloud常用组件" class="headerlink" title="SpringCloud常用组件"></a>SpringCloud常用组件</h2><p>微服务套件</p>
<p>推荐框架</p>
<p>作用</p>
<p>可替换框架</p>
<p>注册中心</p>
<p><code>Eureka</code></p>
<p>微服务系统的中心，可用于服务的注册以及服务之间的发现</p>
<p><code>ZooKeeper</code> <code>Consul</code></p>
<p>配置中心</p>
<p><code>ConfigService</code></p>
<p>业务服务的配置中心，将业务服务通用、系统配置放置于此，服务启动即可发现并应用配置</p>
<p><code>Apollo</code></p>
<p>路由器</p>
<p><code>Gateway</code></p>
<p>微服务生态总入口，需要请求服务只能通过于此。相对的，权限控制、登陆拦截都落在此处。</p>
<p><code>Nginx</code> <code>Nodejs自开发</code></p>
<p>熔断器</p>
<p><code>Hystrix</code></p>
<p>熔断器，用于熔断服务的连接。如果服务负载量过大、频繁报错，将会像保险丝一样断开服务，让他休息一会儿再起来</p>
<p>-</p>
<p>熔断监控</p>
<p><code>Turbine</code></p>
<p>熔断器的监控视图，用于监控熔断器的情况，以便人为干涉</p>
<p>-</p>
<p>消息通知</p>
<p><code>Stream</code></p>
<p>用于服务之间的消息通知，进行封装后可以不需要关注分布式锁(谁来处理的问题)</p>
<p>-</p>
<p>契约开发</p>
<p><code>Contract</code></p>
<p>微服务中，进行 <code>TDD</code> 开发的模拟第三方服务返回数据的套件</p>
<p>-</p>
<p>老夫认为，项目刚刚初始，<code>Eureka</code> <code>Config</code> <code>Gateway</code> <code>Stream</code> 都是初始就要考虑的必备品。</p>
<h3 id="单体项目分布式-1"><a href="#单体项目分布式-1" class="headerlink" title="单体项目分布式"></a>单体项目分布式</h3><p>互联网稍稍发展起来了，一台服务器好像支撑不大住。这时候，聪明的程序员们就说，如果一个系统撑不住，那就启动两个来为客户服务呀。所以架构就变成这样，用户，可以把请求落到两个随便一毛一样的系统上面，提供服务是一致的。这时候一般考虑 <code>sessionid</code> 的共享。</p>
<h2 id="微服务是什么-2"><a href="#微服务是什么-2" class="headerlink" title="微服务是什么"></a>微服务是什么</h2><h3 id="单体项目-2"><a href="#单体项目-2" class="headerlink" title="单体项目"></a>单体项目</h3><p>在互联网刚开始的年代，传统的单体项目，一般是一个服务器，对少量的用户足矣。这时候，开发一套系统，可以提供少量的(相比于现在)服务。并发性不大，服务器性能不需要太好都可以跑得好好的。这个时代我没有经历过。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164344.png"></p>
<h3 id="单体项目分布式-2"><a href="#单体项目分布式-2" class="headerlink" title="单体项目分布式"></a>单体项目分布式</h3><p>互联网稍稍发展起来了，一台服务器好像支撑不大住。这时候，聪明的程序员们就说，如果一个系统撑不住，那就启动两个来为客户服务呀。所以架构就变成这样，用户，可以把请求落到两个随便一毛一样的系统上面，提供服务是一致的。这时候一般考虑 <code>sessionid</code> 的共享。<br><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164357.png"></p>
<h3 id="初代前后端分离-1"><a href="#初代前后端分离-1" class="headerlink" title="初代前后端分离"></a>初代前后端分离</h3><p>下一个发展阶段，即很多企业发现，如果一台机器，需要做数据库操作，还需要做界面层的渲染，服务器的压力太大。这时候出现了初代前后端分离，后端访问数据库的速度可以使用 <code>redis</code> 加成，而前端项目，大部分是渲染成页面提供给用户。所以这时候的架构演变成下面：这种情况可以根据不同的需求进行拓展，拓展前端，拓展后端都还行。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164416.png"></p>
<h3 id="微服务时代-1"><a href="#微服务时代-1" class="headerlink" title="微服务时代"></a>微服务时代</h3><p>很快，需求出现爆炸性的增长，后端服务器如果还是单体项目，无论是部署，拓展都显得特别笨重。如果后端服务需要新增一个实例，那么我们都需要手动重新配置前端服务。如果突然之间需要新增多个实例，那么程序猿将会累死累活。所以这时候，急需一个可以自治的生态系统，将拓展的事情交给程序去设定。 这时候，<code>Java</code> 界男神 <strong>Martin Fowler</strong> 提出了 <code>microservice</code> 架构(<a target="_blank" rel="noopener" href="https://www.martinfowler.com/articles/microservices.html">原文链接</a>)。即我们将公司所在领域，按照一定的子域进行划分，每个子域自成一个小服务。此时，拓展就变得简单，我们可以给并发量大的服务拓展多几个服务，而并发小的，或者任务不重但是缺一不可的，单机或者少一点服务存在。而上一层路由层，通过网络与不同服务之间进行通讯，共同服务于用户。 而微服务还有另外一个元素，那就是自治能力、监控能力。打个比方，如果前端服务需要增加多台，系统可以自动发现，并将其加入”服务团队”中，快速的进入工作状态。 所以微服务架构急切需要一种，自带管理者，统一入口的软件架构。而在当今社会，常见的就有 <code>Dubbo</code> <code>SpringCloud</code> 以及 <code>SpringCloudAlibaba</code> 等一系列的生态框架出现。 那么架构现状，也发生了质的变化： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164430.png"></p>
<h3 id="最终前后端分离-1"><a href="#最终前后端分离-1" class="headerlink" title="最终前后端分离"></a>最终前后端分离</h3><p>正在此时，前端由于 <code>vue</code> <code>AngularJS</code> <code>react</code> 的兴起，也没闲住，也发生了剧烈的变化。<code>ES</code> (<code>JS</code> 的现代叫法)不再单纯的操作 <code>document</code> 而是将 <code>document</code> 交给框架，开发者只需要关注数据的变化即可，框架会自动根据数据的变化去修改 <code>document</code> 的展示。所以这时候，会出现前端直接分离出来，由前端开发者自己开发，自己编织架构，后端只提供数据服务的局面。走到这里，前端真正的独立出来，后端开发者不再需要编写 <code>MVC</code> 的页面。前端开发者后期维护也变得简单，因为一个前端项目修改不再需要前端和后端结对编程了。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164447.png"></p>
<h3 id="微前端化-1"><a href="#微前端化-1" class="headerlink" title="微前端化"></a>微前端化</h3><p>由于业务量爆棚，前端也出现了后端的老路。然后前端也就走了后端的发展路线，一个前端再也支撑不住，所以前端也要分出来不同的业务团队，这时候，前端也就进行了微服务化。不同的业务有不同的模块，然后一个总视图进入前端，统领所有的业务服务模块。这块就不画出来了。</p>
<h2 id="SpringCloud是什么-1"><a href="#SpringCloud是什么-1" class="headerlink" title="SpringCloud是什么"></a>SpringCloud是什么</h2><p><code>SpringCloud</code> 是一系列套件的统称，不单单是一门技术框架。而这些套件，恰好是我们做微服务系统的时候，常常使用的套件，包含 <strong>注册中心</strong> <strong>配置中心</strong> <strong>路由器</strong> <strong>熔断器</strong> <strong>监控</strong> 等微服务所需要的框架。套件什么的，做好部署运维，那么就可以将精力集中在业务服务的开发。</p>
<h2 id="为什么选择SpringCloud-1"><a href="#为什么选择SpringCloud-1" class="headerlink" title="为什么选择SpringCloud"></a>为什么选择SpringCloud</h2><p>常见的面试题就是：为什么使用 <code>SpringBoot</code> ？ 标准答案：因为 <code>Spring</code> 官方提供了自动装配的规范，由第三方框架(<code>MyBatis</code> 等)去实现。然后版本号规约放置于 <code>SpringBoot</code> 的顶级父类里，这样当我们使用对应版本的 <code>SpringBoot</code> 的时候，依赖进来的需要使用的第三方框架也是框架官方提供的，兼容性不错的版本。 而恰恰好，<code>SpringCloud</code> 就是这样集成而来的，所以兼容性问题，并不需要关心太多。 当初选择这个框架，是因为我感觉上手简单，而且套件齐全。公司项目肯定想要稳定，拓展性好的框架。因为 <code>Spring</code> 框架让我放心，因为他是 <code>Spring</code> 公司的。其二，官方提供套件的合成，也不会出现有些不兼容的现象。因为 <code>SpringBoot</code> 的加成，统一的父类，放心的整合。 在快速做一个小服务也是十分的方便，只要把统一的配置放置于 <code>config-server</code> 我在开发新的业务服务的时候，不需要过多的关注他的配置的东西 (比起 <code>Spring</code> 时代的 <code>xml</code> 地狱简直不要太方便)</p>
<h2 id="SpringCloud常用组件-1"><a href="#SpringCloud常用组件-1" class="headerlink" title="SpringCloud常用组件"></a>SpringCloud常用组件</h2><p>微服务套件</p>
<p>推荐框架</p>
<p>作用</p>
<p>可替换框架</p>
<p>注册中心</p>
<p><code>Eureka</code></p>
<p>微服务系统的中心，可用于服务的注册以及服务之间的发现</p>
<p><code>ZooKeeper</code> <code>Consul</code></p>
<p>配置中心</p>
<p><code>ConfigService</code></p>
<p>业务服务的配置中心，将业务服务通用、系统配置放置于此，服务启动即可发现并应用配置</p>
<p><code>Apollo</code></p>
<p>路由器</p>
<p><code>Gateway</code></p>
<p>微服务生态总入口，需要请求服务只能通过于此。相对的，权限控制、登陆拦截都落在此处。</p>
<p><code>Nginx</code> <code>Nodejs自开发</code></p>
<p>熔断器</p>
<p><code>Hystrix</code></p>
<p>熔断器，用于熔断服务的连接。如果服务负载量过大、频繁报错，将会像保险丝一样断开服务，让他休息一会儿再起来</p>
<p>-</p>
<p>熔断监控</p>
<p><code>Turbine</code></p>
<p>熔断器的监控视图，用于监控熔断器的情况，以便人为干涉</p>
<p>-</p>
<p>消息通知</p>
<p><code>Stream</code></p>
<p>用于服务之间的消息通知，进行封装后可以不需要关注分布式锁(谁来处理的问题)</p>
<p>-</p>
<p>契约开发</p>
<p><code>Contract</code></p>
<p>微服务中，进行 <code>TDD</code> 开发的模拟第三方服务返回数据的套件</p>
<p>-</p>
<p>老夫认为，项目刚刚初始，<code>Eureka</code> <code>Config</code> <code>Gateway</code> <code>Stream</code> 都是初始就要考虑的必备品。</p>
<h3 id="初代前后端分离-2"><a href="#初代前后端分离-2" class="headerlink" title="初代前后端分离"></a>初代前后端分离</h3><p>下一个发展阶段，即很多企业发现，如果一台机器，需要做数据库操作，还需要做界面层的渲染，服务器的压力太大。这时候出现了初代前后端分离，后端访问数据库的速度可以使用 <code>redis</code> 加成，而前端项目，大部分是渲染成页面提供给用户。所以这时候的架构演变成下面：这种情况可以根据不同的需求进行拓展，拓展前端，拓展后端都还行。 </p>
<h2 id="微服务是什么-3"><a href="#微服务是什么-3" class="headerlink" title="微服务是什么"></a>微服务是什么</h2><h3 id="单体项目-3"><a href="#单体项目-3" class="headerlink" title="单体项目"></a>单体项目</h3><p>在互联网刚开始的年代，传统的单体项目，一般是一个服务器，对少量的用户足矣。这时候，开发一套系统，可以提供少量的(相比于现在)服务。并发性不大，服务器性能不需要太好都可以跑得好好的。这个时代我没有经历过。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164344.png"></p>
<h3 id="单体项目分布式-3"><a href="#单体项目分布式-3" class="headerlink" title="单体项目分布式"></a>单体项目分布式</h3><p>互联网稍稍发展起来了，一台服务器好像支撑不大住。这时候，聪明的程序员们就说，如果一个系统撑不住，那就启动两个来为客户服务呀。所以架构就变成这样，用户，可以把请求落到两个随便一毛一样的系统上面，提供服务是一致的。这时候一般考虑 <code>sessionid</code> 的共享。<br><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164357.png"></p>
<h3 id="初代前后端分离-3"><a href="#初代前后端分离-3" class="headerlink" title="初代前后端分离"></a>初代前后端分离</h3><p>下一个发展阶段，即很多企业发现，如果一台机器，需要做数据库操作，还需要做界面层的渲染，服务器的压力太大。这时候出现了初代前后端分离，后端访问数据库的速度可以使用 <code>redis</code> 加成，而前端项目，大部分是渲染成页面提供给用户。所以这时候的架构演变成下面：这种情况可以根据不同的需求进行拓展，拓展前端，拓展后端都还行。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164416.png"></p>
<h3 id="微服务时代-2"><a href="#微服务时代-2" class="headerlink" title="微服务时代"></a>微服务时代</h3><p>很快，需求出现爆炸性的增长，后端服务器如果还是单体项目，无论是部署，拓展都显得特别笨重。如果后端服务需要新增一个实例，那么我们都需要手动重新配置前端服务。如果突然之间需要新增多个实例，那么程序猿将会累死累活。所以这时候，急需一个可以自治的生态系统，将拓展的事情交给程序去设定。 这时候，<code>Java</code> 界男神 <strong>Martin Fowler</strong> 提出了 <code>microservice</code> 架构(<a target="_blank" rel="noopener" href="https://www.martinfowler.com/articles/microservices.html">原文链接</a>)。即我们将公司所在领域，按照一定的子域进行划分，每个子域自成一个小服务。此时，拓展就变得简单，我们可以给并发量大的服务拓展多几个服务，而并发小的，或者任务不重但是缺一不可的，单机或者少一点服务存在。而上一层路由层，通过网络与不同服务之间进行通讯，共同服务于用户。 而微服务还有另外一个元素，那就是自治能力、监控能力。打个比方，如果前端服务需要增加多台，系统可以自动发现，并将其加入”服务团队”中，快速的进入工作状态。 所以微服务架构急切需要一种，自带管理者，统一入口的软件架构。而在当今社会，常见的就有 <code>Dubbo</code> <code>SpringCloud</code> 以及 <code>SpringCloudAlibaba</code> 等一系列的生态框架出现。 那么架构现状，也发生了质的变化： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164430.png"></p>
<h3 id="最终前后端分离-2"><a href="#最终前后端分离-2" class="headerlink" title="最终前后端分离"></a>最终前后端分离</h3><p>正在此时，前端由于 <code>vue</code> <code>AngularJS</code> <code>react</code> 的兴起，也没闲住，也发生了剧烈的变化。<code>ES</code> (<code>JS</code> 的现代叫法)不再单纯的操作 <code>document</code> 而是将 <code>document</code> 交给框架，开发者只需要关注数据的变化即可，框架会自动根据数据的变化去修改 <code>document</code> 的展示。所以这时候，会出现前端直接分离出来，由前端开发者自己开发，自己编织架构，后端只提供数据服务的局面。走到这里，前端真正的独立出来，后端开发者不再需要编写 <code>MVC</code> 的页面。前端开发者后期维护也变得简单，因为一个前端项目修改不再需要前端和后端结对编程了。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164447.png"></p>
<h3 id="微前端化-2"><a href="#微前端化-2" class="headerlink" title="微前端化"></a>微前端化</h3><p>由于业务量爆棚，前端也出现了后端的老路。然后前端也就走了后端的发展路线，一个前端再也支撑不住，所以前端也要分出来不同的业务团队，这时候，前端也就进行了微服务化。不同的业务有不同的模块，然后一个总视图进入前端，统领所有的业务服务模块。这块就不画出来了。</p>
<h2 id="SpringCloud是什么-2"><a href="#SpringCloud是什么-2" class="headerlink" title="SpringCloud是什么"></a>SpringCloud是什么</h2><p><code>SpringCloud</code> 是一系列套件的统称，不单单是一门技术框架。而这些套件，恰好是我们做微服务系统的时候，常常使用的套件，包含 <strong>注册中心</strong> <strong>配置中心</strong> <strong>路由器</strong> <strong>熔断器</strong> <strong>监控</strong> 等微服务所需要的框架。套件什么的，做好部署运维，那么就可以将精力集中在业务服务的开发。</p>
<h2 id="为什么选择SpringCloud-2"><a href="#为什么选择SpringCloud-2" class="headerlink" title="为什么选择SpringCloud"></a>为什么选择SpringCloud</h2><p>常见的面试题就是：为什么使用 <code>SpringBoot</code> ？ 标准答案：因为 <code>Spring</code> 官方提供了自动装配的规范，由第三方框架(<code>MyBatis</code> 等)去实现。然后版本号规约放置于 <code>SpringBoot</code> 的顶级父类里，这样当我们使用对应版本的 <code>SpringBoot</code> 的时候，依赖进来的需要使用的第三方框架也是框架官方提供的，兼容性不错的版本。 而恰恰好，<code>SpringCloud</code> 就是这样集成而来的，所以兼容性问题，并不需要关心太多。 当初选择这个框架，是因为我感觉上手简单，而且套件齐全。公司项目肯定想要稳定，拓展性好的框架。因为 <code>Spring</code> 框架让我放心，因为他是 <code>Spring</code> 公司的。其二，官方提供套件的合成，也不会出现有些不兼容的现象。因为 <code>SpringBoot</code> 的加成，统一的父类，放心的整合。 在快速做一个小服务也是十分的方便，只要把统一的配置放置于 <code>config-server</code> 我在开发新的业务服务的时候，不需要过多的关注他的配置的东西 (比起 <code>Spring</code> 时代的 <code>xml</code> 地狱简直不要太方便)</p>
<h2 id="SpringCloud常用组件-2"><a href="#SpringCloud常用组件-2" class="headerlink" title="SpringCloud常用组件"></a>SpringCloud常用组件</h2><p>微服务套件</p>
<p>推荐框架</p>
<p>作用</p>
<p>可替换框架</p>
<p>注册中心</p>
<p><code>Eureka</code></p>
<p>微服务系统的中心，可用于服务的注册以及服务之间的发现</p>
<p><code>ZooKeeper</code> <code>Consul</code></p>
<p>配置中心</p>
<p><code>ConfigService</code></p>
<p>业务服务的配置中心，将业务服务通用、系统配置放置于此，服务启动即可发现并应用配置</p>
<p><code>Apollo</code></p>
<p>路由器</p>
<p><code>Gateway</code></p>
<p>微服务生态总入口，需要请求服务只能通过于此。相对的，权限控制、登陆拦截都落在此处。</p>
<p><code>Nginx</code> <code>Nodejs自开发</code></p>
<p>熔断器</p>
<p><code>Hystrix</code></p>
<p>熔断器，用于熔断服务的连接。如果服务负载量过大、频繁报错，将会像保险丝一样断开服务，让他休息一会儿再起来</p>
<p>-</p>
<p>熔断监控</p>
<p><code>Turbine</code></p>
<p>熔断器的监控视图，用于监控熔断器的情况，以便人为干涉</p>
<p>-</p>
<p>消息通知</p>
<p><code>Stream</code></p>
<p>用于服务之间的消息通知，进行封装后可以不需要关注分布式锁(谁来处理的问题)</p>
<p>-</p>
<p>契约开发</p>
<p><code>Contract</code></p>
<p>微服务中，进行 <code>TDD</code> 开发的模拟第三方服务返回数据的套件</p>
<p>-</p>
<p>老夫认为，项目刚刚初始，<code>Eureka</code> <code>Config</code> <code>Gateway</code> <code>Stream</code> 都是初始就要考虑的必备品。</p>
<h3 id="微服务时代-3"><a href="#微服务时代-3" class="headerlink" title="微服务时代"></a>微服务时代</h3><p>很快，需求出现爆炸性的增长，后端服务器如果还是单体项目，无论是部署，拓展都显得特别笨重。如果后端服务需要新增一个实例，那么我们都需要手动重新配置前端服务。如果突然之间需要新增多个实例，那么程序猿将会累死累活。所以这时候，急需一个可以自治的生态系统，将拓展的事情交给程序去设定。 这时候，<code>Java</code> 界男神 <strong>Martin Fowler</strong> 提出了 <code>microservice</code> 架构(<a target="_blank" rel="noopener" href="https://www.martinfowler.com/articles/microservices.html">原文链接</a>)。即我们将公司所在领域，按照一定的子域进行划分，每个子域自成一个小服务。此时，拓展就变得简单，我们可以给并发量大的服务拓展多几个服务，而并发小的，或者任务不重但是缺一不可的，单机或者少一点服务存在。而上一层路由层，通过网络与不同服务之间进行通讯，共同服务于用户。 而微服务还有另外一个元素，那就是自治能力、监控能力。打个比方，如果前端服务需要增加多台，系统可以自动发现，并将其加入”服务团队”中，快速的进入工作状态。 所以微服务架构急切需要一种，自带管理者，统一入口的软件架构。而在当今社会，常见的就有 <code>Dubbo</code> <code>SpringCloud</code> 以及 <code>SpringCloudAlibaba</code> 等一系列的生态框架出现。 那么架构现状，也发生了质的变化： </p>
<h2 id="微服务是什么-4"><a href="#微服务是什么-4" class="headerlink" title="微服务是什么"></a>微服务是什么</h2><h3 id="单体项目-4"><a href="#单体项目-4" class="headerlink" title="单体项目"></a>单体项目</h3><p>在互联网刚开始的年代，传统的单体项目，一般是一个服务器，对少量的用户足矣。这时候，开发一套系统，可以提供少量的(相比于现在)服务。并发性不大，服务器性能不需要太好都可以跑得好好的。这个时代我没有经历过。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164344.png"></p>
<h3 id="单体项目分布式-4"><a href="#单体项目分布式-4" class="headerlink" title="单体项目分布式"></a>单体项目分布式</h3><p>互联网稍稍发展起来了，一台服务器好像支撑不大住。这时候，聪明的程序员们就说，如果一个系统撑不住，那就启动两个来为客户服务呀。所以架构就变成这样，用户，可以把请求落到两个随便一毛一样的系统上面，提供服务是一致的。这时候一般考虑 <code>sessionid</code> 的共享。<br><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164357.png"></p>
<h3 id="初代前后端分离-4"><a href="#初代前后端分离-4" class="headerlink" title="初代前后端分离"></a>初代前后端分离</h3><p>下一个发展阶段，即很多企业发现，如果一台机器，需要做数据库操作，还需要做界面层的渲染，服务器的压力太大。这时候出现了初代前后端分离，后端访问数据库的速度可以使用 <code>redis</code> 加成，而前端项目，大部分是渲染成页面提供给用户。所以这时候的架构演变成下面：这种情况可以根据不同的需求进行拓展，拓展前端，拓展后端都还行。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164416.png"></p>
<h3 id="微服务时代-4"><a href="#微服务时代-4" class="headerlink" title="微服务时代"></a>微服务时代</h3><p>很快，需求出现爆炸性的增长，后端服务器如果还是单体项目，无论是部署，拓展都显得特别笨重。如果后端服务需要新增一个实例，那么我们都需要手动重新配置前端服务。如果突然之间需要新增多个实例，那么程序猿将会累死累活。所以这时候，急需一个可以自治的生态系统，将拓展的事情交给程序去设定。 这时候，<code>Java</code> 界男神 <strong>Martin Fowler</strong> 提出了 <code>microservice</code> 架构(<a target="_blank" rel="noopener" href="https://www.martinfowler.com/articles/microservices.html">原文链接</a>)。即我们将公司所在领域，按照一定的子域进行划分，每个子域自成一个小服务。此时，拓展就变得简单，我们可以给并发量大的服务拓展多几个服务，而并发小的，或者任务不重但是缺一不可的，单机或者少一点服务存在。而上一层路由层，通过网络与不同服务之间进行通讯，共同服务于用户。 而微服务还有另外一个元素，那就是自治能力、监控能力。打个比方，如果前端服务需要增加多台，系统可以自动发现，并将其加入”服务团队”中，快速的进入工作状态。 所以微服务架构急切需要一种，自带管理者，统一入口的软件架构。而在当今社会，常见的就有 <code>Dubbo</code> <code>SpringCloud</code> 以及 <code>SpringCloudAlibaba</code> 等一系列的生态框架出现。 那么架构现状，也发生了质的变化： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164430.png"></p>
<h3 id="最终前后端分离-3"><a href="#最终前后端分离-3" class="headerlink" title="最终前后端分离"></a>最终前后端分离</h3><p>正在此时，前端由于 <code>vue</code> <code>AngularJS</code> <code>react</code> 的兴起，也没闲住，也发生了剧烈的变化。<code>ES</code> (<code>JS</code> 的现代叫法)不再单纯的操作 <code>document</code> 而是将 <code>document</code> 交给框架，开发者只需要关注数据的变化即可，框架会自动根据数据的变化去修改 <code>document</code> 的展示。所以这时候，会出现前端直接分离出来，由前端开发者自己开发，自己编织架构，后端只提供数据服务的局面。走到这里，前端真正的独立出来，后端开发者不再需要编写 <code>MVC</code> 的页面。前端开发者后期维护也变得简单，因为一个前端项目修改不再需要前端和后端结对编程了。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164447.png"></p>
<h3 id="微前端化-3"><a href="#微前端化-3" class="headerlink" title="微前端化"></a>微前端化</h3><p>由于业务量爆棚，前端也出现了后端的老路。然后前端也就走了后端的发展路线，一个前端再也支撑不住，所以前端也要分出来不同的业务团队，这时候，前端也就进行了微服务化。不同的业务有不同的模块，然后一个总视图进入前端，统领所有的业务服务模块。这块就不画出来了。</p>
<h2 id="SpringCloud是什么-3"><a href="#SpringCloud是什么-3" class="headerlink" title="SpringCloud是什么"></a>SpringCloud是什么</h2><p><code>SpringCloud</code> 是一系列套件的统称，不单单是一门技术框架。而这些套件，恰好是我们做微服务系统的时候，常常使用的套件，包含 <strong>注册中心</strong> <strong>配置中心</strong> <strong>路由器</strong> <strong>熔断器</strong> <strong>监控</strong> 等微服务所需要的框架。套件什么的，做好部署运维，那么就可以将精力集中在业务服务的开发。</p>
<h2 id="为什么选择SpringCloud-3"><a href="#为什么选择SpringCloud-3" class="headerlink" title="为什么选择SpringCloud"></a>为什么选择SpringCloud</h2><p>常见的面试题就是：为什么使用 <code>SpringBoot</code> ？ 标准答案：因为 <code>Spring</code> 官方提供了自动装配的规范，由第三方框架(<code>MyBatis</code> 等)去实现。然后版本号规约放置于 <code>SpringBoot</code> 的顶级父类里，这样当我们使用对应版本的 <code>SpringBoot</code> 的时候，依赖进来的需要使用的第三方框架也是框架官方提供的，兼容性不错的版本。 而恰恰好，<code>SpringCloud</code> 就是这样集成而来的，所以兼容性问题，并不需要关心太多。 当初选择这个框架，是因为我感觉上手简单，而且套件齐全。公司项目肯定想要稳定，拓展性好的框架。因为 <code>Spring</code> 框架让我放心，因为他是 <code>Spring</code> 公司的。其二，官方提供套件的合成，也不会出现有些不兼容的现象。因为 <code>SpringBoot</code> 的加成，统一的父类，放心的整合。 在快速做一个小服务也是十分的方便，只要把统一的配置放置于 <code>config-server</code> 我在开发新的业务服务的时候，不需要过多的关注他的配置的东西 (比起 <code>Spring</code> 时代的 <code>xml</code> 地狱简直不要太方便)</p>
<h2 id="SpringCloud常用组件-3"><a href="#SpringCloud常用组件-3" class="headerlink" title="SpringCloud常用组件"></a>SpringCloud常用组件</h2><p>微服务套件</p>
<p>推荐框架</p>
<p>作用</p>
<p>可替换框架</p>
<p>注册中心</p>
<p><code>Eureka</code></p>
<p>微服务系统的中心，可用于服务的注册以及服务之间的发现</p>
<p><code>ZooKeeper</code> <code>Consul</code></p>
<p>配置中心</p>
<p><code>ConfigService</code></p>
<p>业务服务的配置中心，将业务服务通用、系统配置放置于此，服务启动即可发现并应用配置</p>
<p><code>Apollo</code></p>
<p>路由器</p>
<p><code>Gateway</code></p>
<p>微服务生态总入口，需要请求服务只能通过于此。相对的，权限控制、登陆拦截都落在此处。</p>
<p><code>Nginx</code> <code>Nodejs自开发</code></p>
<p>熔断器</p>
<p><code>Hystrix</code></p>
<p>熔断器，用于熔断服务的连接。如果服务负载量过大、频繁报错，将会像保险丝一样断开服务，让他休息一会儿再起来</p>
<p>-</p>
<p>熔断监控</p>
<p><code>Turbine</code></p>
<p>熔断器的监控视图，用于监控熔断器的情况，以便人为干涉</p>
<p>-</p>
<p>消息通知</p>
<p><code>Stream</code></p>
<p>用于服务之间的消息通知，进行封装后可以不需要关注分布式锁(谁来处理的问题)</p>
<p>-</p>
<p>契约开发</p>
<p><code>Contract</code></p>
<p>微服务中，进行 <code>TDD</code> 开发的模拟第三方服务返回数据的套件</p>
<p>-</p>
<p>老夫认为，项目刚刚初始，<code>Eureka</code> <code>Config</code> <code>Gateway</code> <code>Stream</code> 都是初始就要考虑的必备品。</p>
<h3 id="最终前后端分离-4"><a href="#最终前后端分离-4" class="headerlink" title="最终前后端分离"></a>最终前后端分离</h3><p>正在此时，前端由于 <code>vue</code> <code>AngularJS</code> <code>react</code> 的兴起，也没闲住，也发生了剧烈的变化。<code>ES</code> (<code>JS</code> 的现代叫法)不再单纯的操作 <code>document</code> 而是将 <code>document</code> 交给框架，开发者只需要关注数据的变化即可，框架会自动根据数据的变化去修改 <code>document</code> 的展示。所以这时候，会出现前端直接分离出来，由前端开发者自己开发，自己编织架构，后端只提供数据服务的局面。走到这里，前端真正的独立出来，后端开发者不再需要编写 <code>MVC</code> 的页面。前端开发者后期维护也变得简单，因为一个前端项目修改不再需要前端和后端结对编程了。 </p>
<h2 id="微服务是什么-5"><a href="#微服务是什么-5" class="headerlink" title="微服务是什么"></a>微服务是什么</h2><h3 id="单体项目-5"><a href="#单体项目-5" class="headerlink" title="单体项目"></a>单体项目</h3><p>在互联网刚开始的年代，传统的单体项目，一般是一个服务器，对少量的用户足矣。这时候，开发一套系统，可以提供少量的(相比于现在)服务。并发性不大，服务器性能不需要太好都可以跑得好好的。这个时代我没有经历过。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164344.png"></p>
<h3 id="单体项目分布式-5"><a href="#单体项目分布式-5" class="headerlink" title="单体项目分布式"></a>单体项目分布式</h3><p>互联网稍稍发展起来了，一台服务器好像支撑不大住。这时候，聪明的程序员们就说，如果一个系统撑不住，那就启动两个来为客户服务呀。所以架构就变成这样，用户，可以把请求落到两个随便一毛一样的系统上面，提供服务是一致的。这时候一般考虑 <code>sessionid</code> 的共享。<br><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164357.png"></p>
<h3 id="初代前后端分离-5"><a href="#初代前后端分离-5" class="headerlink" title="初代前后端分离"></a>初代前后端分离</h3><p>下一个发展阶段，即很多企业发现，如果一台机器，需要做数据库操作，还需要做界面层的渲染，服务器的压力太大。这时候出现了初代前后端分离，后端访问数据库的速度可以使用 <code>redis</code> 加成，而前端项目，大部分是渲染成页面提供给用户。所以这时候的架构演变成下面：这种情况可以根据不同的需求进行拓展，拓展前端，拓展后端都还行。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164416.png"></p>
<h3 id="微服务时代-5"><a href="#微服务时代-5" class="headerlink" title="微服务时代"></a>微服务时代</h3><p>很快，需求出现爆炸性的增长，后端服务器如果还是单体项目，无论是部署，拓展都显得特别笨重。如果后端服务需要新增一个实例，那么我们都需要手动重新配置前端服务。如果突然之间需要新增多个实例，那么程序猿将会累死累活。所以这时候，急需一个可以自治的生态系统，将拓展的事情交给程序去设定。 这时候，<code>Java</code> 界男神 <strong>Martin Fowler</strong> 提出了 <code>microservice</code> 架构(<a target="_blank" rel="noopener" href="https://www.martinfowler.com/articles/microservices.html">原文链接</a>)。即我们将公司所在领域，按照一定的子域进行划分，每个子域自成一个小服务。此时，拓展就变得简单，我们可以给并发量大的服务拓展多几个服务，而并发小的，或者任务不重但是缺一不可的，单机或者少一点服务存在。而上一层路由层，通过网络与不同服务之间进行通讯，共同服务于用户。 而微服务还有另外一个元素，那就是自治能力、监控能力。打个比方，如果前端服务需要增加多台，系统可以自动发现，并将其加入”服务团队”中，快速的进入工作状态。 所以微服务架构急切需要一种，自带管理者，统一入口的软件架构。而在当今社会，常见的就有 <code>Dubbo</code> <code>SpringCloud</code> 以及 <code>SpringCloudAlibaba</code> 等一系列的生态框架出现。 那么架构现状，也发生了质的变化： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164430.png"></p>
<h3 id="最终前后端分离-5"><a href="#最终前后端分离-5" class="headerlink" title="最终前后端分离"></a>最终前后端分离</h3><p>正在此时，前端由于 <code>vue</code> <code>AngularJS</code> <code>react</code> 的兴起，也没闲住，也发生了剧烈的变化。<code>ES</code> (<code>JS</code> 的现代叫法)不再单纯的操作 <code>document</code> 而是将 <code>document</code> 交给框架，开发者只需要关注数据的变化即可，框架会自动根据数据的变化去修改 <code>document</code> 的展示。所以这时候，会出现前端直接分离出来，由前端开发者自己开发，自己编织架构，后端只提供数据服务的局面。走到这里，前端真正的独立出来，后端开发者不再需要编写 <code>MVC</code> 的页面。前端开发者后期维护也变得简单，因为一个前端项目修改不再需要前端和后端结对编程了。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110164447.png"></p>
<h3 id="微前端化-4"><a href="#微前端化-4" class="headerlink" title="微前端化"></a>微前端化</h3><p>由于业务量爆棚，前端也出现了后端的老路。然后前端也就走了后端的发展路线，一个前端再也支撑不住，所以前端也要分出来不同的业务团队，这时候，前端也就进行了微服务化。不同的业务有不同的模块，然后一个总视图进入前端，统领所有的业务服务模块。这块就不画出来了。</p>
<h2 id="SpringCloud是什么-4"><a href="#SpringCloud是什么-4" class="headerlink" title="SpringCloud是什么"></a>SpringCloud是什么</h2><p><code>SpringCloud</code> 是一系列套件的统称，不单单是一门技术框架。而这些套件，恰好是我们做微服务系统的时候，常常使用的套件，包含 <strong>注册中心</strong> <strong>配置中心</strong> <strong>路由器</strong> <strong>熔断器</strong> <strong>监控</strong> 等微服务所需要的框架。套件什么的，做好部署运维，那么就可以将精力集中在业务服务的开发。</p>
<h2 id="为什么选择SpringCloud-4"><a href="#为什么选择SpringCloud-4" class="headerlink" title="为什么选择SpringCloud"></a>为什么选择SpringCloud</h2><p>常见的面试题就是：为什么使用 <code>SpringBoot</code> ？ 标准答案：因为 <code>Spring</code> 官方提供了自动装配的规范，由第三方框架(<code>MyBatis</code> 等)去实现。然后版本号规约放置于 <code>SpringBoot</code> 的顶级父类里，这样当我们使用对应版本的 <code>SpringBoot</code> 的时候，依赖进来的需要使用的第三方框架也是框架官方提供的，兼容性不错的版本。 而恰恰好，<code>SpringCloud</code> 就是这样集成而来的，所以兼容性问题，并不需要关心太多。 当初选择这个框架，是因为我感觉上手简单，而且套件齐全。公司项目肯定想要稳定，拓展性好的框架。因为 <code>Spring</code> 框架让我放心，因为他是 <code>Spring</code> 公司的。其二，官方提供套件的合成，也不会出现有些不兼容的现象。因为 <code>SpringBoot</code> 的加成，统一的父类，放心的整合。 在快速做一个小服务也是十分的方便，只要把统一的配置放置于 <code>config-server</code> 我在开发新的业务服务的时候，不需要过多的关注他的配置的东西 (比起 <code>Spring</code> 时代的 <code>xml</code> 地狱简直不要太方便)</p>
<h2 id="SpringCloud常用组件-4"><a href="#SpringCloud常用组件-4" class="headerlink" title="SpringCloud常用组件"></a>SpringCloud常用组件</h2><p>微服务套件</p>
<p>推荐框架</p>
<p>作用</p>
<p>可替换框架</p>
<p>注册中心</p>
<p><code>Eureka</code></p>
<p>微服务系统的中心，可用于服务的注册以及服务之间的发现</p>
<p><code>ZooKeeper</code> <code>Consul</code></p>
<p>配置中心</p>
<p><code>ConfigService</code></p>
<p>业务服务的配置中心，将业务服务通用、系统配置放置于此，服务启动即可发现并应用配置</p>
<p><code>Apollo</code></p>
<p>路由器</p>
<p><code>Gateway</code></p>
<p>微服务生态总入口，需要请求服务只能通过于此。相对的，权限控制、登陆拦截都落在此处。</p>
<p><code>Nginx</code> <code>Nodejs自开发</code></p>
<p>熔断器</p>
<p><code>Hystrix</code></p>
<p>熔断器，用于熔断服务的连接。如果服务负载量过大、频繁报错，将会像保险丝一样断开服务，让他休息一会儿再起来</p>
<p>-</p>
<p>熔断监控</p>
<p><code>Turbine</code></p>
<p>熔断器的监控视图，用于监控熔断器的情况，以便人为干涉</p>
<p>-</p>
<p>消息通知</p>
<p><code>Stream</code></p>
<p>用于服务之间的消息通知，进行封装后可以不需要关注分布式锁(谁来处理的问题)</p>
<p>-</p>
<p>契约开发</p>
<p><code>Contract</code></p>
<p>微服务中，进行 <code>TDD</code> 开发的模拟第三方服务返回数据的套件</p>
<p>-</p>
<p>老夫认为，项目刚刚初始，<code>Eureka</code> <code>Config</code> <code>Gateway</code> <code>Stream</code> 都是初始就要考虑的必备品。</p>
<h3 id="微前端化-5"><a href="#微前端化-5" class="headerlink" title="微前端化"></a>微前端化</h3><p>由于业务量爆棚，前端也出现了后端的老路。然后前端也就走了后端的发展路线，一个前端再也支撑不住，所以前端也要分出来不同的业务团队，这时候，前端也就进行了微服务化。不同的业务有不同的模块，然后一个总视图进入前端，统领所有的业务服务模块。这块就不画出来了。</p>
<h2 id="SpringCloud是什么-5"><a href="#SpringCloud是什么-5" class="headerlink" title="SpringCloud是什么"></a>SpringCloud是什么</h2><p><code>SpringCloud</code> 是一系列套件的统称，不单单是一门技术框架。而这些套件，恰好是我们做微服务系统的时候，常常使用的套件，包含 <strong>注册中心</strong> <strong>配置中心</strong> <strong>路由器</strong> <strong>熔断器</strong> <strong>监控</strong> 等微服务所需要的框架。套件什么的，做好部署运维，那么就可以将精力集中在业务服务的开发。</p>
<h2 id="为什么选择SpringCloud-5"><a href="#为什么选择SpringCloud-5" class="headerlink" title="为什么选择SpringCloud"></a>为什么选择SpringCloud</h2><p>常见的面试题就是：为什么使用 <code>SpringBoot</code> ？ 标准答案：因为 <code>Spring</code> 官方提供了自动装配的规范，由第三方框架(<code>MyBatis</code> 等)去实现。然后版本号规约放置于 <code>SpringBoot</code> 的顶级父类里，这样当我们使用对应版本的 <code>SpringBoot</code> 的时候，依赖进来的需要使用的第三方框架也是框架官方提供的，兼容性不错的版本。 而恰恰好，<code>SpringCloud</code> 就是这样集成而来的，所以兼容性问题，并不需要关心太多。 当初选择这个框架，是因为我感觉上手简单，而且套件齐全。公司项目肯定想要稳定，拓展性好的框架。因为 <code>Spring</code> 框架让我放心，因为他是 <code>Spring</code> 公司的。其二，官方提供套件的合成，也不会出现有些不兼容的现象。因为 <code>SpringBoot</code> 的加成，统一的父类，放心的整合。 在快速做一个小服务也是十分的方便，只要把统一的配置放置于 <code>config-server</code> 我在开发新的业务服务的时候，不需要过多的关注他的配置的东西 (比起 <code>Spring</code> 时代的 <code>xml</code> 地狱简直不要太方便)</p>
<h2 id="SpringCloud常用组件-5"><a href="#SpringCloud常用组件-5" class="headerlink" title="SpringCloud常用组件"></a>SpringCloud常用组件</h2><p>微服务套件</p>
<p>推荐框架</p>
<p>作用</p>
<p>可替换框架</p>
<p>注册中心</p>
<p><code>Eureka</code></p>
<p>微服务系统的中心，可用于服务的注册以及服务之间的发现</p>
<p><code>ZooKeeper</code> <code>Consul</code></p>
<p>配置中心</p>
<p><code>ConfigService</code></p>
<p>业务服务的配置中心，将业务服务通用、系统配置放置于此，服务启动即可发现并应用配置</p>
<p><code>Apollo</code></p>
<p>路由器</p>
<p><code>Gateway</code></p>
<p>微服务生态总入口，需要请求服务只能通过于此。相对的，权限控制、登陆拦截都落在此处。</p>
<p><code>Nginx</code> <code>Nodejs自开发</code></p>
<p>熔断器</p>
<p><code>Hystrix</code></p>
<p>熔断器，用于熔断服务的连接。如果服务负载量过大、频繁报错，将会像保险丝一样断开服务，让他休息一会儿再起来</p>
<p>-</p>
<p>熔断监控</p>
<p><code>Turbine</code></p>
<p>熔断器的监控视图，用于监控熔断器的情况，以便人为干涉</p>
<p>-</p>
<p>消息通知</p>
<p><code>Stream</code></p>
<p>用于服务之间的消息通知，进行封装后可以不需要关注分布式锁(谁来处理的问题)</p>
<p>-</p>
<p>契约开发</p>
<p><code>Contract</code></p>
<p>微服务中，进行 <code>TDD</code> 开发的模拟第三方服务返回数据的套件</p>
<p>-</p>
<p>老夫认为，项目刚刚初始，<code>Eureka</code> <code>Config</code> <code>Gateway</code> <code>Stream</code> 都是初始就要考虑的必备品。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/db/redis/redis-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/db/redis/redis-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">Redis 集群部署方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-06 11:51:33" itemprop="dateCreated datePublished" datetime="2019-04-06T11:51:33+08:00">2019-04-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-12 14:43:05" itemprop="dateModified" datetime="2020-11-12T14:43:05+08:00">2020-11-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/db/" itemprop="url" rel="index"><span itemprop="name">db</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/db/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p>使用的 <code>Redis</code> 版本：<code>4</code> 通常来说，一个小型的项目一台 <code>redis</code> 服务实例即可满足需求，但是当系统很大的时候，客户端读写频繁，一台机器很容易就成为性能和内存的瓶颈，这时候就需要使用<strong>集群</strong>来拓展性能了。 <code>redis</code> 集群有两种方式：</p>
<ol>
<li>复制</li>
<li>哨兵</li>
<li>集群<h2 id="复制模式"><a href="#复制模式" class="headerlink" title="复制模式"></a>复制模式</h2></li>
</ol>
<h3 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h3><p><code>redis</code> 在复制模式下被分为两类数据库：主数据库和从数据库。一个主数据库可以拥有多个从数据库，但是一个从数据库则只能拥有一个主数据库。当主库数据发送变化时，<code>redis</code> 会将数据自动同步到多个从数据库中去。 在 <code>redis</code> 数据库中使用复制功能很简单，只需要在从数据库的配置文件中加入以下配置即可实现：</p>
<blockquote>
<p>ps：以下配置是 Redis4 的配置，在以前版本需要查看配置文件的配置方式。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replicaof 192.168.1.129 6379 # 配置主数据库链接信息</span><br><span class="line">masterauth 123456 # 配置主数据库的密码</span><br><span class="line">bind 192.168.1.130 # 配置主数据库的IP地址表示可以让这个IP访问数据</span><br></pre></td></tr></table></figure>

<p>主数据库无需任何配置。 查看 <code>redis</code> 服务的 <code>Replication</code> 节点相关信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">INFO replication</span><br></pre></td></tr></table></figure>

<p>默认情况下，从数据库是只读的，如果向从数据库设置值，将会得到一个错误（<code>(error) READONLY You can&#39;t write against a read only replica.</code>）。如果想要让从数据库可写，那么需要在配置加上以下信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slave-read-only no</span><br></pre></td></tr></table></figure>

<p>但是即使从数据库可写，写入的数据也会被主数据库同样的键给代替了，所以一般来说，从数据库应该只是只读的模式。 这种方式主数据库只能有一个，而从数据库可以有很多个。 然而，从数据库也可以有自己的从数据库（这里应该说这个从数据库是另外一个从数据库的主数据库。</p>
<h3 id="无硬盘复制"><a href="#无硬盘复制" class="headerlink" title="无硬盘复制"></a>无硬盘复制</h3><p>当 <code>Redis</code> 被配置不使用 <code>RDB</code> 备份的时候（删除所有的 <code>SAVE</code> 配置），<code>Redis</code> 还是会在硬盘生成 <code>RDB</code> 文件，这是为了在 <code>Redis</code> 被关闭的时候，重启 <code>Redis</code> 可以恢复内存中的数据。 在执行复制的时候，每次复制 <code>Redis</code> 都需要执行一次 <code>RDB</code> 文件的导出工作，这时候需要读取硬盘 <code>IO</code> ，必定造成复制效率的下降，在 <code>Redis 2.8.18</code> 开始，<code>Redis</code> 支持无硬盘复制操作，即在内存中生成 <code>RDB</code> 数据，然后通过网络传递给从服务器，避免造成硬盘性能瓶颈。 可以通过在配置文件中修改以下配置开启该功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-diskless-sync yes</span><br></pre></td></tr></table></figure>

<h3 id="增量复制"><a href="#增量复制" class="headerlink" title="增量复制"></a>增量复制</h3><p>在 <code>Redis 2.8</code> 之前，从数据库同步主数据的都需要使用全量复制的模式，即从数据库一旦启动就会发送 <code>SYNC</code> 命令给主数据库，要求读取所有数据然后再写入从数据库。在 <code>2.8</code> 以后咧，新增了增量复制。 增量复制过程：</p>
<ol>
<li>从数据库会存储主数据库的运行 <code>id</code> ，每个实例都会有一个，每当实例重启，就会自动生成一个新的 <code>id</code> 。</li>
<li>复制过程中，主数据库一旦接收到操作命令，就会传送给从数据库，并且存入到一个挤压队列中（backlog，在我看来有点像 <code>MySQL</code> 的 <code>binlog</code> 文档），并记录当前挤压队列中的命令的偏移量范围。</li>
<li>同时从数据库接收到主数据库的命令的时候，也会记录下数据的偏移量。</li>
</ol>
<p>从数据库一旦断开，重新连接上主数据库的时候，不再发送 <code>SYNC</code> 命令，而是 <code>PSYNC</code> 。格式为 <code>PSYNC 断开连接前的命令偏移量</code> 。主数据库收到请求将会查看是否可以发送偏移量后面的内容给从数据库。</p>
<ol>
<li>首先主数据库拿到了运行ID和偏移量，会判断运行ID是否和自己目前的相同，如果不同即进行全量复制。</li>
<li>判断命令偏移量是否存储在当前的积压队列里边，如果存在，进行增量复制，如果不存在，即进行全量复制。</li>
</ol>
<p>主数据的挤压队列默认是 <code>1m</code>，可以通过配置修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 10m # 积压队列长度</span><br><span class="line">repl-backlog-ttl 3600 # 积压队列过多久释放 默认1小时</span><br></pre></td></tr></table></figure>

<p>积压队列长度应按照网络情况，机器情况设定，积压队列越大，可容忍的断连时间就越长。</p>
<h2 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><h3 id="准备复制主从数据库"><a href="#准备复制主从数据库" class="headerlink" title="准备复制主从数据库"></a>准备复制主从数据库</h3><p>在复制模式下，我们项目可以通过读写分离来提高系统并发量。但是当主数据宕机的时候，需要人工手动切换主从数据库，比较繁琐。如果引入哨兵模式，哨兵就会自动的帮我们完成上面的动作。 在系统中，我们只需要运行一个哨兵，通过配置主数据库的连接信息。哨兵即会向主数据库发送一条 <code>INFO replication</code> 命令，了解当前系统中有多少个从数据库。从而各自读取从数据库的信息，并且建立与从数据沟通的链接。 OK，我现在准备了三个虚拟机：<code>192.168.1.129(Master)</code> <code>192.168.1.134(Slave1)</code> <code>192.168.1.139(Slave2)</code> 关闭防火墙，配置 <code>129</code> 机器为主 <code>Redis</code> 数据库。 先测试正常的复制用法。</p>
<h3 id="配置哨兵"><a href="#配置哨兵" class="headerlink" title="配置哨兵"></a>配置哨兵</h3><p>哨兵完全配置在 <code>redis路径/sentinel.conf</code>。 当前我们需要配置他监控主数据库，并且配置主数据库的密码（这不要忘记了，我忘记了所以总是认为掉线了）。修改连接的主数据库地址和连接密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#                主库名字  主库IP     端口 多少票通过认为数据库掉线，用于多个哨兵的时候配置</span><br><span class="line">sentinel monitor mymaster 192.168.1.129 6379 1</span><br><span class="line"># 配置密码</span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line"># 配置 1500 毫秒数据库没有返回 ping 结果则认为已经掉线</span><br><span class="line">sentinel down-after-milliseconds mymaster 1500</span><br></pre></td></tr></table></figure>

<p>然后运行启动哨兵：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel sentinel.conf</span><br></pre></td></tr></table></figure>

<p>运行启动配置文件会被覆写新增从库的监控地址。 来到这里表示哨兵已经就位，开始看看哪个屌毛偷懒了。</p>
<h3 id="划重点的配置"><a href="#划重点的配置" class="headerlink" title="划重点的配置"></a>划重点的配置</h3><p>哨兵和 <code>Redis</code> 中的通讯会受到 <code>bind</code> 配置和 <code>protect-mode</code> 的影响。如果配置这两个的话，哨兵的配置也需要加上相关的配置，如果没有配置的话，那么需要关闭哨兵的 <code>bind</code> 和 <code>protect-mode</code> 配置！我在测试的时候卡在这里很久。 OK，因为是自己使用的，先关闭掉这两个配置先。</p>
<h3 id="测试哨兵"><a href="#测试哨兵" class="headerlink" title="测试哨兵"></a>测试哨兵</h3><p>分别把服务都启动起来，包括哨兵。即可看见，上面的 <code>Redis 132库</code> 是 <code>Master</code> 角色，下面两个 <code>133</code> 和 <code>134</code> 是从库。 </p>
<h2 id="总览-1"><a href="#总览-1" class="headerlink" title="总览"></a>总览</h2><p>使用的 <code>Redis</code> 版本：<code>4</code> 通常来说，一个小型的项目一台 <code>redis</code> 服务实例即可满足需求，但是当系统很大的时候，客户端读写频繁，一台机器很容易就成为性能和内存的瓶颈，这时候就需要使用<strong>集群</strong>来拓展性能了。 <code>redis</code> 集群有两种方式：</p>
<ol>
<li>复制</li>
<li>哨兵</li>
<li>集群<h2 id="复制模式-1"><a href="#复制模式-1" class="headerlink" title="复制模式"></a>复制模式</h2></li>
</ol>
<h3 id="全量复制-1"><a href="#全量复制-1" class="headerlink" title="全量复制"></a>全量复制</h3><p><code>redis</code> 在复制模式下被分为两类数据库：主数据库和从数据库。一个主数据库可以拥有多个从数据库，但是一个从数据库则只能拥有一个主数据库。当主库数据发送变化时，<code>redis</code> 会将数据自动同步到多个从数据库中去。 在 <code>redis</code> 数据库中使用复制功能很简单，只需要在从数据库的配置文件中加入以下配置即可实现：</p>
<blockquote>
<p>ps：以下配置是 Redis4 的配置，在以前版本需要查看配置文件的配置方式。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replicaof 192.168.1.129 6379 # 配置主数据库链接信息</span><br><span class="line">masterauth 123456 # 配置主数据库的密码</span><br><span class="line">bind 192.168.1.130 # 配置主数据库的IP地址表示可以让这个IP访问数据</span><br></pre></td></tr></table></figure>

<p>主数据库无需任何配置。 查看 <code>redis</code> 服务的 <code>Replication</code> 节点相关信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">INFO replication</span><br></pre></td></tr></table></figure>

<p>默认情况下，从数据库是只读的，如果向从数据库设置值，将会得到一个错误（<code>(error) READONLY You can&#39;t write against a read only replica.</code>）。如果想要让从数据库可写，那么需要在配置加上以下信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slave-read-only no</span><br></pre></td></tr></table></figure>

<p>但是即使从数据库可写，写入的数据也会被主数据库同样的键给代替了，所以一般来说，从数据库应该只是只读的模式。 这种方式主数据库只能有一个，而从数据库可以有很多个。 然而，从数据库也可以有自己的从数据库（这里应该说这个从数据库是另外一个从数据库的主数据库。</p>
<h3 id="无硬盘复制-1"><a href="#无硬盘复制-1" class="headerlink" title="无硬盘复制"></a>无硬盘复制</h3><p>当 <code>Redis</code> 被配置不使用 <code>RDB</code> 备份的时候（删除所有的 <code>SAVE</code> 配置），<code>Redis</code> 还是会在硬盘生成 <code>RDB</code> 文件，这是为了在 <code>Redis</code> 被关闭的时候，重启 <code>Redis</code> 可以恢复内存中的数据。 在执行复制的时候，每次复制 <code>Redis</code> 都需要执行一次 <code>RDB</code> 文件的导出工作，这时候需要读取硬盘 <code>IO</code> ，必定造成复制效率的下降，在 <code>Redis 2.8.18</code> 开始，<code>Redis</code> 支持无硬盘复制操作，即在内存中生成 <code>RDB</code> 数据，然后通过网络传递给从服务器，避免造成硬盘性能瓶颈。 可以通过在配置文件中修改以下配置开启该功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-diskless-sync yes</span><br></pre></td></tr></table></figure>

<h3 id="增量复制-1"><a href="#增量复制-1" class="headerlink" title="增量复制"></a>增量复制</h3><p>在 <code>Redis 2.8</code> 之前，从数据库同步主数据的都需要使用全量复制的模式，即从数据库一旦启动就会发送 <code>SYNC</code> 命令给主数据库，要求读取所有数据然后再写入从数据库。在 <code>2.8</code> 以后咧，新增了增量复制。 增量复制过程：</p>
<ol>
<li>从数据库会存储主数据库的运行 <code>id</code> ，每个实例都会有一个，每当实例重启，就会自动生成一个新的 <code>id</code> 。</li>
<li>复制过程中，主数据库一旦接收到操作命令，就会传送给从数据库，并且存入到一个挤压队列中（backlog，在我看来有点像 <code>MySQL</code> 的 <code>binlog</code> 文档），并记录当前挤压队列中的命令的偏移量范围。</li>
<li>同时从数据库接收到主数据库的命令的时候，也会记录下数据的偏移量。</li>
</ol>
<p>从数据库一旦断开，重新连接上主数据库的时候，不再发送 <code>SYNC</code> 命令，而是 <code>PSYNC</code> 。格式为 <code>PSYNC 断开连接前的命令偏移量</code> 。主数据库收到请求将会查看是否可以发送偏移量后面的内容给从数据库。</p>
<ol>
<li>首先主数据库拿到了运行ID和偏移量，会判断运行ID是否和自己目前的相同，如果不同即进行全量复制。</li>
<li>判断命令偏移量是否存储在当前的积压队列里边，如果存在，进行增量复制，如果不存在，即进行全量复制。</li>
</ol>
<p>主数据的挤压队列默认是 <code>1m</code>，可以通过配置修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 10m # 积压队列长度</span><br><span class="line">repl-backlog-ttl 3600 # 积压队列过多久释放 默认1小时</span><br></pre></td></tr></table></figure>

<p>积压队列长度应按照网络情况，机器情况设定，积压队列越大，可容忍的断连时间就越长。</p>
<h2 id="哨兵模式-1"><a href="#哨兵模式-1" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><h3 id="准备复制主从数据库-1"><a href="#准备复制主从数据库-1" class="headerlink" title="准备复制主从数据库"></a>准备复制主从数据库</h3><p>在复制模式下，我们项目可以通过读写分离来提高系统并发量。但是当主数据宕机的时候，需要人工手动切换主从数据库，比较繁琐。如果引入哨兵模式，哨兵就会自动的帮我们完成上面的动作。 在系统中，我们只需要运行一个哨兵，通过配置主数据库的连接信息。哨兵即会向主数据库发送一条 <code>INFO replication</code> 命令，了解当前系统中有多少个从数据库。从而各自读取从数据库的信息，并且建立与从数据沟通的链接。 OK，我现在准备了三个虚拟机：<code>192.168.1.129(Master)</code> <code>192.168.1.134(Slave1)</code> <code>192.168.1.139(Slave2)</code> 关闭防火墙，配置 <code>129</code> 机器为主 <code>Redis</code> 数据库。 先测试正常的复制用法。</p>
<h3 id="配置哨兵-1"><a href="#配置哨兵-1" class="headerlink" title="配置哨兵"></a>配置哨兵</h3><p>哨兵完全配置在 <code>redis路径/sentinel.conf</code>。 当前我们需要配置他监控主数据库，并且配置主数据库的密码（这不要忘记了，我忘记了所以总是认为掉线了）。修改连接的主数据库地址和连接密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#                主库名字  主库IP     端口 多少票通过认为数据库掉线，用于多个哨兵的时候配置</span><br><span class="line">sentinel monitor mymaster 192.168.1.129 6379 1</span><br><span class="line"># 配置密码</span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line"># 配置 1500 毫秒数据库没有返回 ping 结果则认为已经掉线</span><br><span class="line">sentinel down-after-milliseconds mymaster 1500</span><br></pre></td></tr></table></figure>

<p>然后运行启动哨兵：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel sentinel.conf</span><br></pre></td></tr></table></figure>

<p>运行启动配置文件会被覆写新增从库的监控地址。 来到这里表示哨兵已经就位，开始看看哪个屌毛偷懒了。</p>
<h3 id="划重点的配置-1"><a href="#划重点的配置-1" class="headerlink" title="划重点的配置"></a>划重点的配置</h3><p>哨兵和 <code>Redis</code> 中的通讯会受到 <code>bind</code> 配置和 <code>protect-mode</code> 的影响。如果配置这两个的话，哨兵的配置也需要加上相关的配置，如果没有配置的话，那么需要关闭哨兵的 <code>bind</code> 和 <code>protect-mode</code> 配置！我在测试的时候卡在这里很久。 OK，因为是自己使用的，先关闭掉这两个配置先。</p>
<h3 id="测试哨兵-1"><a href="#测试哨兵-1" class="headerlink" title="测试哨兵"></a>测试哨兵</h3><p>分别把服务都启动起来，包括哨兵。即可看见，上面的 <code>Redis 132库</code> 是 <code>Master</code> 角色，下面两个 <code>133</code> 和 <code>134</code> 是从库。 <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110162655.png" alt="image-20190309154733954"></p>
<p> 现在我进入主库服务器，把主库 <code>kill</code> 掉： </p>
<p><img src="./switch-master-2268365.gif"> </p>
<p>可见干掉主库进程的时候，哨兵开始进行投票选举，然后选出来了 <code>127.0.0.1</code> 作为主库（因为哨兵就运行在这台机器上面）然后，哨兵开始切换所有数据库的状态的时候，也会把当前宕机的加入，但是是以从数据库的身份加入的，所以可以看到有 <code>+sdown</code> 输出</p>
<h2 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h2><p>即使我们使用了哨兵模式保证了 <code>Redis</code> 多实例的运行，但是因为是使用复制原理来做的，所以我们的 <code>Redis</code> 存储量极可能会受到最小机器的存储量的影响，形成木桶效应（也就是整个集群能存储多少数据取决于最小配置的实例） 在我们应用还不会很大，数据量不会很多的时候，哨兵模式完全够用（据我所知我们现在商城存储量才 <code>200m</code> 多点） 虽然我在项目中可能完全不需要 <code>Redis</code> 的集群配置，但是为了丰富文档，我还是决定写一写。 早期 <code>Redis</code> 不支持集群的时候，我们一般的做法是使用客户端来做的集群。比如 <code>Java</code> 客户端的 <code>Shardis</code> 。通过一定的规则计算出 <code>Key</code> 应该存储在哪个节点，从而写入数据库，读取也一样。但是这种做法有个弊端，就是后期的拓展性很差，当需要新增数据库的时候，我们所有的数据都会从新被计算，从而导致新增节点需要重置所有数据的尴尬局面。 当然现在 <code>Redis</code> 的集群也有一定的缺陷，当想读取多个键的时候，如果多个键均分布在同一个节点的时候可以正常读取，但是当键落在不同节点的时，此时 <code>Redis</code> 将会报错。</p>
<h3 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h3><p>配置集群必要点：</p>
<ol>
<li>每个实例配置中的 <code>cluster-enabled</code> 均需要为 <code>yes</code> ，也就是每个实例都要打开集群模式；</li>
<li>集群中必须存在 <strong>3</strong> 个主数据库，集群才能正常启动。</li>
</ol>
<p>OK，为了更好玩一点我就不使用单机形式启动，而是启动 6 台虚拟机进行模拟。 第一步 修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 开启集群模式</span><br><span class="line">cluster-enabled yes</span><br></pre></td></tr></table></figure>

<p>第二步 启动所有 <code>Redis</code> 实例，每台实例都会打印以下日志表明身份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11837:M 14 Mar 2019 03:06:48.465 * Node configuration loaded, I&#39;m 15876fe78b4d5bd61f8df8bdc748d5358a761ef0</span><br></pre></td></tr></table></figure>

<p>第三步 使用 <code>redis-cli</code> 连接所有的实例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 192.168.1.143:6379 192.168.1.144:6379 192.168.1.145:6379 192.168.1.150:6379 192.168.1.151:6379 192.168.1.153:6379 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<p>就可以看到输出了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11956:M 14 Mar 2019 07:03:17.632 * Replica 192.168.1.150:6379 asks for synchronization</span><br></pre></td></tr></table></figure>

<p>这个表示 <code>150</code> 服务器是主服务器，当前服务器是从服务器。 测试数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 需要使用 -c 参数表示读写集群中的 redis </span><br><span class="line">redis-cli -c</span><br><span class="line">127.0.0.1:6379&gt; set hello World</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get hello</span><br><span class="line">&quot;World&quot;</span><br><span class="line"># 如果在其他机器上读取，会出现重定向到指定机器上去读取</span><br><span class="line">127.0.0.1:6379&gt; get hello</span><br><span class="line">-&gt; Redirected to slot [866] located at 192.168.1.143:6379</span><br><span class="line">&quot;World&quot;</span><br></pre></td></tr></table></figure>

<h3 id="集群常用命令"><a href="#集群常用命令" class="headerlink" title="集群常用命令"></a>集群常用命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CLUSTER NODES</span><br><span class="line">15876fe78b4d5bd61f8df8bdc748d5358a761ef0 192.168.1.144:6379@16379 master - 0 1552564297487 2 connected 5461-10922</span><br><span class="line">f5a0ac798882cdeb6c543729a501a16220156f0a 192.168.1.143:6379@16379 myself,master - 0 1552564280000 1 connected 0-5460</span><br><span class="line">4acf665a179c8959c3287c05a515fce4648a550e 192.168.1.150:6379@16379 slave f5a0ac798882cdeb6c543729a501a16220156f0a 0 1552564299501 1 connected</span><br><span class="line">39ffad57d67b7b456f6e3373eb15f1f3f90f4242 192.168.1.153:6379@16379 slave 47ff715c566f6e373c0b3c020f34e9b910b7aa0b 0 1552564300509 6 connected</span><br><span class="line">4c825414ed6c09b375abb9917be3300e29970a07 192.168.1.151:6379@16379 slave 15876fe78b4d5bd61f8df8bdc748d5358a761ef0 0 1552564301519 5 connected</span><br><span class="line">47ff715c566f6e373c0b3c020f34e9b910b7aa0b 192.168.1.145:6379@16379 master - 0 1552564298493 3 connected 10923-16383</span><br></pre></td></tr></table></figure>

<p><code>CLUSTER NODES</code> 可以查看当前集群中插槽的情况以及主从的情况。</p>
<h4 id="插槽"><a href="#插槽" class="headerlink" title="插槽"></a>插槽</h4><p>一个 <code>redis</code> 共拥有 <code>16384</code> 个插槽，将会平均分配给每个主数据库，像上面的命令后面的 <code>connected 5461-10922</code> 即表示这个主数据库处理哪部分的插槽。 每个键将会落在哪个插槽，<code>redis</code> 会通过建的有效部分（如果存在 <code>&#123;&#125;</code> 则取 <code>&#123;&#125;</code> 中间的至少一个字符，如果不存在，整个键都是有效部分）进行 <code>CRC16</code> 算法计算出来散列值，然后与 <code>16384</code> 进行取余，然后得出来落在哪个节点的哪个插槽上去。 使用 <code>&#123;&#125;</code> 指定有效部分可以使相似业务的键值落在同一个节点，比如 <code>&#123;order&#125;:details</code> <code>&#123;order&#125;:info</code> 这样既可使这两个订单业务的数据落在同一个节点上去，从而支持一些集群不支持的命令。</p>
<h3 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h3><ol>
<li>集群中每个节点都会定时向其他节点发送 <code>ping</code> 命令，并且判断哪个节点没有回复</li>
<li>将没有回复的节点通知其他节点试试看能不能 <code>ping</code> 通</li>
<li>如果半数以上的节点认为已经下线，则集群系统会标记这个节点已经掉线了</li>
<li>如果挂掉的节点是个 <code>master</code> 并且拥有 <code>slave</code> 节点那么他的 <code>slave</code> 会通过选举自己，然后由集群进行投票，从而竞选升级为 <code>master</code> （这里可能会因为总是没有合适的 <code>slave</code> 而出现集群短时间不提供服务）</li>
<li>如果有半数以上的 <code>master</code> 挂掉了，那么集群将不会再对外提供服务</li>
<li><code>master</code> 挂掉以后可以重新加入集群，但是 <code>slave</code> 挂掉以后如果 <code>master</code> 不同了，需要通过修改配置文件来加入集群。</li>
</ol>
<p> 现在我进入主库服务器，把主库 <code>kill</code> 掉： </p>
<img src="/db/redis/redis-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F/switch-master-2268365.gif" class=""> 

<p>可见干掉主库进程的时候，哨兵开始进行投票选举，然后选出来了 <code>127.0.0.1</code> 作为主库（因为哨兵就运行在这台机器上面）然后，哨兵开始切换所有数据库的状态的时候，也会把当前宕机的加入，但是是以从数据库的身份加入的，所以可以看到有 <code>+sdown</code> 输出</p>
<h2 id="集群模式-1"><a href="#集群模式-1" class="headerlink" title="集群模式"></a>集群模式</h2><p>即使我们使用了哨兵模式保证了 <code>Redis</code> 多实例的运行，但是因为是使用复制原理来做的，所以我们的 <code>Redis</code> 存储量极可能会受到最小机器的存储量的影响，形成木桶效应（也就是整个集群能存储多少数据取决于最小配置的实例） 在我们应用还不会很大，数据量不会很多的时候，哨兵模式完全够用（据我所知我们现在商城存储量才 <code>200m</code> 多点） 虽然我在项目中可能完全不需要 <code>Redis</code> 的集群配置，但是为了丰富文档，我还是决定写一写。 早期 <code>Redis</code> 不支持集群的时候，我们一般的做法是使用客户端来做的集群。比如 <code>Java</code> 客户端的 <code>Shardis</code> 。通过一定的规则计算出 <code>Key</code> 应该存储在哪个节点，从而写入数据库，读取也一样。但是这种做法有个弊端，就是后期的拓展性很差，当需要新增数据库的时候，我们所有的数据都会从新被计算，从而导致新增节点需要重置所有数据的尴尬局面。 当然现在 <code>Redis</code> 的集群也有一定的缺陷，当想读取多个键的时候，如果多个键均分布在同一个节点的时候可以正常读取，但是当键落在不同节点的时，此时 <code>Redis</code> 将会报错。</p>
<h3 id="配置集群-1"><a href="#配置集群-1" class="headerlink" title="配置集群"></a>配置集群</h3><p>配置集群必要点：</p>
<ol>
<li>每个实例配置中的 <code>cluster-enabled</code> 均需要为 <code>yes</code> ，也就是每个实例都要打开集群模式；</li>
<li>集群中必须存在 <strong>3</strong> 个主数据库，集群才能正常启动。</li>
</ol>
<p>OK，为了更好玩一点我就不使用单机形式启动，而是启动 6 台虚拟机进行模拟。 第一步 修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 开启集群模式</span><br><span class="line">cluster-enabled yes</span><br></pre></td></tr></table></figure>

<p>第二步 启动所有 <code>Redis</code> 实例，每台实例都会打印以下日志表明身份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11837:M 14 Mar 2019 03:06:48.465 * Node configuration loaded, I&#39;m 15876fe78b4d5bd61f8df8bdc748d5358a761ef0</span><br></pre></td></tr></table></figure>

<p>第三步 使用 <code>redis-cli</code> 连接所有的实例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 192.168.1.143:6379 192.168.1.144:6379 192.168.1.145:6379 192.168.1.150:6379 192.168.1.151:6379 192.168.1.153:6379 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<p>就可以看到输出了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11956:M 14 Mar 2019 07:03:17.632 * Replica 192.168.1.150:6379 asks for synchronization</span><br></pre></td></tr></table></figure>

<p>这个表示 <code>150</code> 服务器是主服务器，当前服务器是从服务器。 测试数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 需要使用 -c 参数表示读写集群中的 redis </span><br><span class="line">redis-cli -c</span><br><span class="line">127.0.0.1:6379&gt; set hello World</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get hello</span><br><span class="line">&quot;World&quot;</span><br><span class="line"># 如果在其他机器上读取，会出现重定向到指定机器上去读取</span><br><span class="line">127.0.0.1:6379&gt; get hello</span><br><span class="line">-&gt; Redirected to slot [866] located at 192.168.1.143:6379</span><br><span class="line">&quot;World&quot;</span><br></pre></td></tr></table></figure>

<h3 id="集群常用命令-1"><a href="#集群常用命令-1" class="headerlink" title="集群常用命令"></a>集群常用命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CLUSTER NODES</span><br><span class="line">15876fe78b4d5bd61f8df8bdc748d5358a761ef0 192.168.1.144:6379@16379 master - 0 1552564297487 2 connected 5461-10922</span><br><span class="line">f5a0ac798882cdeb6c543729a501a16220156f0a 192.168.1.143:6379@16379 myself,master - 0 1552564280000 1 connected 0-5460</span><br><span class="line">4acf665a179c8959c3287c05a515fce4648a550e 192.168.1.150:6379@16379 slave f5a0ac798882cdeb6c543729a501a16220156f0a 0 1552564299501 1 connected</span><br><span class="line">39ffad57d67b7b456f6e3373eb15f1f3f90f4242 192.168.1.153:6379@16379 slave 47ff715c566f6e373c0b3c020f34e9b910b7aa0b 0 1552564300509 6 connected</span><br><span class="line">4c825414ed6c09b375abb9917be3300e29970a07 192.168.1.151:6379@16379 slave 15876fe78b4d5bd61f8df8bdc748d5358a761ef0 0 1552564301519 5 connected</span><br><span class="line">47ff715c566f6e373c0b3c020f34e9b910b7aa0b 192.168.1.145:6379@16379 master - 0 1552564298493 3 connected 10923-16383</span><br></pre></td></tr></table></figure>

<p><code>CLUSTER NODES</code> 可以查看当前集群中插槽的情况以及主从的情况。</p>
<h4 id="插槽-1"><a href="#插槽-1" class="headerlink" title="插槽"></a>插槽</h4><p>一个 <code>redis</code> 共拥有 <code>16384</code> 个插槽，将会平均分配给每个主数据库，像上面的命令后面的 <code>connected 5461-10922</code> 即表示这个主数据库处理哪部分的插槽。 每个键将会落在哪个插槽，<code>redis</code> 会通过建的有效部分（如果存在 <code>&#123;&#125;</code> 则取 <code>&#123;&#125;</code> 中间的至少一个字符，如果不存在，整个键都是有效部分）进行 <code>CRC16</code> 算法计算出来散列值，然后与 <code>16384</code> 进行取余，然后得出来落在哪个节点的哪个插槽上去。 使用 <code>&#123;&#125;</code> 指定有效部分可以使相似业务的键值落在同一个节点，比如 <code>&#123;order&#125;:details</code> <code>&#123;order&#125;:info</code> 这样既可使这两个订单业务的数据落在同一个节点上去，从而支持一些集群不支持的命令。</p>
<h3 id="故障恢复-1"><a href="#故障恢复-1" class="headerlink" title="故障恢复"></a>故障恢复</h3><ol>
<li>集群中每个节点都会定时向其他节点发送 <code>ping</code> 命令，并且判断哪个节点没有回复</li>
<li>将没有回复的节点通知其他节点试试看能不能 <code>ping</code> 通</li>
<li>如果半数以上的节点认为已经下线，则集群系统会标记这个节点已经掉线了</li>
<li>如果挂掉的节点是个 <code>master</code> 并且拥有 <code>slave</code> 节点那么他的 <code>slave</code> 会通过选举自己，然后由集群进行投票，从而竞选升级为 <code>master</code> （这里可能会因为总是没有合适的 <code>slave</code> 而出现集群短时间不提供服务）</li>
<li>如果有半数以上的 <code>master</code> 挂掉了，那么集群将不会再对外提供服务</li>
<li><code>master</code> 挂掉以后可以重新加入集群，但是 <code>slave</code> 挂掉以后如果 <code>master</code> 不同了，需要通过修改配置文件来加入集群。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/db/redis/redis-%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/db/redis/redis-%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Redis 持久化机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-06 11:47:08" itemprop="dateCreated datePublished" datetime="2019-04-06T11:47:08+08:00">2019-04-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:26:36" itemprop="dateModified" datetime="2020-11-10T16:26:36+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/db/" itemprop="url" rel="index"><span itemprop="name">db</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/db/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p><code>redis</code> 数据库，可以直接用来当数据库使用，也可以当系统的缓存使用。但是 <code>redis</code> 大部分数据是存储在内存中的，当服务掉线重启，会造成数据的丢失。当然，<code>redis</code> 是有持久化线程的，我们可以利用这个持久化服务来做数据的持久化，这样当 <code>redis</code> 重启的时候，即可从硬盘重新读取数据，然后进行数据的恢复。 <code>redis</code> 的持久化方式有两种：</p>
<ol>
<li>RDB 方式</li>
<li>AOP方式<h2 id="RDB-方式"><a href="#RDB-方式" class="headerlink" title="RDB 方式"></a>RDB 方式</h2></li>
</ol>
<h3 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h3><p><code>redis</code> 的 <code>RDB</code> 持久化是通过快照完成的。当符合一定条件的时候，<code>redis</code> 可以将目前的数据生成一份副本存储在硬盘。 <code>redis</code> 执行快照的一句有下面几种：</p>
<ol>
<li>根据配置的规则</li>
<li>用户执行 <code>SAVE</code> 或 <code>BGSAVE</code> 命令</li>
<li>执行 <code>FLUSHALL</code> 命令</li>
<li>执行复制时</li>
</ol>
<h3 id="配置规则"><a href="#配置规则" class="headerlink" title="配置规则"></a>配置规则</h3><p><code>redis</code> 可以根据用户在配置文件中配置的规则进行定时，定量的持久化。在 <code>redis</code> 的 <code>conf</code> 文件夹中配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1 # 表示900秒以内有一个或以上的简直更改时进行快照</span><br><span class="line">save 300 10 </span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>

<h3 id="执行-SAVE-或-BGSAVE-命令"><a href="#执行-SAVE-或-BGSAVE-命令" class="headerlink" title="执行 SAVE 或 BGSAVE 命令"></a>执行 SAVE 或 BGSAVE 命令</h3><p>执行 <code>SAVE</code> 时，<code>redis</code> 会阻塞所有客户端的请求，然后进行备份。这一过程可能造成 <code>redis</code> 长时间无响应，所以应该尽量避免。 执行 <code>BGSAVE</code> 时，<code>redis</code> 则异步的进行快照，客户端的请求依然可以进行处理。 执行 <code>BGSAVE</code> 时，<code>redis</code> 做了以下的操作：</p>
<ol>
<li>当执行 <code>BGSAVE</code> 的时候，<code>redis</code> 会使用 <code>Fork</code> 函数复制一份当前进程（父）的副本（子）</li>
<li>父进程继续接收客户端的请求，而子进程会将 <code>Fork</code> 的副本写入硬盘的临时文件</li>
<li>当子进程将所有数据写入临时文件时，开始替换旧的 <code>RDB</code> 文件</li>
</ol>
<blockquote>
<p>在进行 Fork 操作的时候，父子进程共享一份内存数据，当父进程需要修改某一片的数据的时候，操作系统会将这一份数据进行复制，保证子进程的读取。所以，Fork 函数执行的时候，RDB文件存储的是这一时刻的数据。 执行这一操作需要确保开启 Linux 系统允许应用程序申请超过可用内存的空间（物理空间和交换空间）。方法是在 .etc/sysctl.conf 加入 vm.overcommit_memory = 1 然后重启系统或执行 sysctl vm.overcommit_memory = 1使配置生效即可。</p>
</blockquote>
<h3 id="执行-FLUSHALL-命令"><a href="#执行-FLUSHALL-命令" class="headerlink" title="执行 FLUSHALL 命令"></a>执行 FLUSHALL 命令</h3><p>执行该命令时，数据库中的所有数据将会被清空，不论配置文件怎么配置，只要执行该命令，<code>redis</code> 就会执行一次快照操作。</p>
<h3 id="执行复制时"><a href="#执行复制时" class="headerlink" title="执行复制时"></a>执行复制时</h3><p>只要配置主从复制时，无论有没有配置规则，都会生成 <code>RDB</code> 文件的快照。用于多个实例之间进行数据的同步。</p>
<h2 id="AOF-方式"><a href="#AOF-方式" class="headerlink" title="AOF 方式"></a>AOF 方式</h2><p>当使用 <code>redis</code> 存储非临时数据时，一般需要开启 <code>AOF</code> 模式来减少每次 <code>redis</code> 的宕机造成的数据损失。<code>AOF</code> 会将 <code>redis</code> 执行的每一条命令都写入硬盘。当然这一过程肯定对性能造成一定影响，不过可以接受。</p>
<h3 id="开启AOF"><a href="#开启AOF" class="headerlink" title="开启AOF"></a>开启AOF</h3><p>默认 <code>redis</code> 是没有开启 <code>AOF</code> 模式的。可以通过配置文件来实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>

<p>开启 <code>AOF</code> 持久化后将会保存每一条命令，可以通过下面配置来指定持久化文件的名字。 <code>appendfilename append.aof</code></p>
<h3 id="AOF-的实现"><a href="#AOF-的实现" class="headerlink" title="AOF 的实现"></a>AOF 的实现</h3><p><code>AOF</code> 会通过保存客户端发送的通讯协议进行保存，所以会导致 <code>AOF</code> 文件越来越大的问题，因为可能出现的情况是，一个键被设置了，后面又被删除了，这时候完全可以不进行记录这一个过程。那么可以通过配置文件来设置 <code>redis</code> 当 <code>AOF</code> 文件达到一定容量的时候进行 <code>AOF</code> 的优化重写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto-aof-rewrite-percentage 100 # 当前 AOF 文件超过上一次的 AOF 文件的百分之多少时进行重写，如果无重写过则以启动时的文件大小为准</span><br><span class="line">auto-aof-min-size 64mb # 当 AOF 达到这个设置容量时触发重写</span><br></pre></td></tr></table></figure>

<p>除了可以让 <code>redis</code> 自动重写以外，还可以通过传输命令 <code>BGREWRITEAOF</code> 来触发 <code>redis</code> 的重写。</p>
<h3 id="同步硬盘数据"><a href="#同步硬盘数据" class="headerlink" title="同步硬盘数据"></a>同步硬盘数据</h3><p>虽然每次都会重写 <code>AOF</code> 文件，但是此时这个文件并没有真正的写入硬盘中，而是进入硬盘缓存，如果此时系统出现异常宕机，则会导致数据的丢失。系统默认情况下，30秒执行一次同步硬盘操作，但是一般开启 <code>AOF</code> 的应用都不能允许这个情况的出现，这就需要 <code>redis</code> 在写入 <code>AOF</code> 文件的时候，主动触发同步硬盘。我们可以通过以下设置来实现这个目的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aapendfsync everysec # 每秒执行一次同步操作，也是默认设置</span><br></pre></td></tr></table></figure>

<p>可选值：<code>always</code> <code>no</code> 前者是每次写入 <code>AOF</code> 都进行同步，后者则完全交由系统决定。</p>
<h2 id="持久化使用"><a href="#持久化使用" class="headerlink" title="持久化使用"></a>持久化使用</h2><p><code>redis</code> 允许同时开启两种模式，既保证数据安全又使得备份十分容易。重启 <code>redis</code> 后 <code>redis</code> 会使用 <code>AOF</code> 方式来回复数据，因为 <code>AOF</code> 可能丢失的数据更少。 </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/db/mysql/mysql-8-0-15-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/db/mysql/mysql-8-0-15-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">MySQL 8.0.15 主从复制配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-06 11:35:06" itemprop="dateCreated datePublished" datetime="2019-04-06T11:35:06+08:00">2019-04-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:12:15" itemprop="dateModified" datetime="2020-11-10T16:12:15+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/db/" itemprop="url" rel="index"><span itemprop="name">db</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/db/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="MySQL-主从复制"><a href="#MySQL-主从复制" class="headerlink" title="MySQL 主从复制"></a>MySQL 主从复制</h2><p>BasicIn: <code>MySQL 8.0.15</code> 看过 <code>Redis</code> 的主从复制，其实 <code>MySQL</code> 的原理也差不多。都是通过一个中间文件(记录操作)进行传播，达到数据相同的结果。 开启主从复制有以下几个好处：</p>
<ol>
<li>提高吞吐量，启动 <code>MySQL</code> 主从复制以后，写操作一般将是发生在主数据库(当然要求实时性特别高的读操作也会发生在主数据库上)，而读操作一般会发生在从数据库；</li>
<li>数据安全性，数据多了几个地方存储了，自然提高了数据丢失的安全性；</li>
<li>提升数据分析性能，数据分析一般都是占用较大的资源，我们可以把数据分析步骤放在其中一个或者多个从数据库上进行；</li>
<li>长距离的数据拷贝，无需与主数据库进行长连接的复制远程数据库的数据<h2 id="主从复制方式"><a href="#主从复制方式" class="headerlink" title="主从复制方式"></a>主从复制方式</h2></li>
</ol>
<p><code>MySQL</code> 经历了这么多的版本迭代以来，已经支持多种方式进行主从数据复制了。 <code>MySQL</code> 支持以下方式进行：</p>
<ol>
<li>同步复制：即主数据库数据发生变化的时候，需要所有的从数据库表示已经写入才返回，效率低</li>
<li>半同步复制：即主数据库数据发生变化的时候，至少一个从数据库表示已经写入才返回，效率较高，数据安全性也适中；</li>
<li>全异步复制：主库写入完成即返回，不关心从数据库是否成功。</li>
</ol>
<h2 id="主从复制的格式"><a href="#主从复制的格式" class="headerlink" title="主从复制的格式"></a>主从复制的格式</h2><ul>
<li>SBR：基于 <code>SQL</code> 语句描述的文档</li>
<li>RBR：基于<strong>数据行</strong>描述的文档</li>
<li>MBR：上面两者混合的文档</li>
</ul>
<p>以上两种方式其实各有优缺点。</p>
<h3 id="SBR-格式"><a href="#SBR-格式" class="headerlink" title="SBR 格式"></a>SBR 格式</h3><p>优点：</p>
<ol>
<li>妥当，毕竟已经经历很久的考验了</li>
<li>不需要记录大量的数据</li>
<li>文档包含了所有的 <code>SQL</code> 语句</li>
</ol>
<p>缺点：</p>
<ol>
<li>不是所有修改数据的语句都能够被复制，一些语句会被定义不安全性的，包含以下项目的将会被定义成不安全：<ul>
<li>需要使用自定义函数返回 <code>SQL</code> 参数的语句</li>
<li><code>UPDATE</code> 和 <code>DELETE</code> 语句中使用了分页但是没有使用排序语句</li>
<li>读写锁(<code>SELECT ... FOR UPDATE</code> and <code>SELECT ... FOR SHARE</code>)</li>
<li>需要从数据库有确定性返回值的函数的时候</li>
<li>使用以下函数的时候：<code>LOAD_FILE()</code>、<code>UUID(), UUID_SHORT()</code>、<code>USER()</code>、<code>FOUND_ROWS()</code>、<code>SYSDATE() (unless both the master and the slave are started with the --sysdate-is-now option)</code>、<code>GET_LOCK()</code>、<code>IS_FREE_LOCK()</code>、<code>IS_USED_LOCK()</code>、<code>MASTER_POS_WAIT()</code>、<code>RAND()</code>、<code>RELEASE_LOCK()</code>、<code>SLEEP()</code>、<code>VERSION()</code>；除了这些其他函数都能够被正确复制，包括 <code>NOW()</code>。如果 <code>SQL</code> 出现 <code>[Warning] Statement is not safe to log in statement format.</code> 也将不能被复制</li>
</ul>
</li>
<li><code>INSERT ... SELECT</code> 会比 <code>RBR</code> 锁住更多的数据行</li>
<li><code>update</code> 语句需要全表扫描，会比 <code>RBR</code> 锁住更多的数据行</li>
<li><code>InnoDB</code> 下插入自增的数据会锁住</li>
<li>复杂语句下，从数据库都会重新执行一次</li>
<li>如果复杂语句执行时间过长，从数据库可能好报过长时间</li>
<li>执行过程函数执行 <code>NOW()</code> 的时候会产生同样的数据，如果存储过程要求实时性的话，那么会出现问题</li>
<li>函数都需要部署到从数据库</li>
<li>表格式主从数据库都需要相同</li>
</ol>
<h3 id="RBR-格式"><a href="#RBR-格式" class="headerlink" title="RBR 格式"></a>RBR 格式</h3><p>优点：</p>
<ol>
<li>所有的修改都会被查看到</li>
<li>使用以下语句会锁住主数据库的一些数据行<ul>
<li><code>INSERT...SELECT</code></li>
<li>自增插入</li>
<li>没有使用列条件的 <code>UPDATE</code> 和 <code>DELETE</code>，或者不影响大多数行的语句</li>
</ul>
</li>
</ol>
<p>缺点：</p>
<ol>
<li>当语句影响了很多行数据的时候，日志文档会变得很大，从数据库同步将会需要更长的时间</li>
<li>从数据库查看不了语句执行情况，不过可以查看 <code>binlog</code> 中数据的变化情况</li>
<li><code>MyISAM</code> 格式下，<code>INSERT</code> 语句会导致锁表。</li>
</ol>
<h2 id="实战主从复制"><a href="#实战主从复制" class="headerlink" title="实战主从复制"></a>实战主从复制</h2><h3 id="MySQL-安装"><a href="#MySQL-安装" class="headerlink" title="MySQL 安装"></a>MySQL 安装</h3><blockquote>
<p>Linux系统：CentOSKU7 MySQL版本：8.0</p>
</blockquote>
<h4 id="第一步-安装数据库软件"><a href="#第一步-安装数据库软件" class="headerlink" title="第一步 安装数据库软件"></a>第一步 安装数据库软件</h4><p>下载 <a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/repo/yum/">MySQL8.0 yum 仓库</a> 文档，放入 <code>root</code> 文件夹中。然后在服务器上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mysql80-community-release-el7-2.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>程序会自动更新服务器中的 <code>yum</code> 仓库，并且安装一些证书认证等等。 然后执行以下命令安装 <code>MySQL 8.0</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install mysql-community-server</span><br><span class="line">systemctl start mysqld.service</span><br></pre></td></tr></table></figure>

<p>注意配置好防火墙配置，因为是开发环境我索性关闭了防火墙：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure>

<h4 id="第二步-修改root密码"><a href="#第二步-修改root密码" class="headerlink" title="第二步 修改root密码"></a>第二步 修改root密码</h4><p>接下来查看 <code>MySQL</code> 初次启动生成的密码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br></pre></td></tr></table></figure>

<p>进入 <code>MySQL</code> 客户端修改数据库的密码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pXXX</span><br><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;新密码&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="第三步-配置允许远程连接"><a href="#第三步-配置允许远程连接" class="headerlink" title="第三步 配置允许远程连接"></a>第三步 配置允许远程连接</h4><p>查看原有的用户列表以及允许连接的 <code>host</code>，可以发现，目前 <code>root</code> 命令只允许 <code>localhost</code> 连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; select user, host from user</span><br><span class="line">    -&gt; ;</span><br><span class="line">+------------------+-----------+</span><br><span class="line"> user              host      </span><br><span class="line">+------------------+-----------+</span><br><span class="line"> mysql.infoschema  localhost </span><br><span class="line"> mysql.session     localhost </span><br><span class="line"> mysql.sys         localhost </span><br><span class="line"> root              localhost </span><br><span class="line">+------------------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>通过以下指令进行修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update user set host &#x3D; &#39;%&#39; where user &#x3D; &#39;root&#39;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39;;</span><br><span class="line">ERROR 1410 (42000): You are not allowed to create a user with GRANT</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH   PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>然后我这里陷入一个坑，就是我习惯性使用 <code>IDEA</code> 连接数据库死活连不上去，以为是我数据库的配置出现了问题。后来换个 <code>Navicat</code> 就连上去了。驱动也是换了，<code>IDEA</code> 就是连不上去。</p>
<h3 id="主数据库配置"><a href="#主数据库配置" class="headerlink" title="主数据库配置"></a>主数据库配置</h3><h4 id="第一步-查看logbin有没有开启"><a href="#第一步-查看logbin有没有开启" class="headerlink" title="第一步 查看logbin有没有开启"></a>第一步 查看logbin有没有开启</h4><p>查看数据库的 <code>log_bin</code> 功能有没有开启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show VARIABLES  LIKE &#39;%log_bin%&#39;;</span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line"> Variable_name                    Value                       </span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line"> log_bin                          ON                          </span><br><span class="line"> log_bin_basename                 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;binlog       </span><br><span class="line"> log_bin_index                    &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;binlog.index </span><br><span class="line"> log_bin_trust_function_creators  OFF                         </span><br><span class="line"> log_bin_use_v1_row_events        OFF                         </span><br><span class="line"> sql_log_bin                      ON                          </span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line">6 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>如上所示，第一个数据表示 <code>ON</code> 则已经开启了。 如果没有开启，需要在 <code>/etc/my.cnf</code> 中指定 <code>log-bin=mysql-bin</code> 进行开启</p>
<h4 id="第二步-设置数据库的server-id"><a href="#第二步-设置数据库的server-id" class="headerlink" title="第二步 设置数据库的server_id"></a>第二步 设置数据库的server_id</h4><p>同样是在 <code>/etc/my.cnf</code> 文件中，加入 <code>server-id=1</code>。可接受范围是 <code>1 到 2^32−1</code>，设置其他值可能会出现不必要的坑。建议可以设置成当前数据库所在服务器 <code>ip</code> 最后一个字段的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...省略其他设置</span><br><span class="line">datadir&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line"></span><br><span class="line">log-error&#x3D;&#x2F;var&#x2F;log&#x2F;mysqld.log</span><br><span class="line">pid-file&#x3D;&#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid</span><br><span class="line">server-id&#x3D;127</span><br></pre></td></tr></table></figure>

<p>OK，这两个步骤做完主数据库的设置也就好了。接下来配置从数据库连接主数据库即可。</p>
<h4 id="第三步-准备一个同步的账号"><a href="#第三步-准备一个同步的账号" class="headerlink" title="第三步 准备一个同步的账号"></a>第三步 准备一个同步的账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 官方示例</span><br><span class="line">mysql&gt; CREATE USER &#39;repl&#39;@&#39;%&#39; IDENTIFIED BY &#39;Liweidan1@#&#39;;</span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;repl&#39;@&#39;%&#39;;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h3 id="从数据库配置"><a href="#从数据库配置" class="headerlink" title="从数据库配置"></a>从数据库配置</h3><h4 id="第一步-配置server-id"><a href="#第一步-配置server-id" class="headerlink" title="第一步 配置server_id"></a>第一步 配置server_id</h4><p>同上面 <code>Master</code> 的配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">datadir&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line"></span><br><span class="line">log-error&#x3D;&#x2F;var&#x2F;log&#x2F;mysqld.log</span><br><span class="line">pid-file&#x3D;&#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid</span><br><span class="line">server-id&#x3D;154</span><br></pre></td></tr></table></figure>

<h4 id="第二步-在主数据库准备一个用来同步的账号"><a href="#第二步-在主数据库准备一个用来同步的账号" class="headerlink" title="第二步 在主数据库准备一个用来同步的账号"></a>第二步 在主数据库准备一个用来同步的账号</h4><h4 id="第三步-导出主库数据"><a href="#第三步-导出主库数据" class="headerlink" title="第三步 导出主库数据"></a>第三步 导出主库数据</h4><p>使用 <code>FLUSH TABLES WITH READ LOCK;</code> 锁住表格。然后使用上面的两个工具将数据进行同步。并且使用 <code>SHOW MASTER STATUS;</code> 来查看数据执行的位置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 主数据库操作</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH TABLES WITH READ LOCK;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line"> File           Position  Binlog_Do_DB  Binlog_Ignore_DB  Executed_Gtid_Set </span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line"> binlog.000004       846                                                    </span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出数据</span></span><br><span class="line">[root@localhost ~]# mysqldump -uroot -p&#x27;Liweidan1@#&#x27; -S /var/lib/mysql/mysql.sock --all-databases &gt; ~/mysql_bak.$(date +%F).sql</span><br><span class="line">mysqldump: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@localhost ~]# ll</span><br><span class="line">total 908</span><br><span class="line">-rw-------. 1 root root   1225 Mar  7 03:40 anaconda-ks.cfg</span><br><span class="line">-rw-r--r--. 1 root root  25892 Mar 19 06:29 mysql80-community-release-el7-2.noarch.rpm</span><br><span class="line">-rw-r--r--. 1 root root 894115 Mar 19 11:31 mysql_bak.2019-03-19.sql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 传递给从服务器</span></span><br><span class="line">[root@localhost ~]scp -r ~/mysql_bak.2019-03-19.sql root@192.168.1.154:~/</span><br></pre></td></tr></table></figure>

<h4 id="第四步-从库导入主库数据"><a href="#第四步-从库导入主库数据" class="headerlink" title="第四步 从库导入主库数据"></a>第四步 从库导入主库数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p&#x27;Liweidan1@#&#x27; -S /var/lib/mysql/mysql.sock &lt; ~/mysql_bak.2019-03-19.sql</span><br></pre></td></tr></table></figure>

<h4 id="第五步-配置从库同步"><a href="#第五步-配置从库同步" class="headerlink" title="第五步 配置从库同步"></a>第五步 配置从库同步</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO</span></span><br><span class="line">    -&gt;     MASTER_HOST=&#x27;192.168.1.127&#x27;, # 主库IP</span><br><span class="line">    -&gt;     MASTER_USER=&#x27;repl&#x27;, # 主库配置给从库的用户名</span><br><span class="line">    -&gt;     MASTER_PASSWORD=&#x27;Liweidan1@#&#x27;, # 主库中的从库密码</span><br><span class="line">    -&gt;     MASTER_LOG_FILE=&#x27;binlog.000004&#x27;, # 上面查询主库binlog的文件名</span><br><span class="line">    -&gt;     MASTER_LOG_POS=846; # 上面查询主库binlog的Position</span><br></pre></td></tr></table></figure>

<p>完整命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;192.168.1.127&#39;,MASTER_USER&#x3D;&#39;repl&#39;,MASTER_PASSWORD&#x3D;&#39;Liweidan1@#&#39;,MASTER_LOG_FILE&#x3D;&#39;binlog.000004&#39;,MASTER_LOG_POS&#x3D;846;</span><br><span class="line">start slave;</span><br><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.1.127</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: binlog.000004</span><br><span class="line">          Read_Master_Log_Pos: 4486</span><br><span class="line">               Relay_Log_File: localhost-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 319</span><br><span class="line">        Relay_Master_Log_File: binlog.000004</span><br><span class="line">             Slave_IO_Running: Yes (这一项和下面一项如果都是YES表示主从设置成功)</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="第六步-启动从库同步进程"><a href="#第六步-启动从库同步进程" class="headerlink" title="第六步 启动从库同步进程"></a>第六步 启动从库同步进程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure>

<h4 id="第七步-释放主库的读锁"><a href="#第七步-释放主库的读锁" class="headerlink" title="第七步 释放主库的读锁"></a>第七步 释放主库的读锁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UNLOCK TABLES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="测试同步"><a href="#测试同步" class="headerlink" title="测试同步"></a>测试同步</h2><h2 id="MySQL-主从复制-1"><a href="#MySQL-主从复制-1" class="headerlink" title="MySQL 主从复制"></a>MySQL 主从复制</h2><p>BasicIn: <code>MySQL 8.0.15</code> 看过 <code>Redis</code> 的主从复制，其实 <code>MySQL</code> 的原理也差不多。都是通过一个中间文件(记录操作)进行传播，达到数据相同的结果。 开启主从复制有以下几个好处：</p>
<ol>
<li>提高吞吐量，启动 <code>MySQL</code> 主从复制以后，写操作一般将是发生在主数据库(当然要求实时性特别高的读操作也会发生在主数据库上)，而读操作一般会发生在从数据库；</li>
<li>数据安全性，数据多了几个地方存储了，自然提高了数据丢失的安全性；</li>
<li>提升数据分析性能，数据分析一般都是占用较大的资源，我们可以把数据分析步骤放在其中一个或者多个从数据库上进行；</li>
<li>长距离的数据拷贝，无需与主数据库进行长连接的复制远程数据库的数据<h2 id="主从复制方式-1"><a href="#主从复制方式-1" class="headerlink" title="主从复制方式"></a>主从复制方式</h2></li>
</ol>
<p><code>MySQL</code> 经历了这么多的版本迭代以来，已经支持多种方式进行主从数据复制了。 <code>MySQL</code> 支持以下方式进行：</p>
<ol>
<li>同步复制：即主数据库数据发生变化的时候，需要所有的从数据库表示已经写入才返回，效率低</li>
<li>半同步复制：即主数据库数据发生变化的时候，至少一个从数据库表示已经写入才返回，效率较高，数据安全性也适中；</li>
<li>全异步复制：主库写入完成即返回，不关心从数据库是否成功。</li>
</ol>
<h2 id="主从复制的格式-1"><a href="#主从复制的格式-1" class="headerlink" title="主从复制的格式"></a>主从复制的格式</h2><ul>
<li>SBR：基于 <code>SQL</code> 语句描述的文档</li>
<li>RBR：基于<strong>数据行</strong>描述的文档</li>
<li>MBR：上面两者混合的文档</li>
</ul>
<p>以上两种方式其实各有优缺点。</p>
<h3 id="SBR-格式-1"><a href="#SBR-格式-1" class="headerlink" title="SBR 格式"></a>SBR 格式</h3><p>优点：</p>
<ol>
<li>妥当，毕竟已经经历很久的考验了</li>
<li>不需要记录大量的数据</li>
<li>文档包含了所有的 <code>SQL</code> 语句</li>
</ol>
<p>缺点：</p>
<ol>
<li>不是所有修改数据的语句都能够被复制，一些语句会被定义不安全性的，包含以下项目的将会被定义成不安全：<ul>
<li>需要使用自定义函数返回 <code>SQL</code> 参数的语句</li>
<li><code>UPDATE</code> 和 <code>DELETE</code> 语句中使用了分页但是没有使用排序语句</li>
<li>读写锁(<code>SELECT ... FOR UPDATE</code> and <code>SELECT ... FOR SHARE</code>)</li>
<li>需要从数据库有确定性返回值的函数的时候</li>
<li>使用以下函数的时候：<code>LOAD_FILE()</code>、<code>UUID(), UUID_SHORT()</code>、<code>USER()</code>、<code>FOUND_ROWS()</code>、<code>SYSDATE() (unless both the master and the slave are started with the --sysdate-is-now option)</code>、<code>GET_LOCK()</code>、<code>IS_FREE_LOCK()</code>、<code>IS_USED_LOCK()</code>、<code>MASTER_POS_WAIT()</code>、<code>RAND()</code>、<code>RELEASE_LOCK()</code>、<code>SLEEP()</code>、<code>VERSION()</code>；除了这些其他函数都能够被正确复制，包括 <code>NOW()</code>。如果 <code>SQL</code> 出现 <code>[Warning] Statement is not safe to log in statement format.</code> 也将不能被复制</li>
</ul>
</li>
<li><code>INSERT ... SELECT</code> 会比 <code>RBR</code> 锁住更多的数据行</li>
<li><code>update</code> 语句需要全表扫描，会比 <code>RBR</code> 锁住更多的数据行</li>
<li><code>InnoDB</code> 下插入自增的数据会锁住</li>
<li>复杂语句下，从数据库都会重新执行一次</li>
<li>如果复杂语句执行时间过长，从数据库可能好报过长时间</li>
<li>执行过程函数执行 <code>NOW()</code> 的时候会产生同样的数据，如果存储过程要求实时性的话，那么会出现问题</li>
<li>函数都需要部署到从数据库</li>
<li>表格式主从数据库都需要相同</li>
</ol>
<h3 id="RBR-格式-1"><a href="#RBR-格式-1" class="headerlink" title="RBR 格式"></a>RBR 格式</h3><p>优点：</p>
<ol>
<li>所有的修改都会被查看到</li>
<li>使用以下语句会锁住主数据库的一些数据行<ul>
<li><code>INSERT...SELECT</code></li>
<li>自增插入</li>
<li>没有使用列条件的 <code>UPDATE</code> 和 <code>DELETE</code>，或者不影响大多数行的语句</li>
</ul>
</li>
</ol>
<p>缺点：</p>
<ol>
<li>当语句影响了很多行数据的时候，日志文档会变得很大，从数据库同步将会需要更长的时间</li>
<li>从数据库查看不了语句执行情况，不过可以查看 <code>binlog</code> 中数据的变化情况</li>
<li><code>MyISAM</code> 格式下，<code>INSERT</code> 语句会导致锁表。</li>
</ol>
<h2 id="实战主从复制-1"><a href="#实战主从复制-1" class="headerlink" title="实战主从复制"></a>实战主从复制</h2><h3 id="MySQL-安装-1"><a href="#MySQL-安装-1" class="headerlink" title="MySQL 安装"></a>MySQL 安装</h3><blockquote>
<p>Linux系统：CentOSKU7 MySQL版本：8.0</p>
</blockquote>
<h4 id="第一步-安装数据库软件-1"><a href="#第一步-安装数据库软件-1" class="headerlink" title="第一步 安装数据库软件"></a>第一步 安装数据库软件</h4><p>下载 <a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/repo/yum/">MySQL8.0 yum 仓库</a> 文档，放入 <code>root</code> 文件夹中。然后在服务器上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mysql80-community-release-el7-2.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>程序会自动更新服务器中的 <code>yum</code> 仓库，并且安装一些证书认证等等。 然后执行以下命令安装 <code>MySQL 8.0</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install mysql-community-server</span><br><span class="line">systemctl start mysqld.service</span><br></pre></td></tr></table></figure>

<p>注意配置好防火墙配置，因为是开发环境我索性关闭了防火墙：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure>

<h4 id="第二步-修改root密码-1"><a href="#第二步-修改root密码-1" class="headerlink" title="第二步 修改root密码"></a>第二步 修改root密码</h4><p>接下来查看 <code>MySQL</code> 初次启动生成的密码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br></pre></td></tr></table></figure>

<p>进入 <code>MySQL</code> 客户端修改数据库的密码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pXXX</span><br><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;新密码&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="第三步-配置允许远程连接-1"><a href="#第三步-配置允许远程连接-1" class="headerlink" title="第三步 配置允许远程连接"></a>第三步 配置允许远程连接</h4><p>查看原有的用户列表以及允许连接的 <code>host</code>，可以发现，目前 <code>root</code> 命令只允许 <code>localhost</code> 连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; select user, host from user</span><br><span class="line">    -&gt; ;</span><br><span class="line">+------------------+-----------+</span><br><span class="line"> user              host      </span><br><span class="line">+------------------+-----------+</span><br><span class="line"> mysql.infoschema  localhost </span><br><span class="line"> mysql.session     localhost </span><br><span class="line"> mysql.sys         localhost </span><br><span class="line"> root              localhost </span><br><span class="line">+------------------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>通过以下指令进行修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update user set host &#x3D; &#39;%&#39; where user &#x3D; &#39;root&#39;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39;;</span><br><span class="line">ERROR 1410 (42000): You are not allowed to create a user with GRANT</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH   PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>然后我这里陷入一个坑，就是我习惯性使用 <code>IDEA</code> 连接数据库死活连不上去，以为是我数据库的配置出现了问题。后来换个 <code>Navicat</code> 就连上去了。驱动也是换了，<code>IDEA</code> 就是连不上去。</p>
<h3 id="主数据库配置-1"><a href="#主数据库配置-1" class="headerlink" title="主数据库配置"></a>主数据库配置</h3><h4 id="第一步-查看logbin有没有开启-1"><a href="#第一步-查看logbin有没有开启-1" class="headerlink" title="第一步 查看logbin有没有开启"></a>第一步 查看logbin有没有开启</h4><p>查看数据库的 <code>log_bin</code> 功能有没有开启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show VARIABLES  LIKE &#39;%log_bin%&#39;;</span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line"> Variable_name                    Value                       </span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line"> log_bin                          ON                          </span><br><span class="line"> log_bin_basename                 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;binlog       </span><br><span class="line"> log_bin_index                    &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;binlog.index </span><br><span class="line"> log_bin_trust_function_creators  OFF                         </span><br><span class="line"> log_bin_use_v1_row_events        OFF                         </span><br><span class="line"> sql_log_bin                      ON                          </span><br><span class="line">+---------------------------------+-----------------------------+</span><br><span class="line">6 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>如上所示，第一个数据表示 <code>ON</code> 则已经开启了。 如果没有开启，需要在 <code>/etc/my.cnf</code> 中指定 <code>log-bin=mysql-bin</code> 进行开启</p>
<h4 id="第二步-设置数据库的server-id-1"><a href="#第二步-设置数据库的server-id-1" class="headerlink" title="第二步 设置数据库的server_id"></a>第二步 设置数据库的server_id</h4><p>同样是在 <code>/etc/my.cnf</code> 文件中，加入 <code>server-id=1</code>。可接受范围是 <code>1 到 2^32−1</code>，设置其他值可能会出现不必要的坑。建议可以设置成当前数据库所在服务器 <code>ip</code> 最后一个字段的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...省略其他设置</span><br><span class="line">datadir&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line"></span><br><span class="line">log-error&#x3D;&#x2F;var&#x2F;log&#x2F;mysqld.log</span><br><span class="line">pid-file&#x3D;&#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid</span><br><span class="line">server-id&#x3D;127</span><br></pre></td></tr></table></figure>

<p>OK，这两个步骤做完主数据库的设置也就好了。接下来配置从数据库连接主数据库即可。</p>
<h4 id="第三步-准备一个同步的账号-1"><a href="#第三步-准备一个同步的账号-1" class="headerlink" title="第三步 准备一个同步的账号"></a>第三步 准备一个同步的账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 官方示例</span><br><span class="line">mysql&gt; CREATE USER &#39;repl&#39;@&#39;%&#39; IDENTIFIED BY &#39;Liweidan1@#&#39;;</span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;repl&#39;@&#39;%&#39;;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h3 id="从数据库配置-1"><a href="#从数据库配置-1" class="headerlink" title="从数据库配置"></a>从数据库配置</h3><h4 id="第一步-配置server-id-1"><a href="#第一步-配置server-id-1" class="headerlink" title="第一步 配置server_id"></a>第一步 配置server_id</h4><p>同上面 <code>Master</code> 的配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">datadir&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line"></span><br><span class="line">log-error&#x3D;&#x2F;var&#x2F;log&#x2F;mysqld.log</span><br><span class="line">pid-file&#x3D;&#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid</span><br><span class="line">server-id&#x3D;154</span><br></pre></td></tr></table></figure>

<h4 id="第二步-在主数据库准备一个用来同步的账号-1"><a href="#第二步-在主数据库准备一个用来同步的账号-1" class="headerlink" title="第二步 在主数据库准备一个用来同步的账号"></a>第二步 在主数据库准备一个用来同步的账号</h4><h4 id="第三步-导出主库数据-1"><a href="#第三步-导出主库数据-1" class="headerlink" title="第三步 导出主库数据"></a>第三步 导出主库数据</h4><p>使用 <code>FLUSH TABLES WITH READ LOCK;</code> 锁住表格。然后使用上面的两个工具将数据进行同步。并且使用 <code>SHOW MASTER STATUS;</code> 来查看数据执行的位置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 主数据库操作</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH TABLES WITH READ LOCK;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line"> File           Position  Binlog_Do_DB  Binlog_Ignore_DB  Executed_Gtid_Set </span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line"> binlog.000004       846                                                    </span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出数据</span></span><br><span class="line">[root@localhost ~]# mysqldump -uroot -p&#x27;Liweidan1@#&#x27; -S /var/lib/mysql/mysql.sock --all-databases &gt; ~/mysql_bak.$(date +%F).sql</span><br><span class="line">mysqldump: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@localhost ~]# ll</span><br><span class="line">total 908</span><br><span class="line">-rw-------. 1 root root   1225 Mar  7 03:40 anaconda-ks.cfg</span><br><span class="line">-rw-r--r--. 1 root root  25892 Mar 19 06:29 mysql80-community-release-el7-2.noarch.rpm</span><br><span class="line">-rw-r--r--. 1 root root 894115 Mar 19 11:31 mysql_bak.2019-03-19.sql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 传递给从服务器</span></span><br><span class="line">[root@localhost ~]scp -r ~/mysql_bak.2019-03-19.sql root@192.168.1.154:~/</span><br></pre></td></tr></table></figure>

<h4 id="第四步-从库导入主库数据-1"><a href="#第四步-从库导入主库数据-1" class="headerlink" title="第四步 从库导入主库数据"></a>第四步 从库导入主库数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p&#x27;Liweidan1@#&#x27; -S /var/lib/mysql/mysql.sock &lt; ~/mysql_bak.2019-03-19.sql</span><br></pre></td></tr></table></figure>

<h4 id="第五步-配置从库同步-1"><a href="#第五步-配置从库同步-1" class="headerlink" title="第五步 配置从库同步"></a>第五步 配置从库同步</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO</span></span><br><span class="line">    -&gt;     MASTER_HOST=&#x27;192.168.1.127&#x27;, # 主库IP</span><br><span class="line">    -&gt;     MASTER_USER=&#x27;repl&#x27;, # 主库配置给从库的用户名</span><br><span class="line">    -&gt;     MASTER_PASSWORD=&#x27;Liweidan1@#&#x27;, # 主库中的从库密码</span><br><span class="line">    -&gt;     MASTER_LOG_FILE=&#x27;binlog.000004&#x27;, # 上面查询主库binlog的文件名</span><br><span class="line">    -&gt;     MASTER_LOG_POS=846; # 上面查询主库binlog的Position</span><br></pre></td></tr></table></figure>

<p>完整命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;192.168.1.127&#39;,MASTER_USER&#x3D;&#39;repl&#39;,MASTER_PASSWORD&#x3D;&#39;Liweidan1@#&#39;,MASTER_LOG_FILE&#x3D;&#39;binlog.000004&#39;,MASTER_LOG_POS&#x3D;846;</span><br><span class="line">start slave;</span><br><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.1.127</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: binlog.000004</span><br><span class="line">          Read_Master_Log_Pos: 4486</span><br><span class="line">               Relay_Log_File: localhost-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 319</span><br><span class="line">        Relay_Master_Log_File: binlog.000004</span><br><span class="line">             Slave_IO_Running: Yes (这一项和下面一项如果都是YES表示主从设置成功)</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="第六步-启动从库同步进程-1"><a href="#第六步-启动从库同步进程-1" class="headerlink" title="第六步 启动从库同步进程"></a>第六步 启动从库同步进程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure>

<h4 id="第七步-释放主库的读锁-1"><a href="#第七步-释放主库的读锁-1" class="headerlink" title="第七步 释放主库的读锁"></a>第七步 释放主库的读锁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UNLOCK TABLES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="测试同步-1"><a href="#测试同步-1" class="headerlink" title="测试同步"></a>测试同步</h2><p><img src="https://liweidan.cn/wp-content/uploads/2019/04/databse-async.gif"> <img src="https://liweidan.cn/wp-content/uploads/2019/04/table-async.gif"> <img src="https://liweidan.cn/wp-content/uploads/2019/04/data-async.gif"></p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>从数据库同步的状态，如果发现同步有问题，可以通过以上的 <code>show slave status\G</code> 来查看日志问题。 这里说我遇到的问题，因为我是使用虚拟机来做的主从服务器，所以从数据库是直接从主数据库下克隆出来的镜像，这里就导致了出现同步的问题：<code>The slave I/O thread stops because master and slave have equal MySQL server UUIDs;</code> 即使我们设置 <code>server_id</code> 但是这两个值也不可以一致。解决也很简单，关闭从 <code>mysql</code>，删除 <code>mysql Data</code> 目录下（<code>SHOW VARIABLES LIKE &#39;%datadir%&#39;</code> 可以查看 <code>Data</code> 目录的路径）的 <code>auto.cnf</code> ，启动 <code>MySQL</code> 服务即可。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kylinlin/p/5258719.html">Mysql主从同步（复制）</a> </p>
<h2 id="遇到的问题-1"><a href="#遇到的问题-1" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>从数据库同步的状态，如果发现同步有问题，可以通过以上的 <code>show slave status\G</code> 来查看日志问题。 这里说我遇到的问题，因为我是使用虚拟机来做的主从服务器，所以从数据库是直接从主数据库下克隆出来的镜像，这里就导致了出现同步的问题：<code>The slave I/O thread stops because master and slave have equal MySQL server UUIDs;</code> 即使我们设置 <code>server_id</code> 但是这两个值也不可以一致。解决也很简单，关闭从 <code>mysql</code>，删除 <code>mysql Data</code> 目录下（<code>SHOW VARIABLES LIKE &#39;%datadir%&#39;</code> 可以查看 <code>Data</code> 目录的路径）的 <code>auto.cnf</code> ，启动 <code>MySQL</code> 服务即可。</p>
<h2 id="参考资料-1"><a href="#参考资料-1" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kylinlin/p/5258719.html">Mysql主从同步（复制）</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/front/front-backend-ajax-permission-due-iview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/front/front-backend-ajax-permission-due-iview/" class="post-title-link" itemprop="url">关于前后端分离权限的控制（元素细粒度 iview-admin实现）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-05 09:45:40" itemprop="dateCreated datePublished" datetime="2019-03-05T09:45:40+08:00">2019-03-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-12 14:39:28" itemprop="dateModified" datetime="2020-11-12T14:39:28+08:00">2020-11-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/front/" itemprop="url" rel="index"><span itemprop="name">front</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="开篇啰嗦几句"><a href="#开篇啰嗦几句" class="headerlink" title="开篇啰嗦几句"></a>开篇啰嗦几句</h2><p>在传统单体项目中，通常会有一些框架用来管理熟知的权限。如耳濡目染的 <code>Shiro</code> 或者 <code>Spring Security</code> 。然而，到了现在这个时代，新开始的项目会更多的才用后端微服务 + 前端 <code>mvvm</code> 的架构开始书写项目。权限控制方面将变得有些许晦涩。当然，得益于 <code>Java</code> 后端的 <code>Spring</code> 项目的可插拔式接口以及前端大部分 <code>SPA</code> 的架构，权限控制也并没有变得那么的难以实现。相反，在我看来只要找到一个合适的插拔插件的入口，权限也可以做的很简单，跟业务只要少许的耦合即可实现我们熟悉的权限模块。 <a target="_blank" rel="noopener" href="https://github.com/WeidanLi/iview-admin-permission">示例代码 iview-admin-permission</a></p>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="路由方面"><a href="#路由方面" class="headerlink" title="路由方面"></a>路由方面</h3><p>后端提供当前登录用户可访问的所有可访问资源接口信息，前端项目根据当前用户所拥有的接口信息，判断是否拥有菜单权限，如果拥有主要访问权限则加入路由，让用户可以访问其当前的页面。 由于 <code>iview-admin</code> 中，路由信息与菜单是同一份资料，所以在加入路由的时候，即可实现菜单的隐藏与现实。</p>
<h3 id="按钮方面"><a href="#按钮方面" class="headerlink" title="按钮方面"></a>按钮方面</h3><p>按钮通过 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/custom-directive.html"><code>vue</code> 自定义指令</a>绑定其特定的操作接口信息（如：产品上传按钮，需要拥有产品上传的信息，才可以继续执行按钮的业务逻辑）。在按钮或者 <code>a</code> 标签被渲染的时候，判断是否拥有权限，如若没有，可以隐藏，或者劫持原来绑定的点击事件，使其变成无权限的弹窗提示。 该指令支持 <code>render</code> 生成的按钮或者 <code>a</code> 标签。</p>
<h3 id="数据表格方面"><a href="#数据表格方面" class="headerlink" title="数据表格方面"></a>数据表格方面</h3><p>数据的隐藏与否应该不会放在前端做吧…不然就是沙雕网友了。 这方面可以提供思路，在微服务架构中，如若前端项目拥有 <code>NodeJS</code> 做数据转换层，那是极好的。如果没有，则需要在微服务路由层做一些细微的改变。即用户无权限的数据列（属性）给他模糊掉，变成 <code>*</code> 或者 <code>—</code> 输出。这方面与前端无关，那么并不会在这里出现。</p>
<h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>后端不再关注页面上的事情，基于权限代码让前端自己随心所欲编排</li>
<li>灵活性较高，可以控制页面上所有的元素，可以隐藏弹窗等等喜欢的功能</li>
</ol>
<p>缺点：</p>
<ol>
<li>编排路由的时候会显得繁琐，权限代码比较零散，开发完业务页面可能会忘记加上</li>
</ol>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>公司实现并不能成为开源，所以我重新下载一份 <code>iview-admin</code> ，然后加入关键代码，来实现上面所需要的功能。 常规操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>正常打开窗口即可进行修改。 接下来就小步前进加入权限的功能。</p>
<h3 id="新增权限模块的store"><a href="#新增权限模块的store" class="headerlink" title="新增权限模块的store"></a>新增权限模块的store</h3><p>权限提供了一个用户所拥有的所有权限列表以及一个 <code>getters</code> 后面会用到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">// &#123; operatorCode: &#x27;ProductEndpoint#upload&#x27;, name: &#x27;产品上传&#x27; &#125;</span></span><br><span class="line">    operatorList: []</span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    hasPermission: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">queryOpcode</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!state.operatorList  !state.operatorList.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> state.operatorList.map(<span class="function"><span class="params">operatInfo</span> =&gt;</span> operatInfo.operatorCode).indexOf(queryOpcode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    setPermissionList (state, opList) &#123;</span><br><span class="line">      state.operatorList = opList</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我定义简单的后端返回值：一个 <code>operatorCode</code> 代表某个操作的代号，一个 <code>name</code> 用于分配权限的时候给用户查看。 <code>operatorCode</code> 有很多中生成方式，我这里采用 <code>SpringMVC</code> 的 <code>Controller</code> 名 + <code>#</code> + <code>方法名</code> 的形式， <code>Controller</code> 名用于分割不同资源的资源空间。使用 <code>Spring</code> 的生命周期函数，在项目启动的时候扫描，写入数据库，相当于所有的资源。后面的权限模型，以前该怎样就还是怎样，比如用户 —&gt; 角色 —&gt; 资源的模型。然后根据登陆的用户 <code>ID</code> 查询，返回给前端。至于中文名字，我们项目搭配 <code>Swagger</code> 使用，如果没有使用 <code>Swagger</code> 则需要使用自定义开发的注解指定。 注册到 <code>store</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&#x27;./module/user&#x27;</span></span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">&#x27;./module/app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;./module/permission&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    user,</span><br><span class="line">    app,</span><br><span class="line">    permission</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用户登陆时初始化拥有的资源操作"><a href="#用户登陆时初始化拥有的资源操作" class="headerlink" title="用户登陆时初始化拥有的资源操作"></a>用户登陆时初始化拥有的资源操作</h3><p>静态操作数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">String</span>(userName) === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登陆操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/login/login.vue</span></span><br><span class="line">...</span><br><span class="line">handleSubmit (&#123; userName, password &#125;) &#123;</span><br><span class="line">    <span class="built_in">this</span>.handleLogin(&#123; userName, password &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserInfo().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 用户登陆成功时候加入操作Code</span></span><br><span class="line">            <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">            <span class="built_in">this</span>.$router.push(&#123;</span><br><span class="line">                name: <span class="built_in">this</span>.$config.homeName</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入用户列表的信息，不然不能登录，因为作者默认只放了两个，当然生产项目肯定不管这里啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/login.js</span></span><br><span class="line"><span class="keyword">const</span> USER_MAP = &#123;</span><br><span class="line">  super_admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://file.iviewui.com/dist/a0e88e83800f138b94d2414621bd9704.png&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  zhangsan: &#123;</span><br><span class="line">    name: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  lisi: &#123;</span><br><span class="line">    name: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>加入权限数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开始加载菜单"><a href="#开始加载菜单" class="headerlink" title="开始加载菜单"></a>开始加载菜单</h3><p>刚开始我们先设立一个口进入，由于项目的 <code>menuList</code> 挂载在 <code>store</code> 的 <code>app.js</code> 里面，所以我们需要在这里动刀。 这里修改造成两个事情：1. 清掉项目原来的 <code>router</code> 的菜单，但是还可以访问（因为内存加载了）；2. 我加入了需要权限管理的菜单，但是还不能访问，因为路由还没有。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/store/module/app.js</span></span><br><span class="line">...</span><br><span class="line">getters: &#123;</span><br><span class="line">    menuList: <span class="function">(<span class="params">state, getters, rootState</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> allMenus = []</span><br><span class="line">      <span class="keyword">const</span> menuWithPermission = getMenuWithPermissionByRouter(routersWithPermission, rootState.permission.operatorList)</span><br><span class="line">      allMenus.push(...menuWithPermission)</span><br><span class="line">      <span class="keyword">return</span> allMenus</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>那么这里用到一个函数 <code>getMenuWithPermissionByRouter</code>，我决定放在 <code>util.js</code> 即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/libs/util.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK，运行项目。很好，没有出现错误，继续前行。 我的需求是这样的，当一个路由，在 <code>meta</code> 里面的 <code>requireCode</code> 用户拥有第一项操作权限的时候，是可以进入的，也就是菜单需要加载出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;/product&#x27;</span>,</span><br><span class="line">    name: <span class="string">&#x27;product&#x27;</span>,</span><br><span class="line">    component: Main,</span><br><span class="line">    meta: &#123;</span><br><span class="line">      hideInBread: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-list&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-list.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-add&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-form.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当这个页面需要同时满足两个要求的资源操作的时候，第一项使用数组装载。即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requireCode: [[<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>], <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>那么这个页面需要同时满足前面两个的时候，才能加载出来。 那么开始编写 <code>getMenuWithPermissionByRouter</code> 函数。呃，怎么说呢，先把 <code>Aresn</code> 的代码拷过来改改满足我上面的需求即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据需要控制菜单的路由，获取菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>routerWithPermissionList 需要权限管理的路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>userOperatorList 用户拥有的所有操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// debugger</span></span><br><span class="line">  <span class="keyword">let</span> res = []</span><br><span class="line">  <span class="keyword">const</span> allOpCodeArr = userOperatorList.map(<span class="function"><span class="params">opCodeObj</span> =&gt;</span> opCodeObj.operatorCode)</span><br><span class="line">  forEach(routerWithPermissionList, <span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!item.meta  (item.meta &amp;&amp; !item.meta.hideInMenu)) &#123;</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        icon: (item.meta &amp;&amp; item.meta.icon)  <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        name: item.name,</span><br><span class="line">        meta: item.meta</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((hasChild(item)  (item.meta &amp;&amp; item.meta.showAlways))) &#123;</span><br><span class="line">        obj.children = getMenuWithPermissionByRouter(item.children, userOperatorList)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasThisMenuPermission(item, allOpCodeArr)  hasChild(item)) res.push(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasThisMenuPermission = <span class="function">(<span class="params">routerInfo, allOpCodeArr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (routerInfo.meta &amp;&amp; routerInfo.meta.requireCode &amp;&amp; routerInfo.meta.requireCode.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> requireCode = routerInfo.meta.requireCode[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(requireCode)) &#123;</span><br><span class="line">      <span class="keyword">let</span> hasPermission = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; requireCode.length; i++) &#123;</span><br><span class="line">        hasPermission = hasPermission &amp;&amp; allOpCodeArr.indexOf(requireCode[i]) &gt; <span class="number">-1</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hasPermission</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> allOpCodeArr.indexOf(requireCode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OK，如图所示，已经把菜单加载出来了。但是现在出现一个问题，就是刷新页面的时候，什么都没了。因为刷新页面的时候，内存中的 <code>store</code> 被置空了。</p>
<h2 id="开篇啰嗦几句-1"><a href="#开篇啰嗦几句-1" class="headerlink" title="开篇啰嗦几句"></a>开篇啰嗦几句</h2><p>在传统单体项目中，通常会有一些框架用来管理熟知的权限。如耳濡目染的 <code>Shiro</code> 或者 <code>Spring Security</code> 。然而，到了现在这个时代，新开始的项目会更多的才用后端微服务 + 前端 <code>mvvm</code> 的架构开始书写项目。权限控制方面将变得有些许晦涩。当然，得益于 <code>Java</code> 后端的 <code>Spring</code> 项目的可插拔式接口以及前端大部分 <code>SPA</code> 的架构，权限控制也并没有变得那么的难以实现。相反，在我看来只要找到一个合适的插拔插件的入口，权限也可以做的很简单，跟业务只要少许的耦合即可实现我们熟悉的权限模块。 <a target="_blank" rel="noopener" href="https://github.com/WeidanLi/iview-admin-permission">示例代码 iview-admin-permission</a></p>
<h2 id="实现思路-1"><a href="#实现思路-1" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="路由方面-1"><a href="#路由方面-1" class="headerlink" title="路由方面"></a>路由方面</h3><p>后端提供当前登录用户可访问的所有可访问资源接口信息，前端项目根据当前用户所拥有的接口信息，判断是否拥有菜单权限，如果拥有主要访问权限则加入路由，让用户可以访问其当前的页面。 由于 <code>iview-admin</code> 中，路由信息与菜单是同一份资料，所以在加入路由的时候，即可实现菜单的隐藏与现实。</p>
<h3 id="按钮方面-1"><a href="#按钮方面-1" class="headerlink" title="按钮方面"></a>按钮方面</h3><p>按钮通过 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/custom-directive.html"><code>vue</code> 自定义指令</a>绑定其特定的操作接口信息（如：产品上传按钮，需要拥有产品上传的信息，才可以继续执行按钮的业务逻辑）。在按钮或者 <code>a</code> 标签被渲染的时候，判断是否拥有权限，如若没有，可以隐藏，或者劫持原来绑定的点击事件，使其变成无权限的弹窗提示。 该指令支持 <code>render</code> 生成的按钮或者 <code>a</code> 标签。</p>
<h3 id="数据表格方面-1"><a href="#数据表格方面-1" class="headerlink" title="数据表格方面"></a>数据表格方面</h3><p>数据的隐藏与否应该不会放在前端做吧…不然就是沙雕网友了。 这方面可以提供思路，在微服务架构中，如若前端项目拥有 <code>NodeJS</code> 做数据转换层，那是极好的。如果没有，则需要在微服务路由层做一些细微的改变。即用户无权限的数据列（属性）给他模糊掉，变成 <code>*</code> 或者 <code>—</code> 输出。这方面与前端无关，那么并不会在这里出现。</p>
<h3 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>后端不再关注页面上的事情，基于权限代码让前端自己随心所欲编排</li>
<li>灵活性较高，可以控制页面上所有的元素，可以隐藏弹窗等等喜欢的功能</li>
</ol>
<p>缺点：</p>
<ol>
<li>编排路由的时候会显得繁琐，权限代码比较零散，开发完业务页面可能会忘记加上</li>
</ol>
<h2 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h2><p>公司实现并不能成为开源，所以我重新下载一份 <code>iview-admin</code> ，然后加入关键代码，来实现上面所需要的功能。 常规操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>正常打开窗口即可进行修改。 接下来就小步前进加入权限的功能。</p>
<h3 id="新增权限模块的store-1"><a href="#新增权限模块的store-1" class="headerlink" title="新增权限模块的store"></a>新增权限模块的store</h3><p>权限提供了一个用户所拥有的所有权限列表以及一个 <code>getters</code> 后面会用到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">// &#123; operatorCode: &#x27;ProductEndpoint#upload&#x27;, name: &#x27;产品上传&#x27; &#125;</span></span><br><span class="line">    operatorList: []</span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    hasPermission: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">queryOpcode</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!state.operatorList  !state.operatorList.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> state.operatorList.map(<span class="function"><span class="params">operatInfo</span> =&gt;</span> operatInfo.operatorCode).indexOf(queryOpcode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    setPermissionList (state, opList) &#123;</span><br><span class="line">      state.operatorList = opList</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我定义简单的后端返回值：一个 <code>operatorCode</code> 代表某个操作的代号，一个 <code>name</code> 用于分配权限的时候给用户查看。 <code>operatorCode</code> 有很多中生成方式，我这里采用 <code>SpringMVC</code> 的 <code>Controller</code> 名 + <code>#</code> + <code>方法名</code> 的形式， <code>Controller</code> 名用于分割不同资源的资源空间。使用 <code>Spring</code> 的生命周期函数，在项目启动的时候扫描，写入数据库，相当于所有的资源。后面的权限模型，以前该怎样就还是怎样，比如用户 —&gt; 角色 —&gt; 资源的模型。然后根据登陆的用户 <code>ID</code> 查询，返回给前端。至于中文名字，我们项目搭配 <code>Swagger</code> 使用，如果没有使用 <code>Swagger</code> 则需要使用自定义开发的注解指定。 注册到 <code>store</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&#x27;./module/user&#x27;</span></span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">&#x27;./module/app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;./module/permission&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    user,</span><br><span class="line">    app,</span><br><span class="line">    permission</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用户登陆时初始化拥有的资源操作-1"><a href="#用户登陆时初始化拥有的资源操作-1" class="headerlink" title="用户登陆时初始化拥有的资源操作"></a>用户登陆时初始化拥有的资源操作</h3><p>静态操作数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">String</span>(userName) === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登陆操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/login/login.vue</span></span><br><span class="line">...</span><br><span class="line">handleSubmit (&#123; userName, password &#125;) &#123;</span><br><span class="line">    <span class="built_in">this</span>.handleLogin(&#123; userName, password &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserInfo().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 用户登陆成功时候加入操作Code</span></span><br><span class="line">            <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">            <span class="built_in">this</span>.$router.push(&#123;</span><br><span class="line">                name: <span class="built_in">this</span>.$config.homeName</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入用户列表的信息，不然不能登录，因为作者默认只放了两个，当然生产项目肯定不管这里啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/login.js</span></span><br><span class="line"><span class="keyword">const</span> USER_MAP = &#123;</span><br><span class="line">  super_admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://file.iviewui.com/dist/a0e88e83800f138b94d2414621bd9704.png&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  zhangsan: &#123;</span><br><span class="line">    name: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  lisi: &#123;</span><br><span class="line">    name: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>加入权限数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开始加载菜单-1"><a href="#开始加载菜单-1" class="headerlink" title="开始加载菜单"></a>开始加载菜单</h3><p>刚开始我们先设立一个口进入，由于项目的 <code>menuList</code> 挂载在 <code>store</code> 的 <code>app.js</code> 里面，所以我们需要在这里动刀。 这里修改造成两个事情：1. 清掉项目原来的 <code>router</code> 的菜单，但是还可以访问（因为内存加载了）；2. 我加入了需要权限管理的菜单，但是还不能访问，因为路由还没有。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/store/module/app.js</span></span><br><span class="line">...</span><br><span class="line">getters: &#123;</span><br><span class="line">    menuList: <span class="function">(<span class="params">state, getters, rootState</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> allMenus = []</span><br><span class="line">      <span class="keyword">const</span> menuWithPermission = getMenuWithPermissionByRouter(routersWithPermission, rootState.permission.operatorList)</span><br><span class="line">      allMenus.push(...menuWithPermission)</span><br><span class="line">      <span class="keyword">return</span> allMenus</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>那么这里用到一个函数 <code>getMenuWithPermissionByRouter</code>，我决定放在 <code>util.js</code> 即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/libs/util.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK，运行项目。很好，没有出现错误，继续前行。 我的需求是这样的，当一个路由，在 <code>meta</code> 里面的 <code>requireCode</code> 用户拥有第一项操作权限的时候，是可以进入的，也就是菜单需要加载出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;/product&#x27;</span>,</span><br><span class="line">    name: <span class="string">&#x27;product&#x27;</span>,</span><br><span class="line">    component: Main,</span><br><span class="line">    meta: &#123;</span><br><span class="line">      hideInBread: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-list&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-list.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-add&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-form.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当这个页面需要同时满足两个要求的资源操作的时候，第一项使用数组装载。即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requireCode: [[<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>], <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>那么这个页面需要同时满足前面两个的时候，才能加载出来。 那么开始编写 <code>getMenuWithPermissionByRouter</code> 函数。呃，怎么说呢，先把 <code>Aresn</code> 的代码拷过来改改满足我上面的需求即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据需要控制菜单的路由，获取菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>routerWithPermissionList 需要权限管理的路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>userOperatorList 用户拥有的所有操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// debugger</span></span><br><span class="line">  <span class="keyword">let</span> res = []</span><br><span class="line">  <span class="keyword">const</span> allOpCodeArr = userOperatorList.map(<span class="function"><span class="params">opCodeObj</span> =&gt;</span> opCodeObj.operatorCode)</span><br><span class="line">  forEach(routerWithPermissionList, <span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!item.meta  (item.meta &amp;&amp; !item.meta.hideInMenu)) &#123;</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        icon: (item.meta &amp;&amp; item.meta.icon)  <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        name: item.name,</span><br><span class="line">        meta: item.meta</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((hasChild(item)  (item.meta &amp;&amp; item.meta.showAlways))) &#123;</span><br><span class="line">        obj.children = getMenuWithPermissionByRouter(item.children, userOperatorList)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasThisMenuPermission(item, allOpCodeArr)  hasChild(item)) res.push(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasThisMenuPermission = <span class="function">(<span class="params">routerInfo, allOpCodeArr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (routerInfo.meta &amp;&amp; routerInfo.meta.requireCode &amp;&amp; routerInfo.meta.requireCode.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> requireCode = routerInfo.meta.requireCode[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(requireCode)) &#123;</span><br><span class="line">      <span class="keyword">let</span> hasPermission = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; requireCode.length; i++) &#123;</span><br><span class="line">        hasPermission = hasPermission &amp;&amp; allOpCodeArr.indexOf(requireCode[i]) &gt; <span class="number">-1</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hasPermission</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> allOpCodeArr.indexOf(requireCode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OK，如图所示，已经把菜单加载出来了。但是现在出现一个问题，就是刷新页面的时候，什么都没了。因为刷新页面的时候，内存中的 <code>store</code> 被置空了。</p>
<p> <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150329.png"></p>
<h3 id="页面加载的时候自动加载操作"><a href="#页面加载的时候自动加载操作" class="headerlink" title="页面加载的时候自动加载操作"></a>页面加载的时候自动加载操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">...</span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可喜可贺，刷新的时候，菜单已经出来了。但是有个报错，报 <code>sideMenu</code> 的 <code>undefined</code> 异常。是由于刚开始刷新页面的时候，菜单还没有出来，而代码写死了读第0个元素，菜单是空数组，所以理所当然导致了异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;components&#x2F;main&#x2F;components&#x2F;side-menu&#x2F;side-menu.vue 第 20 行，去掉最后属性的或者即可</span><br><span class="line">&lt;a @click&#x3D;&quot;handleSelect(getNameOrHref(item, true))&quot; class&#x3D;&quot;drop-menu-a&quot; :style&#x3D;&quot;&#123;textAlign: &#39;center&#39;&#125;&quot;&gt;&lt;common-icon :size&#x3D;&quot;rootIconSize&quot; :color&#x3D;&quot;textColor&quot; :type&#x3D;&quot;item.icon&quot;&#x2F;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>OK，我感觉最难的菜单搞定了。接下来要搞定路由。</p>
<h3 id="动态新增有权限的路由"><a href="#动态新增有权限的路由" class="headerlink" title="动态新增有权限的路由"></a>动态新增有权限的路由</h3><p>有了前面的铺垫，我感觉路由要好做很多了。 动态路由有一个调用的函数是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.addRoutes(routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;)</span><br></pre></td></tr></table></figure>

<p>那么我们需要做的只是，获取有权限的路由，然后加入到 <code>Vue</code> 中。 但是这段代码有点问题就是每次进入都会调用一次= =</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">    <span class="keyword">const</span> routers = getRouterWithPermission(routersWithPermission, <span class="built_in">this</span>.$store.state.permission.operatorList)</span><br><span class="line">    <span class="keyword">const</span> originRouteNames = <span class="built_in">this</span>.$router.options.routes.map(<span class="function"><span class="params">r</span> =&gt;</span> r.name)</span><br><span class="line">    <span class="comment">// 需要解决重复加入问题</span></span><br><span class="line">    <span class="keyword">if</span> (routers &amp;&amp; routers.length &amp;&amp; originRouteNames.indexOf(routers[<span class="number">0</span>].name) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$router.addRoutes(routers)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，菜单有了，路由有了，点击测试能否进入。 然后被作者的路由拦截到了-,-</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">const</span> turnTo = <span class="function">(<span class="params">to, access, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next() <span class="comment">// 直接过。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试路由和菜单"><a href="#测试路由和菜单" class="headerlink" title="测试路由和菜单"></a>测试路由和菜单</h3><p>分别登陆 <code>zhangsan</code> 和 <code>lisi</code> 从上面的测试权限数据可以看到，<code>lisi</code> 是进入不了产品列表的。</p>
<h4 id="登陆lisi"><a href="#登陆lisi" class="headerlink" title="登陆lisi"></a>登陆lisi</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150340.png"></p>
<p> 强行进入： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150401.png"> </p>
<p>OK，正确了，如果没有权限，肯定就没有页面嘛，直接404.</p>
<h4 id="登陆zhangsan"><a href="#登陆zhangsan" class="headerlink" title="登陆zhangsan"></a>登陆zhangsan</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150424.png"></p>
<h3 id="按钮的控制"><a href="#按钮的控制" class="headerlink" title="按钮的控制"></a>按钮的控制</h3><p>页面的跳转搞定了，接下来就要考虑按钮的问题了。那么上面设置的 <code>Vuex</code> 的 <code>hasPermission</code> 在这里派上用场。关于按钮的绑定，思路来源于 <code>Vue</code> 的自定义指令，只需要在主页面注册自定义指令，每次页面加载的时候，加载到指定指令的组件，开始读取这个组件的 <code>operaCode</code> 是否在当前登陆的用户中，如果存在，则继续执行，如果不存在，则拿到了节点的 <code>Vnode</code> 开始设置我们想要的东西，比如锁定按钮啊，劫持点击事件弹出提示，或者隐藏都可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册权限控制指令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Vue.directive(<span class="string">&#x27;opcode&#x27;</span>, &#123;</span><br><span class="line">  bind: <span class="function"><span class="keyword">function</span> (<span class="params">el, opcode, vnode, oldVNode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> requireOpCode = opcode.value</span><br><span class="line">    <span class="comment">// 如果用户没有这个操作Code的权限，那么劫持click事件，赋予弹出无权限弹窗的事件</span></span><br><span class="line">    <span class="built_in">console</span>.log(requireOpCode);</span><br><span class="line">    <span class="keyword">if</span> (vnode.componentInstance === <span class="literal">undefined</span>  vnode.componentInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.context.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.data.on.click.fns = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.componentInstance.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.componentInstance.$off(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        vnode.componentInstance.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>常规按钮使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src&#x2F;view&#x2F;product&#x2F;components&#x2F;toolbars.vue --&gt;</span><br><span class="line">&lt;Button v-opcode&#x3D;&quot;&#39;ProductManageEndpoint#createProduct&#39;&quot; type&#x3D;&quot;primary&quot; class&#x3D;&quot;btn&quot; icon&#x3D;&quot;ios-arrow-up&quot; @click&#x3D;&quot;$router.push(&#39;&#x2F;product&#x2F;add&#39;)&quot;&gt;上传新商品&lt;&#x2F;Button&gt;</span><br></pre></td></tr></table></figure>

<p><code>Render</code> 函数中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/product/product-list.vue</span></span><br><span class="line">prodColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;pname&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          width: <span class="number">300</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;operator&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          render: <span class="function">(<span class="params">h, params</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">              attrs: &#123;</span><br><span class="line">                href: <span class="string">&#x27;javascript:;&#x27;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              on: &#123;</span><br><span class="line">                click: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  <span class="built_in">this</span>.handleEditProduct(params.row)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="comment">// 在这里注册自定义指令</span></span><br><span class="line">              directives: [</span><br><span class="line">                &#123;</span><br><span class="line">                  name: <span class="string">&#x27;opcode&#x27;</span>,</span><br><span class="line">                  value: <span class="string">&#x27;ProductManageEndpoint#updateByUuid&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;, <span class="string">&#x27;编辑&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>这种方式即使分页，改变表格数据，也可以被主页面上的判断监听到。 PS：在这里就可以看到了按钮的编排的问题，即我们新增产品的页面接口，是在填写完 <code>Form</code> 表单的时候才开始请求的，但是我们需要在两个地方做设置，一个是跳转页面（路由+菜单），一个是新增产品的按钮，即需要把这个权限拦截提前到进入页面之前。这方面现在确实想不到更好的解决办法了。</p>
<h3 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h3><p>回顾一下权限设置数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，用户名为 <code>zhangsan</code> 是没有删除产品权限以及编辑产品的，但是前面的都有。而 <code>lisi</code> 用户，没有产品列表功能，所以列表都不可以进去。 <code>zhangsan</code> 用户界面： </p>
<p><img src="./zhangsan.gif"></p>
<p> <code>lisi</code> 用户界面： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150941.png"></p>
<h3 id="权限编排页面建议"><a href="#权限编排页面建议" class="headerlink" title="权限编排页面建议"></a>权限编排页面建议</h3><p>我们知道，经典权限模型是用户、角色、资源的编排。那么我们可以设置一系列的角色，当然记得给自己预留一个流氓角色可以读取所有资源和角色的，利于管理。每个角色可以绑定不同的资源，也可以绑定不同的用户。这样用户一旦登陆，即可读取所有角色中的所有资源操作（记得去重）。 我们公司的绑定界面，通过读取用户所拥有的所有资源，再把 <code>router</code> 中绑定的读取出来（当然过滤掉当前绑定用户无权限的），然后通过加载勾选，最后发送请求给服务器做修改。这样设置可以无限极下限，只要赋予用户授权的权限，用户即可一直创建然后绑定他想绑定的。 <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150951.png"></p>
<h2 id="权限模块建议"><a href="#权限模块建议" class="headerlink" title="权限模块建议"></a>权限模块建议</h2><p>当前所做的都是前端需要做的工作，后端也需要配合完成接口的调用，即使前端做了设置，但是有些用户可以绕过前端，这时候所有的权限操作就需要后端来拦截了。 </p>
<h3 id="页面加载的时候自动加载操作-1"><a href="#页面加载的时候自动加载操作-1" class="headerlink" title="页面加载的时候自动加载操作"></a>页面加载的时候自动加载操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">...</span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可喜可贺，刷新的时候，菜单已经出来了。但是有个报错，报 <code>sideMenu</code> 的 <code>undefined</code> 异常。是由于刚开始刷新页面的时候，菜单还没有出来，而代码写死了读第0个元素，菜单是空数组，所以理所当然导致了异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;components&#x2F;main&#x2F;components&#x2F;side-menu&#x2F;side-menu.vue 第 20 行，去掉最后属性的或者即可</span><br><span class="line">&lt;a @click&#x3D;&quot;handleSelect(getNameOrHref(item, true))&quot; class&#x3D;&quot;drop-menu-a&quot; :style&#x3D;&quot;&#123;textAlign: &#39;center&#39;&#125;&quot;&gt;&lt;common-icon :size&#x3D;&quot;rootIconSize&quot; :color&#x3D;&quot;textColor&quot; :type&#x3D;&quot;item.icon&quot;&#x2F;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>OK，我感觉最难的菜单搞定了。接下来要搞定路由。</p>
<h3 id="动态新增有权限的路由-1"><a href="#动态新增有权限的路由-1" class="headerlink" title="动态新增有权限的路由"></a>动态新增有权限的路由</h3><p>有了前面的铺垫，我感觉路由要好做很多了。 动态路由有一个调用的函数是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.addRoutes(routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;)</span><br></pre></td></tr></table></figure>

<p>那么我们需要做的只是，获取有权限的路由，然后加入到 <code>Vue</code> 中。 但是这段代码有点问题就是每次进入都会调用一次= =</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">    <span class="keyword">const</span> routers = getRouterWithPermission(routersWithPermission, <span class="built_in">this</span>.$store.state.permission.operatorList)</span><br><span class="line">    <span class="keyword">const</span> originRouteNames = <span class="built_in">this</span>.$router.options.routes.map(<span class="function"><span class="params">r</span> =&gt;</span> r.name)</span><br><span class="line">    <span class="comment">// 需要解决重复加入问题</span></span><br><span class="line">    <span class="keyword">if</span> (routers &amp;&amp; routers.length &amp;&amp; originRouteNames.indexOf(routers[<span class="number">0</span>].name) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$router.addRoutes(routers)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，菜单有了，路由有了，点击测试能否进入。 然后被作者的路由拦截到了-,-</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">const</span> turnTo = <span class="function">(<span class="params">to, access, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next() <span class="comment">// 直接过。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试路由和菜单-1"><a href="#测试路由和菜单-1" class="headerlink" title="测试路由和菜单"></a>测试路由和菜单</h3><p>分别登陆 <code>zhangsan</code> 和 <code>lisi</code> 从上面的测试权限数据可以看到，<code>lisi</code> 是进入不了产品列表的。</p>
<h4 id="登陆lisi-1"><a href="#登陆lisi-1" class="headerlink" title="登陆lisi"></a>登陆lisi</h4><h2 id="开篇啰嗦几句-2"><a href="#开篇啰嗦几句-2" class="headerlink" title="开篇啰嗦几句"></a>开篇啰嗦几句</h2><p>在传统单体项目中，通常会有一些框架用来管理熟知的权限。如耳濡目染的 <code>Shiro</code> 或者 <code>Spring Security</code> 。然而，到了现在这个时代，新开始的项目会更多的才用后端微服务 + 前端 <code>mvvm</code> 的架构开始书写项目。权限控制方面将变得有些许晦涩。当然，得益于 <code>Java</code> 后端的 <code>Spring</code> 项目的可插拔式接口以及前端大部分 <code>SPA</code> 的架构，权限控制也并没有变得那么的难以实现。相反，在我看来只要找到一个合适的插拔插件的入口，权限也可以做的很简单，跟业务只要少许的耦合即可实现我们熟悉的权限模块。 <a target="_blank" rel="noopener" href="https://github.com/WeidanLi/iview-admin-permission">示例代码 iview-admin-permission</a></p>
<h2 id="实现思路-2"><a href="#实现思路-2" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="路由方面-2"><a href="#路由方面-2" class="headerlink" title="路由方面"></a>路由方面</h3><p>后端提供当前登录用户可访问的所有可访问资源接口信息，前端项目根据当前用户所拥有的接口信息，判断是否拥有菜单权限，如果拥有主要访问权限则加入路由，让用户可以访问其当前的页面。 由于 <code>iview-admin</code> 中，路由信息与菜单是同一份资料，所以在加入路由的时候，即可实现菜单的隐藏与现实。</p>
<h3 id="按钮方面-2"><a href="#按钮方面-2" class="headerlink" title="按钮方面"></a>按钮方面</h3><p>按钮通过 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/custom-directive.html"><code>vue</code> 自定义指令</a>绑定其特定的操作接口信息（如：产品上传按钮，需要拥有产品上传的信息，才可以继续执行按钮的业务逻辑）。在按钮或者 <code>a</code> 标签被渲染的时候，判断是否拥有权限，如若没有，可以隐藏，或者劫持原来绑定的点击事件，使其变成无权限的弹窗提示。 该指令支持 <code>render</code> 生成的按钮或者 <code>a</code> 标签。</p>
<h3 id="数据表格方面-2"><a href="#数据表格方面-2" class="headerlink" title="数据表格方面"></a>数据表格方面</h3><p>数据的隐藏与否应该不会放在前端做吧…不然就是沙雕网友了。 这方面可以提供思路，在微服务架构中，如若前端项目拥有 <code>NodeJS</code> 做数据转换层，那是极好的。如果没有，则需要在微服务路由层做一些细微的改变。即用户无权限的数据列（属性）给他模糊掉，变成 <code>*</code> 或者 <code>—</code> 输出。这方面与前端无关，那么并不会在这里出现。</p>
<h3 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>后端不再关注页面上的事情，基于权限代码让前端自己随心所欲编排</li>
<li>灵活性较高，可以控制页面上所有的元素，可以隐藏弹窗等等喜欢的功能</li>
</ol>
<p>缺点：</p>
<ol>
<li>编排路由的时候会显得繁琐，权限代码比较零散，开发完业务页面可能会忘记加上</li>
</ol>
<h2 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h2><p>公司实现并不能成为开源，所以我重新下载一份 <code>iview-admin</code> ，然后加入关键代码，来实现上面所需要的功能。 常规操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>正常打开窗口即可进行修改。 接下来就小步前进加入权限的功能。</p>
<h3 id="新增权限模块的store-2"><a href="#新增权限模块的store-2" class="headerlink" title="新增权限模块的store"></a>新增权限模块的store</h3><p>权限提供了一个用户所拥有的所有权限列表以及一个 <code>getters</code> 后面会用到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">// &#123; operatorCode: &#x27;ProductEndpoint#upload&#x27;, name: &#x27;产品上传&#x27; &#125;</span></span><br><span class="line">    operatorList: []</span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    hasPermission: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">queryOpcode</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!state.operatorList  !state.operatorList.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> state.operatorList.map(<span class="function"><span class="params">operatInfo</span> =&gt;</span> operatInfo.operatorCode).indexOf(queryOpcode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    setPermissionList (state, opList) &#123;</span><br><span class="line">      state.operatorList = opList</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我定义简单的后端返回值：一个 <code>operatorCode</code> 代表某个操作的代号，一个 <code>name</code> 用于分配权限的时候给用户查看。 <code>operatorCode</code> 有很多中生成方式，我这里采用 <code>SpringMVC</code> 的 <code>Controller</code> 名 + <code>#</code> + <code>方法名</code> 的形式， <code>Controller</code> 名用于分割不同资源的资源空间。使用 <code>Spring</code> 的生命周期函数，在项目启动的时候扫描，写入数据库，相当于所有的资源。后面的权限模型，以前该怎样就还是怎样，比如用户 —&gt; 角色 —&gt; 资源的模型。然后根据登陆的用户 <code>ID</code> 查询，返回给前端。至于中文名字，我们项目搭配 <code>Swagger</code> 使用，如果没有使用 <code>Swagger</code> 则需要使用自定义开发的注解指定。 注册到 <code>store</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&#x27;./module/user&#x27;</span></span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">&#x27;./module/app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;./module/permission&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    user,</span><br><span class="line">    app,</span><br><span class="line">    permission</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用户登陆时初始化拥有的资源操作-2"><a href="#用户登陆时初始化拥有的资源操作-2" class="headerlink" title="用户登陆时初始化拥有的资源操作"></a>用户登陆时初始化拥有的资源操作</h3><p>静态操作数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">String</span>(userName) === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登陆操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/login/login.vue</span></span><br><span class="line">...</span><br><span class="line">handleSubmit (&#123; userName, password &#125;) &#123;</span><br><span class="line">    <span class="built_in">this</span>.handleLogin(&#123; userName, password &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserInfo().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 用户登陆成功时候加入操作Code</span></span><br><span class="line">            <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">            <span class="built_in">this</span>.$router.push(&#123;</span><br><span class="line">                name: <span class="built_in">this</span>.$config.homeName</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入用户列表的信息，不然不能登录，因为作者默认只放了两个，当然生产项目肯定不管这里啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/login.js</span></span><br><span class="line"><span class="keyword">const</span> USER_MAP = &#123;</span><br><span class="line">  super_admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://file.iviewui.com/dist/a0e88e83800f138b94d2414621bd9704.png&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  zhangsan: &#123;</span><br><span class="line">    name: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  lisi: &#123;</span><br><span class="line">    name: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>加入权限数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开始加载菜单-2"><a href="#开始加载菜单-2" class="headerlink" title="开始加载菜单"></a>开始加载菜单</h3><p>刚开始我们先设立一个口进入，由于项目的 <code>menuList</code> 挂载在 <code>store</code> 的 <code>app.js</code> 里面，所以我们需要在这里动刀。 这里修改造成两个事情：1. 清掉项目原来的 <code>router</code> 的菜单，但是还可以访问（因为内存加载了）；2. 我加入了需要权限管理的菜单，但是还不能访问，因为路由还没有。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/store/module/app.js</span></span><br><span class="line">...</span><br><span class="line">getters: &#123;</span><br><span class="line">    menuList: <span class="function">(<span class="params">state, getters, rootState</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> allMenus = []</span><br><span class="line">      <span class="keyword">const</span> menuWithPermission = getMenuWithPermissionByRouter(routersWithPermission, rootState.permission.operatorList)</span><br><span class="line">      allMenus.push(...menuWithPermission)</span><br><span class="line">      <span class="keyword">return</span> allMenus</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>那么这里用到一个函数 <code>getMenuWithPermissionByRouter</code>，我决定放在 <code>util.js</code> 即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/libs/util.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK，运行项目。很好，没有出现错误，继续前行。 我的需求是这样的，当一个路由，在 <code>meta</code> 里面的 <code>requireCode</code> 用户拥有第一项操作权限的时候，是可以进入的，也就是菜单需要加载出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;/product&#x27;</span>,</span><br><span class="line">    name: <span class="string">&#x27;product&#x27;</span>,</span><br><span class="line">    component: Main,</span><br><span class="line">    meta: &#123;</span><br><span class="line">      hideInBread: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-list&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-list.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-add&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-form.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当这个页面需要同时满足两个要求的资源操作的时候，第一项使用数组装载。即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requireCode: [[<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>], <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>那么这个页面需要同时满足前面两个的时候，才能加载出来。 那么开始编写 <code>getMenuWithPermissionByRouter</code> 函数。呃，怎么说呢，先把 <code>Aresn</code> 的代码拷过来改改满足我上面的需求即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据需要控制菜单的路由，获取菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>routerWithPermissionList 需要权限管理的路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>userOperatorList 用户拥有的所有操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// debugger</span></span><br><span class="line">  <span class="keyword">let</span> res = []</span><br><span class="line">  <span class="keyword">const</span> allOpCodeArr = userOperatorList.map(<span class="function"><span class="params">opCodeObj</span> =&gt;</span> opCodeObj.operatorCode)</span><br><span class="line">  forEach(routerWithPermissionList, <span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!item.meta  (item.meta &amp;&amp; !item.meta.hideInMenu)) &#123;</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        icon: (item.meta &amp;&amp; item.meta.icon)  <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        name: item.name,</span><br><span class="line">        meta: item.meta</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((hasChild(item)  (item.meta &amp;&amp; item.meta.showAlways))) &#123;</span><br><span class="line">        obj.children = getMenuWithPermissionByRouter(item.children, userOperatorList)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasThisMenuPermission(item, allOpCodeArr)  hasChild(item)) res.push(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasThisMenuPermission = <span class="function">(<span class="params">routerInfo, allOpCodeArr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (routerInfo.meta &amp;&amp; routerInfo.meta.requireCode &amp;&amp; routerInfo.meta.requireCode.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> requireCode = routerInfo.meta.requireCode[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(requireCode)) &#123;</span><br><span class="line">      <span class="keyword">let</span> hasPermission = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; requireCode.length; i++) &#123;</span><br><span class="line">        hasPermission = hasPermission &amp;&amp; allOpCodeArr.indexOf(requireCode[i]) &gt; <span class="number">-1</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hasPermission</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> allOpCodeArr.indexOf(requireCode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OK，如图所示，已经把菜单加载出来了。但是现在出现一个问题，就是刷新页面的时候，什么都没了。因为刷新页面的时候，内存中的 <code>store</code> 被置空了。</p>
<p> <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150329.png"></p>
<h3 id="页面加载的时候自动加载操作-2"><a href="#页面加载的时候自动加载操作-2" class="headerlink" title="页面加载的时候自动加载操作"></a>页面加载的时候自动加载操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">...</span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可喜可贺，刷新的时候，菜单已经出来了。但是有个报错，报 <code>sideMenu</code> 的 <code>undefined</code> 异常。是由于刚开始刷新页面的时候，菜单还没有出来，而代码写死了读第0个元素，菜单是空数组，所以理所当然导致了异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;components&#x2F;main&#x2F;components&#x2F;side-menu&#x2F;side-menu.vue 第 20 行，去掉最后属性的或者即可</span><br><span class="line">&lt;a @click&#x3D;&quot;handleSelect(getNameOrHref(item, true))&quot; class&#x3D;&quot;drop-menu-a&quot; :style&#x3D;&quot;&#123;textAlign: &#39;center&#39;&#125;&quot;&gt;&lt;common-icon :size&#x3D;&quot;rootIconSize&quot; :color&#x3D;&quot;textColor&quot; :type&#x3D;&quot;item.icon&quot;&#x2F;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>OK，我感觉最难的菜单搞定了。接下来要搞定路由。</p>
<h3 id="动态新增有权限的路由-2"><a href="#动态新增有权限的路由-2" class="headerlink" title="动态新增有权限的路由"></a>动态新增有权限的路由</h3><p>有了前面的铺垫，我感觉路由要好做很多了。 动态路由有一个调用的函数是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.addRoutes(routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;)</span><br></pre></td></tr></table></figure>

<p>那么我们需要做的只是，获取有权限的路由，然后加入到 <code>Vue</code> 中。 但是这段代码有点问题就是每次进入都会调用一次= =</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">    <span class="keyword">const</span> routers = getRouterWithPermission(routersWithPermission, <span class="built_in">this</span>.$store.state.permission.operatorList)</span><br><span class="line">    <span class="keyword">const</span> originRouteNames = <span class="built_in">this</span>.$router.options.routes.map(<span class="function"><span class="params">r</span> =&gt;</span> r.name)</span><br><span class="line">    <span class="comment">// 需要解决重复加入问题</span></span><br><span class="line">    <span class="keyword">if</span> (routers &amp;&amp; routers.length &amp;&amp; originRouteNames.indexOf(routers[<span class="number">0</span>].name) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$router.addRoutes(routers)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，菜单有了，路由有了，点击测试能否进入。 然后被作者的路由拦截到了-,-</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">const</span> turnTo = <span class="function">(<span class="params">to, access, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next() <span class="comment">// 直接过。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试路由和菜单-2"><a href="#测试路由和菜单-2" class="headerlink" title="测试路由和菜单"></a>测试路由和菜单</h3><p>分别登陆 <code>zhangsan</code> 和 <code>lisi</code> 从上面的测试权限数据可以看到，<code>lisi</code> 是进入不了产品列表的。</p>
<h4 id="登陆lisi-2"><a href="#登陆lisi-2" class="headerlink" title="登陆lisi"></a>登陆lisi</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150340.png"></p>
<p> 强行进入： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150401.png"> </p>
<p>OK，正确了，如果没有权限，肯定就没有页面嘛，直接404.</p>
<h4 id="登陆zhangsan-1"><a href="#登陆zhangsan-1" class="headerlink" title="登陆zhangsan"></a>登陆zhangsan</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150424.png"></p>
<h3 id="按钮的控制-1"><a href="#按钮的控制-1" class="headerlink" title="按钮的控制"></a>按钮的控制</h3><p>页面的跳转搞定了，接下来就要考虑按钮的问题了。那么上面设置的 <code>Vuex</code> 的 <code>hasPermission</code> 在这里派上用场。关于按钮的绑定，思路来源于 <code>Vue</code> 的自定义指令，只需要在主页面注册自定义指令，每次页面加载的时候，加载到指定指令的组件，开始读取这个组件的 <code>operaCode</code> 是否在当前登陆的用户中，如果存在，则继续执行，如果不存在，则拿到了节点的 <code>Vnode</code> 开始设置我们想要的东西，比如锁定按钮啊，劫持点击事件弹出提示，或者隐藏都可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册权限控制指令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Vue.directive(<span class="string">&#x27;opcode&#x27;</span>, &#123;</span><br><span class="line">  bind: <span class="function"><span class="keyword">function</span> (<span class="params">el, opcode, vnode, oldVNode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> requireOpCode = opcode.value</span><br><span class="line">    <span class="comment">// 如果用户没有这个操作Code的权限，那么劫持click事件，赋予弹出无权限弹窗的事件</span></span><br><span class="line">    <span class="built_in">console</span>.log(requireOpCode);</span><br><span class="line">    <span class="keyword">if</span> (vnode.componentInstance === <span class="literal">undefined</span>  vnode.componentInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.context.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.data.on.click.fns = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.componentInstance.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.componentInstance.$off(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        vnode.componentInstance.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>常规按钮使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src&#x2F;view&#x2F;product&#x2F;components&#x2F;toolbars.vue --&gt;</span><br><span class="line">&lt;Button v-opcode&#x3D;&quot;&#39;ProductManageEndpoint#createProduct&#39;&quot; type&#x3D;&quot;primary&quot; class&#x3D;&quot;btn&quot; icon&#x3D;&quot;ios-arrow-up&quot; @click&#x3D;&quot;$router.push(&#39;&#x2F;product&#x2F;add&#39;)&quot;&gt;上传新商品&lt;&#x2F;Button&gt;</span><br></pre></td></tr></table></figure>

<p><code>Render</code> 函数中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/product/product-list.vue</span></span><br><span class="line">prodColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;pname&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          width: <span class="number">300</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;operator&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          render: <span class="function">(<span class="params">h, params</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">              attrs: &#123;</span><br><span class="line">                href: <span class="string">&#x27;javascript:;&#x27;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              on: &#123;</span><br><span class="line">                click: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  <span class="built_in">this</span>.handleEditProduct(params.row)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="comment">// 在这里注册自定义指令</span></span><br><span class="line">              directives: [</span><br><span class="line">                &#123;</span><br><span class="line">                  name: <span class="string">&#x27;opcode&#x27;</span>,</span><br><span class="line">                  value: <span class="string">&#x27;ProductManageEndpoint#updateByUuid&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;, <span class="string">&#x27;编辑&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>这种方式即使分页，改变表格数据，也可以被主页面上的判断监听到。 PS：在这里就可以看到了按钮的编排的问题，即我们新增产品的页面接口，是在填写完 <code>Form</code> 表单的时候才开始请求的，但是我们需要在两个地方做设置，一个是跳转页面（路由+菜单），一个是新增产品的按钮，即需要把这个权限拦截提前到进入页面之前。这方面现在确实想不到更好的解决办法了。</p>
<h3 id="演示-1"><a href="#演示-1" class="headerlink" title="演示"></a>演示</h3><p>回顾一下权限设置数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，用户名为 <code>zhangsan</code> 是没有删除产品权限以及编辑产品的，但是前面的都有。而 <code>lisi</code> 用户，没有产品列表功能，所以列表都不可以进去。 <code>zhangsan</code> 用户界面： </p>
<p><img src="./zhangsan.gif"></p>
<p> <code>lisi</code> 用户界面： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150941.png"></p>
<h3 id="权限编排页面建议-1"><a href="#权限编排页面建议-1" class="headerlink" title="权限编排页面建议"></a>权限编排页面建议</h3><p>我们知道，经典权限模型是用户、角色、资源的编排。那么我们可以设置一系列的角色，当然记得给自己预留一个流氓角色可以读取所有资源和角色的，利于管理。每个角色可以绑定不同的资源，也可以绑定不同的用户。这样用户一旦登陆，即可读取所有角色中的所有资源操作（记得去重）。 我们公司的绑定界面，通过读取用户所拥有的所有资源，再把 <code>router</code> 中绑定的读取出来（当然过滤掉当前绑定用户无权限的），然后通过加载勾选，最后发送请求给服务器做修改。这样设置可以无限极下限，只要赋予用户授权的权限，用户即可一直创建然后绑定他想绑定的。 <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150951.png"></p>
<h2 id="权限模块建议-1"><a href="#权限模块建议-1" class="headerlink" title="权限模块建议"></a>权限模块建议</h2><p>当前所做的都是前端需要做的工作，后端也需要配合完成接口的调用，即使前端做了设置，但是有些用户可以绕过前端，这时候所有的权限操作就需要后端来拦截了。 </p>
<p> 强行进入： </p>
<h2 id="开篇啰嗦几句-3"><a href="#开篇啰嗦几句-3" class="headerlink" title="开篇啰嗦几句"></a>开篇啰嗦几句</h2><p>在传统单体项目中，通常会有一些框架用来管理熟知的权限。如耳濡目染的 <code>Shiro</code> 或者 <code>Spring Security</code> 。然而，到了现在这个时代，新开始的项目会更多的才用后端微服务 + 前端 <code>mvvm</code> 的架构开始书写项目。权限控制方面将变得有些许晦涩。当然，得益于 <code>Java</code> 后端的 <code>Spring</code> 项目的可插拔式接口以及前端大部分 <code>SPA</code> 的架构，权限控制也并没有变得那么的难以实现。相反，在我看来只要找到一个合适的插拔插件的入口，权限也可以做的很简单，跟业务只要少许的耦合即可实现我们熟悉的权限模块。 <a target="_blank" rel="noopener" href="https://github.com/WeidanLi/iview-admin-permission">示例代码 iview-admin-permission</a></p>
<h2 id="实现思路-3"><a href="#实现思路-3" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="路由方面-3"><a href="#路由方面-3" class="headerlink" title="路由方面"></a>路由方面</h3><p>后端提供当前登录用户可访问的所有可访问资源接口信息，前端项目根据当前用户所拥有的接口信息，判断是否拥有菜单权限，如果拥有主要访问权限则加入路由，让用户可以访问其当前的页面。 由于 <code>iview-admin</code> 中，路由信息与菜单是同一份资料，所以在加入路由的时候，即可实现菜单的隐藏与现实。</p>
<h3 id="按钮方面-3"><a href="#按钮方面-3" class="headerlink" title="按钮方面"></a>按钮方面</h3><p>按钮通过 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/custom-directive.html"><code>vue</code> 自定义指令</a>绑定其特定的操作接口信息（如：产品上传按钮，需要拥有产品上传的信息，才可以继续执行按钮的业务逻辑）。在按钮或者 <code>a</code> 标签被渲染的时候，判断是否拥有权限，如若没有，可以隐藏，或者劫持原来绑定的点击事件，使其变成无权限的弹窗提示。 该指令支持 <code>render</code> 生成的按钮或者 <code>a</code> 标签。</p>
<h3 id="数据表格方面-3"><a href="#数据表格方面-3" class="headerlink" title="数据表格方面"></a>数据表格方面</h3><p>数据的隐藏与否应该不会放在前端做吧…不然就是沙雕网友了。 这方面可以提供思路，在微服务架构中，如若前端项目拥有 <code>NodeJS</code> 做数据转换层，那是极好的。如果没有，则需要在微服务路由层做一些细微的改变。即用户无权限的数据列（属性）给他模糊掉，变成 <code>*</code> 或者 <code>—</code> 输出。这方面与前端无关，那么并不会在这里出现。</p>
<h3 id="优缺点-3"><a href="#优缺点-3" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>后端不再关注页面上的事情，基于权限代码让前端自己随心所欲编排</li>
<li>灵活性较高，可以控制页面上所有的元素，可以隐藏弹窗等等喜欢的功能</li>
</ol>
<p>缺点：</p>
<ol>
<li>编排路由的时候会显得繁琐，权限代码比较零散，开发完业务页面可能会忘记加上</li>
</ol>
<h2 id="代码实现-3"><a href="#代码实现-3" class="headerlink" title="代码实现"></a>代码实现</h2><p>公司实现并不能成为开源，所以我重新下载一份 <code>iview-admin</code> ，然后加入关键代码，来实现上面所需要的功能。 常规操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>正常打开窗口即可进行修改。 接下来就小步前进加入权限的功能。</p>
<h3 id="新增权限模块的store-3"><a href="#新增权限模块的store-3" class="headerlink" title="新增权限模块的store"></a>新增权限模块的store</h3><p>权限提供了一个用户所拥有的所有权限列表以及一个 <code>getters</code> 后面会用到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">// &#123; operatorCode: &#x27;ProductEndpoint#upload&#x27;, name: &#x27;产品上传&#x27; &#125;</span></span><br><span class="line">    operatorList: []</span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    hasPermission: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">queryOpcode</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!state.operatorList  !state.operatorList.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> state.operatorList.map(<span class="function"><span class="params">operatInfo</span> =&gt;</span> operatInfo.operatorCode).indexOf(queryOpcode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    setPermissionList (state, opList) &#123;</span><br><span class="line">      state.operatorList = opList</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我定义简单的后端返回值：一个 <code>operatorCode</code> 代表某个操作的代号，一个 <code>name</code> 用于分配权限的时候给用户查看。 <code>operatorCode</code> 有很多中生成方式，我这里采用 <code>SpringMVC</code> 的 <code>Controller</code> 名 + <code>#</code> + <code>方法名</code> 的形式， <code>Controller</code> 名用于分割不同资源的资源空间。使用 <code>Spring</code> 的生命周期函数，在项目启动的时候扫描，写入数据库，相当于所有的资源。后面的权限模型，以前该怎样就还是怎样，比如用户 —&gt; 角色 —&gt; 资源的模型。然后根据登陆的用户 <code>ID</code> 查询，返回给前端。至于中文名字，我们项目搭配 <code>Swagger</code> 使用，如果没有使用 <code>Swagger</code> 则需要使用自定义开发的注解指定。 注册到 <code>store</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&#x27;./module/user&#x27;</span></span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">&#x27;./module/app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;./module/permission&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    user,</span><br><span class="line">    app,</span><br><span class="line">    permission</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用户登陆时初始化拥有的资源操作-3"><a href="#用户登陆时初始化拥有的资源操作-3" class="headerlink" title="用户登陆时初始化拥有的资源操作"></a>用户登陆时初始化拥有的资源操作</h3><p>静态操作数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">String</span>(userName) === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登陆操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/login/login.vue</span></span><br><span class="line">...</span><br><span class="line">handleSubmit (&#123; userName, password &#125;) &#123;</span><br><span class="line">    <span class="built_in">this</span>.handleLogin(&#123; userName, password &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserInfo().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 用户登陆成功时候加入操作Code</span></span><br><span class="line">            <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">            <span class="built_in">this</span>.$router.push(&#123;</span><br><span class="line">                name: <span class="built_in">this</span>.$config.homeName</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入用户列表的信息，不然不能登录，因为作者默认只放了两个，当然生产项目肯定不管这里啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/login.js</span></span><br><span class="line"><span class="keyword">const</span> USER_MAP = &#123;</span><br><span class="line">  super_admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://file.iviewui.com/dist/a0e88e83800f138b94d2414621bd9704.png&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  zhangsan: &#123;</span><br><span class="line">    name: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  lisi: &#123;</span><br><span class="line">    name: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>加入权限数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开始加载菜单-3"><a href="#开始加载菜单-3" class="headerlink" title="开始加载菜单"></a>开始加载菜单</h3><p>刚开始我们先设立一个口进入，由于项目的 <code>menuList</code> 挂载在 <code>store</code> 的 <code>app.js</code> 里面，所以我们需要在这里动刀。 这里修改造成两个事情：1. 清掉项目原来的 <code>router</code> 的菜单，但是还可以访问（因为内存加载了）；2. 我加入了需要权限管理的菜单，但是还不能访问，因为路由还没有。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/store/module/app.js</span></span><br><span class="line">...</span><br><span class="line">getters: &#123;</span><br><span class="line">    menuList: <span class="function">(<span class="params">state, getters, rootState</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> allMenus = []</span><br><span class="line">      <span class="keyword">const</span> menuWithPermission = getMenuWithPermissionByRouter(routersWithPermission, rootState.permission.operatorList)</span><br><span class="line">      allMenus.push(...menuWithPermission)</span><br><span class="line">      <span class="keyword">return</span> allMenus</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>那么这里用到一个函数 <code>getMenuWithPermissionByRouter</code>，我决定放在 <code>util.js</code> 即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/libs/util.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK，运行项目。很好，没有出现错误，继续前行。 我的需求是这样的，当一个路由，在 <code>meta</code> 里面的 <code>requireCode</code> 用户拥有第一项操作权限的时候，是可以进入的，也就是菜单需要加载出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;/product&#x27;</span>,</span><br><span class="line">    name: <span class="string">&#x27;product&#x27;</span>,</span><br><span class="line">    component: Main,</span><br><span class="line">    meta: &#123;</span><br><span class="line">      hideInBread: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-list&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-list.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-add&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-form.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当这个页面需要同时满足两个要求的资源操作的时候，第一项使用数组装载。即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requireCode: [[<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>], <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>那么这个页面需要同时满足前面两个的时候，才能加载出来。 那么开始编写 <code>getMenuWithPermissionByRouter</code> 函数。呃，怎么说呢，先把 <code>Aresn</code> 的代码拷过来改改满足我上面的需求即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据需要控制菜单的路由，获取菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>routerWithPermissionList 需要权限管理的路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>userOperatorList 用户拥有的所有操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// debugger</span></span><br><span class="line">  <span class="keyword">let</span> res = []</span><br><span class="line">  <span class="keyword">const</span> allOpCodeArr = userOperatorList.map(<span class="function"><span class="params">opCodeObj</span> =&gt;</span> opCodeObj.operatorCode)</span><br><span class="line">  forEach(routerWithPermissionList, <span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!item.meta  (item.meta &amp;&amp; !item.meta.hideInMenu)) &#123;</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        icon: (item.meta &amp;&amp; item.meta.icon)  <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        name: item.name,</span><br><span class="line">        meta: item.meta</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((hasChild(item)  (item.meta &amp;&amp; item.meta.showAlways))) &#123;</span><br><span class="line">        obj.children = getMenuWithPermissionByRouter(item.children, userOperatorList)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasThisMenuPermission(item, allOpCodeArr)  hasChild(item)) res.push(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasThisMenuPermission = <span class="function">(<span class="params">routerInfo, allOpCodeArr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (routerInfo.meta &amp;&amp; routerInfo.meta.requireCode &amp;&amp; routerInfo.meta.requireCode.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> requireCode = routerInfo.meta.requireCode[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(requireCode)) &#123;</span><br><span class="line">      <span class="keyword">let</span> hasPermission = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; requireCode.length; i++) &#123;</span><br><span class="line">        hasPermission = hasPermission &amp;&amp; allOpCodeArr.indexOf(requireCode[i]) &gt; <span class="number">-1</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hasPermission</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> allOpCodeArr.indexOf(requireCode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OK，如图所示，已经把菜单加载出来了。但是现在出现一个问题，就是刷新页面的时候，什么都没了。因为刷新页面的时候，内存中的 <code>store</code> 被置空了。</p>
<p> <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150329.png"></p>
<h3 id="页面加载的时候自动加载操作-3"><a href="#页面加载的时候自动加载操作-3" class="headerlink" title="页面加载的时候自动加载操作"></a>页面加载的时候自动加载操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">...</span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可喜可贺，刷新的时候，菜单已经出来了。但是有个报错，报 <code>sideMenu</code> 的 <code>undefined</code> 异常。是由于刚开始刷新页面的时候，菜单还没有出来，而代码写死了读第0个元素，菜单是空数组，所以理所当然导致了异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;components&#x2F;main&#x2F;components&#x2F;side-menu&#x2F;side-menu.vue 第 20 行，去掉最后属性的或者即可</span><br><span class="line">&lt;a @click&#x3D;&quot;handleSelect(getNameOrHref(item, true))&quot; class&#x3D;&quot;drop-menu-a&quot; :style&#x3D;&quot;&#123;textAlign: &#39;center&#39;&#125;&quot;&gt;&lt;common-icon :size&#x3D;&quot;rootIconSize&quot; :color&#x3D;&quot;textColor&quot; :type&#x3D;&quot;item.icon&quot;&#x2F;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>OK，我感觉最难的菜单搞定了。接下来要搞定路由。</p>
<h3 id="动态新增有权限的路由-3"><a href="#动态新增有权限的路由-3" class="headerlink" title="动态新增有权限的路由"></a>动态新增有权限的路由</h3><p>有了前面的铺垫，我感觉路由要好做很多了。 动态路由有一个调用的函数是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.addRoutes(routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;)</span><br></pre></td></tr></table></figure>

<p>那么我们需要做的只是，获取有权限的路由，然后加入到 <code>Vue</code> 中。 但是这段代码有点问题就是每次进入都会调用一次= =</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">    <span class="keyword">const</span> routers = getRouterWithPermission(routersWithPermission, <span class="built_in">this</span>.$store.state.permission.operatorList)</span><br><span class="line">    <span class="keyword">const</span> originRouteNames = <span class="built_in">this</span>.$router.options.routes.map(<span class="function"><span class="params">r</span> =&gt;</span> r.name)</span><br><span class="line">    <span class="comment">// 需要解决重复加入问题</span></span><br><span class="line">    <span class="keyword">if</span> (routers &amp;&amp; routers.length &amp;&amp; originRouteNames.indexOf(routers[<span class="number">0</span>].name) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$router.addRoutes(routers)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，菜单有了，路由有了，点击测试能否进入。 然后被作者的路由拦截到了-,-</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">const</span> turnTo = <span class="function">(<span class="params">to, access, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next() <span class="comment">// 直接过。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试路由和菜单-3"><a href="#测试路由和菜单-3" class="headerlink" title="测试路由和菜单"></a>测试路由和菜单</h3><p>分别登陆 <code>zhangsan</code> 和 <code>lisi</code> 从上面的测试权限数据可以看到，<code>lisi</code> 是进入不了产品列表的。</p>
<h4 id="登陆lisi-3"><a href="#登陆lisi-3" class="headerlink" title="登陆lisi"></a>登陆lisi</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150340.png"></p>
<p> 强行进入： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150401.png"> </p>
<p>OK，正确了，如果没有权限，肯定就没有页面嘛，直接404.</p>
<h4 id="登陆zhangsan-2"><a href="#登陆zhangsan-2" class="headerlink" title="登陆zhangsan"></a>登陆zhangsan</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150424.png"></p>
<h3 id="按钮的控制-2"><a href="#按钮的控制-2" class="headerlink" title="按钮的控制"></a>按钮的控制</h3><p>页面的跳转搞定了，接下来就要考虑按钮的问题了。那么上面设置的 <code>Vuex</code> 的 <code>hasPermission</code> 在这里派上用场。关于按钮的绑定，思路来源于 <code>Vue</code> 的自定义指令，只需要在主页面注册自定义指令，每次页面加载的时候，加载到指定指令的组件，开始读取这个组件的 <code>operaCode</code> 是否在当前登陆的用户中，如果存在，则继续执行，如果不存在，则拿到了节点的 <code>Vnode</code> 开始设置我们想要的东西，比如锁定按钮啊，劫持点击事件弹出提示，或者隐藏都可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册权限控制指令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Vue.directive(<span class="string">&#x27;opcode&#x27;</span>, &#123;</span><br><span class="line">  bind: <span class="function"><span class="keyword">function</span> (<span class="params">el, opcode, vnode, oldVNode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> requireOpCode = opcode.value</span><br><span class="line">    <span class="comment">// 如果用户没有这个操作Code的权限，那么劫持click事件，赋予弹出无权限弹窗的事件</span></span><br><span class="line">    <span class="built_in">console</span>.log(requireOpCode);</span><br><span class="line">    <span class="keyword">if</span> (vnode.componentInstance === <span class="literal">undefined</span>  vnode.componentInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.context.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.data.on.click.fns = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.componentInstance.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.componentInstance.$off(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        vnode.componentInstance.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>常规按钮使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src&#x2F;view&#x2F;product&#x2F;components&#x2F;toolbars.vue --&gt;</span><br><span class="line">&lt;Button v-opcode&#x3D;&quot;&#39;ProductManageEndpoint#createProduct&#39;&quot; type&#x3D;&quot;primary&quot; class&#x3D;&quot;btn&quot; icon&#x3D;&quot;ios-arrow-up&quot; @click&#x3D;&quot;$router.push(&#39;&#x2F;product&#x2F;add&#39;)&quot;&gt;上传新商品&lt;&#x2F;Button&gt;</span><br></pre></td></tr></table></figure>

<p><code>Render</code> 函数中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/product/product-list.vue</span></span><br><span class="line">prodColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;pname&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          width: <span class="number">300</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;operator&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          render: <span class="function">(<span class="params">h, params</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">              attrs: &#123;</span><br><span class="line">                href: <span class="string">&#x27;javascript:;&#x27;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              on: &#123;</span><br><span class="line">                click: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  <span class="built_in">this</span>.handleEditProduct(params.row)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="comment">// 在这里注册自定义指令</span></span><br><span class="line">              directives: [</span><br><span class="line">                &#123;</span><br><span class="line">                  name: <span class="string">&#x27;opcode&#x27;</span>,</span><br><span class="line">                  value: <span class="string">&#x27;ProductManageEndpoint#updateByUuid&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;, <span class="string">&#x27;编辑&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>这种方式即使分页，改变表格数据，也可以被主页面上的判断监听到。 PS：在这里就可以看到了按钮的编排的问题，即我们新增产品的页面接口，是在填写完 <code>Form</code> 表单的时候才开始请求的，但是我们需要在两个地方做设置，一个是跳转页面（路由+菜单），一个是新增产品的按钮，即需要把这个权限拦截提前到进入页面之前。这方面现在确实想不到更好的解决办法了。</p>
<h3 id="演示-2"><a href="#演示-2" class="headerlink" title="演示"></a>演示</h3><p>回顾一下权限设置数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，用户名为 <code>zhangsan</code> 是没有删除产品权限以及编辑产品的，但是前面的都有。而 <code>lisi</code> 用户，没有产品列表功能，所以列表都不可以进去。 <code>zhangsan</code> 用户界面： </p>
<p><img src="./zhangsan.gif"></p>
<p> <code>lisi</code> 用户界面： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150941.png"></p>
<h3 id="权限编排页面建议-2"><a href="#权限编排页面建议-2" class="headerlink" title="权限编排页面建议"></a>权限编排页面建议</h3><p>我们知道，经典权限模型是用户、角色、资源的编排。那么我们可以设置一系列的角色，当然记得给自己预留一个流氓角色可以读取所有资源和角色的，利于管理。每个角色可以绑定不同的资源，也可以绑定不同的用户。这样用户一旦登陆，即可读取所有角色中的所有资源操作（记得去重）。 我们公司的绑定界面，通过读取用户所拥有的所有资源，再把 <code>router</code> 中绑定的读取出来（当然过滤掉当前绑定用户无权限的），然后通过加载勾选，最后发送请求给服务器做修改。这样设置可以无限极下限，只要赋予用户授权的权限，用户即可一直创建然后绑定他想绑定的。 <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150951.png"></p>
<h2 id="权限模块建议-2"><a href="#权限模块建议-2" class="headerlink" title="权限模块建议"></a>权限模块建议</h2><p>当前所做的都是前端需要做的工作，后端也需要配合完成接口的调用，即使前端做了设置，但是有些用户可以绕过前端，这时候所有的权限操作就需要后端来拦截了。  </p>
<p>OK，正确了，如果没有权限，肯定就没有页面嘛，直接404.</p>
<h4 id="登陆zhangsan-3"><a href="#登陆zhangsan-3" class="headerlink" title="登陆zhangsan"></a>登陆zhangsan</h4><h2 id="开篇啰嗦几句-4"><a href="#开篇啰嗦几句-4" class="headerlink" title="开篇啰嗦几句"></a>开篇啰嗦几句</h2><p>在传统单体项目中，通常会有一些框架用来管理熟知的权限。如耳濡目染的 <code>Shiro</code> 或者 <code>Spring Security</code> 。然而，到了现在这个时代，新开始的项目会更多的才用后端微服务 + 前端 <code>mvvm</code> 的架构开始书写项目。权限控制方面将变得有些许晦涩。当然，得益于 <code>Java</code> 后端的 <code>Spring</code> 项目的可插拔式接口以及前端大部分 <code>SPA</code> 的架构，权限控制也并没有变得那么的难以实现。相反，在我看来只要找到一个合适的插拔插件的入口，权限也可以做的很简单，跟业务只要少许的耦合即可实现我们熟悉的权限模块。 <a target="_blank" rel="noopener" href="https://github.com/WeidanLi/iview-admin-permission">示例代码 iview-admin-permission</a></p>
<h2 id="实现思路-4"><a href="#实现思路-4" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="路由方面-4"><a href="#路由方面-4" class="headerlink" title="路由方面"></a>路由方面</h3><p>后端提供当前登录用户可访问的所有可访问资源接口信息，前端项目根据当前用户所拥有的接口信息，判断是否拥有菜单权限，如果拥有主要访问权限则加入路由，让用户可以访问其当前的页面。 由于 <code>iview-admin</code> 中，路由信息与菜单是同一份资料，所以在加入路由的时候，即可实现菜单的隐藏与现实。</p>
<h3 id="按钮方面-4"><a href="#按钮方面-4" class="headerlink" title="按钮方面"></a>按钮方面</h3><p>按钮通过 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/custom-directive.html"><code>vue</code> 自定义指令</a>绑定其特定的操作接口信息（如：产品上传按钮，需要拥有产品上传的信息，才可以继续执行按钮的业务逻辑）。在按钮或者 <code>a</code> 标签被渲染的时候，判断是否拥有权限，如若没有，可以隐藏，或者劫持原来绑定的点击事件，使其变成无权限的弹窗提示。 该指令支持 <code>render</code> 生成的按钮或者 <code>a</code> 标签。</p>
<h3 id="数据表格方面-4"><a href="#数据表格方面-4" class="headerlink" title="数据表格方面"></a>数据表格方面</h3><p>数据的隐藏与否应该不会放在前端做吧…不然就是沙雕网友了。 这方面可以提供思路，在微服务架构中，如若前端项目拥有 <code>NodeJS</code> 做数据转换层，那是极好的。如果没有，则需要在微服务路由层做一些细微的改变。即用户无权限的数据列（属性）给他模糊掉，变成 <code>*</code> 或者 <code>—</code> 输出。这方面与前端无关，那么并不会在这里出现。</p>
<h3 id="优缺点-4"><a href="#优缺点-4" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>后端不再关注页面上的事情，基于权限代码让前端自己随心所欲编排</li>
<li>灵活性较高，可以控制页面上所有的元素，可以隐藏弹窗等等喜欢的功能</li>
</ol>
<p>缺点：</p>
<ol>
<li>编排路由的时候会显得繁琐，权限代码比较零散，开发完业务页面可能会忘记加上</li>
</ol>
<h2 id="代码实现-4"><a href="#代码实现-4" class="headerlink" title="代码实现"></a>代码实现</h2><p>公司实现并不能成为开源，所以我重新下载一份 <code>iview-admin</code> ，然后加入关键代码，来实现上面所需要的功能。 常规操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>正常打开窗口即可进行修改。 接下来就小步前进加入权限的功能。</p>
<h3 id="新增权限模块的store-4"><a href="#新增权限模块的store-4" class="headerlink" title="新增权限模块的store"></a>新增权限模块的store</h3><p>权限提供了一个用户所拥有的所有权限列表以及一个 <code>getters</code> 后面会用到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">// &#123; operatorCode: &#x27;ProductEndpoint#upload&#x27;, name: &#x27;产品上传&#x27; &#125;</span></span><br><span class="line">    operatorList: []</span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    hasPermission: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">queryOpcode</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!state.operatorList  !state.operatorList.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> state.operatorList.map(<span class="function"><span class="params">operatInfo</span> =&gt;</span> operatInfo.operatorCode).indexOf(queryOpcode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    setPermissionList (state, opList) &#123;</span><br><span class="line">      state.operatorList = opList</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我定义简单的后端返回值：一个 <code>operatorCode</code> 代表某个操作的代号，一个 <code>name</code> 用于分配权限的时候给用户查看。 <code>operatorCode</code> 有很多中生成方式，我这里采用 <code>SpringMVC</code> 的 <code>Controller</code> 名 + <code>#</code> + <code>方法名</code> 的形式， <code>Controller</code> 名用于分割不同资源的资源空间。使用 <code>Spring</code> 的生命周期函数，在项目启动的时候扫描，写入数据库，相当于所有的资源。后面的权限模型，以前该怎样就还是怎样，比如用户 —&gt; 角色 —&gt; 资源的模型。然后根据登陆的用户 <code>ID</code> 查询，返回给前端。至于中文名字，我们项目搭配 <code>Swagger</code> 使用，如果没有使用 <code>Swagger</code> 则需要使用自定义开发的注解指定。 注册到 <code>store</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&#x27;./module/user&#x27;</span></span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">&#x27;./module/app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;./module/permission&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    user,</span><br><span class="line">    app,</span><br><span class="line">    permission</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用户登陆时初始化拥有的资源操作-4"><a href="#用户登陆时初始化拥有的资源操作-4" class="headerlink" title="用户登陆时初始化拥有的资源操作"></a>用户登陆时初始化拥有的资源操作</h3><p>静态操作数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">String</span>(userName) === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登陆操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/login/login.vue</span></span><br><span class="line">...</span><br><span class="line">handleSubmit (&#123; userName, password &#125;) &#123;</span><br><span class="line">    <span class="built_in">this</span>.handleLogin(&#123; userName, password &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserInfo().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 用户登陆成功时候加入操作Code</span></span><br><span class="line">            <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">            <span class="built_in">this</span>.$router.push(&#123;</span><br><span class="line">                name: <span class="built_in">this</span>.$config.homeName</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入用户列表的信息，不然不能登录，因为作者默认只放了两个，当然生产项目肯定不管这里啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/login.js</span></span><br><span class="line"><span class="keyword">const</span> USER_MAP = &#123;</span><br><span class="line">  super_admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://file.iviewui.com/dist/a0e88e83800f138b94d2414621bd9704.png&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  zhangsan: &#123;</span><br><span class="line">    name: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  lisi: &#123;</span><br><span class="line">    name: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>加入权限数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开始加载菜单-4"><a href="#开始加载菜单-4" class="headerlink" title="开始加载菜单"></a>开始加载菜单</h3><p>刚开始我们先设立一个口进入，由于项目的 <code>menuList</code> 挂载在 <code>store</code> 的 <code>app.js</code> 里面，所以我们需要在这里动刀。 这里修改造成两个事情：1. 清掉项目原来的 <code>router</code> 的菜单，但是还可以访问（因为内存加载了）；2. 我加入了需要权限管理的菜单，但是还不能访问，因为路由还没有。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/store/module/app.js</span></span><br><span class="line">...</span><br><span class="line">getters: &#123;</span><br><span class="line">    menuList: <span class="function">(<span class="params">state, getters, rootState</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> allMenus = []</span><br><span class="line">      <span class="keyword">const</span> menuWithPermission = getMenuWithPermissionByRouter(routersWithPermission, rootState.permission.operatorList)</span><br><span class="line">      allMenus.push(...menuWithPermission)</span><br><span class="line">      <span class="keyword">return</span> allMenus</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>那么这里用到一个函数 <code>getMenuWithPermissionByRouter</code>，我决定放在 <code>util.js</code> 即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/libs/util.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK，运行项目。很好，没有出现错误，继续前行。 我的需求是这样的，当一个路由，在 <code>meta</code> 里面的 <code>requireCode</code> 用户拥有第一项操作权限的时候，是可以进入的，也就是菜单需要加载出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;/product&#x27;</span>,</span><br><span class="line">    name: <span class="string">&#x27;product&#x27;</span>,</span><br><span class="line">    component: Main,</span><br><span class="line">    meta: &#123;</span><br><span class="line">      hideInBread: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-list&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-list.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-add&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-form.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当这个页面需要同时满足两个要求的资源操作的时候，第一项使用数组装载。即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requireCode: [[<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>], <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>那么这个页面需要同时满足前面两个的时候，才能加载出来。 那么开始编写 <code>getMenuWithPermissionByRouter</code> 函数。呃，怎么说呢，先把 <code>Aresn</code> 的代码拷过来改改满足我上面的需求即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据需要控制菜单的路由，获取菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>routerWithPermissionList 需要权限管理的路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>userOperatorList 用户拥有的所有操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// debugger</span></span><br><span class="line">  <span class="keyword">let</span> res = []</span><br><span class="line">  <span class="keyword">const</span> allOpCodeArr = userOperatorList.map(<span class="function"><span class="params">opCodeObj</span> =&gt;</span> opCodeObj.operatorCode)</span><br><span class="line">  forEach(routerWithPermissionList, <span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!item.meta  (item.meta &amp;&amp; !item.meta.hideInMenu)) &#123;</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        icon: (item.meta &amp;&amp; item.meta.icon)  <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        name: item.name,</span><br><span class="line">        meta: item.meta</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((hasChild(item)  (item.meta &amp;&amp; item.meta.showAlways))) &#123;</span><br><span class="line">        obj.children = getMenuWithPermissionByRouter(item.children, userOperatorList)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasThisMenuPermission(item, allOpCodeArr)  hasChild(item)) res.push(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasThisMenuPermission = <span class="function">(<span class="params">routerInfo, allOpCodeArr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (routerInfo.meta &amp;&amp; routerInfo.meta.requireCode &amp;&amp; routerInfo.meta.requireCode.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> requireCode = routerInfo.meta.requireCode[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(requireCode)) &#123;</span><br><span class="line">      <span class="keyword">let</span> hasPermission = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; requireCode.length; i++) &#123;</span><br><span class="line">        hasPermission = hasPermission &amp;&amp; allOpCodeArr.indexOf(requireCode[i]) &gt; <span class="number">-1</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hasPermission</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> allOpCodeArr.indexOf(requireCode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OK，如图所示，已经把菜单加载出来了。但是现在出现一个问题，就是刷新页面的时候，什么都没了。因为刷新页面的时候，内存中的 <code>store</code> 被置空了。</p>
<p> <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150329.png"></p>
<h3 id="页面加载的时候自动加载操作-4"><a href="#页面加载的时候自动加载操作-4" class="headerlink" title="页面加载的时候自动加载操作"></a>页面加载的时候自动加载操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">...</span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可喜可贺，刷新的时候，菜单已经出来了。但是有个报错，报 <code>sideMenu</code> 的 <code>undefined</code> 异常。是由于刚开始刷新页面的时候，菜单还没有出来，而代码写死了读第0个元素，菜单是空数组，所以理所当然导致了异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;components&#x2F;main&#x2F;components&#x2F;side-menu&#x2F;side-menu.vue 第 20 行，去掉最后属性的或者即可</span><br><span class="line">&lt;a @click&#x3D;&quot;handleSelect(getNameOrHref(item, true))&quot; class&#x3D;&quot;drop-menu-a&quot; :style&#x3D;&quot;&#123;textAlign: &#39;center&#39;&#125;&quot;&gt;&lt;common-icon :size&#x3D;&quot;rootIconSize&quot; :color&#x3D;&quot;textColor&quot; :type&#x3D;&quot;item.icon&quot;&#x2F;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>OK，我感觉最难的菜单搞定了。接下来要搞定路由。</p>
<h3 id="动态新增有权限的路由-4"><a href="#动态新增有权限的路由-4" class="headerlink" title="动态新增有权限的路由"></a>动态新增有权限的路由</h3><p>有了前面的铺垫，我感觉路由要好做很多了。 动态路由有一个调用的函数是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.addRoutes(routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;)</span><br></pre></td></tr></table></figure>

<p>那么我们需要做的只是，获取有权限的路由，然后加入到 <code>Vue</code> 中。 但是这段代码有点问题就是每次进入都会调用一次= =</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">    <span class="keyword">const</span> routers = getRouterWithPermission(routersWithPermission, <span class="built_in">this</span>.$store.state.permission.operatorList)</span><br><span class="line">    <span class="keyword">const</span> originRouteNames = <span class="built_in">this</span>.$router.options.routes.map(<span class="function"><span class="params">r</span> =&gt;</span> r.name)</span><br><span class="line">    <span class="comment">// 需要解决重复加入问题</span></span><br><span class="line">    <span class="keyword">if</span> (routers &amp;&amp; routers.length &amp;&amp; originRouteNames.indexOf(routers[<span class="number">0</span>].name) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$router.addRoutes(routers)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，菜单有了，路由有了，点击测试能否进入。 然后被作者的路由拦截到了-,-</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">const</span> turnTo = <span class="function">(<span class="params">to, access, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next() <span class="comment">// 直接过。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试路由和菜单-4"><a href="#测试路由和菜单-4" class="headerlink" title="测试路由和菜单"></a>测试路由和菜单</h3><p>分别登陆 <code>zhangsan</code> 和 <code>lisi</code> 从上面的测试权限数据可以看到，<code>lisi</code> 是进入不了产品列表的。</p>
<h4 id="登陆lisi-4"><a href="#登陆lisi-4" class="headerlink" title="登陆lisi"></a>登陆lisi</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150340.png"></p>
<p> 强行进入： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150401.png"> </p>
<p>OK，正确了，如果没有权限，肯定就没有页面嘛，直接404.</p>
<h4 id="登陆zhangsan-4"><a href="#登陆zhangsan-4" class="headerlink" title="登陆zhangsan"></a>登陆zhangsan</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150424.png"></p>
<h3 id="按钮的控制-3"><a href="#按钮的控制-3" class="headerlink" title="按钮的控制"></a>按钮的控制</h3><p>页面的跳转搞定了，接下来就要考虑按钮的问题了。那么上面设置的 <code>Vuex</code> 的 <code>hasPermission</code> 在这里派上用场。关于按钮的绑定，思路来源于 <code>Vue</code> 的自定义指令，只需要在主页面注册自定义指令，每次页面加载的时候，加载到指定指令的组件，开始读取这个组件的 <code>operaCode</code> 是否在当前登陆的用户中，如果存在，则继续执行，如果不存在，则拿到了节点的 <code>Vnode</code> 开始设置我们想要的东西，比如锁定按钮啊，劫持点击事件弹出提示，或者隐藏都可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册权限控制指令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Vue.directive(<span class="string">&#x27;opcode&#x27;</span>, &#123;</span><br><span class="line">  bind: <span class="function"><span class="keyword">function</span> (<span class="params">el, opcode, vnode, oldVNode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> requireOpCode = opcode.value</span><br><span class="line">    <span class="comment">// 如果用户没有这个操作Code的权限，那么劫持click事件，赋予弹出无权限弹窗的事件</span></span><br><span class="line">    <span class="built_in">console</span>.log(requireOpCode);</span><br><span class="line">    <span class="keyword">if</span> (vnode.componentInstance === <span class="literal">undefined</span>  vnode.componentInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.context.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.data.on.click.fns = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.componentInstance.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.componentInstance.$off(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        vnode.componentInstance.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>常规按钮使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src&#x2F;view&#x2F;product&#x2F;components&#x2F;toolbars.vue --&gt;</span><br><span class="line">&lt;Button v-opcode&#x3D;&quot;&#39;ProductManageEndpoint#createProduct&#39;&quot; type&#x3D;&quot;primary&quot; class&#x3D;&quot;btn&quot; icon&#x3D;&quot;ios-arrow-up&quot; @click&#x3D;&quot;$router.push(&#39;&#x2F;product&#x2F;add&#39;)&quot;&gt;上传新商品&lt;&#x2F;Button&gt;</span><br></pre></td></tr></table></figure>

<p><code>Render</code> 函数中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/product/product-list.vue</span></span><br><span class="line">prodColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;pname&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          width: <span class="number">300</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;operator&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          render: <span class="function">(<span class="params">h, params</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">              attrs: &#123;</span><br><span class="line">                href: <span class="string">&#x27;javascript:;&#x27;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              on: &#123;</span><br><span class="line">                click: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  <span class="built_in">this</span>.handleEditProduct(params.row)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="comment">// 在这里注册自定义指令</span></span><br><span class="line">              directives: [</span><br><span class="line">                &#123;</span><br><span class="line">                  name: <span class="string">&#x27;opcode&#x27;</span>,</span><br><span class="line">                  value: <span class="string">&#x27;ProductManageEndpoint#updateByUuid&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;, <span class="string">&#x27;编辑&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>这种方式即使分页，改变表格数据，也可以被主页面上的判断监听到。 PS：在这里就可以看到了按钮的编排的问题，即我们新增产品的页面接口，是在填写完 <code>Form</code> 表单的时候才开始请求的，但是我们需要在两个地方做设置，一个是跳转页面（路由+菜单），一个是新增产品的按钮，即需要把这个权限拦截提前到进入页面之前。这方面现在确实想不到更好的解决办法了。</p>
<h3 id="演示-3"><a href="#演示-3" class="headerlink" title="演示"></a>演示</h3><p>回顾一下权限设置数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，用户名为 <code>zhangsan</code> 是没有删除产品权限以及编辑产品的，但是前面的都有。而 <code>lisi</code> 用户，没有产品列表功能，所以列表都不可以进去。 <code>zhangsan</code> 用户界面： </p>
<p><img src="./zhangsan.gif"></p>
<p> <code>lisi</code> 用户界面： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150941.png"></p>
<h3 id="权限编排页面建议-3"><a href="#权限编排页面建议-3" class="headerlink" title="权限编排页面建议"></a>权限编排页面建议</h3><p>我们知道，经典权限模型是用户、角色、资源的编排。那么我们可以设置一系列的角色，当然记得给自己预留一个流氓角色可以读取所有资源和角色的，利于管理。每个角色可以绑定不同的资源，也可以绑定不同的用户。这样用户一旦登陆，即可读取所有角色中的所有资源操作（记得去重）。 我们公司的绑定界面，通过读取用户所拥有的所有资源，再把 <code>router</code> 中绑定的读取出来（当然过滤掉当前绑定用户无权限的），然后通过加载勾选，最后发送请求给服务器做修改。这样设置可以无限极下限，只要赋予用户授权的权限，用户即可一直创建然后绑定他想绑定的。 <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150951.png"></p>
<h2 id="权限模块建议-3"><a href="#权限模块建议-3" class="headerlink" title="权限模块建议"></a>权限模块建议</h2><p>当前所做的都是前端需要做的工作，后端也需要配合完成接口的调用，即使前端做了设置，但是有些用户可以绕过前端，这时候所有的权限操作就需要后端来拦截了。 </p>
<h3 id="按钮的控制-4"><a href="#按钮的控制-4" class="headerlink" title="按钮的控制"></a>按钮的控制</h3><p>页面的跳转搞定了，接下来就要考虑按钮的问题了。那么上面设置的 <code>Vuex</code> 的 <code>hasPermission</code> 在这里派上用场。关于按钮的绑定，思路来源于 <code>Vue</code> 的自定义指令，只需要在主页面注册自定义指令，每次页面加载的时候，加载到指定指令的组件，开始读取这个组件的 <code>operaCode</code> 是否在当前登陆的用户中，如果存在，则继续执行，如果不存在，则拿到了节点的 <code>Vnode</code> 开始设置我们想要的东西，比如锁定按钮啊，劫持点击事件弹出提示，或者隐藏都可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册权限控制指令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Vue.directive(<span class="string">&#x27;opcode&#x27;</span>, &#123;</span><br><span class="line">  bind: <span class="function"><span class="keyword">function</span> (<span class="params">el, opcode, vnode, oldVNode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> requireOpCode = opcode.value</span><br><span class="line">    <span class="comment">// 如果用户没有这个操作Code的权限，那么劫持click事件，赋予弹出无权限弹窗的事件</span></span><br><span class="line">    <span class="built_in">console</span>.log(requireOpCode);</span><br><span class="line">    <span class="keyword">if</span> (vnode.componentInstance === <span class="literal">undefined</span>  vnode.componentInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.context.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.data.on.click.fns = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.componentInstance.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.componentInstance.$off(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        vnode.componentInstance.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>常规按钮使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src&#x2F;view&#x2F;product&#x2F;components&#x2F;toolbars.vue --&gt;</span><br><span class="line">&lt;Button v-opcode&#x3D;&quot;&#39;ProductManageEndpoint#createProduct&#39;&quot; type&#x3D;&quot;primary&quot; class&#x3D;&quot;btn&quot; icon&#x3D;&quot;ios-arrow-up&quot; @click&#x3D;&quot;$router.push(&#39;&#x2F;product&#x2F;add&#39;)&quot;&gt;上传新商品&lt;&#x2F;Button&gt;</span><br></pre></td></tr></table></figure>

<p><code>Render</code> 函数中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/product/product-list.vue</span></span><br><span class="line">prodColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;pname&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          width: <span class="number">300</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;operator&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          render: <span class="function">(<span class="params">h, params</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">              attrs: &#123;</span><br><span class="line">                href: <span class="string">&#x27;javascript:;&#x27;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              on: &#123;</span><br><span class="line">                click: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  <span class="built_in">this</span>.handleEditProduct(params.row)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="comment">// 在这里注册自定义指令</span></span><br><span class="line">              directives: [</span><br><span class="line">                &#123;</span><br><span class="line">                  name: <span class="string">&#x27;opcode&#x27;</span>,</span><br><span class="line">                  value: <span class="string">&#x27;ProductManageEndpoint#updateByUuid&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;, <span class="string">&#x27;编辑&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>这种方式即使分页，改变表格数据，也可以被主页面上的判断监听到。 PS：在这里就可以看到了按钮的编排的问题，即我们新增产品的页面接口，是在填写完 <code>Form</code> 表单的时候才开始请求的，但是我们需要在两个地方做设置，一个是跳转页面（路由+菜单），一个是新增产品的按钮，即需要把这个权限拦截提前到进入页面之前。这方面现在确实想不到更好的解决办法了。</p>
<h3 id="演示-4"><a href="#演示-4" class="headerlink" title="演示"></a>演示</h3><p>回顾一下权限设置数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，用户名为 <code>zhangsan</code> 是没有删除产品权限以及编辑产品的，但是前面的都有。而 <code>lisi</code> 用户，没有产品列表功能，所以列表都不可以进去。 <code>zhangsan</code> 用户界面： </p>
<img src="/front/front-backend-ajax-permission-due-iview/zhangsan.gif" class="">

<p> <code>lisi</code> 用户界面： </p>
<h2 id="开篇啰嗦几句-5"><a href="#开篇啰嗦几句-5" class="headerlink" title="开篇啰嗦几句"></a>开篇啰嗦几句</h2><p>在传统单体项目中，通常会有一些框架用来管理熟知的权限。如耳濡目染的 <code>Shiro</code> 或者 <code>Spring Security</code> 。然而，到了现在这个时代，新开始的项目会更多的才用后端微服务 + 前端 <code>mvvm</code> 的架构开始书写项目。权限控制方面将变得有些许晦涩。当然，得益于 <code>Java</code> 后端的 <code>Spring</code> 项目的可插拔式接口以及前端大部分 <code>SPA</code> 的架构，权限控制也并没有变得那么的难以实现。相反，在我看来只要找到一个合适的插拔插件的入口，权限也可以做的很简单，跟业务只要少许的耦合即可实现我们熟悉的权限模块。 <a target="_blank" rel="noopener" href="https://github.com/WeidanLi/iview-admin-permission">示例代码 iview-admin-permission</a></p>
<h2 id="实现思路-5"><a href="#实现思路-5" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="路由方面-5"><a href="#路由方面-5" class="headerlink" title="路由方面"></a>路由方面</h3><p>后端提供当前登录用户可访问的所有可访问资源接口信息，前端项目根据当前用户所拥有的接口信息，判断是否拥有菜单权限，如果拥有主要访问权限则加入路由，让用户可以访问其当前的页面。 由于 <code>iview-admin</code> 中，路由信息与菜单是同一份资料，所以在加入路由的时候，即可实现菜单的隐藏与现实。</p>
<h3 id="按钮方面-5"><a href="#按钮方面-5" class="headerlink" title="按钮方面"></a>按钮方面</h3><p>按钮通过 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/custom-directive.html"><code>vue</code> 自定义指令</a>绑定其特定的操作接口信息（如：产品上传按钮，需要拥有产品上传的信息，才可以继续执行按钮的业务逻辑）。在按钮或者 <code>a</code> 标签被渲染的时候，判断是否拥有权限，如若没有，可以隐藏，或者劫持原来绑定的点击事件，使其变成无权限的弹窗提示。 该指令支持 <code>render</code> 生成的按钮或者 <code>a</code> 标签。</p>
<h3 id="数据表格方面-5"><a href="#数据表格方面-5" class="headerlink" title="数据表格方面"></a>数据表格方面</h3><p>数据的隐藏与否应该不会放在前端做吧…不然就是沙雕网友了。 这方面可以提供思路，在微服务架构中，如若前端项目拥有 <code>NodeJS</code> 做数据转换层，那是极好的。如果没有，则需要在微服务路由层做一些细微的改变。即用户无权限的数据列（属性）给他模糊掉，变成 <code>*</code> 或者 <code>—</code> 输出。这方面与前端无关，那么并不会在这里出现。</p>
<h3 id="优缺点-5"><a href="#优缺点-5" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>后端不再关注页面上的事情，基于权限代码让前端自己随心所欲编排</li>
<li>灵活性较高，可以控制页面上所有的元素，可以隐藏弹窗等等喜欢的功能</li>
</ol>
<p>缺点：</p>
<ol>
<li>编排路由的时候会显得繁琐，权限代码比较零散，开发完业务页面可能会忘记加上</li>
</ol>
<h2 id="代码实现-5"><a href="#代码实现-5" class="headerlink" title="代码实现"></a>代码实现</h2><p>公司实现并不能成为开源，所以我重新下载一份 <code>iview-admin</code> ，然后加入关键代码，来实现上面所需要的功能。 常规操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>正常打开窗口即可进行修改。 接下来就小步前进加入权限的功能。</p>
<h3 id="新增权限模块的store-5"><a href="#新增权限模块的store-5" class="headerlink" title="新增权限模块的store"></a>新增权限模块的store</h3><p>权限提供了一个用户所拥有的所有权限列表以及一个 <code>getters</code> 后面会用到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">// &#123; operatorCode: &#x27;ProductEndpoint#upload&#x27;, name: &#x27;产品上传&#x27; &#125;</span></span><br><span class="line">    operatorList: []</span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    hasPermission: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">queryOpcode</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!state.operatorList  !state.operatorList.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> state.operatorList.map(<span class="function"><span class="params">operatInfo</span> =&gt;</span> operatInfo.operatorCode).indexOf(queryOpcode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    setPermissionList (state, opList) &#123;</span><br><span class="line">      state.operatorList = opList</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我定义简单的后端返回值：一个 <code>operatorCode</code> 代表某个操作的代号，一个 <code>name</code> 用于分配权限的时候给用户查看。 <code>operatorCode</code> 有很多中生成方式，我这里采用 <code>SpringMVC</code> 的 <code>Controller</code> 名 + <code>#</code> + <code>方法名</code> 的形式， <code>Controller</code> 名用于分割不同资源的资源空间。使用 <code>Spring</code> 的生命周期函数，在项目启动的时候扫描，写入数据库，相当于所有的资源。后面的权限模型，以前该怎样就还是怎样，比如用户 —&gt; 角色 —&gt; 资源的模型。然后根据登陆的用户 <code>ID</code> 查询，返回给前端。至于中文名字，我们项目搭配 <code>Swagger</code> 使用，如果没有使用 <code>Swagger</code> 则需要使用自定义开发的注解指定。 注册到 <code>store</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&#x27;./module/user&#x27;</span></span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">&#x27;./module/app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;./module/permission&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    user,</span><br><span class="line">    app,</span><br><span class="line">    permission</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用户登陆时初始化拥有的资源操作-5"><a href="#用户登陆时初始化拥有的资源操作-5" class="headerlink" title="用户登陆时初始化拥有的资源操作"></a>用户登陆时初始化拥有的资源操作</h3><p>静态操作数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">String</span>(userName) === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登陆操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/login/login.vue</span></span><br><span class="line">...</span><br><span class="line">handleSubmit (&#123; userName, password &#125;) &#123;</span><br><span class="line">    <span class="built_in">this</span>.handleLogin(&#123; userName, password &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserInfo().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 用户登陆成功时候加入操作Code</span></span><br><span class="line">            <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">            <span class="built_in">this</span>.$router.push(&#123;</span><br><span class="line">                name: <span class="built_in">this</span>.$config.homeName</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入用户列表的信息，不然不能登录，因为作者默认只放了两个，当然生产项目肯定不管这里啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/login.js</span></span><br><span class="line"><span class="keyword">const</span> USER_MAP = &#123;</span><br><span class="line">  super_admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://file.iviewui.com/dist/a0e88e83800f138b94d2414621bd9704.png&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  zhangsan: &#123;</span><br><span class="line">    name: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  lisi: &#123;</span><br><span class="line">    name: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>加入权限数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开始加载菜单-5"><a href="#开始加载菜单-5" class="headerlink" title="开始加载菜单"></a>开始加载菜单</h3><p>刚开始我们先设立一个口进入，由于项目的 <code>menuList</code> 挂载在 <code>store</code> 的 <code>app.js</code> 里面，所以我们需要在这里动刀。 这里修改造成两个事情：1. 清掉项目原来的 <code>router</code> 的菜单，但是还可以访问（因为内存加载了）；2. 我加入了需要权限管理的菜单，但是还不能访问，因为路由还没有。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/store/module/app.js</span></span><br><span class="line">...</span><br><span class="line">getters: &#123;</span><br><span class="line">    menuList: <span class="function">(<span class="params">state, getters, rootState</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> allMenus = []</span><br><span class="line">      <span class="keyword">const</span> menuWithPermission = getMenuWithPermissionByRouter(routersWithPermission, rootState.permission.operatorList)</span><br><span class="line">      allMenus.push(...menuWithPermission)</span><br><span class="line">      <span class="keyword">return</span> allMenus</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>那么这里用到一个函数 <code>getMenuWithPermissionByRouter</code>，我决定放在 <code>util.js</code> 即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/libs/util.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK，运行项目。很好，没有出现错误，继续前行。 我的需求是这样的，当一个路由，在 <code>meta</code> 里面的 <code>requireCode</code> 用户拥有第一项操作权限的时候，是可以进入的，也就是菜单需要加载出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;/product&#x27;</span>,</span><br><span class="line">    name: <span class="string">&#x27;product&#x27;</span>,</span><br><span class="line">    component: Main,</span><br><span class="line">    meta: &#123;</span><br><span class="line">      hideInBread: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-list&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-list.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-add&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-form.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当这个页面需要同时满足两个要求的资源操作的时候，第一项使用数组装载。即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requireCode: [[<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>], <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>那么这个页面需要同时满足前面两个的时候，才能加载出来。 那么开始编写 <code>getMenuWithPermissionByRouter</code> 函数。呃，怎么说呢，先把 <code>Aresn</code> 的代码拷过来改改满足我上面的需求即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据需要控制菜单的路由，获取菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>routerWithPermissionList 需要权限管理的路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>userOperatorList 用户拥有的所有操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// debugger</span></span><br><span class="line">  <span class="keyword">let</span> res = []</span><br><span class="line">  <span class="keyword">const</span> allOpCodeArr = userOperatorList.map(<span class="function"><span class="params">opCodeObj</span> =&gt;</span> opCodeObj.operatorCode)</span><br><span class="line">  forEach(routerWithPermissionList, <span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!item.meta  (item.meta &amp;&amp; !item.meta.hideInMenu)) &#123;</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        icon: (item.meta &amp;&amp; item.meta.icon)  <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        name: item.name,</span><br><span class="line">        meta: item.meta</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((hasChild(item)  (item.meta &amp;&amp; item.meta.showAlways))) &#123;</span><br><span class="line">        obj.children = getMenuWithPermissionByRouter(item.children, userOperatorList)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasThisMenuPermission(item, allOpCodeArr)  hasChild(item)) res.push(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasThisMenuPermission = <span class="function">(<span class="params">routerInfo, allOpCodeArr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (routerInfo.meta &amp;&amp; routerInfo.meta.requireCode &amp;&amp; routerInfo.meta.requireCode.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> requireCode = routerInfo.meta.requireCode[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(requireCode)) &#123;</span><br><span class="line">      <span class="keyword">let</span> hasPermission = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; requireCode.length; i++) &#123;</span><br><span class="line">        hasPermission = hasPermission &amp;&amp; allOpCodeArr.indexOf(requireCode[i]) &gt; <span class="number">-1</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hasPermission</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> allOpCodeArr.indexOf(requireCode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OK，如图所示，已经把菜单加载出来了。但是现在出现一个问题，就是刷新页面的时候，什么都没了。因为刷新页面的时候，内存中的 <code>store</code> 被置空了。</p>
<p> <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150329.png"></p>
<h3 id="页面加载的时候自动加载操作-5"><a href="#页面加载的时候自动加载操作-5" class="headerlink" title="页面加载的时候自动加载操作"></a>页面加载的时候自动加载操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">...</span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可喜可贺，刷新的时候，菜单已经出来了。但是有个报错，报 <code>sideMenu</code> 的 <code>undefined</code> 异常。是由于刚开始刷新页面的时候，菜单还没有出来，而代码写死了读第0个元素，菜单是空数组，所以理所当然导致了异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;components&#x2F;main&#x2F;components&#x2F;side-menu&#x2F;side-menu.vue 第 20 行，去掉最后属性的或者即可</span><br><span class="line">&lt;a @click&#x3D;&quot;handleSelect(getNameOrHref(item, true))&quot; class&#x3D;&quot;drop-menu-a&quot; :style&#x3D;&quot;&#123;textAlign: &#39;center&#39;&#125;&quot;&gt;&lt;common-icon :size&#x3D;&quot;rootIconSize&quot; :color&#x3D;&quot;textColor&quot; :type&#x3D;&quot;item.icon&quot;&#x2F;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>OK，我感觉最难的菜单搞定了。接下来要搞定路由。</p>
<h3 id="动态新增有权限的路由-5"><a href="#动态新增有权限的路由-5" class="headerlink" title="动态新增有权限的路由"></a>动态新增有权限的路由</h3><p>有了前面的铺垫，我感觉路由要好做很多了。 动态路由有一个调用的函数是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.addRoutes(routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;)</span><br></pre></td></tr></table></figure>

<p>那么我们需要做的只是，获取有权限的路由，然后加入到 <code>Vue</code> 中。 但是这段代码有点问题就是每次进入都会调用一次= =</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">    <span class="keyword">const</span> routers = getRouterWithPermission(routersWithPermission, <span class="built_in">this</span>.$store.state.permission.operatorList)</span><br><span class="line">    <span class="keyword">const</span> originRouteNames = <span class="built_in">this</span>.$router.options.routes.map(<span class="function"><span class="params">r</span> =&gt;</span> r.name)</span><br><span class="line">    <span class="comment">// 需要解决重复加入问题</span></span><br><span class="line">    <span class="keyword">if</span> (routers &amp;&amp; routers.length &amp;&amp; originRouteNames.indexOf(routers[<span class="number">0</span>].name) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$router.addRoutes(routers)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，菜单有了，路由有了，点击测试能否进入。 然后被作者的路由拦截到了-,-</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">const</span> turnTo = <span class="function">(<span class="params">to, access, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next() <span class="comment">// 直接过。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试路由和菜单-5"><a href="#测试路由和菜单-5" class="headerlink" title="测试路由和菜单"></a>测试路由和菜单</h3><p>分别登陆 <code>zhangsan</code> 和 <code>lisi</code> 从上面的测试权限数据可以看到，<code>lisi</code> 是进入不了产品列表的。</p>
<h4 id="登陆lisi-5"><a href="#登陆lisi-5" class="headerlink" title="登陆lisi"></a>登陆lisi</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150340.png"></p>
<p> 强行进入： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150401.png"> </p>
<p>OK，正确了，如果没有权限，肯定就没有页面嘛，直接404.</p>
<h4 id="登陆zhangsan-5"><a href="#登陆zhangsan-5" class="headerlink" title="登陆zhangsan"></a>登陆zhangsan</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150424.png"></p>
<h3 id="按钮的控制-5"><a href="#按钮的控制-5" class="headerlink" title="按钮的控制"></a>按钮的控制</h3><p>页面的跳转搞定了，接下来就要考虑按钮的问题了。那么上面设置的 <code>Vuex</code> 的 <code>hasPermission</code> 在这里派上用场。关于按钮的绑定，思路来源于 <code>Vue</code> 的自定义指令，只需要在主页面注册自定义指令，每次页面加载的时候，加载到指定指令的组件，开始读取这个组件的 <code>operaCode</code> 是否在当前登陆的用户中，如果存在，则继续执行，如果不存在，则拿到了节点的 <code>Vnode</code> 开始设置我们想要的东西，比如锁定按钮啊，劫持点击事件弹出提示，或者隐藏都可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册权限控制指令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Vue.directive(<span class="string">&#x27;opcode&#x27;</span>, &#123;</span><br><span class="line">  bind: <span class="function"><span class="keyword">function</span> (<span class="params">el, opcode, vnode, oldVNode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> requireOpCode = opcode.value</span><br><span class="line">    <span class="comment">// 如果用户没有这个操作Code的权限，那么劫持click事件，赋予弹出无权限弹窗的事件</span></span><br><span class="line">    <span class="built_in">console</span>.log(requireOpCode);</span><br><span class="line">    <span class="keyword">if</span> (vnode.componentInstance === <span class="literal">undefined</span>  vnode.componentInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.context.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.data.on.click.fns = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.componentInstance.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.componentInstance.$off(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        vnode.componentInstance.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>常规按钮使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src&#x2F;view&#x2F;product&#x2F;components&#x2F;toolbars.vue --&gt;</span><br><span class="line">&lt;Button v-opcode&#x3D;&quot;&#39;ProductManageEndpoint#createProduct&#39;&quot; type&#x3D;&quot;primary&quot; class&#x3D;&quot;btn&quot; icon&#x3D;&quot;ios-arrow-up&quot; @click&#x3D;&quot;$router.push(&#39;&#x2F;product&#x2F;add&#39;)&quot;&gt;上传新商品&lt;&#x2F;Button&gt;</span><br></pre></td></tr></table></figure>

<p><code>Render</code> 函数中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/product/product-list.vue</span></span><br><span class="line">prodColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;pname&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          width: <span class="number">300</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;operator&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          render: <span class="function">(<span class="params">h, params</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">              attrs: &#123;</span><br><span class="line">                href: <span class="string">&#x27;javascript:;&#x27;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              on: &#123;</span><br><span class="line">                click: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  <span class="built_in">this</span>.handleEditProduct(params.row)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="comment">// 在这里注册自定义指令</span></span><br><span class="line">              directives: [</span><br><span class="line">                &#123;</span><br><span class="line">                  name: <span class="string">&#x27;opcode&#x27;</span>,</span><br><span class="line">                  value: <span class="string">&#x27;ProductManageEndpoint#updateByUuid&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;, <span class="string">&#x27;编辑&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>这种方式即使分页，改变表格数据，也可以被主页面上的判断监听到。 PS：在这里就可以看到了按钮的编排的问题，即我们新增产品的页面接口，是在填写完 <code>Form</code> 表单的时候才开始请求的，但是我们需要在两个地方做设置，一个是跳转页面（路由+菜单），一个是新增产品的按钮，即需要把这个权限拦截提前到进入页面之前。这方面现在确实想不到更好的解决办法了。</p>
<h3 id="演示-5"><a href="#演示-5" class="headerlink" title="演示"></a>演示</h3><p>回顾一下权限设置数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，用户名为 <code>zhangsan</code> 是没有删除产品权限以及编辑产品的，但是前面的都有。而 <code>lisi</code> 用户，没有产品列表功能，所以列表都不可以进去。 <code>zhangsan</code> 用户界面： </p>
<p><img src="./zhangsan.gif"></p>
<p> <code>lisi</code> 用户界面： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150941.png"></p>
<h3 id="权限编排页面建议-4"><a href="#权限编排页面建议-4" class="headerlink" title="权限编排页面建议"></a>权限编排页面建议</h3><p>我们知道，经典权限模型是用户、角色、资源的编排。那么我们可以设置一系列的角色，当然记得给自己预留一个流氓角色可以读取所有资源和角色的，利于管理。每个角色可以绑定不同的资源，也可以绑定不同的用户。这样用户一旦登陆，即可读取所有角色中的所有资源操作（记得去重）。 我们公司的绑定界面，通过读取用户所拥有的所有资源，再把 <code>router</code> 中绑定的读取出来（当然过滤掉当前绑定用户无权限的），然后通过加载勾选，最后发送请求给服务器做修改。这样设置可以无限极下限，只要赋予用户授权的权限，用户即可一直创建然后绑定他想绑定的。 <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150951.png"></p>
<h2 id="权限模块建议-4"><a href="#权限模块建议-4" class="headerlink" title="权限模块建议"></a>权限模块建议</h2><p>当前所做的都是前端需要做的工作，后端也需要配合完成接口的调用，即使前端做了设置，但是有些用户可以绕过前端，这时候所有的权限操作就需要后端来拦截了。 </p>
<h3 id="权限编排页面建议-5"><a href="#权限编排页面建议-5" class="headerlink" title="权限编排页面建议"></a>权限编排页面建议</h3><p>我们知道，经典权限模型是用户、角色、资源的编排。那么我们可以设置一系列的角色，当然记得给自己预留一个流氓角色可以读取所有资源和角色的，利于管理。每个角色可以绑定不同的资源，也可以绑定不同的用户。这样用户一旦登陆，即可读取所有角色中的所有资源操作（记得去重）。 我们公司的绑定界面，通过读取用户所拥有的所有资源，再把 <code>router</code> 中绑定的读取出来（当然过滤掉当前绑定用户无权限的），然后通过加载勾选，最后发送请求给服务器做修改。这样设置可以无限极下限，只要赋予用户授权的权限，用户即可一直创建然后绑定他想绑定的。 </p>
<h2 id="开篇啰嗦几句-6"><a href="#开篇啰嗦几句-6" class="headerlink" title="开篇啰嗦几句"></a>开篇啰嗦几句</h2><p>在传统单体项目中，通常会有一些框架用来管理熟知的权限。如耳濡目染的 <code>Shiro</code> 或者 <code>Spring Security</code> 。然而，到了现在这个时代，新开始的项目会更多的才用后端微服务 + 前端 <code>mvvm</code> 的架构开始书写项目。权限控制方面将变得有些许晦涩。当然，得益于 <code>Java</code> 后端的 <code>Spring</code> 项目的可插拔式接口以及前端大部分 <code>SPA</code> 的架构，权限控制也并没有变得那么的难以实现。相反，在我看来只要找到一个合适的插拔插件的入口，权限也可以做的很简单，跟业务只要少许的耦合即可实现我们熟悉的权限模块。 <a target="_blank" rel="noopener" href="https://github.com/WeidanLi/iview-admin-permission">示例代码 iview-admin-permission</a></p>
<h2 id="实现思路-6"><a href="#实现思路-6" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="路由方面-6"><a href="#路由方面-6" class="headerlink" title="路由方面"></a>路由方面</h3><p>后端提供当前登录用户可访问的所有可访问资源接口信息，前端项目根据当前用户所拥有的接口信息，判断是否拥有菜单权限，如果拥有主要访问权限则加入路由，让用户可以访问其当前的页面。 由于 <code>iview-admin</code> 中，路由信息与菜单是同一份资料，所以在加入路由的时候，即可实现菜单的隐藏与现实。</p>
<h3 id="按钮方面-6"><a href="#按钮方面-6" class="headerlink" title="按钮方面"></a>按钮方面</h3><p>按钮通过 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/custom-directive.html"><code>vue</code> 自定义指令</a>绑定其特定的操作接口信息（如：产品上传按钮，需要拥有产品上传的信息，才可以继续执行按钮的业务逻辑）。在按钮或者 <code>a</code> 标签被渲染的时候，判断是否拥有权限，如若没有，可以隐藏，或者劫持原来绑定的点击事件，使其变成无权限的弹窗提示。 该指令支持 <code>render</code> 生成的按钮或者 <code>a</code> 标签。</p>
<h3 id="数据表格方面-6"><a href="#数据表格方面-6" class="headerlink" title="数据表格方面"></a>数据表格方面</h3><p>数据的隐藏与否应该不会放在前端做吧…不然就是沙雕网友了。 这方面可以提供思路，在微服务架构中，如若前端项目拥有 <code>NodeJS</code> 做数据转换层，那是极好的。如果没有，则需要在微服务路由层做一些细微的改变。即用户无权限的数据列（属性）给他模糊掉，变成 <code>*</code> 或者 <code>—</code> 输出。这方面与前端无关，那么并不会在这里出现。</p>
<h3 id="优缺点-6"><a href="#优缺点-6" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>后端不再关注页面上的事情，基于权限代码让前端自己随心所欲编排</li>
<li>灵活性较高，可以控制页面上所有的元素，可以隐藏弹窗等等喜欢的功能</li>
</ol>
<p>缺点：</p>
<ol>
<li>编排路由的时候会显得繁琐，权限代码比较零散，开发完业务页面可能会忘记加上</li>
</ol>
<h2 id="代码实现-6"><a href="#代码实现-6" class="headerlink" title="代码实现"></a>代码实现</h2><p>公司实现并不能成为开源，所以我重新下载一份 <code>iview-admin</code> ，然后加入关键代码，来实现上面所需要的功能。 常规操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>正常打开窗口即可进行修改。 接下来就小步前进加入权限的功能。</p>
<h3 id="新增权限模块的store-6"><a href="#新增权限模块的store-6" class="headerlink" title="新增权限模块的store"></a>新增权限模块的store</h3><p>权限提供了一个用户所拥有的所有权限列表以及一个 <code>getters</code> 后面会用到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">// &#123; operatorCode: &#x27;ProductEndpoint#upload&#x27;, name: &#x27;产品上传&#x27; &#125;</span></span><br><span class="line">    operatorList: []</span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    hasPermission: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">queryOpcode</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!state.operatorList  !state.operatorList.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> state.operatorList.map(<span class="function"><span class="params">operatInfo</span> =&gt;</span> operatInfo.operatorCode).indexOf(queryOpcode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    setPermissionList (state, opList) &#123;</span><br><span class="line">      state.operatorList = opList</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我定义简单的后端返回值：一个 <code>operatorCode</code> 代表某个操作的代号，一个 <code>name</code> 用于分配权限的时候给用户查看。 <code>operatorCode</code> 有很多中生成方式，我这里采用 <code>SpringMVC</code> 的 <code>Controller</code> 名 + <code>#</code> + <code>方法名</code> 的形式， <code>Controller</code> 名用于分割不同资源的资源空间。使用 <code>Spring</code> 的生命周期函数，在项目启动的时候扫描，写入数据库，相当于所有的资源。后面的权限模型，以前该怎样就还是怎样，比如用户 —&gt; 角色 —&gt; 资源的模型。然后根据登陆的用户 <code>ID</code> 查询，返回给前端。至于中文名字，我们项目搭配 <code>Swagger</code> 使用，如果没有使用 <code>Swagger</code> 则需要使用自定义开发的注解指定。 注册到 <code>store</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&#x27;./module/user&#x27;</span></span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">&#x27;./module/app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;./module/permission&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    user,</span><br><span class="line">    app,</span><br><span class="line">    permission</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用户登陆时初始化拥有的资源操作-6"><a href="#用户登陆时初始化拥有的资源操作-6" class="headerlink" title="用户登陆时初始化拥有的资源操作"></a>用户登陆时初始化拥有的资源操作</h3><p>静态操作数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">String</span>(userName) === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登陆操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/login/login.vue</span></span><br><span class="line">...</span><br><span class="line">handleSubmit (&#123; userName, password &#125;) &#123;</span><br><span class="line">    <span class="built_in">this</span>.handleLogin(&#123; userName, password &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserInfo().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 用户登陆成功时候加入操作Code</span></span><br><span class="line">            <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">            <span class="built_in">this</span>.$router.push(&#123;</span><br><span class="line">                name: <span class="built_in">this</span>.$config.homeName</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入用户列表的信息，不然不能登录，因为作者默认只放了两个，当然生产项目肯定不管这里啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/login.js</span></span><br><span class="line"><span class="keyword">const</span> USER_MAP = &#123;</span><br><span class="line">  super_admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;super_admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://file.iviewui.com/dist/a0e88e83800f138b94d2414621bd9704.png&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  admin: &#123;</span><br><span class="line">    name: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  zhangsan: &#123;</span><br><span class="line">    name: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  lisi: &#123;</span><br><span class="line">    name: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    user_id: <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">    access: [<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>],</span><br><span class="line">    token: <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">    avator: <span class="string">&#x27;https://avatars0.githubusercontent.com/u/20942571?s=460&amp;v=4&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>加入权限数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock/data/permission-data.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开始加载菜单-6"><a href="#开始加载菜单-6" class="headerlink" title="开始加载菜单"></a>开始加载菜单</h3><p>刚开始我们先设立一个口进入，由于项目的 <code>menuList</code> 挂载在 <code>store</code> 的 <code>app.js</code> 里面，所以我们需要在这里动刀。 这里修改造成两个事情：1. 清掉项目原来的 <code>router</code> 的菜单，但是还可以访问（因为内存加载了）；2. 我加入了需要权限管理的菜单，但是还不能访问，因为路由还没有。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/store/module/app.js</span></span><br><span class="line">...</span><br><span class="line">getters: &#123;</span><br><span class="line">    menuList: <span class="function">(<span class="params">state, getters, rootState</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> allMenus = []</span><br><span class="line">      <span class="keyword">const</span> menuWithPermission = getMenuWithPermissionByRouter(routersWithPermission, rootState.permission.operatorList)</span><br><span class="line">      allMenus.push(...menuWithPermission)</span><br><span class="line">      <span class="keyword">return</span> allMenus</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>那么这里用到一个函数 <code>getMenuWithPermissionByRouter</code>，我决定放在 <code>util.js</code> 即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/libs/util.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK，运行项目。很好，没有出现错误，继续前行。 我的需求是这样的，当一个路由，在 <code>meta</code> 里面的 <code>requireCode</code> 用户拥有第一项操作权限的时候，是可以进入的，也就是菜单需要加载出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;/product&#x27;</span>,</span><br><span class="line">    name: <span class="string">&#x27;product&#x27;</span>,</span><br><span class="line">    component: Main,</span><br><span class="line">    meta: &#123;</span><br><span class="line">      hideInBread: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-list&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-list.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        name: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">        meta: &#123;</span><br><span class="line">          title: <span class="string">&#x27;product-add&#x27;</span>,</span><br><span class="line">          requireCode: [<span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/view/product/product-form.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当这个页面需要同时满足两个要求的资源操作的时候，第一项使用数组装载。即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requireCode: [[<span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>], <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>那么这个页面需要同时满足前面两个的时候，才能加载出来。 那么开始编写 <code>getMenuWithPermissionByRouter</code> 函数。呃，怎么说呢，先把 <code>Aresn</code> 的代码拷过来改改满足我上面的需求即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据需要控制菜单的路由，获取菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>routerWithPermissionList 需要权限管理的路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>userOperatorList 用户拥有的所有操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getMenuWithPermissionByRouter = <span class="function">(<span class="params">routerWithPermissionList, userOperatorList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// debugger</span></span><br><span class="line">  <span class="keyword">let</span> res = []</span><br><span class="line">  <span class="keyword">const</span> allOpCodeArr = userOperatorList.map(<span class="function"><span class="params">opCodeObj</span> =&gt;</span> opCodeObj.operatorCode)</span><br><span class="line">  forEach(routerWithPermissionList, <span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!item.meta  (item.meta &amp;&amp; !item.meta.hideInMenu)) &#123;</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        icon: (item.meta &amp;&amp; item.meta.icon)  <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        name: item.name,</span><br><span class="line">        meta: item.meta</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((hasChild(item)  (item.meta &amp;&amp; item.meta.showAlways))) &#123;</span><br><span class="line">        obj.children = getMenuWithPermissionByRouter(item.children, userOperatorList)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasThisMenuPermission(item, allOpCodeArr)  hasChild(item)) res.push(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasThisMenuPermission = <span class="function">(<span class="params">routerInfo, allOpCodeArr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (routerInfo.meta &amp;&amp; routerInfo.meta.requireCode &amp;&amp; routerInfo.meta.requireCode.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> requireCode = routerInfo.meta.requireCode[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(requireCode)) &#123;</span><br><span class="line">      <span class="keyword">let</span> hasPermission = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; requireCode.length; i++) &#123;</span><br><span class="line">        hasPermission = hasPermission &amp;&amp; allOpCodeArr.indexOf(requireCode[i]) &gt; <span class="number">-1</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hasPermission</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> allOpCodeArr.indexOf(requireCode) &gt; <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OK，如图所示，已经把菜单加载出来了。但是现在出现一个问题，就是刷新页面的时候，什么都没了。因为刷新页面的时候，内存中的 <code>store</code> 被置空了。</p>
<p> <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150329.png"></p>
<h3 id="页面加载的时候自动加载操作-6"><a href="#页面加载的时候自动加载操作-6" class="headerlink" title="页面加载的时候自动加载操作"></a>页面加载的时候自动加载操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">...</span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可喜可贺，刷新的时候，菜单已经出来了。但是有个报错，报 <code>sideMenu</code> 的 <code>undefined</code> 异常。是由于刚开始刷新页面的时候，菜单还没有出来，而代码写死了读第0个元素，菜单是空数组，所以理所当然导致了异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;components&#x2F;main&#x2F;components&#x2F;side-menu&#x2F;side-menu.vue 第 20 行，去掉最后属性的或者即可</span><br><span class="line">&lt;a @click&#x3D;&quot;handleSelect(getNameOrHref(item, true))&quot; class&#x3D;&quot;drop-menu-a&quot; :style&#x3D;&quot;&#123;textAlign: &#39;center&#39;&#125;&quot;&gt;&lt;common-icon :size&#x3D;&quot;rootIconSize&quot; :color&#x3D;&quot;textColor&quot; :type&#x3D;&quot;item.icon&quot;&#x2F;&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>OK，我感觉最难的菜单搞定了。接下来要搞定路由。</p>
<h3 id="动态新增有权限的路由-6"><a href="#动态新增有权限的路由-6" class="headerlink" title="动态新增有权限的路由"></a>动态新增有权限的路由</h3><p>有了前面的铺垫，我感觉路由要好做很多了。 动态路由有一个调用的函数是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.addRoutes(routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;)</span><br></pre></td></tr></table></figure>

<p>那么我们需要做的只是，获取有权限的路由，然后加入到 <code>Vue</code> 中。 但是这段代码有点问题就是每次进入都会调用一次= =</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/single-page/home/home.vue</span></span><br><span class="line">mounted () &#123;</span><br><span class="line">    <span class="comment">// 需要在这里加载权限信息</span></span><br><span class="line">    <span class="keyword">const</span> userName = <span class="built_in">this</span>.$store.state.user.userName</span><br><span class="line">    <span class="built_in">this</span>.$store.commit(<span class="string">&#x27;setPermissionList&#x27;</span>, getPermissionCodeList(userName))</span><br><span class="line">    <span class="keyword">const</span> routers = getRouterWithPermission(routersWithPermission, <span class="built_in">this</span>.$store.state.permission.operatorList)</span><br><span class="line">    <span class="keyword">const</span> originRouteNames = <span class="built_in">this</span>.$router.options.routes.map(<span class="function"><span class="params">r</span> =&gt;</span> r.name)</span><br><span class="line">    <span class="comment">// 需要解决重复加入问题</span></span><br><span class="line">    <span class="keyword">if</span> (routers &amp;&amp; routers.length &amp;&amp; originRouteNames.indexOf(routers[<span class="number">0</span>].name) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$router.addRoutes(routers)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，菜单有了，路由有了，点击测试能否进入。 然后被作者的路由拦截到了-,-</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">const</span> turnTo = <span class="function">(<span class="params">to, access, next</span>) =&gt;</span> &#123;</span><br><span class="line">  next() <span class="comment">// 直接过。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试路由和菜单-6"><a href="#测试路由和菜单-6" class="headerlink" title="测试路由和菜单"></a>测试路由和菜单</h3><p>分别登陆 <code>zhangsan</code> 和 <code>lisi</code> 从上面的测试权限数据可以看到，<code>lisi</code> 是进入不了产品列表的。</p>
<h4 id="登陆lisi-6"><a href="#登陆lisi-6" class="headerlink" title="登陆lisi"></a>登陆lisi</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150340.png"></p>
<p> 强行进入： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150401.png"> </p>
<p>OK，正确了，如果没有权限，肯定就没有页面嘛，直接404.</p>
<h4 id="登陆zhangsan-6"><a href="#登陆zhangsan-6" class="headerlink" title="登陆zhangsan"></a>登陆zhangsan</h4><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150424.png"></p>
<h3 id="按钮的控制-6"><a href="#按钮的控制-6" class="headerlink" title="按钮的控制"></a>按钮的控制</h3><p>页面的跳转搞定了，接下来就要考虑按钮的问题了。那么上面设置的 <code>Vuex</code> 的 <code>hasPermission</code> 在这里派上用场。关于按钮的绑定，思路来源于 <code>Vue</code> 的自定义指令，只需要在主页面注册自定义指令，每次页面加载的时候，加载到指定指令的组件，开始读取这个组件的 <code>operaCode</code> 是否在当前登陆的用户中，如果存在，则继续执行，如果不存在，则拿到了节点的 <code>Vnode</code> 开始设置我们想要的东西，比如锁定按钮啊，劫持点击事件弹出提示，或者隐藏都可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册权限控制指令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Vue.directive(<span class="string">&#x27;opcode&#x27;</span>, &#123;</span><br><span class="line">  bind: <span class="function"><span class="keyword">function</span> (<span class="params">el, opcode, vnode, oldVNode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> requireOpCode = opcode.value</span><br><span class="line">    <span class="comment">// 如果用户没有这个操作Code的权限，那么劫持click事件，赋予弹出无权限弹窗的事件</span></span><br><span class="line">    <span class="built_in">console</span>.log(requireOpCode);</span><br><span class="line">    <span class="keyword">if</span> (vnode.componentInstance === <span class="literal">undefined</span>  vnode.componentInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.context.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.data.on.click.fns = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!vnode.componentInstance.$store.getters.hasPermission(requireOpCode)) &#123;</span><br><span class="line">        vnode.componentInstance.$off(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        vnode.componentInstance.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          Modal.warning(&#123;</span><br><span class="line">            title: <span class="string">&#x27;无权限&#x27;</span>,</span><br><span class="line">            content: <span class="string">&#x27;很抱歉，您没有这项操作的权限&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>常规按钮使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src&#x2F;view&#x2F;product&#x2F;components&#x2F;toolbars.vue --&gt;</span><br><span class="line">&lt;Button v-opcode&#x3D;&quot;&#39;ProductManageEndpoint#createProduct&#39;&quot; type&#x3D;&quot;primary&quot; class&#x3D;&quot;btn&quot; icon&#x3D;&quot;ios-arrow-up&quot; @click&#x3D;&quot;$router.push(&#39;&#x2F;product&#x2F;add&#39;)&quot;&gt;上传新商品&lt;&#x2F;Button&gt;</span><br></pre></td></tr></table></figure>

<p><code>Render</code> 函数中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/view/product/product-list.vue</span></span><br><span class="line">prodColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;pname&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          width: <span class="number">300</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">          key: <span class="string">&#x27;operator&#x27;</span>,</span><br><span class="line">          align: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">          render: <span class="function">(<span class="params">h, params</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">              attrs: &#123;</span><br><span class="line">                href: <span class="string">&#x27;javascript:;&#x27;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              on: &#123;</span><br><span class="line">                click: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  <span class="built_in">this</span>.handleEditProduct(params.row)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="comment">// 在这里注册自定义指令</span></span><br><span class="line">              directives: [</span><br><span class="line">                &#123;</span><br><span class="line">                  name: <span class="string">&#x27;opcode&#x27;</span>,</span><br><span class="line">                  value: <span class="string">&#x27;ProductManageEndpoint#updateByUuid&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;, <span class="string">&#x27;编辑&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>这种方式即使分页，改变表格数据，也可以被主页面上的判断监听到。 PS：在这里就可以看到了按钮的编排的问题，即我们新增产品的页面接口，是在填写完 <code>Form</code> 表单的时候才开始请求的，但是我们需要在两个地方做设置，一个是跳转页面（路由+菜单），一个是新增产品的按钮，即需要把这个权限拦截提前到进入页面之前。这方面现在确实想不到更好的解决办法了。</p>
<h3 id="演示-6"><a href="#演示-6" class="headerlink" title="演示"></a>演示</h3><p>回顾一下权限设置数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPermissionCodeList = <span class="function">(<span class="params">userName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (userName === <span class="string">&#x27;zhangsan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#list&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品列表&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#putawayProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [&#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#createProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品上传&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#delistProduct&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品下架&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">operatorCode</span>: <span class="string">&#x27;ProductManageEndpoint#deleteByUuid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;产品删除&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，用户名为 <code>zhangsan</code> 是没有删除产品权限以及编辑产品的，但是前面的都有。而 <code>lisi</code> 用户，没有产品列表功能，所以列表都不可以进去。 <code>zhangsan</code> 用户界面： </p>
<p><img src="./zhangsan.gif"></p>
<p> <code>lisi</code> 用户界面： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150941.png"></p>
<h3 id="权限编排页面建议-6"><a href="#权限编排页面建议-6" class="headerlink" title="权限编排页面建议"></a>权限编排页面建议</h3><p>我们知道，经典权限模型是用户、角色、资源的编排。那么我们可以设置一系列的角色，当然记得给自己预留一个流氓角色可以读取所有资源和角色的，利于管理。每个角色可以绑定不同的资源，也可以绑定不同的用户。这样用户一旦登陆，即可读取所有角色中的所有资源操作（记得去重）。 我们公司的绑定界面，通过读取用户所拥有的所有资源，再把 <code>router</code> 中绑定的读取出来（当然过滤掉当前绑定用户无权限的），然后通过加载勾选，最后发送请求给服务器做修改。这样设置可以无限极下限，只要赋予用户授权的权限，用户即可一直创建然后绑定他想绑定的。 <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110150951.png"></p>
<h2 id="权限模块建议-5"><a href="#权限模块建议-5" class="headerlink" title="权限模块建议"></a>权限模块建议</h2><p>当前所做的都是前端需要做的工作，后端也需要配合完成接口的调用，即使前端做了设置，但是有些用户可以绕过前端，这时候所有的权限操作就需要后端来拦截了。 </p>
<h2 id="权限模块建议-6"><a href="#权限模块建议-6" class="headerlink" title="权限模块建议"></a>权限模块建议</h2><p>当前所做的都是前端需要做的工作，后端也需要配合完成接口的调用，即使前端做了设置，但是有些用户可以绕过前端，这时候所有的权限操作就需要后端来拦截了。 </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/springboot-%E7%9A%84%E6%89%93%E5%8C%85%E4%B8%8E%E5%8D%95%E7%8B%AC%E9%83%A8%E7%BD%B2-%E9%83%A8%E7%BD%B2%E5%88%B0-tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/springboot-%E7%9A%84%E6%89%93%E5%8C%85%E4%B8%8E%E5%8D%95%E7%8B%AC%E9%83%A8%E7%BD%B2-%E9%83%A8%E7%BD%B2%E5%88%B0-tomcat/" class="post-title-link" itemprop="url">springboot 的打包与单独部署 部署到 tomcat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-02-05 23:39:02" itemprop="dateCreated datePublished" datetime="2019-02-05T23:39:02+08:00">2019-02-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:35:20" itemprop="dateModified" datetime="2020-11-10T16:35:20+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一.简述"></a>一.简述</h2><p>项目开发完成，就需要上线部署了，不然开发了那么久的代码也没什么存在的意义。 说到上线部署，那么以往的部署方式都是使用 <code>servlet</code> 项目，整合一些中间件使用，配置好配置文件。当需要上线部署的时候，就打包成 <code>war</code> 格式的压缩包，放在一个 <code>web</code> 容器中，然后启动容器，让容器去启动我们的项目。 但是在现在的 <code>springboot</code> 时代，官方已经很贴心的给我们提供一个内置的 <code>tomcat</code> 容器了，当然如果我们需要更换成其他的内置容器也完全可行。这样子能够让部署显得更加简单便捷，也不需要像以前一样，当需要多个微服务项目的时候，我们又不想一个 <code>tomcat</code> 运行多个项目让他互相影响，然而开启了很多 <code>tomcat</code> 容器，造成了资源的浪费。<code>springboot</code> 内置的容器咧，也经过官方修改让他更加吻合我们的项目了，我们完全可以在项目的配置文件中配置允许 <code>tomcat</code> 使用的资源信息。</p>
<h2 id="二-打包的两种方式"><a href="#二-打包的两种方式" class="headerlink" title="二.打包的两种方式"></a>二.打包的两种方式</h2><h3 id="（一）直接打包成jar包进行运行"><a href="#（一）直接打包成jar包进行运行" class="headerlink" title="（一）直接打包成jar包进行运行"></a>（一）直接打包成jar包进行运行</h3><p>直接打包 <code>jar</code> 包的方式就很简单了，我们可以使用命令行或者 <code>IDE</code> 去到我们项目的 <code>pom</code> 所在的目录。 运行 <code>mvn package</code>。稍等片刻，如果没有遇到错误，那么 <code>mvn</code> 会帮助我们在 <code>target</code> 文件夹生成一个 <code>.jar</code> 结尾的压缩包，这个就是我们项目的所有信息了。 我们只需要通过 <code>FTP</code> 或者其他的方式将这个项目包放在一个地方，然后使用 <code>java -jar xxx.jar</code> 的形式进行运行就可以启动项目了。过程还是十分轻量级的。 当然以上那种方式，运行完成以后，如果退出了，那么项目也就退出了，这并不是我们想看到的。所以在 <code>Linux</code> 下，我们可以使用 <code>nohup</code> 命令进行启动，将启动打印出来的日志定位到一个文件里面去，例如 <code>nohup java -jar xxx.jar &gt;xxx.out 2&gt;&amp;1 &amp;</code> 这样子，项目运行过程中的情况，会跟我们使用 <code>IDE</code> 一样把日志写到指定的文件里面去，当然如果不想要这个文件毕竟自己一般都实现了日志了的。那么可以使用这个命令，将日志导入到一个黑洞里面去：<code>nohup java -jar /xxx/xxx/xxx.jar &gt;/dev/null 2&gt;&amp;1 &amp;</code></p>
<h3 id="（二）打包成war包放入web容器运行"><a href="#（二）打包成war包放入web容器运行" class="headerlink" title="（二）打包成war包放入web容器运行"></a>（二）打包成war包放入web容器运行</h3><p>将项目打成 <code>jar</code> 包容易，毕竟是标配了，但是如果因为业务需要需要放进一个 <code>tomcat</code> 里面去运行的话，那么久需要反其道而行把一些配置给去掉。 <code>pom.xml</code> 需要加入一些配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-tutorial&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;cn.liweidan.springboot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 指定搜索不到 web.xml 不报错，继续构建 --&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;failOnMissingWebXml&gt;false&lt;&#x2F;failOnMissingWebXml&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;cn.liweidan.springboot.tomcat&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;global-inner-tomcat&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 指定需要构建的格式 --&gt;</span><br><span class="line">    &lt;packaging&gt;war&lt;&#x2F;packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 指定Tomcat只是编译时期加入，打包不加入 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-tomcat&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<p>然后运行 <code>mvn package</code> 即可打包成 <code>war</code> 包了，这时将 <code>war</code> 包放入 <code>WEB</code> 容器即可运行起来。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/springboot-%E7%9B%91%E6%8E%A7-%E7%BB%93%E5%90%88-spring-boot-admin-%E5%AE%9E%E7%8E%B0%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/springboot-%E7%9B%91%E6%8E%A7-%E7%BB%93%E5%90%88-spring-boot-admin-%E5%AE%9E%E7%8E%B0%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7/" class="post-title-link" itemprop="url">springboot 监控 结合 spring-boot-admin 实现项目监控</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-02-05 15:46:45" itemprop="dateCreated datePublished" datetime="2019-02-05T15:46:45+08:00">2019-02-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:36:25" itemprop="dateModified" datetime="2020-11-10T16:36:25+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>针对基于 <code>SpringBoot</code> 构建的微服务项目（当然也可以是普通项目），我们可以通过 <code>SpringBoot</code> 官方提供的 <code>spring-boot-starter-actuator</code> 套件进行监控。但是这个套件有个问题，就是只有 <code>HTTP</code> 接口可以调用，如果我们需要可视化的监控界面，则需要配置 <code>ELK</code> 或者其他的后台管理系统调用这个接口获取系统的信息。 当然，还有一种解决方案就是使用 <code>spring-boot-admin</code> 这个项目来监控我们的微服务系统，这是一个开源的项目，用起来还是蛮舒服的，所以在这里推荐大家可以用一用。 <code>spring-boot-admin</code> 有两种方式可以集成到系统中，一种是使用 <code>spring-cloud</code> 的服务发现，另外一种是直接配置监控的服务地址，这样 <code>admin</code> 服务即可接收到我们配置的系统的一些信息和快照了。 由于这里还不涉及 <code>spring-cloud</code> 所以这里先使用我们自己的服务集成 <code>admin-client</code> 的方式来集成系统监控。</p>
<h2 id="二-开发"><a href="#二-开发" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="（一）-spring-boot-admin-服务端的搭建"><a href="#（一）-spring-boot-admin-服务端的搭建" class="headerlink" title="（一） spring-boot-admin 服务端的搭建"></a>（一） spring-boot-admin 服务端的搭建</h3><h4 id="1-mvn依赖："><a href="#1-mvn依赖：" class="headerlink" title="1.mvn依赖："></a>1.mvn依赖：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- 注意：admin-server的版本号要和spring-boot的版本号对应起来，不然会出现错误 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;de.codecentric&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-admin-starter-server&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-启动器编写"><a href="#2-启动器编写" class="headerlink" title="2.启动器编写"></a>2.启动器编写</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAdminServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AdminServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-配置文件-application-yml"><a href="#3-配置文件-application-yml" class="headerlink" title="3.配置文件 application.yml"></a>3.配置文件 application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>只配置了 <code>8081</code> 端口启动服务端，后面客户端需要用到这个端口，才能正确收集数据。</p>
<h2 id="（二）spring-boot-admin-客户端集成到-springboot-项目"><a href="#（二）spring-boot-admin-客户端集成到-springboot-项目" class="headerlink" title="（二）spring-boot-admin 客户端集成到 springboot 项目"></a>（二）spring-boot-admin 客户端集成到 springboot 项目</h2><h4 id="1-mvn依赖"><a href="#1-mvn依赖" class="headerlink" title="1.mvn依赖"></a>1.mvn依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;de.codecentric&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-admin-starter-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-启动器编写-1"><a href="#2-启动器编写-1" class="headerlink" title="2.启动器编写"></a>2.启动器编写</h4><p>因为是在起步中，所以安全措施什么的，先不设置任何东西，后面需要整合的时候才做修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityPermitAllConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            http.authorizeRequests().anyRequest().permitAll()</span><br><span class="line">                    .and().csrf().disable();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AdminClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-配置文件application-yml"><a href="#3-配置文件application-yml" class="headerlink" title="3.配置文件application.yml"></a>3.配置文件application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">boot:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://localhost:8081/</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> [<span class="string">&#x27;*&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>同上，配置都是最简单的配置，整合起来先。暴露了所有安全相关的端口以及配置了一个 <code>admin-server</code> 的地址，让他可以发送相关信息给服务端。</p>
<h2 id="三-测试"><a href="#三-测试" class="headerlink" title="三. 测试"></a>三. 测试</h2><p>打开服务端的地址：<code>http://localhost:8081</code> </p>
<h2 id="一-简述-1"><a href="#一-简述-1" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>针对基于 <code>SpringBoot</code> 构建的微服务项目（当然也可以是普通项目），我们可以通过 <code>SpringBoot</code> 官方提供的 <code>spring-boot-starter-actuator</code> 套件进行监控。但是这个套件有个问题，就是只有 <code>HTTP</code> 接口可以调用，如果我们需要可视化的监控界面，则需要配置 <code>ELK</code> 或者其他的后台管理系统调用这个接口获取系统的信息。 当然，还有一种解决方案就是使用 <code>spring-boot-admin</code> 这个项目来监控我们的微服务系统，这是一个开源的项目，用起来还是蛮舒服的，所以在这里推荐大家可以用一用。 <code>spring-boot-admin</code> 有两种方式可以集成到系统中，一种是使用 <code>spring-cloud</code> 的服务发现，另外一种是直接配置监控的服务地址，这样 <code>admin</code> 服务即可接收到我们配置的系统的一些信息和快照了。 由于这里还不涉及 <code>spring-cloud</code> 所以这里先使用我们自己的服务集成 <code>admin-client</code> 的方式来集成系统监控。</p>
<h2 id="二-开发-1"><a href="#二-开发-1" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="（一）-spring-boot-admin-服务端的搭建-1"><a href="#（一）-spring-boot-admin-服务端的搭建-1" class="headerlink" title="（一） spring-boot-admin 服务端的搭建"></a>（一） spring-boot-admin 服务端的搭建</h3><h4 id="1-mvn依赖：-1"><a href="#1-mvn依赖：-1" class="headerlink" title="1.mvn依赖："></a>1.mvn依赖：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- 注意：admin-server的版本号要和spring-boot的版本号对应起来，不然会出现错误 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;de.codecentric&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-admin-starter-server&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-启动器编写-2"><a href="#2-启动器编写-2" class="headerlink" title="2.启动器编写"></a>2.启动器编写</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAdminServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AdminServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-配置文件-application-yml-1"><a href="#3-配置文件-application-yml-1" class="headerlink" title="3.配置文件 application.yml"></a>3.配置文件 application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>只配置了 <code>8081</code> 端口启动服务端，后面客户端需要用到这个端口，才能正确收集数据。</p>
<h2 id="（二）spring-boot-admin-客户端集成到-springboot-项目-1"><a href="#（二）spring-boot-admin-客户端集成到-springboot-项目-1" class="headerlink" title="（二）spring-boot-admin 客户端集成到 springboot 项目"></a>（二）spring-boot-admin 客户端集成到 springboot 项目</h2><h4 id="1-mvn依赖-1"><a href="#1-mvn依赖-1" class="headerlink" title="1.mvn依赖"></a>1.mvn依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;de.codecentric&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-admin-starter-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-启动器编写-3"><a href="#2-启动器编写-3" class="headerlink" title="2.启动器编写"></a>2.启动器编写</h4><p>因为是在起步中，所以安全措施什么的，先不设置任何东西，后面需要整合的时候才做修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityPermitAllConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            http.authorizeRequests().anyRequest().permitAll()</span><br><span class="line">                    .and().csrf().disable();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AdminClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-配置文件application-yml-1"><a href="#3-配置文件application-yml-1" class="headerlink" title="3.配置文件application.yml"></a>3.配置文件application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">boot:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://localhost:8081/</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> [<span class="string">&#x27;*&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>同上，配置都是最简单的配置，整合起来先。暴露了所有安全相关的端口以及配置了一个 <code>admin-server</code> 的地址，让他可以发送相关信息给服务端。</p>
<h2 id="三-测试-1"><a href="#三-测试-1" class="headerlink" title="三. 测试"></a>三. 测试</h2><p>打开服务端的地址：<code>http://localhost:8081</code> <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110163603.png"> 可见，<code>spring-boot-admin</code> 已经显示了我们当前启动的系统的一些信息，包括 <code>jvm</code> 的信息，以及一些日志的情况，可以动态设置我们打印日志的一些等级等等。当然后面如果使用了 <code>spring-cloud</code> 的套件集成进来会更加的容易了。  可见，<code>spring-boot-admin</code> 已经显示了我们当前启动的系统的一些信息，包括 <code>jvm</code> 的信息，以及一些日志的情况，可以动态设置我们打印日志的一些等级等等。当然后面如果使用了 <code>spring-cloud</code> 的套件集成进来会更加的容易了。 </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/%E6%B5%8B%E8%AF%95%E4%BD%A0%E7%9A%84-springboot-%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/%E6%B5%8B%E8%AF%95%E4%BD%A0%E7%9A%84-springboot-%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">测试你的 springboot 项目</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-25 21:03:08" itemprop="dateCreated datePublished" datetime="2019-01-25T21:03:08+08:00">2019-01-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 15:03:03" itemprop="dateModified" datetime="2020-11-10T15:03:03+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>测试用例，在日常开发来说，可能刚开始写代码的小厂不会在乎，不过也有很多公司根本就没有测试用例，开发的时候一直写下去。写完一部分，直接启动项目，调用接口进行 <code>debug</code> 调试，然后修改报错的地方。等到了所有功能都实现了以后，就可以合并分支并且发布给测试环境去测试了。 以前刚开始我也是没有写测试用例的习惯，慢慢的接触了 <code>TDD</code> 开发模式，简直被深深吸引住了。测试驱动开发的步骤简单的说就是先写出来你期待的功能，期待的返回值，然后开始启动项目进行运行，由程序自动识别返回的结果是否是错误的。小步开发，一直到功能完成为止。<br>乍一听好像没什么用处，但是好处还在后面，当部门经理提出来这个功能需要加入新的需求的时候，这时候测试用例就是开发人员的利器了。在开始加入新功能之前，保证测试用例正常通过，然后开始小步加入新的需求，修改新需求结果的用例，知道满足新的需求为止。这个过程开发体验是及其舒服的，测试用例可以保证程序的正常运行，及早发现漏洞和错误。暂时把新加入需求这一项放一边，在后面看到这段代码想要重构的时候，测试用例就是心中的奠基石，修改代码的结果，然后运行测试用例，顺利通过，心情愉悦的提交代码。 ok，说了这么多测试的好处，那就要看看怎么实施了，怎么结合 <code>springboot</code> 来编写运行我们的测试用例。<code>web</code> 的测试来说，应该是要复杂一点，应为涉及到容器的启动以及正确初始化，常规的整合 <code>spring</code> 框架那么自动化注入也是测试中的一部分，所以不妨每次测试用例开始的时候，运行 <code>spring</code> 让其正确的进行运行，再测试我们的业务代码，岂不美哉。 <strong>示例代码：spring-boot-test</strong> <strong>项目地址：<a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-boot-tutorial/">https://github.com/WeidanLi/spring-boot-tutorial/</a></strong></p>
<h2 id="二-开发"><a href="#二-开发" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="1-引入测试库"><a href="#1-引入测试库" class="headerlink" title="1. 引入测试库"></a>1. 引入测试库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- springboot web starter --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- SpringBoot 测试 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-准备简单的业务环境"><a href="#2-准备简单的业务环境" class="headerlink" title="2. 准备简单的业务环境"></a>2. 准备简单的业务环境</h3><p><code>UserDo</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略 getter and setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UserService</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, UserDo&gt; userDB = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(UserDo userDo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userDo.getUuid())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;用户uuid不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userDo.getName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;用户姓名不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        userDB.put(userDo.getUuid(), userDo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDo <span class="title">findByUID</span><span class="params">(String UID)</span> </span>&#123;</span><br><span class="line">        UserDo userDo = userDB.get(UID);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(userDo)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userDo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UserEndpoint</code> 接口类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEndpoint</span> </span>&#123;                                                              ··`</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> UserDo userDo)</span> </span>&#123;</span><br><span class="line">        userService.create(userDo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;userUID&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDo <span class="title">findById</span><span class="params">(<span class="meta">@PathVariable(&quot;userUID&quot;)</span> String userUID)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findByUID(userUID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单的说就是实现了两个接口，一个是新增用户的接口，如果用户的两个属性有一个为空，将会抛出错误参数的属性。另外一个是查询，如果查询不到也会抛出错误参数的信息（此步日常中应该是 <code>NotFoundException</code> ）。</p>
<h3 id="3-开始测试"><a href="#3-开始测试" class="headerlink" title="3. 开始测试"></a>3. 开始测试</h3><h4 id="1）编写测试环境的配置文件"><a href="#1）编写测试环境的配置文件" class="headerlink" title="1）编写测试环境的配置文件"></a>1）编写测试环境的配置文件</h4><p>我们知道，<code>mvn</code> 或 <code>gradle</code> 提供了测试包的 <code>resources</code> 可以隔离生产环境的配置文件，当然如果觉得生产环境的配置文件已经配置了一些测试的配置，此处可以略过，因为如果读取不到测试包下的 <code>resources</code> ，测试会自动读取生产下的 <code>resources</code> 。这里为了省时省力，也好像没什么需要特别指出的，我就不写了（主要还是因为懒…） 哎呀不行不行，还是要简单说下配置吧。像 <code>springboot</code> 测试环境下的配置，我觉得几点是我踩坑来的。比如当前项目调用了第三方项目，可以在测试配置里面写打桩的配置（比如使用了 <code>spring-cloud-contract</code> ），数据库的配置可以直接连接内存数据库，一来呢比较快，二来呢也不会存储测试过的垃圾数据（就是说会影响下一次测试的数据）。当然像连接第三方中间件的方式，目前来说，Emm，好像还没什么比较好的解决方案，就是直接连接真实存在的链接。所以我们公司在开发的时候，测试的流程中基本连接公司本地的测试服务器的中间件。</p>
<h4 id="2）编写测试基类"><a href="#2）编写测试基类" class="headerlink" title="2）编写测试基类"></a>2）编写测试基类</h4><p>测试基类呢，主要是关于配置，关于测试前需要准备的数据，每个测试用例过后需要清理动作的抽象，由子测试类继承，拥有基类的配置以及常用的数据。 我这里就是简单的装配一些套件，当测试的一个范围里面总是需要一部分测试数据的时候，可以在这里进行装配。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：测试基类</span></span><br><span class="line"><span class="comment"> * 测试基类在类级别上主要定义了测试基类的安装（一般就是 SpringBootTest 的一些注解）</span></span><br><span class="line"><span class="comment"> * 安装数据</span></span><br><span class="line"><span class="comment"> * 清理数据等等</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/1/25 7:34 PM</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = TestApplication.class)</span> <span class="comment">// 定义这个类是一个 SpringBoot 项目的测试，指定启动器（当然只有一个的话不指定也是可以的）</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span> <span class="comment">// 使用 SpringRunner 进行运行，常规写法，照抄就可以了</span></span><br><span class="line"><span class="meta">@Transactional</span> <span class="comment">// 测试过后是否回滚数据，这么写是会自动回滚的，如果不想要回滚，可以省略该注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试是否按需抛出异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">protected</span> ExpectedException thrown = ExpectedException.none();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试mvn层接口套件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext context;</span><br><span class="line">    <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在测试用来开始的时候装配 MockMvc 套件</span></span><br><span class="line">        mvc = MockMvcBuilders.webAppContextSetup(context).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3）测试业务层"><a href="#3）测试业务层" class="headerlink" title="3）测试业务层"></a>3）测试业务层</h4><p>OK，那么我们现在可以开始编写我们自己代码的测试用例了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * describe: 用户业务层的测试</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/1/25 7:44 PM</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 测试传递空数据的时候是否正常抛出异常，首先传递想要出现的异常</span></span><br><span class="line">        thrown.expect(IllegalArgumentException.class);</span><br><span class="line">        <span class="comment">// 调用实例</span></span><br><span class="line">        userService.create(<span class="keyword">new</span> UserDo());</span><br><span class="line">        <span class="comment">// 如果没有抛出异常，代码走到这里，将会直接抛出错误（因为不应该会走到这里来的）</span></span><br><span class="line">        fail();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 可以逐个缺少参数进行测试但好像没这个必要，毕竟业务开发时间不允许那么长时间花在编写测试上面</span></span><br><span class="line">        <span class="comment">// 不过话说回来，这里缺失的在后面如果对参数验证进行重构的话，绝对需要补上来的</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 编写一个正确的参数传递进去，然后需要回过头来查询插入的数据是否存在</span></span><br><span class="line">        UserDo userDo = <span class="keyword">new</span> UserDo();</span><br><span class="line">        userDo.setUuid(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        userDo.setName(<span class="string">&quot;Adan&quot;</span>);</span><br><span class="line">        userService.create(userDo);</span><br><span class="line">        <span class="comment">// 查询是否存在，当实际项目中这里是使用仓库进行存储的时候，理应应该使用仓库进行查询</span></span><br><span class="line">        UserDo dbUserDo = userService.findByUID(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        assertNotNull(<span class="string">&quot;用户信息不应该为null&quot;</span>, dbUserDo);</span><br><span class="line">        assertTrue(<span class="string">&quot;用户uuid不应为空&quot;</span>, !StringUtils.isEmpty(dbUserDo.getUuid()));</span><br><span class="line">        assertTrue(<span class="string">&quot;用户name不应为空&quot;</span>, !StringUtils.isEmpty(dbUserDo.getName()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里的测试步骤基本和上面差不多，不过反过来的，先使用findByUID查询，期望为找不到，</span></span><br><span class="line">        thrown.expect(IllegalArgumentException.class);</span><br><span class="line">        userService.findByUID(<span class="string">&quot;999&quot;</span>);</span><br><span class="line">        fail();</span><br><span class="line">        <span class="comment">// 再插入再查询，期望不为空</span></span><br><span class="line">        UserDo userDo = <span class="keyword">new</span> UserDo();</span><br><span class="line">        userDo.setUuid(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        userDo.setName(<span class="string">&quot;Adan&quot;</span>);</span><br><span class="line">        userService.create(userDo);</span><br><span class="line">        UserDo dbUserDo = userService.findByUID(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        assertNotNull(<span class="string">&quot;用户信息不应该为null&quot;</span>, dbUserDo);</span><br><span class="line">        assertTrue(<span class="string">&quot;用户uuid不应为空&quot;</span>, !StringUtils.isEmpty(dbUserDo.getUuid()));</span><br><span class="line">        assertTrue(<span class="string">&quot;用户name不应为空&quot;</span>, !StringUtils.isEmpty(dbUserDo.getName()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例其实也不怎么难吧，其实可以说一种心理来编写是最好的，就是你别当做代码是你自己写的，你当做是别人写的，然后你现在要找茬，为难这个方法调用，写出来的测试用例就有用多了。 还有一点，有些同事喜欢直接打印出来结果，然后用肉眼去看。其实我刚开始也是，不过这种方式很痛苦，你需要在控制台一个一个去寻找，然后在脑袋里面去判断这个值是否正确。那为什么不解放你的脑袋，让程序来做呢，这就是 <code>Assert.assertXXX</code> 的用途了，使用他来判断，测试运行的时候，完全可以当成放松自己的脑袋。当所有测试用例慢慢的一个一个通过的时候，全部绿色，那就皆大欢喜了，有红色了，一个一个来修正然后重复运行。直到所有测试用例通过。说实在的，我很享受全部绿色给我的那种激励感，完全可以让我更有信心的去做另外一个任务了。</p>
<h4 id="4）测试接口层"><a href="#4）测试接口层" class="headerlink" title="4）测试接口层"></a>4）测试接口层</h4><p>老实讲，我很少测试接口层，因为公司的需求就是只要请求到达我们的服务的时候，都是需要返回 <code>200</code> 状态码的，那么这个时候，运行测试用例来测试控制器层，对于我来说只会加大我的判断力度，我需要拿到结果再去判断我们的业务代码，所以显得有点多余了。 那么如果你们公司使用的是 <code>RESTful</code> 规范的时候，那么恭喜你，这个测试你完全可以写的很舒适。我就简单演示一下接口层的测试吧。 因为只是简单的演示项目，所以测试接口显得有点吃力。比如，查找不到数据的时候应该返回 <code>404</code> 但是我这里没做接口层的监听，所以根本做不了。按照现在来看，接口层的测试一般是测试状态码是否正常返回，以及数据是否正常的返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEndpointTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        UserDo userDo = <span class="keyword">new</span> UserDo();</span><br><span class="line">        userDo.setUuid(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        userDo.setName(<span class="string">&quot;Adan&quot;</span>);</span><br><span class="line">        userService.create(userDo);</span><br><span class="line"></span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        mvc.perform(MockMvcRequestBuilders.get(<span class="string">&quot;/1&quot;</span>)</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">                .andExpect(mvcResult -&gt; &#123;</span><br><span class="line">                    String contentAsString = mvcResult.getResponse().getContentAsString();</span><br><span class="line">                    UserDo respUserDo = mapper.readValue(contentAsString, UserDo.class);</span><br><span class="line">                    assertNotNull(<span class="string">&quot;用户信息不能为空&quot;</span>, respUserDo);</span><br><span class="line">                &#125;)</span><br><span class="line">                .andDo(MockMvcResultHandlers.print());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h2><p>编写项目的代码的同时，可以结合测试驱动开发编写代码，先写测试用例再写代码体，逐步让测试用例通过，这时候测试用例将变得很强大还完善，代码也不会再是孤单存在着。测试用例完善了，重构起来就显得特别方便。 在我心中完整的测试应该是项目中分层，每一层都有自己独特的测试用例，下层暴露给上层接口，这时候接口都是被测试过的，所以不害怕被调用。但是可能因为项目开发的时间并不多，所以我使用起来还是蛮吃力的。只能在业务层上做测试。不过按照日常贫血性开发，下一层也并没有东西可以测试了，项目最主要的逻辑都落在了业务层，所以好像并没有什么毛病。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/springboot-%E4%B8%8E-redis-%E5%A4%84%E7%90%86%E7%BC%93%E5%AD%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/springboot-%E4%B8%8E-redis-%E5%A4%84%E7%90%86%E7%BC%93%E5%AD%98/" class="post-title-link" itemprop="url">springboot 与 redis 处理缓存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-08 09:38:29" itemprop="dateCreated datePublished" datetime="2019-01-08T09:38:29+08:00">2019-01-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:38:39" itemprop="dateModified" datetime="2020-11-10T16:38:39+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p><code>Redis</code> 是现在大部分项目中使用最多的 <code>NOSQL</code> 型数据库，其单线程的模型以及内存级别的读取可以给项目适当加加速。<code>Redis</code> 不仅会被当成缓存数据库使用，还会被作为分布式锁（因为是单线程模型）的工具来使用。 <code>Spring-Boot</code> 项目有两种方式使用 <code>Redis</code> ，接下来就是两种方式的使用方式了。<br>项目：<code>spring-boot-data-redis</code> 地址：<a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-boot-tutorial">https://github.com/WeidanLi/spring-boot-tutorial</a></p>
<h2 id="二-开发"><a href="#二-开发" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="（一）连接-redis-数据库"><a href="#（一）连接-redis-数据库" class="headerlink" title="（一）连接 redis 数据库"></a>（一）连接 redis 数据库</h3><h4 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h4><p>使用 <code>Docker</code> 启动 <code>redis</code> 内存数据库：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --restart=always -d -p 6379:6379 --name imopei-redis redis redis-server</span><br></pre></td></tr></table></figure>

<h4 id="2-mvn-依赖"><a href="#2-mvn-依赖" class="headerlink" title="2. mvn 依赖"></a>2. mvn 依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h4 id="3-配置-redis-信息"><a href="#3-配置-redis-信息" class="headerlink" title="3. 配置 redis 信息"></a>3. 配置 redis 信息</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span> <span class="comment"># 连接地址</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># 密码</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">16</span>   <span class="comment"># 最大多少个可用</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span>      <span class="comment"># 最大存活数量</span></span><br></pre></td></tr></table></figure>

<h4 id="4-开发接口以及实体类"><a href="#4-开发接口以及实体类" class="headerlink" title="4. 开发接口以及实体类"></a>4. 开发接口以及实体类</h4><p>为了简单，我就只使用接口和自带的 <code>redisTemplate</code> 来做数据存储。（当然有些数据真的可以直接存放于 <code>redis</code> 数据库）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .........</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDo <span class="title">uuidOf</span><span class="params">(<span class="meta">@PathVariable</span> String uid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String json = redisTemplate.opsForValue().get(uid);</span><br><span class="line">        UserDo userDo = <span class="keyword">new</span> ObjectMapper().readValue(json, UserDo.class);</span><br><span class="line">        <span class="keyword">return</span> userDo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> UserDo userDo)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(userDo.getUuid(), <span class="keyword">new</span> ObjectMapper().writeValueAsString(userDo));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-请求测试"><a href="#5-请求测试" class="headerlink" title="5. 请求测试"></a>5. 请求测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">POST http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;user</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;uuid&quot;: &quot;1238910&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;Weidan&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Length: 0</span><br><span class="line">Date: Fri, 04 Jan 2019 08:24:30 GMT</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 202ms; Content length: 0 bytes</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">GET http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;user&#x2F;1238910</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 04 Jan 2019 08:25:01 GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;uuid&quot;: &quot;1238910&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;Weidan&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 89ms; Content length: 34 bytes</span><br></pre></td></tr></table></figure>

<h3 id="（二）使用-spring-的缓存注解"><a href="#（二）使用-spring-的缓存注解" class="headerlink" title="（二）使用 spring 的缓存注解"></a>（二）使用 spring 的缓存注解</h3><p>第（一）种方式自由度比较高，可以决定是否要缓存部分数据。 使用了 <code>spring</code> 的缓存注解的时候，因为缓存注解是使用 <code>AOP</code> 方式切入业务层的，所以可定制度相对就比较低了，一般是直接将整个方法的返回值根据注解定制的 <code>Key</code> 进行存储。 不过项目中可以采用两种方式缓和的方式进行开发？可能维护缓存是否有效就比较麻烦了。 我在项目中是采用第一种方式进行存储的。</p>
<h4 id="1-mvn-依赖"><a href="#1-mvn-依赖" class="headerlink" title="1. mvn 依赖"></a>1. mvn 依赖</h4><p>需要新增一个包：<code>spring-boot-starter-cache</code> 项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-cache&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-启动类配置启动缓存"><a href="#2-启动类配置启动缓存" class="headerlink" title="2. 启动类配置启动缓存"></a>2. 启动类配置启动缓存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RedisApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-新增一个缓存注解的控制器和业务层"><a href="#3-新增一个缓存注解的控制器和业务层" class="headerlink" title="3. 新增一个缓存注解的控制器和业务层"></a>3. 新增一个缓存注解的控制器和业务层</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;usercache&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCacheEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserCacheEndpoint</span><span class="params">(UserService userService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDo <span class="title">uuidOf</span><span class="params">(<span class="meta">@PathVariable</span> String uid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.uuidOf(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="meta">@RequestBody</span> UserDo userDo)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        userService.add(userDo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="meta">@PathVariable</span> String uid)</span> </span>&#123;</span><br><span class="line">        userService.deyByUuid(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String REDIS_VALUE = <span class="string">&quot;user-details&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结果可缓存</span></span><br><span class="line">    <span class="meta">@Cacheable(value = REDIS_VALUE, key = &quot;getArgs()[0]&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDo <span class="title">uuidOf</span><span class="params">(String uuid)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;------&quot;</span>);</span><br><span class="line">        UserDo userDo = <span class="keyword">new</span> UserDo();</span><br><span class="line">        userDo.setUuid(uuid);</span><br><span class="line">        userDo.setName(<span class="string">&quot;USER&quot;</span> + uuid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userDo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删掉缓存</span></span><br><span class="line">    <span class="meta">@CacheEvict(value = REDIS_VALUE, key = &quot;getArgs()[0]&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deyByUuid</span><span class="params">(String uuid)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将返回值放入缓存系统中</span></span><br><span class="line">    <span class="meta">@CachePut(value = REDIS_VALUE, key = &quot;getArgs()[0].uuid&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDo <span class="title">add</span><span class="params">(UserDo userDo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 需要实现序列化接口和toString！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UserDo&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;uuid=&#x27;&quot;</span> + uuid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-测试调用"><a href="#4-测试调用" class="headerlink" title="4. 测试调用"></a>4. 测试调用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;usercache</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;uuid&quot;: &quot;1238910&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;Weidan&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Length: 0</span><br><span class="line">Date: Mon, 07 Jan 2019 09:36:29 GMT</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 127ms; Content length: 0 bytes</span><br></pre></td></tr></table></figure>

<p>接下来我需要请求我新增的这个对象，要知道我上面如果没有缓存的话，<code>get</code> 出来的 <code>user</code> 的名字和这里的名字是不同的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET http:<span class="comment">//127.0.0.1:8080/usercache/1238910</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> </span><br><span class="line">Content-Type: application/json;charset=UTF-<span class="number">8</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Mon, <span class="number">07</span> Jan <span class="number">2019</span> <span class="number">09</span>:<span class="number">37</span>:<span class="number">25</span> GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;uuid&quot;</span>: <span class="string">&quot;1238910&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Weidan&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: <span class="number">200</span>; Time: <span class="number">34</span>ms; Content length: <span class="number">34</span> bytes</span><br></pre></td></tr></table></figure>

<p>OK，已经成功了，实现了我们新增用户的时候就把新增结果存入缓存系统。 接下来我要把它删掉：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELETE http:<span class="comment">//127.0.0.1:8080/usercache/1238910</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> </span><br><span class="line">Content-Length: <span class="number">0</span></span><br><span class="line">Date: Mon, <span class="number">07</span> Jan <span class="number">2019</span> <span class="number">09</span>:<span class="number">38</span>:<span class="number">05</span> GMT</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: <span class="number">200</span>; Time: <span class="number">25</span>ms; Content length: <span class="number">0</span> bytes</span><br></pre></td></tr></table></figure>

<p>再重新获取这个 <code>uid</code> 的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;usercache&#x2F;1238910</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Mon, 07 Jan 2019 09:38:28 GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;uuid&quot;: &quot;1238910&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;USER1238910&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 30ms; Content length: 39 bytes</span><br></pre></td></tr></table></figure>

<p>可以发现，获取的用户信息已经变成我自定义的用户信息了。 到这里缓存系统就已经集成成功了。 接下来，有个需求：</p>
<ol>
<li>缓存系统缓存的信息在 <code>redis</code> 是以二进制的形式存在，不利于查看维护，所以我们需要修改序列化的方式</li>
</ol>
<h4 id="5-修改缓存序列化的形式"><a href="#5-修改缓存序列化的形式" class="headerlink" title="5. 修改缓存序列化的形式"></a>5. 修改缓存序列化的形式</h4><p>一般来说，缓存的形式以 <code>JSON</code> 的形式存在，当需要手动干预系统的运行（比如某个地方出现 <code>bug</code> 暂时不能运行但是又需要删除这个缓存的时候，可以快速定位）可以快速的进行相关的操作。</p>
<blockquote>
<p>参考资料：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/cjsblog/p/9150482.html">Spring Boot Cache配置 序列化成JSON字符串</a></p>
</blockquote>
<p>相当于只需要在系统中重新定义 <code>RedisTemplate</code> 的序列化方式即可，为了方便我没有多余创建配置类，直接写在了启动类里面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.liweidan.springboot.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheWriter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：启动器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/1/4 4:14 PM</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RedisApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; serializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Object&gt;(Object.class);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        serializer.setObjectMapper(objectMapper);</span><br><span class="line"></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(serializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        redisTemplate.setHashValueSerializer(serializer);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheManager <span class="title">redisCacheManager</span><span class="params">(RedisTemplate redisTemplate)</span> </span>&#123;</span><br><span class="line">        RedisCacheWriter redisCacheWriter = RedisCacheWriter.nonLockingRedisCacheWriter(redisTemplate.getConnectionFactory());</span><br><span class="line">        RedisCacheConfiguration redisCacheConfiguration = RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(redisTemplate.getValueSerializer()));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(redisCacheWriter, redisCacheConfiguration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK，重新获取上面接口的内容，可以在 <code>redis</code> 的桌面端查看数据： <code>[&quot;cn.liweidan.springboot.redis.dbo.UserDo&quot;,&#123;&quot;uuid&quot;:&quot;1238910&quot;,&quot;name&quot;:&quot;USER1238910&quot;&#125;]</code></p>
<h4 id="6-Cache-的注解"><a href="#6-Cache-的注解" class="headerlink" title="6. Cache 的注解"></a>6. Cache 的注解</h4><h5 id="0）常用的属性"><a href="#0）常用的属性" class="headerlink" title="0）常用的属性"></a>0）常用的属性</h5><p>缓存的方式相当于我们自己手动设置的 <code>redisKey</code> : user-details: ${id} 在 <code>Redis</code> 桌面工具查看是会把前缀 user-details 当成一个文件夹来看的，相当于分组 Value: <code>Redis</code> 的 <code>key</code> 前缀，相当于分组 key: 可变后缀，可以使用常用的函数进行读取，函数调用的方法都存在于 <code>CacheExpressionRootObject</code> 类中</p>
<h5 id="1）查询缓存"><a href="#1）查询缓存" class="headerlink" title="1）查询缓存"></a>1）查询缓存</h5><p><code>@Cacheable(value = REDIS_VALUE, key = &quot;getArgs()[0]&quot;)</code> 这个注解常用于查询，因为运行的机制是先在缓存中查询是否有对应的 <code>value</code> 和 <code>key</code> ，如果没有再调用方法进行查询。示例中的意思是使用常量 <code>REDIS_VALUE</code> 存储前缀，参数的第一个值作为可变后缀。</p>
<h5 id="2）更新缓存"><a href="#2）更新缓存" class="headerlink" title="2）更新缓存"></a>2）更新缓存</h5><p><code>@CachePut(value = REDIS_VALUE, key = &quot;getArgs()[0].uuid&quot;)</code> 这个注解常用于更新缓存，无论是新增还是更新操作，只要方法运行完成，会将方法的返回值（注意是方法的返回值，所以更新、新增操作都需要返回对象）存入 <code>Redis</code> 中。<code>value</code> <code>key</code> 用法同上。</p>
<h5 id="3）删除缓存"><a href="#3）删除缓存" class="headerlink" title="3）删除缓存"></a>3）删除缓存</h5><p><code>@CacheEvict(value = REDIS_VALUE, key = &quot;getArgs()[0]&quot;)</code> 这个注解常用于删除处理，也是方法（一般是删除方法）运行完成后运行，将会把缓存中的数据给删除了。</p>
<h5 id="4）类全局配置"><a href="#4）类全局配置" class="headerlink" title="4）类全局配置"></a>4）类全局配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheConfig(cacheNames = &#123;&quot;user-details&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以定义该类行为下所有的分组 <code>cacheName</code> ，这样就不需要在上面三个注解中定义 <code>value</code> 值。</p>
<h4 id="7-注意！！"><a href="#7-注意！！" class="headerlink" title="7. 注意！！"></a>7. 注意！！</h4><p>因为缓存注解 <code>Spring</code> 是通过 <code>AOP</code> 进行实现的，所以，只有进入 <code>AOP</code> 的时候方法才会被缓存，嵌套调用 <code>service</code> 方法的时候，缓存注解并不会起作用。 我新增一个接口来做测试，按照上面 <code>uuidOf</code> 方法打印的 <code>------</code> 做判定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;usercache&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCacheEndpoint</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;testUuidOfWithMutipleCache/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDo <span class="title">testUuidOfWithMutipleCache</span><span class="params">(<span class="meta">@PathVariable</span> String uid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.testUuidOfWithMutipleCache(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@CacheConfig(cacheNames = &#123;&quot;user-details&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDo <span class="title">testUuidOfWithMutipleCache</span><span class="params">(String uid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uuidOf(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>连续调用三次 <code>GET http://127.0.0.1:8080/usercache/testUuidOfWithMutipleCache/1238910</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line">2019-01-08 09:24:58.154  INFO 8892 --- [on(4)-127.0.0.1] io.lettuce.core.EpollProvider            : Starting without optional epoll library</span><br><span class="line">2019-01-08 09:24:58.155  INFO 8892 --- [on(4)-127.0.0.1] io.lettuce.core.KqueueProvider           : Starting without optional kqueue library</span><br><span class="line">------</span><br><span class="line">------</span><br><span class="line">------</span><br></pre></td></tr></table></figure>

<p>可以看到控制台打印了三次，说明缓存并不起作用。</p>
<h2 id="三-总结一下"><a href="#三-总结一下" class="headerlink" title="三. 总结一下"></a>三. 总结一下</h2><p>两种方式各不相同，一种是直接当成数据库调用来看待，一种是通过注解的形式。 当然各有长短板，所以可以说，两种方式可以在项目中结合使用，但是缓存的时候不要互串，比如使用第二种方式创建的缓存在第一种方式获取，后面维护起来可以说很痛苦了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Weidan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
