<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weidanli.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>

  <meta name="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
<meta property="og:type" content="website">
<meta property="og:title" content="丹崽的技术博客">
<meta property="og:url" content="http://weidanli.github.io/page/7/index.html">
<meta property="og:site_name" content="丹崽的技术博客">
<meta property="og:description" content="计算机基础 计算机网络 Java Vue 前端 后端">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Weidan">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://weidanli.github.io/page/7/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>丹崽的技术博客</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">丹崽的技术博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">丹崽的计算机知识博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Weidan</p>
  <div class="site-description" itemprop="description">计算机基础 计算机网络 Java Vue 前端 后端</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/springboot-%E4%B8%8E%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/springboot-%E4%B8%8E%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81/" class="post-title-link" itemprop="url">springboot 与数据验证</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-20 08:55:35" itemprop="dateCreated datePublished" datetime="2018-12-20T08:55:35+08:00">2018-12-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:42:01" itemprop="dateModified" datetime="2020-11-10T16:42:01+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="springboot-与数据验证"><a href="#springboot-与数据验证" class="headerlink" title="springboot 与数据验证"></a>springboot 与数据验证</h1><h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>在项目开发中，验证参数也是最经常使用的业务需求了。通常在开发的时候都需要根据业务需求，对参数进行必要验证。 当然一堆的 <code>if-else</code> 的验证在日常开发中时常可见。这种方式非常不友好： 1. 代码太长导致阅读不友好，更改需求可能只是简单的修改但是却需要阅读几十到几百行的代码 2. 有时候业务只是一两句但是验证代码却占用了很长时间 <code>JSR-303</code> 是 <code>Java</code> 的验证规范，早期是在 <code>Hibernate</code> 框架中实现的，后面被抽取到 <code>Java</code> 体系。<code>Spring-Boot</code> 使用了 <code>hibernate-validator</code> 验证器，所以也包含了 <code>JSR-303</code> 在里面。当需要进行参数验证的时候，只需要几个注解即可实现复杂的验证。<br>GitHub：<a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-boot-tutorial">https://github.com/WeidanLi/spring-boot-tutorial</a> 项目示例：<code>web-validate</code></p>
<h2 id="二-开发"><a href="#二-开发" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 引入 web-starter, 已经包含 hibernate-validator 验证器 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-使用注解开发控制器"><a href="#2-使用注解开发控制器" class="headerlink" title="2. 使用注解开发控制器"></a>2. 使用注解开发控制器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span> <span class="comment">// 类上添加该注解，能够验证直接使用参数形式的借口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果需要验证Dto类，只需要加上<span class="doctag">@Validated</span>即可，如需分组，传入参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDto</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> UserDto userDto)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;-----&gt; add: &quot;</span> + userDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDto <span class="title">queryByName</span><span class="params">(<span class="meta">@Length(min = 1, max = 8)</span> <span class="meta">@RequestParam(value = &quot;name&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        UserDto userDto = <span class="keyword">new</span> UserDto();</span><br><span class="line">        userDto.setId(<span class="number">100</span>);</span><br><span class="line">        userDto.setUserName(<span class="string">&quot;狗蛋&quot;</span>);</span><br><span class="line">        userDto.setAge(<span class="number">19</span>);</span><br><span class="line">        <span class="keyword">return</span> userDto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>PS: 1. 第一个接口使用 <code>DTO</code> 的形式进行验证，验证注解将会被使用在 <code>DTO</code> 上，<code>DTO</code>如下 2. 第二个接口直接在接口参数进行验证 UserDto：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户数据交换类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-请求两个接口"><a href="#3-请求两个接口" class="headerlink" title="3. 请求两个接口"></a>3. 请求两个接口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">POST http:&#x2F;&#x2F;localhost:8080</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 400 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 14 Dec 2018 01:41:46 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;timestamp&quot;: &quot;2018-12-14T01:41:46.244+0000&quot;,</span><br><span class="line">  &quot;status&quot;: 400,</span><br><span class="line">  &quot;error&quot;: &quot;Bad Request&quot;,</span><br><span class="line">  &quot;errors&quot;: [</span><br><span class="line">  ... 这里不做详细演示因为下面要配合控制器监听把这个错误给修改掉</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080?name&#x3D;</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 500 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 14 Dec 2018 01:42:55 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;timestamp&quot;: &quot;2018-12-14T01:42:55.654+0000&quot;,</span><br><span class="line">  &quot;status&quot;: 500,</span><br><span class="line">  &quot;error&quot;: &quot;Internal Server Error&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;queryByName.name: 长度需要在1和8之间&quot;,</span><br><span class="line">  &quot;path&quot;: &quot;&#x2F;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 500; Time: 29ms; Content length: 141 bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到，<code>Spring</code> 已经对数据按照我们的需求进行了验证，但是返回的错误信息并不是很友好，我们可以使用前面提到的 <code>controller-advice</code> 进行拦截返回</p>
<h3 id="4-定制返回验证错误信息"><a href="#4-定制返回验证错误信息" class="headerlink" title="4. 定制返回验证错误信息"></a>4. 定制返回验证错误信息</h3><p>从控制台可以看到，验证不通过的时候抛出的异常是 <code>ConstraintViolationException</code> 和 <code>MethodArgumentNotValidException</code> 异常，所以在监听器里只需要对这个异常进行监听，获取 <code>message</code> 属性进行返回即可得知错误的原因。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EndpointAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(ConstraintViolationException.class)</span> <span class="comment">// 参数验证异常</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span> <span class="comment">// 返回 400</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">errorParam</span><span class="params">(ConstraintViolationException e)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; error = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        error.put(<span class="string">&quot;message&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span> <span class="comment">// DTO 验证异常</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span> <span class="comment">// 返回 400</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">errorDto</span><span class="params">(MethodArgumentNotValidException e)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; error = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        StringBuilder message = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (ObjectError allError : e.getBindingResult().getAllErrors()) &#123;</span><br><span class="line">            message.append(allError.getDefaultMessage()).append(<span class="string">&quot;; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        error.put(<span class="string">&quot;message&quot;</span>, message.toString());</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">POST http:&#x2F;&#x2F;localhost:8080</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 400 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 14 Dec 2018 01:59:57 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;名字不允许为空; 年龄不允许为空; &quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 400; Time: 166ms; Content length: 28 bytes</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080?name&#x3D;</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 400 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 14 Dec 2018 01:48:23 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;queryByName.name: 长度需要在1和8之间&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 400; Time: 151ms; Content length: 42 bytes</span><br></pre></td></tr></table></figure>

<h3 id="5-分组验证"><a href="#5-分组验证" class="headerlink" title="5. 分组验证"></a>5. 分组验证</h3><p><code>DTO</code> 如果验证不能自由的话，那么<code>DTO</code> 的复用性就变差了，总不能一个接口都要重新写属性相同但是验证不相同的 <code>DTO</code> 吧 所以，<code>JSR-303</code> 的每个验证注解上都有一个 <code>groups</code> 属性，传入 <code>Class</code> 数组（多组验证），用于定义分组验证的接口（但是这个接口没有实际实现，只是以 <code>Java</code> 类来做分组罢了）。 <code>DTO</code> 修改为更新的时候要求 <code>id</code> 不能为空，新增时名字和年龄不能为空。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(groups = Update.class)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;名字不允许为空&quot;, groups = Add.class)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;年龄不允许为空&quot;, groups = Add.class)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口修改，验证器传入分组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span> <span class="comment">// 类上添加该注解，能够验证直接使用参数形式的借口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增的时候验证 ADD 分组下需要验证的属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDto</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="meta">@Validated(&#123;Add.class&#125;)</span> <span class="meta">@RequestBody</span> UserDto userDto)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;-----&gt; add: &quot;</span> + userDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新的时候验证 UPDATE 分组下需要验证的属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDto</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="meta">@Validated(&#123;Update.class&#125;)</span> <span class="meta">@RequestBody</span> UserDto userDto)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;-----&gt; update: &quot;</span> + userDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新请求接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST http:&#x2F;&#x2F;localhost:8080</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 400 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 14 Dec 2018 02:11:14 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;年龄不允许为空; 名字不允许为空; &quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 400; Time: 11ms; Content length: 32 bytes</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line"></span><br><span class="line">PUT http:&#x2F;&#x2F;localhost:8080</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 400 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 14 Dec 2018 02:12:06 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;不能为null; &quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 400; Time: 194ms; Content length: 23 bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-注解使用说明"><a href="#6-注解使用说明" class="headerlink" title="6. 注解使用说明"></a>6. 注解使用说明</h3><p>每个注解都拥有两个属性： </p>
<ol>
<li>groups 用于定义这个注解要应用于哪些分组的 </li>
<li>message 用于定义不符合要求时要输出的内容</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">注解</span><br><span class="line"></span><br><span class="line">说明</span><br><span class="line"></span><br><span class="line">@Null</span><br><span class="line"></span><br><span class="line">被注释的元素必须为</span><br><span class="line"></span><br><span class="line">@NotNull</span><br><span class="line"></span><br><span class="line">被注释的元素必须不为null</span><br><span class="line"></span><br><span class="line">@AssertTrue</span><br><span class="line"></span><br><span class="line">被注释的元素必须为true</span><br><span class="line"></span><br><span class="line">@AssertFalse</span><br><span class="line"></span><br><span class="line">被注释的元素必须为false</span><br><span class="line"></span><br><span class="line">@Min(value)</span><br><span class="line"></span><br><span class="line">被注释的元素必须是一个数字，其值必须大于等于指定的最小值</span><br><span class="line"></span><br><span class="line">@Max(value)</span><br><span class="line"></span><br><span class="line">被注释的元素必须是一个数字，其值必须小于等于指定的最大值</span><br><span class="line"></span><br><span class="line">@DecimalMin(value)</span><br><span class="line"></span><br><span class="line">被注释的元素必须是一个数字，其值必须大于等于指定的最小值</span><br><span class="line"></span><br><span class="line">@DecimalMax(value)</span><br><span class="line"></span><br><span class="line">被注释的元素必须是一个数字，其值必须小于等于指定的最大值</span><br><span class="line"></span><br><span class="line">@Size(max&#x3D;,min&#x3D;)</span><br><span class="line"></span><br><span class="line">被注释的元素的大小必须在指定的范围内</span><br><span class="line"></span><br><span class="line">@Digits</span><br><span class="line"></span><br><span class="line">被注释的元素必须是一个数字，其值必须在可接受的范围内</span><br><span class="line"></span><br><span class="line">@Past</span><br><span class="line"></span><br><span class="line">被注释的元素必须是一个过去的日期</span><br><span class="line"></span><br><span class="line">@Future</span><br><span class="line"></span><br><span class="line">被注释的元素必须是一个将来的日期</span><br><span class="line"></span><br><span class="line">@Pattern(regex&#x3D;,flag&#x3D;)</span><br><span class="line"></span><br><span class="line">被注释的元素必须符合指定的正则表达式</span><br><span class="line"></span><br><span class="line">Hibernate</span><br><span class="line"></span><br><span class="line">Validator</span><br><span class="line"></span><br><span class="line">@NotBlank</span><br><span class="line"></span><br><span class="line">验证字符串非null，且长度必须大于0</span><br><span class="line"></span><br><span class="line">@Email</span><br><span class="line"></span><br><span class="line">被注释的元素必须是电子邮箱地址</span><br><span class="line"></span><br><span class="line">@Length(min&#x3D;,max&#x3D;)</span><br><span class="line"></span><br><span class="line">被注释的字符串的大小必须在指定的范围内</span><br><span class="line"></span><br><span class="line">@NotEmpty</span><br><span class="line"></span><br><span class="line">被注释的字符串的必须非空</span><br><span class="line"></span><br><span class="line">@Range(min&#x3D;,max&#x3D;,message&#x3D;)</span><br><span class="line"></span><br><span class="line">被注释的元素必须在合适的范围内</span><br></pre></td></tr></table></figure>

<h3 id="7-开发自定义校验器"><a href="#7-开发自定义校验器" class="headerlink" title="7. 开发自定义校验器"></a>7. 开发自定义校验器</h3><p>很多时候，框架自带的功能并不能或者说不方便实现我们想要的功能的时候，我们就可以开始考虑自己造轮子，开发属于我们所在领域的校验器。 简单来说，开发流程就是以下两个步骤：</p>
<ol>
<li>编写约束注解，填充需要的属性以及官方必须要求的属性；</li>
<li>编写校验器，对目标值配合注解上的属性进行验证。</li>
</ol>
<h4 id="7-1-定义校验注解"><a href="#7-1-定义校验注解" class="headerlink" title="7.1 定义校验注解"></a>7.1 定义校验注解</h4><p>为了示范，我定义一个验证目标字符串需要纯中文字符的校验注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证纯中文的注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = &#123; ChsValidator.class &#125;)</span> <span class="comment">// 定义注解的校验器</span></span><br><span class="line"><span class="meta">@Target(ElementType.FIELD)</span> <span class="comment">// 定义该注解使用在类属性上</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span> <span class="comment">// 运行时有效</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Chs &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 可以自定义属性，这个属性暂时没什么用 */</span></span><br><span class="line">    <span class="function">String <span class="title">chineseName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 以下是注解必须的三个属性，分别是定义组别、错误等级以及提示信息 */</span></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;该字段需要纯中文&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="7-2-定义校验器"><a href="#7-2-定义校验器" class="headerlink" title="7.2 定义校验器"></a>7.2 定义校验器</h4><p>校验器需要去实现 <code>ConstraintValidator</code> 接口，传入两个泛型，第一个泛型是注解类型，第二个是目标值的类型。实现两个方法，校验器调用的校验在 <code>isValid</code> 中进行，如果校验通过返回 <code>True</code> 不同过则返回 <code>False</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChsValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">Chs</span>, <span class="title">String</span>&gt; </span>&#123; <span class="comment">// 实现ConstraintValidator接口，第一个泛型是注解类型，第二个是目标值的类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String reg = <span class="string">&quot;^[\\u0391-\\uFFE5]+[\\w*[\\u0391-\\uFFE5]*]*&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Chs constraintAnnotation)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == value) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value.matches(reg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-3-测试自定义校验器"><a href="#7-3-测试自定义校验器" class="headerlink" title="7.3 测试自定义校验器"></a>7.3 测试自定义校验器</h4><p>现在需要一个控制器接口来测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;testChsValidator&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testChsValidator</span><span class="params">(<span class="meta">@Chs</span> <span class="meta">@RequestParam</span> String chsName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求访问测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST http:&#x2F;&#x2F;localhost:8080&#x2F;testChsValidator?chsName&#x3D;888</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 400 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Tue, 18 Dec 2018 01:39:40 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;testChsValidator.chsName: 该字段需要纯中文&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 400; Time: 239ms; Content length: 48 bytes</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------</span><br><span class="line"></span><br><span class="line">POST http:&#x2F;&#x2F;localhost:8080&#x2F;testChsValidator?chsName&#x3D;你好</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Length: 0</span><br><span class="line">Date: Tue, 18 Dec 2018 01:40:11 GMT</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 44ms; Content length: 0 bytes</span><br></pre></td></tr></table></figure>

<h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h2><p>OK，验证器的使用到这里基本完结，一般来说基础的可以适用大部分需求，但是我建议如果某个校验规则用的不多的话，就不大需要定义自定义校验器，如果用的比较多而且是通用的话，那么自定义的注解校验无疑会带来很多便捷。校验器适用的实现是 <code>Hibernate Validate</code> 所以如若需要查询资料可直接查询<code>Hibernate Validate</code> 相关的即可。 <a target="_blank" rel="noopener" href="http://docs.jboss.org/hibernate/validator/4.2/reference/zh-CN/html_single/#validator-customconstraints-constraintannotation">Hibernate-Validate</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/springboot-%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%8E%A5%E5%8F%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/springboot-%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%8E%A5%E5%8F%A3/" class="post-title-link" itemprop="url">springboot 与数据接口</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-20 08:53:17" itemprop="dateCreated datePublished" datetime="2018-12-20T08:53:17+08:00">2018-12-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:40:43" itemprop="dateModified" datetime="2020-11-10T16:40:43+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="springboot-与数据接口"><a href="#springboot-与数据接口" class="headerlink" title="springboot 与数据接口"></a>springboot 与数据接口</h1><h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>从以往的 <code>Spring</code> 项目开发经验来看，<code>Spring</code> 对 <code>JSON</code> 情有独钟，这也得益于 <code>JSON</code> 是<code>JS</code> 发明的一种轻量级的数据交换格式，因为本身 <code>JS</code> 是弱类型的语言，所以 <code>JSON</code> 便没有什么特定类型限制，使得其他各门语言都可以对 <code>JSON</code> 进行解析，从而序列化成各自的对象。 其实前面说的已经有一点半点的，基本都是返回 <code>JSON</code> 字符串，所以这里便加深一点，涉及 <code>SpringMVC</code> 可以用于开发的注解。<br>GitHub：<a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-boot-tutorial">https://github.com/WeidanLi/spring-boot-tutorial</a> <strong>项目示例：<code>web-restful</code></strong></p>
<h2 id="二-开发"><a href="#二-开发" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="1-maven-依赖"><a href="#1-maven-依赖" class="headerlink" title="1. maven 依赖"></a>1. <code>maven</code> 依赖</h3><p><code>maven</code> 依赖依然只需要 <code>spring-boot-starter-web</code> 的依赖即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- 引入 web-starter --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-资源控制器"><a href="#2-资源控制器" class="headerlink" title="2. 资源控制器"></a>2. 资源控制器</h3><p>我这里为了能够说明明白，先假定控制器是用户资源控制器，我可以通过公司查询，也可以通过用户的某个字段查询。 一般来说，一个资源控制器，我喜欢只关注聚合类的资源，比如用户控制器，返回的一般都是用户，操作的也一般是用户。 使用 <code>RESTful</code> 风格来编排 <code>URL</code> ，以前开发的时候因为没有关注到一些注解的用法，<code>RESTful</code> 用起来总是有点吃力，因为有些时候我是从另外一个方向去查询的，并不是 <code>User</code> 的内部属性。 由于先不接触数据库，所以先用集合模拟数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.liweidan.springboot.webrestful.endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.liweidan.springboot.webrestful.dbo.UserDo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：用户资源控制器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/11/22 11:00 AM</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 公司关联用户ID表 */</span></span><br><span class="line">    Map&lt;Long, List&lt;Long&gt;&gt; orgRelationUser = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">/** 用户表 */</span></span><br><span class="line">    List&lt;UserDo&gt; userDoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserEndpoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 假设五个用户，隶属于两个公司，我可能从公司ID查询，也根据条件查询全部</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        userDoList.add(<span class="keyword">new</span> UserDo(<span class="number">1L</span>, <span class="string">&quot;weidan&quot;</span>, <span class="number">6000L</span>, <span class="number">18</span>));</span><br><span class="line">        userDoList.add(<span class="keyword">new</span> UserDo(<span class="number">2L</span>, <span class="string">&quot;xiaodan&quot;</span>, <span class="number">10000L</span>, <span class="number">36</span>));</span><br><span class="line">        userDoList.add(<span class="keyword">new</span> UserDo(<span class="number">3L</span>, <span class="string">&quot;dadan&quot;</span>, <span class="number">9000L</span>, <span class="number">28</span>));</span><br><span class="line">        userDoList.add(<span class="keyword">new</span> UserDo(<span class="number">4L</span>, <span class="string">&quot;Sally&quot;</span>, <span class="number">12000L</span>, <span class="number">24</span>));</span><br><span class="line">        userDoList.add(<span class="keyword">new</span> UserDo(<span class="number">5L</span>, <span class="string">&quot;weisuodan&quot;</span>, <span class="number">20000L</span>, <span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; userIds1 = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        userIds1.add(<span class="number">1L</span>);</span><br><span class="line">        userIds1.add(<span class="number">3L</span>);</span><br><span class="line">        userIds1.add(<span class="number">4L</span>);</span><br><span class="line">        orgRelationUser.put(<span class="number">10L</span>, userIds1);</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; userIds2 = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        userIds2.add(<span class="number">2L</span>);</span><br><span class="line">        userIds2.add(<span class="number">5L</span>);</span><br><span class="line">        orgRelationUser.put(<span class="number">7L</span>, userIds2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(params = &quot;orgId&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserDo&gt; <span class="title">selectByOrg</span><span class="params">(<span class="meta">@RequestParam(&quot;orgId&quot;)</span> Long orgId)</span> </span>&#123;</span><br><span class="line">        List&lt;Long&gt; userIds = orgRelationUser.get(orgId);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(userIds)  userIds.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userDoList.stream().filter(userDo -&gt; userIds.contains(userDo.getId())).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(params = &#123;&quot;salaryMin&quot;, &quot;salaryMax&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserDo&gt; <span class="title">selectAllByCondition</span><span class="params">(<span class="meta">@RequestParam(value = &quot;salaryMin&quot;, defaultValue = &quot;0&quot;)</span> Long salaryMin,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="meta">@RequestParam(value = &quot;salaryMax&quot;, defaultValue = Long.MAX_VALUE + &quot;&quot;)</span> Long salaryMax)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDoList.stream()</span><br><span class="line">                .filter(userDo -&gt; userDo.getSalary() &gt; salaryMin &amp;&amp; userDo.getSalary() &lt; salaryMax)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserDo&gt; <span class="title">selectAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> UserDo userDo, <span class="meta">@RequestParam(&quot;orgId&quot;)</span> Long orgId)</span> </span>&#123;</span><br><span class="line">        Long nextId = (<span class="keyword">long</span>) (userDoList.size() + <span class="number">1</span>);</span><br><span class="line">        userDo.setId(nextId);</span><br><span class="line">        userDoList.add(userDo);</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; userIds = orgRelationUser.get(orgId);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(userIds)) &#123;</span><br><span class="line">            userIds = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        userIds.add(nextId);</span><br><span class="line">        orgRelationUser.put(orgId, userIds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.NO_CONTENT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(<span class="meta">@RequestBody</span> UserDo userDo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (UserDo origin : userDoList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (origin.getId().equals(userDo.getId())) &#123;</span><br><span class="line">                origin.setName(userDo.getName());</span><br><span class="line">                origin.setSalary(userDo.getSalary());</span><br><span class="line">                origin.setAge(userDo.getAge());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> Long userId)</span> </span>&#123;</span><br><span class="line">        userDoList = userDoList.stream().filter(userDo -&gt; !userDo.getId().equals(userId)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-接口测试"><a href="#3-接口测试" class="headerlink" title="3. 接口测试"></a>3. 接口测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"># 根据公司ID查询</span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080&#x2F;user?orgId&#x3D;10</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Thu, 22 Nov 2018 08:12:46 GMT</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;name&quot;: &quot;weidan&quot;,</span><br><span class="line">    &quot;salary&quot;: 6000,</span><br><span class="line">    &quot;age&quot;: 18</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 3,</span><br><span class="line">    &quot;name&quot;: &quot;dadan&quot;,</span><br><span class="line">    &quot;salary&quot;: 9000,</span><br><span class="line">    &quot;age&quot;: 28</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 4,</span><br><span class="line">    &quot;name&quot;: &quot;Sally&quot;,</span><br><span class="line">    &quot;salary&quot;: 12000,</span><br><span class="line">    &quot;age&quot;: 24</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 469ms; Content length: 144 bytes</span><br><span class="line">---------------------------------------------------------</span><br><span class="line"># 根据条件查询全部</span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080&#x2F;user?salaryMin&#x3D;9000</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Thu, 22 Nov 2018 08:13:38 GMT</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;name&quot;: &quot;weidan&quot;,</span><br><span class="line">    &quot;salary&quot;: 6000,</span><br><span class="line">    &quot;age&quot;: 18</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 2,</span><br><span class="line">    &quot;name&quot;: &quot;xiaodan&quot;,</span><br><span class="line">    &quot;salary&quot;: 10000,</span><br><span class="line">    &quot;age&quot;: 36</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 3,</span><br><span class="line">    &quot;name&quot;: &quot;dadan&quot;,</span><br><span class="line">    &quot;salary&quot;: 9000,</span><br><span class="line">    &quot;age&quot;: 28</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 4,</span><br><span class="line">    &quot;name&quot;: &quot;Sally&quot;,</span><br><span class="line">    &quot;salary&quot;: 12000,</span><br><span class="line">    &quot;age&quot;: 24</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 5,</span><br><span class="line">    &quot;name&quot;: &quot;weisuodan&quot;,</span><br><span class="line">    &quot;salary&quot;: 20000,</span><br><span class="line">    &quot;age&quot;: 20</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 22ms; Content length: 246 bytes</span><br><span class="line">---------------------------------------------------------</span><br><span class="line"># 查询全部用户</span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080&#x2F;user</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Thu, 22 Nov 2018 08:14:11 GMT</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;name&quot;: &quot;weidan&quot;,</span><br><span class="line">    &quot;salary&quot;: 6000,</span><br><span class="line">    &quot;age&quot;: 18</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 2,</span><br><span class="line">    &quot;name&quot;: &quot;xiaodan&quot;,</span><br><span class="line">    &quot;salary&quot;: 10000,</span><br><span class="line">    &quot;age&quot;: 36</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 3,</span><br><span class="line">    &quot;name&quot;: &quot;dadan&quot;,</span><br><span class="line">    &quot;salary&quot;: 9000,</span><br><span class="line">    &quot;age&quot;: 28</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 4,</span><br><span class="line">    &quot;name&quot;: &quot;Sally&quot;,</span><br><span class="line">    &quot;salary&quot;: 12000,</span><br><span class="line">    &quot;age&quot;: 24</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 5,</span><br><span class="line">    &quot;name&quot;: &quot;weisuodan&quot;,</span><br><span class="line">    &quot;salary&quot;: 20000,</span><br><span class="line">    &quot;age&quot;: 20</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 29ms; Content length: 246 bytes</span><br><span class="line">---------------------------------------------------------</span><br><span class="line"># 新增用户接口 返回 201</span><br><span class="line">POST http:&#x2F;&#x2F;localhost:8080&#x2F;user?orgId&#x3D;10</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 201 </span><br><span class="line">Content-Length: 0</span><br><span class="line">Date: Thu, 22 Nov 2018 08:16:23 GMT</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: 201; Time: 232ms; Content length: 0 bytes</span><br><span class="line">---------------------------------------------------------</span><br><span class="line"># 更新用户接口 返回 204</span><br><span class="line">PUT http:&#x2F;&#x2F;localhost:8080&#x2F;user</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 204 </span><br><span class="line">Date: Thu, 22 Nov 2018 08:16:56 GMT</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: 204; Time: 79ms; Content length: 0 bytes</span><br><span class="line">---------------------------------------------------------</span><br><span class="line"># 删除用户接口</span><br><span class="line">DELETE http:&#x2F;&#x2F;localhost:8080&#x2F;user&#x2F;2</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Length: 0</span><br><span class="line">Date: Thu, 22 Nov 2018 08:17:20 GMT</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 46ms; Content length: 0 bytes</span><br></pre></td></tr></table></figure>

<h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h2><p><code>JSON</code> 已经成为各大语言的青睐，<code>SpringMVC</code> 还可以提供其他的数据格式交互，例如 <code>Hession</code> 。这些后面跟 <code>SpringCloud</code> 放在一起，跟 <code>Feign</code> 一起搭配使用，提升数据交互的效率。 其实做 <code>RESTful</code> 的时候，最纠结的就是资源的设计了，有的需要用这个条件获取，有的需要那个条件去获取，以前写的乱七八糟，自从知道了 <code>params</code> 以后，设计就变得简单易懂了。不仅仅 <code>GetMapping</code> 所有的请求方式都有这个参数。 以及还有 <code>@SessionAttribute</code> <code>@CookieValue</code> <code>@RequestHeader</code> 可以获取相对应区域的信息。交替使用则可以让开发更加流畅。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/springboot-%E4%B8%8E-web-%E6%8B%A6%E6%88%AA%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/springboot-%E4%B8%8E-web-%E6%8B%A6%E6%88%AA%E5%99%A8/" class="post-title-link" itemprop="url">springboot 与 web 拦截器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-20 08:50:58" itemprop="dateCreated datePublished" datetime="2018-12-20T08:50:58+08:00">2018-12-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:39:56" itemprop="dateModified" datetime="2020-11-10T16:39:56+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="springboot-web-拦截器的使用"><a href="#springboot-web-拦截器的使用" class="headerlink" title="springboot-web 拦截器的使用"></a>springboot-web 拦截器的使用</h1><h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>用过 <code>SpringMVC</code> 的应该都知道拦截器，拦截器可以设置在 <code>SpringMVC</code> 接收请求之前处理（返回 <code>true</code> 继续执行或 <code>false</code> 拒绝执行），方法处理请求之后，以及处理完整个请求之后的操作。例如：单体项目的登陆拦截、在进入处理器之前先给线程栈设置一个公用的 <code>UserThreadLocal</code> 等等。<br>GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-boot-tutorial">https://github.com/WeidanLi/spring-boot-tutorial</a> <strong>项目示例：<code>web-interceptor</code></strong></p>
<h2 id="二-开发"><a href="#二-开发" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="1-mvn-新增-web-starter-的依赖"><a href="#1-mvn-新增-web-starter-的依赖" class="headerlink" title="1. mvn 新增 web-starter 的依赖"></a>1. <code>mvn</code> 新增 <code>web-starter</code> 的依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- 引入 web-starter --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>拦截器依然默认是存在 <code>web-starter</code> 里面的。</p>
<h3 id="2-设置一个资源控制器"><a href="#2-设置一个资源控制器" class="headerlink" title="2. 设置一个资源控制器"></a>2. 设置一个资源控制器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.liweidan.springboot.simpleweb.endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：HelloWorld 控制器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/11/19 12:14 PM</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span> <span class="comment">// 使用 RestController，指定该控制器输出都是 json 对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span> <span class="comment">// 使用 GetMapping 代替 RequestMapping、同理还有 PostMapping PutMapping DeleteMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">helloWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; helloMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        helloMap.put(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> helloMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-开发拦截器"><a href="#3-开发拦截器" class="headerlink" title="3. 开发拦截器"></a>3. 开发拦截器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.liweidan.springboot.webinterceptor.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：权限拦截器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/11/22 1:30 AM</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123; <span class="comment">// 1. 实现 HandlerInterceptor 接口</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写 preHandle 方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> </span>&#123;</span><br><span class="line">        String authHeader = request.getHeader(HttpHeaders.AUTHORIZATION);</span><br><span class="line">        <span class="comment">// 假设只有 Authorization 的值是 weidan 才给继续请求</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(authHeader) &amp;&amp; !authHeader.isEmpty() &amp;&amp; authHeader.equals(<span class="string">&quot;weidan&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Spring</code> 5.0 之前是需要重写所有方法的，现在都是默认接口方法了，要靠自己重写所需要的。 一般重写 <code>preHandle</code> 方法，但这里需要注意的是，需要设置不通过后的响应问，不然会出现状态码 <code>200</code> 但是没有响应体的情况，我这里返回 <code>401</code></p>
<h3 id="4-配置拦截器注入项目"><a href="#4-配置拦截器注入项目" class="headerlink" title="4. 配置拦截器注入项目"></a>4. 配置拦截器注入项目</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.liweidan.springboot.webinterceptor.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：web 配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/11/22 1:35 AM</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">// 配置类必备</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注入拦截器并设置拦截路径</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> AuthInterceptor()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意两点：</p>
<ol>
<li><p>同样，<code>WebMvcConfigurer</code> 都是默认方法的形式，只需要重写所需要的即可。</p>
</li>
<li><p><code>@Configuration</code> 是编写配置类必备的，不要忘记。</p>
</li>
</ol>
<h3 id="5-接口测试"><a href="#5-接口测试" class="headerlink" title="5. 接口测试"></a>5. 接口测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 传递错误的 Authorization 头</span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080</span><br><span class="line">Accept: application&#x2F;json</span><br><span class="line">Authorization: weidan0</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 401 </span><br><span class="line">Content-Length: 0</span><br><span class="line">Date: Wed, 21 Nov 2018 17:44:01 GMT</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: 401; Time: 29ms; Content length: 0 bytes</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">&#x2F;&#x2F; 正确的姿势传递</span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080</span><br><span class="line">Accept: application&#x2F;json</span><br><span class="line">Authorization: weidan</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Wed, 21 Nov 2018 17:50:32 GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;hello&quot;: &quot;world&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 189ms; Content length: 17 bytes</span><br></pre></td></tr></table></figure>

<h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h2><p>使用拦截器来开发登陆拦截，权限是可行的，就是需要自己编写较多的逻辑如查询数据库啦，判断啦。 所以如果权限模型简单的话，是没有问题的，如果权限问题比较复杂可以结合著名框架 <code>shrio</code> <code>spring-security</code> 等协助开发，当然像我们公司，权限模型自定义程度高，框架是解决不了的，也只能手撸了。 在日常开发中，一般 <code>Authorization</code> 存放的是 <code>jwt</code> 验证字符串，具体后面再细说。在微服务架构中，拦截器可就没什么用场了，我能想到的就是在当前线程栈中设置用户信息这个需求了。一般微服务架构权限的实现会交给路由来解决。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/springboot-%E5%B8%B8%E7%94%A8%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF%E8%BF%94%E5%9B%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/springboot-%E5%B8%B8%E7%94%A8%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF%E8%BF%94%E5%9B%9E/" class="post-title-link" itemprop="url">springboot 常用异常信息返回</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-20 08:47:54" itemprop="dateCreated datePublished" datetime="2018-12-20T08:47:54+08:00">2018-12-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 11:10:36" itemprop="dateModified" datetime="2020-11-10T11:10:36+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="springboot-web-常用异常信息返回"><a href="#springboot-web-常用异常信息返回" class="headerlink" title="springboot-web 常用异常信息返回"></a>springboot-web 常用异常信息返回</h1><h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>在日常的开发中，都会有多多少少的异常发生，如：不存在异常、参数异常等等。那这时候怎么向前端展示也是一个问题，通常的做法就是建立一个通用的数据返回类注入 <code>ResultDto</code> 然后存储是否顺利调用，数据，错误信息等信息。结合 <code>spring-boot-web</code> 的监听器，可以让我们尽量少的关注这些错误异常的发生，只要一句话或者一个注解【需要自己封装，使用 <code>aop</code> 】，就可以实现程序给我们的自动验证。 GitHub: <a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-boot-tutorial">https://github.com/WeidanLi/spring-boot-tutorial</a> <strong>示例代码：<code>web-exception-resp</code></strong></p>
<h2 id="二-开发"><a href="#二-开发" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="1-mvn-新增-web-starter-的依赖"><a href="#1-mvn-新增-web-starter-的依赖" class="headerlink" title="1. mvn 新增 web-starter 的依赖"></a>1. <code>mvn</code> 新增 <code>web-starter</code> 的依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- 引入 web-starter --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-准备一个标准输出类和一些异常"><a href="#2-准备一个标准输出类和一些异常" class="headerlink" title="2. 准备一个标准输出类和一些异常"></a>2. 准备一个标准输出类和一些异常</h3><p>标准数据响应类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultDto</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResultDto</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResultDto</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>准备了一些异常，一个基类，两个子类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbsException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbsException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbsException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElementNotFoundException</span> <span class="keyword">extends</span> <span class="title">AbsException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ElementNotFoundException</span><span class="params">(String elementName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(elementName + <span class="string">&quot;不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamInvalidException</span> <span class="keyword">extends</span> <span class="title">AbsException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParamInvalidException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">&quot;参数错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-资源和资源控制器"><a href="#3-资源和资源控制器" class="headerlink" title="3. 资源和资源控制器"></a>3. 资源和资源控制器</h3><p>我假设，<code>id</code> 超过 <code>100</code> 的就是参数错误了，如果 <code>id</code> 是个偶数就是资源不存在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDto</span><span class="params">(Long id, String name, Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略 getter 和 setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultDto&lt;UserDto&gt; <span class="title">idOf</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id &gt; <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParamInvalidException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (id % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ElementNotFoundException(<span class="string">&quot;用户&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        UserDto userDto = <span class="keyword">new</span> UserDto(id, <span class="string">&quot;狗蛋&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultDto&lt;&gt;(userDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-重点：使用-ControllerAdvice-监听控制器调用时出现的异常"><a href="#4-重点：使用-ControllerAdvice-监听控制器调用时出现的异常" class="headerlink" title="4. 重点：使用 ControllerAdvice 监听控制器调用时出现的异常"></a>4. 重点：使用 <code>ControllerAdvice</code> 监听控制器调用时出现的异常</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span> <span class="comment">// 指定这个类是一个监听类，用于监听不同异常输出结果</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EndpointAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(ElementNotFoundException.class)</span> <span class="comment">// 元素未找到异常</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.NOT_FOUND)</span> <span class="comment">// 返回 404</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultDto&lt;Void&gt; <span class="title">elementNotFount</span><span class="params">(ElementNotFoundException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultDto&lt;&gt;(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(ParamInvalidException.class)</span> <span class="comment">// 参数错误异常</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span> <span class="comment">// 返回 400</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultDto&lt;Void&gt; <span class="title">paramInvalid</span><span class="params">(ParamInvalidException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultDto&lt;&gt;(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span> <span class="comment">// 未知错误</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span> <span class="comment">// 返回 500</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultDto&lt;Void&gt; <span class="title">other</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultDto&lt;&gt;(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-接口测试"><a href="#5-接口测试" class="headerlink" title="5. 接口测试"></a>5. 接口测试</h3><p>使用 <code>idea-2018</code> 的 <code>http</code> 测试工具请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">GET http:&#x2F;&#x2F;localhost:8080&#x2F;user&#x2F;101</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 400 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Mon, 19 Nov 2018 16:45:16 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;success&quot;: false,</span><br><span class="line">  &quot;data&quot;: null,</span><br><span class="line">  &quot;message&quot;: &quot;参数错误&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 400; Time: 357ms; Content length: 46 bytes</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line"></span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080&#x2F;user&#x2F;100</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 404 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Mon, 19 Nov 2018 16:46:46 GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;success&quot;: false,</span><br><span class="line">  &quot;data&quot;: null,</span><br><span class="line">  &quot;message&quot;: &quot;用户不存在&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 404; Time: 41ms; Content length: 47 bytes</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line"></span><br><span class="line">GET http:&#x2F;&#x2F;localhost:8080&#x2F;user&#x2F;99</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Mon, 19 Nov 2018 16:47:09 GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;success&quot;: true,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: 99,</span><br><span class="line">    &quot;name&quot;: &quot;狗蛋&quot;,</span><br><span class="line">    &quot;age&quot;: 18</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;message&quot;: null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 140ms; Content length: 69 bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h2><p>其实 <code>spring-boot</code> 的构建大部分都是一致的，上面前几步基本和简单的 <code>web</code> 项目一致，最重要的一步就是监听到不同的异常，然后返回不同的状态码以及输出信息。 因为现在大部分项目都是微服务架构的，所以建议对自己公司内部整理一个基本的框架，包含有不同异常的，基本输出类的，以及这个 <code>ControllerAdvice</code> 的配置。在微服务中，只要对此框架进行依赖，即可拥有上面的功能。 常用状态码：</p>
<p>状态码</p>
<p>说明</p>
<p>200</p>
<p>请求成功（多用于 <code>get</code> 请求资源、<code>put</code> 更新资源）</p>
<p>201</p>
<p>创建成功（多用于 <code>post</code> 创建资源）</p>
<p>400</p>
<p>请求错误，参数格式不正确或者参数不符合验证要求</p>
<p>404</p>
<p>未找到，资源不存在或者</p>
<p>500</p>
<p>服务器出现问题</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%85%A5%E9%97%A8-web-%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%85%A5%E9%97%A8-web-%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">一个简单的入门 web 项目</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-20 08:42:40" itemprop="dateCreated datePublished" datetime="2018-12-20T08:42:40+08:00">2018-12-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 15:25:16" itemprop="dateModified" datetime="2020-11-10T15:25:16+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一个简单的入门-web-项目"><a href="#一个简单的入门-web-项目" class="headerlink" title="一个简单的入门 web 项目"></a>一个简单的入门 web 项目</h1><p>[toc]</p>
<h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>其实，<code>spring</code> 在我们职业生涯中，大部分只做一件事情，那就是：<code>web</code> 项目 <code>bean</code> 的管理和整合。所以，<code>web</code> 应用是至关重要的，本文将从一个简单的 <code>hello world</code> 开始 <code>web</code> 的构建。 <strong>示例代码：<code>web-simple</code></strong></p>
<h2 id="二-开发"><a href="#二-开发" class="headerlink" title="二. 开发"></a>二. 开发</h2><h3 id="1-mvn-新增-web-starter-的依赖"><a href="#1-mvn-新增-web-starter-的依赖" class="headerlink" title="1. mvn 新增 web-starter 的依赖"></a>1. <code>mvn</code> 新增 <code>web-starter</code> 的依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- 引入 web-starter --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/frame/spring-boot/%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%85%A5%E9%97%A8-web-%E9%A1%B9%E7%9B%AE/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/%E4%BB%80%E4%B9%88%E6%98%AF-spring-boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/%E4%BB%80%E4%B9%88%E6%98%AF-spring-boot/" class="post-title-link" itemprop="url">什么是 spring-boot</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-20 08:38:05" itemprop="dateCreated datePublished" datetime="2018-12-20T08:38:05+08:00">2018-12-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 15:15:38" itemprop="dateModified" datetime="2020-11-10T15:15:38+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="什么是-spring-boot"><a href="#什么是-spring-boot" class="headerlink" title="什么是 spring-boot"></a>什么是 <code>spring-boot</code></h1><p>[toc]</p>
<h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>用了一年多的 <code>spring-boot</code> 进行项目开发了，我想我有必要把平时开发遇到的，我自己个人在项目中要求 <code>spring-boot</code> 做到的整理成一份主题博客。一来整理一下用了 <code>spring-boot</code> 这么久以来的收获，二来也好给自己有个知识的重新整理和归纳。</p>
<h2 id="二-spring-boot-介绍"><a href="#二-spring-boot-介绍" class="headerlink" title="二. spring-boot 介绍"></a>二. spring-boot 介绍</h2><p>讲真，项目还在用 <code>spring</code> 的时候，听说别人在用 <code>spring-boot</code> 感觉，哇塞，好高大上的样子。于是乎我就去百度了解一圈，查了一下相关资料，按照我印象中来说：<code>spring-boot</code> 就是官方为了解决经常在项目中整合第三方中间件的时候，需要配置一堆 <code>xml</code> 的麻烦，开发出来的，通过非常简单的依赖和配置，从而完成与第三方中间件的整合，也可以解决常常因为版本的不兼容导致项目的出错，也可以减轻项目开发中对 <code>spring</code> 的重量级配置（这句话我下面会反驳）。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/frame/spring-boot/%E4%BB%80%E4%B9%88%E6%98%AF-spring-boot/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/%E5%BE%AE%E6%9C%8D%E5%8A%A1feign%E6%9C%AC%E5%9C%B0%E5%A5%91%E7%BA%A6%E6%B5%8B%E8%AF%95-springcloudcontract/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/%E5%BE%AE%E6%9C%8D%E5%8A%A1feign%E6%9C%AC%E5%9C%B0%E5%A5%91%E7%BA%A6%E6%B5%8B%E8%AF%95-springcloudcontract/" class="post-title-link" itemprop="url">微服务Feign本地契约测试--SpringCloudContract</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-11 15:48:22" itemprop="dateCreated datePublished" datetime="2018-12-11T15:48:22+08:00">2018-12-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 15:24:25" itemprop="dateModified" datetime="2020-11-10T15:24:25+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>在项目开发的时候，特别是使用 <code>TDD</code> 进行开发的项目，测试便是不可或缺的一个环节。然而我们的服务一般都需要配合其他服务接口来进行开发，那么测试的时候就需要开启所有服务来配合测试，机器配置跟不上，在构建的时候也会出现很多问题。 这时候就需要有一个东西来把调用第三方接口的事情给做了。最近看了<code>Clossoverjie</code>的一篇文章 <a target="_blank" rel="noopener" href="https://crossoverjie.top/2018/10/15/SpringBoot/SpringBoot-tips/#more">分享几个 SpringBoot 实用的小技巧</a>，他很巧妙的利用 <code>Spring</code> 的容器把连接第三方接口的 <code>bean</code> 给替换掉。但我感觉始终还不是那么优雅（嗯，<code>Spring</code> 脑残粉，<code>Spring</code> 提供了就会用）。 现在 <code>Spring-Cloud</code> 提供了一个插件，<code>Spring-Cloud-Contract</code> 可以巧妙的对消费者项目进行打桩，让项目的测试调用访问的时候，可以模拟第三方业务，这也需要生产者提供一个 <code>Contract</code> 来使用。（当然，挺适合我这种一个人开发多个服务的开发者） </p>
<h2 id="一-简述-1"><a href="#一-简述-1" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>在项目开发的时候，特别是使用 <code>TDD</code> 进行开发的项目，测试便是不可或缺的一个环节。然而我们的服务一般都需要配合其他服务接口来进行开发，那么测试的时候就需要开启所有服务来配合测试，机器配置跟不上，在构建的时候也会出现很多问题。 这时候就需要有一个东西来把调用第三方接口的事情给做了。最近看了<code>Clossoverjie</code>的一篇文章 <a target="_blank" rel="noopener" href="https://crossoverjie.top/2018/10/15/SpringBoot/SpringBoot-tips/#more">分享几个 SpringBoot 实用的小技巧</a>，他很巧妙的利用 <code>Spring</code> 的容器把连接第三方接口的 <code>bean</code> 给替换掉。但我感觉始终还不是那么优雅（嗯，<code>Spring</code> 脑残粉，<code>Spring</code> 提供了就会用）。 现在 <code>Spring-Cloud</code> 提供了一个插件，<code>Spring-Cloud-Contract</code> 可以巧妙的对消费者项目进行打桩，让项目的测试调用访问的时候，可以模拟第三方业务，这也需要生产者提供一个 <code>Contract</code> 来使用。（当然，挺适合我这种一个人开发多个服务的开发者） </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152339.png"></p>
<h2 id="二-搭建一个环境"><a href="#二-搭建一个环境" class="headerlink" title="二. 搭建一个环境"></a>二. 搭建一个环境</h2><p>OK，演示需要有个大概的业务示例来做。 我这里模拟了订单服务需要从产品服务获取产品的描述（不要吐槽，随便想到罢了）。那么调用订单服务就需要调用到产品服务了，我将演示如何在订单服务中将产品服务给 <code>Mock</code> 掉。 项目情况：</p>
<ul>
<li>Eureka: 注册中心</li>
<li>product-server：产品服务</li>
<li>order-server：订单服务</li>
<li>SpringCloud：<code>Edgware.SR3</code></li>
<li>SpringBoot：<code>1.5.10.RELEASE</code></li>
</ul>
<h3 id="2-1-订单服务"><a href="#2-1-订单服务" class="headerlink" title="2.1 订单服务"></a>2.1 订单服务</h3><p>获取一个订单的时候，需要获取产品信息的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProductClient productClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderEndpoint</span><span class="params">(ProductClient productClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.productClient = productClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">get</span><span class="params">(<span class="meta">@RequestParam(&quot;productUuid&quot;)</span> String productUuid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里需要调用产品服务接口来获取产品信息</span></span><br><span class="line">        ProductDesciption productDesciption = productClient.uuidOf(productUuid);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Order(UUID.randomUUID().toString(), productDesciption);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 产品客户端</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;product-server&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function">ProductDesciption <span class="title">uuidOf</span><span class="params">(<span class="meta">@RequestParam(&quot;uuid&quot;)</span> String uuid)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订单DTO类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProductDesciption productDesciption;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 产品类，用于接收上游接口返回的信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductDesciption</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-产品服务"><a href="#2-2-产品服务" class="headerlink" title="2.2 产品服务"></a>2.2 产品服务</h3><p>产品服务随意的提供了产品信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">uuidOf</span><span class="params">(<span class="meta">@RequestParam(&quot;uuid&quot;)</span> String uuid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (uuid) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Product(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;电视&quot;</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Product(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;iPhone&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Product();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-请求订单接口"><a href="#2-3-请求订单接口" class="headerlink" title="2.3 请求订单接口"></a>2.3 请求订单接口</h3><p>我用了 <code>idea</code> 自带的 <code>HTTP</code> 工具来测试接口，返回正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET http:&#x2F;&#x2F;127.0.0.1:8082?productUuid&#x3D;1</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">X-Application-Context: order-server:8082</span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Tue, 11 Dec 2018 02:41:59 GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;uuid&quot;: &quot;53ddfe48-0bf9-43d9-abb5-65a59468a5b5&quot;,</span><br><span class="line">  &quot;productDesciption&quot;: &#123;</span><br><span class="line">    &quot;prodName&quot;: &quot;电视&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三-生产者提供contract包"><a href="#三-生产者提供contract包" class="headerlink" title="三. 生产者提供contract包"></a>三. 生产者提供contract包</h2><h3 id="3-1-引入相关包"><a href="#3-1-引入相关包" class="headerlink" title="3.1 引入相关包"></a>3.1 引入相关包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--契约测试服务提供端依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-contract-verifier&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--以下需要放在 plugins 标签中--&gt;</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-contract-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;!-- Don&#39;t forget about this value !! --&gt;</span><br><span class="line">    &lt;extensions&gt;true&lt;&#x2F;extensions&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;!-- MvcMockTest为生成本地测试案例的基类 --&gt;</span><br><span class="line">        &lt;baseClassForTests&gt;com.springboot.services.producer.MvcMockTest&lt;&#x2F;baseClassForTests&gt;</span><br><span class="line">    &lt;&#x2F;configuration&gt;</span><br><span class="line">&lt;&#x2F;plugin&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-编写-Contract"><a href="#3-1-编写-Contract" class="headerlink" title="3.1 编写 Contract"></a>3.1 编写 <code>Contract</code></h3><p>可以使用 <code>groovy</code> 或者 <code>yaml</code> 进行编写，我就提供 <code>groovy</code> 版本了。 需要放在 <code>src/test/resources/contracts/ProductEndpoint.groovy</code> 中，注意资源包下的那个目录。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> contracts</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.contract.spec.Contract</span><br><span class="line"></span><br><span class="line">Contract.make &#123;</span><br><span class="line">    request &#123;</span><br><span class="line">        <span class="comment">// 请求方法</span></span><br><span class="line">        method <span class="string">&#x27;GET&#x27;</span></span><br><span class="line">        <span class="comment">// 路径</span></span><br><span class="line">        url(<span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            queryParameters &#123;</span><br><span class="line">                parameter(<span class="string">&quot;uuid&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    response &#123; <span class="comment">// 响应设置</span></span><br><span class="line">        status <span class="number">200</span></span><br><span class="line">        body(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">              &quot;uuid&quot;: &quot;1&quot;,</span></span><br><span class="line"><span class="string">              &quot;prodName&quot;: &quot;电视&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span>)</span><br><span class="line">        headers &#123;</span><br><span class="line">            header(<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json;charset=UTF-8&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-2-生成桩"><a href="#3-2-生成桩" class="headerlink" title="3.2 生成桩"></a>3.2 生成桩</h3><p>生成 <code>Mapping.json</code>，放在<code>product-server/target/stubs/META-INF/cn.liweidan.contract/product-server/1.0.0-SNAPSHOT/mappings/ProductEndpoint.json</code> 中，里面是对请求响应的设定</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd product-server # pom.xml 所在目录</span><br><span class="line">mvn spring-cloud-contract:convert # 转换成mapping.json</span><br><span class="line">mvn spring-cloud-contract:generateStubs # 生成 jar 包</span><br><span class="line">mvn install:install-file -DgroupId=cn.liweidan.contract \</span><br><span class="line">    -DartifactId=product-server -Dversion=1.0.0-SNAPSHOT \</span><br><span class="line">    -Dpackaging=jar -Dclassifier=stubs -Dfile=target/product-server-1.0.0-SNAPSHOT-stubs.jar # 安装到本地仓库</span><br></pre></td></tr></table></figure>

<p>OK，已经将 <code>product-server</code> 的桩打进 <code>maven</code> 仓库了，现在可以在消费者那边进行使用</p>
<h2 id="四-消费者使用contract包"><a href="#四-消费者使用contract包" class="headerlink" title="四. 消费者使用contract包"></a>四. 消费者使用contract包</h2><h3 id="4-1-引入相关包"><a href="#4-1-引入相关包" class="headerlink" title="4.1 引入相关包"></a>4.1 引入相关包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- SpringBoot 测试 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--契约测试服务提供端依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-contract-stub-runner&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-编写测试类"><a href="#4-2-编写测试类" class="headerlink" title="4.2 编写测试类"></a>4.2 编写测试类</h3><p>这里跟参考资料作者写的就有点区别了，可能是因为升级了版本 <code>@AutoConfigureStubRunner</code> 的 <code>stubsMode</code> 属性已经取消了。 这里是去 <code>maven</code> 仓库查找。 <code>ids</code> 属性指定的是刚刚打包的桩的坐标 格式是：<code>groupId:artifactId:version:classifier:port</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.liweidan.contract.order.endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.hamcrest.core.Is;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.contract.stubrunner.spring.AutoConfigureStubRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：测试订单端口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018-12-11 12:02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="comment">// ids 指定需要打桩的服务，记住写 workOffline</span></span><br><span class="line"><span class="meta">@AutoConfigureStubRunner(ids = &#123;&quot;cn.liweidan.contract:product-server:1.0.0-SNAPSHOT:stubs:9080&quot;&#125;, workOffline = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderEndpointTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetOrder</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mvc.perform(MockMvcRequestBuilders.get(<span class="string">&quot;/&quot;</span>).param(<span class="string">&quot;productUuid&quot;</span>, <span class="string">&quot;1&quot;</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;productDesciption.prodName&quot;</span>, Is.is(<span class="string">&quot;电视&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-3-配置服务名称"><a href="#4-3-配置服务名称" class="headerlink" title="4.3 配置服务名称"></a>4.3 配置服务名称</h3><p>我已经顺便把测试的时候把 <code>eureka</code> 的链接关闭了。 完整配置（<code>test/resources</code>）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-server</span></span><br><span class="line"><span class="attr">stubrunner:</span></span><br><span class="line">  <span class="attr">idsToServiceIds:</span> <span class="comment"># 用于指定 feign 名字对应的 stubs 包。前面是 stubs 包的 artifactId，后面是  feign 名字</span></span><br><span class="line">    <span class="attr">product-server:</span> <span class="string">product-server</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-运行测试"><a href="#4-4-运行测试" class="headerlink" title="4.4 运行测试"></a>4.4 运行测试</h3><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152411.png"></p>
<p>OK，单机测试可以用过了。 当然测试还包括数据库使用内存数据库等等，可以防止在 <code>maven</code> 编译的时候报错，这块其他文章再说</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-cloud-contract-demo">示例代码</a> <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015555626">基于Feign的微服务调用之契约测试 Spring Cloud Contract</a> <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-contract/single/spring-cloud-contract.html#contract-dsl">Contract-dsl</a> <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html">SpringCloudContractDocs</a></p>
<h2 id="二-搭建一个环境-1"><a href="#二-搭建一个环境-1" class="headerlink" title="二. 搭建一个环境"></a>二. 搭建一个环境</h2><p>OK，演示需要有个大概的业务示例来做。 我这里模拟了订单服务需要从产品服务获取产品的描述（不要吐槽，随便想到罢了）。那么调用订单服务就需要调用到产品服务了，我将演示如何在订单服务中将产品服务给 <code>Mock</code> 掉。 项目情况：</p>
<ul>
<li>Eureka: 注册中心</li>
<li>product-server：产品服务</li>
<li>order-server：订单服务</li>
<li>SpringCloud：<code>Edgware.SR3</code></li>
<li>SpringBoot：<code>1.5.10.RELEASE</code></li>
</ul>
<h3 id="2-1-订单服务-1"><a href="#2-1-订单服务-1" class="headerlink" title="2.1 订单服务"></a>2.1 订单服务</h3><p>获取一个订单的时候，需要获取产品信息的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProductClient productClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderEndpoint</span><span class="params">(ProductClient productClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.productClient = productClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">get</span><span class="params">(<span class="meta">@RequestParam(&quot;productUuid&quot;)</span> String productUuid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里需要调用产品服务接口来获取产品信息</span></span><br><span class="line">        ProductDesciption productDesciption = productClient.uuidOf(productUuid);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Order(UUID.randomUUID().toString(), productDesciption);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 产品客户端</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;product-server&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function">ProductDesciption <span class="title">uuidOf</span><span class="params">(<span class="meta">@RequestParam(&quot;uuid&quot;)</span> String uuid)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订单DTO类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProductDesciption productDesciption;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 产品类，用于接收上游接口返回的信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductDesciption</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-产品服务-1"><a href="#2-2-产品服务-1" class="headerlink" title="2.2 产品服务"></a>2.2 产品服务</h3><p>产品服务随意的提供了产品信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">uuidOf</span><span class="params">(<span class="meta">@RequestParam(&quot;uuid&quot;)</span> String uuid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (uuid) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Product(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;电视&quot;</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Product(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;iPhone&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Product();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-请求订单接口-1"><a href="#2-3-请求订单接口-1" class="headerlink" title="2.3 请求订单接口"></a>2.3 请求订单接口</h3><p>我用了 <code>idea</code> 自带的 <code>HTTP</code> 工具来测试接口，返回正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET http:&#x2F;&#x2F;127.0.0.1:8082?productUuid&#x3D;1</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">X-Application-Context: order-server:8082</span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Tue, 11 Dec 2018 02:41:59 GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;uuid&quot;: &quot;53ddfe48-0bf9-43d9-abb5-65a59468a5b5&quot;,</span><br><span class="line">  &quot;productDesciption&quot;: &#123;</span><br><span class="line">    &quot;prodName&quot;: &quot;电视&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三-生产者提供contract包-1"><a href="#三-生产者提供contract包-1" class="headerlink" title="三. 生产者提供contract包"></a>三. 生产者提供contract包</h2><h3 id="3-1-引入相关包-1"><a href="#3-1-引入相关包-1" class="headerlink" title="3.1 引入相关包"></a>3.1 引入相关包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--契约测试服务提供端依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-contract-verifier&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--以下需要放在 plugins 标签中--&gt;</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-contract-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;!-- Don&#39;t forget about this value !! --&gt;</span><br><span class="line">    &lt;extensions&gt;true&lt;&#x2F;extensions&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;!-- MvcMockTest为生成本地测试案例的基类 --&gt;</span><br><span class="line">        &lt;baseClassForTests&gt;com.springboot.services.producer.MvcMockTest&lt;&#x2F;baseClassForTests&gt;</span><br><span class="line">    &lt;&#x2F;configuration&gt;</span><br><span class="line">&lt;&#x2F;plugin&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-编写-Contract-1"><a href="#3-1-编写-Contract-1" class="headerlink" title="3.1 编写 Contract"></a>3.1 编写 <code>Contract</code></h3><p>可以使用 <code>groovy</code> 或者 <code>yaml</code> 进行编写，我就提供 <code>groovy</code> 版本了。 需要放在 <code>src/test/resources/contracts/ProductEndpoint.groovy</code> 中，注意资源包下的那个目录。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> contracts</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.contract.spec.Contract</span><br><span class="line"></span><br><span class="line">Contract.make &#123;</span><br><span class="line">    request &#123;</span><br><span class="line">        <span class="comment">// 请求方法</span></span><br><span class="line">        method <span class="string">&#x27;GET&#x27;</span></span><br><span class="line">        <span class="comment">// 路径</span></span><br><span class="line">        url(<span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            queryParameters &#123;</span><br><span class="line">                parameter(<span class="string">&quot;uuid&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    response &#123; <span class="comment">// 响应设置</span></span><br><span class="line">        status <span class="number">200</span></span><br><span class="line">        body(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">              &quot;uuid&quot;: &quot;1&quot;,</span></span><br><span class="line"><span class="string">              &quot;prodName&quot;: &quot;电视&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span>)</span><br><span class="line">        headers &#123;</span><br><span class="line">            header(<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json;charset=UTF-8&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-2-生成桩-1"><a href="#3-2-生成桩-1" class="headerlink" title="3.2 生成桩"></a>3.2 生成桩</h3><p>生成 <code>Mapping.json</code>，放在<code>product-server/target/stubs/META-INF/cn.liweidan.contract/product-server/1.0.0-SNAPSHOT/mappings/ProductEndpoint.json</code> 中，里面是对请求响应的设定</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd product-server # pom.xml 所在目录</span><br><span class="line">mvn spring-cloud-contract:convert # 转换成mapping.json</span><br><span class="line">mvn spring-cloud-contract:generateStubs # 生成 jar 包</span><br><span class="line">mvn install:install-file -DgroupId=cn.liweidan.contract \</span><br><span class="line">    -DartifactId=product-server -Dversion=1.0.0-SNAPSHOT \</span><br><span class="line">    -Dpackaging=jar -Dclassifier=stubs -Dfile=target/product-server-1.0.0-SNAPSHOT-stubs.jar # 安装到本地仓库</span><br></pre></td></tr></table></figure>

<p>OK，已经将 <code>product-server</code> 的桩打进 <code>maven</code> 仓库了，现在可以在消费者那边进行使用</p>
<h2 id="四-消费者使用contract包-1"><a href="#四-消费者使用contract包-1" class="headerlink" title="四. 消费者使用contract包"></a>四. 消费者使用contract包</h2><h3 id="4-1-引入相关包-1"><a href="#4-1-引入相关包-1" class="headerlink" title="4.1 引入相关包"></a>4.1 引入相关包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- SpringBoot 测试 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--契约测试服务提供端依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-contract-stub-runner&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-编写测试类-1"><a href="#4-2-编写测试类-1" class="headerlink" title="4.2 编写测试类"></a>4.2 编写测试类</h3><p>这里跟参考资料作者写的就有点区别了，可能是因为升级了版本 <code>@AutoConfigureStubRunner</code> 的 <code>stubsMode</code> 属性已经取消了。 这里是去 <code>maven</code> 仓库查找。 <code>ids</code> 属性指定的是刚刚打包的桩的坐标 格式是：<code>groupId:artifactId:version:classifier:port</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.liweidan.contract.order.endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.hamcrest.core.Is;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.contract.stubrunner.spring.AutoConfigureStubRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：测试订单端口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018-12-11 12:02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="comment">// ids 指定需要打桩的服务，记住写 workOffline</span></span><br><span class="line"><span class="meta">@AutoConfigureStubRunner(ids = &#123;&quot;cn.liweidan.contract:product-server:1.0.0-SNAPSHOT:stubs:9080&quot;&#125;, workOffline = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderEndpointTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetOrder</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mvc.perform(MockMvcRequestBuilders.get(<span class="string">&quot;/&quot;</span>).param(<span class="string">&quot;productUuid&quot;</span>, <span class="string">&quot;1&quot;</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;productDesciption.prodName&quot;</span>, Is.is(<span class="string">&quot;电视&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-3-配置服务名称-1"><a href="#4-3-配置服务名称-1" class="headerlink" title="4.3 配置服务名称"></a>4.3 配置服务名称</h3><p>我已经顺便把测试的时候把 <code>eureka</code> 的链接关闭了。 完整配置（<code>test/resources</code>）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-server</span></span><br><span class="line"><span class="attr">stubrunner:</span></span><br><span class="line">  <span class="attr">idsToServiceIds:</span> <span class="comment"># 用于指定 feign 名字对应的 stubs 包。前面是 stubs 包的 artifactId，后面是  feign 名字</span></span><br><span class="line">    <span class="attr">product-server:</span> <span class="string">product-server</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-运行测试-1"><a href="#4-4-运行测试-1" class="headerlink" title="4.4 运行测试"></a>4.4 运行测试</h3><h2 id="一-简述-2"><a href="#一-简述-2" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>在项目开发的时候，特别是使用 <code>TDD</code> 进行开发的项目，测试便是不可或缺的一个环节。然而我们的服务一般都需要配合其他服务接口来进行开发，那么测试的时候就需要开启所有服务来配合测试，机器配置跟不上，在构建的时候也会出现很多问题。 这时候就需要有一个东西来把调用第三方接口的事情给做了。最近看了<code>Clossoverjie</code>的一篇文章 <a target="_blank" rel="noopener" href="https://crossoverjie.top/2018/10/15/SpringBoot/SpringBoot-tips/#more">分享几个 SpringBoot 实用的小技巧</a>，他很巧妙的利用 <code>Spring</code> 的容器把连接第三方接口的 <code>bean</code> 给替换掉。但我感觉始终还不是那么优雅（嗯，<code>Spring</code> 脑残粉，<code>Spring</code> 提供了就会用）。 现在 <code>Spring-Cloud</code> 提供了一个插件，<code>Spring-Cloud-Contract</code> 可以巧妙的对消费者项目进行打桩，让项目的测试调用访问的时候，可以模拟第三方业务，这也需要生产者提供一个 <code>Contract</code> 来使用。（当然，挺适合我这种一个人开发多个服务的开发者） </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152339.png"></p>
<h2 id="二-搭建一个环境-2"><a href="#二-搭建一个环境-2" class="headerlink" title="二. 搭建一个环境"></a>二. 搭建一个环境</h2><p>OK，演示需要有个大概的业务示例来做。 我这里模拟了订单服务需要从产品服务获取产品的描述（不要吐槽，随便想到罢了）。那么调用订单服务就需要调用到产品服务了，我将演示如何在订单服务中将产品服务给 <code>Mock</code> 掉。 项目情况：</p>
<ul>
<li>Eureka: 注册中心</li>
<li>product-server：产品服务</li>
<li>order-server：订单服务</li>
<li>SpringCloud：<code>Edgware.SR3</code></li>
<li>SpringBoot：<code>1.5.10.RELEASE</code></li>
</ul>
<h3 id="2-1-订单服务-2"><a href="#2-1-订单服务-2" class="headerlink" title="2.1 订单服务"></a>2.1 订单服务</h3><p>获取一个订单的时候，需要获取产品信息的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProductClient productClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderEndpoint</span><span class="params">(ProductClient productClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.productClient = productClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">get</span><span class="params">(<span class="meta">@RequestParam(&quot;productUuid&quot;)</span> String productUuid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里需要调用产品服务接口来获取产品信息</span></span><br><span class="line">        ProductDesciption productDesciption = productClient.uuidOf(productUuid);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Order(UUID.randomUUID().toString(), productDesciption);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 产品客户端</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;product-server&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function">ProductDesciption <span class="title">uuidOf</span><span class="params">(<span class="meta">@RequestParam(&quot;uuid&quot;)</span> String uuid)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订单DTO类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProductDesciption productDesciption;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 产品类，用于接收上游接口返回的信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductDesciption</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-产品服务-2"><a href="#2-2-产品服务-2" class="headerlink" title="2.2 产品服务"></a>2.2 产品服务</h3><p>产品服务随意的提供了产品信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">uuidOf</span><span class="params">(<span class="meta">@RequestParam(&quot;uuid&quot;)</span> String uuid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (uuid) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Product(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;电视&quot;</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Product(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;iPhone&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Product();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter&amp;setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-请求订单接口-2"><a href="#2-3-请求订单接口-2" class="headerlink" title="2.3 请求订单接口"></a>2.3 请求订单接口</h3><p>我用了 <code>idea</code> 自带的 <code>HTTP</code> 工具来测试接口，返回正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET http:&#x2F;&#x2F;127.0.0.1:8082?productUuid&#x3D;1</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 </span><br><span class="line">X-Application-Context: order-server:8082</span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Tue, 11 Dec 2018 02:41:59 GMT</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;uuid&quot;: &quot;53ddfe48-0bf9-43d9-abb5-65a59468a5b5&quot;,</span><br><span class="line">  &quot;productDesciption&quot;: &#123;</span><br><span class="line">    &quot;prodName&quot;: &quot;电视&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三-生产者提供contract包-2"><a href="#三-生产者提供contract包-2" class="headerlink" title="三. 生产者提供contract包"></a>三. 生产者提供contract包</h2><h3 id="3-1-引入相关包-2"><a href="#3-1-引入相关包-2" class="headerlink" title="3.1 引入相关包"></a>3.1 引入相关包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--契约测试服务提供端依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-contract-verifier&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--以下需要放在 plugins 标签中--&gt;</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-contract-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;!-- Don&#39;t forget about this value !! --&gt;</span><br><span class="line">    &lt;extensions&gt;true&lt;&#x2F;extensions&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;!-- MvcMockTest为生成本地测试案例的基类 --&gt;</span><br><span class="line">        &lt;baseClassForTests&gt;com.springboot.services.producer.MvcMockTest&lt;&#x2F;baseClassForTests&gt;</span><br><span class="line">    &lt;&#x2F;configuration&gt;</span><br><span class="line">&lt;&#x2F;plugin&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-编写-Contract-2"><a href="#3-1-编写-Contract-2" class="headerlink" title="3.1 编写 Contract"></a>3.1 编写 <code>Contract</code></h3><p>可以使用 <code>groovy</code> 或者 <code>yaml</code> 进行编写，我就提供 <code>groovy</code> 版本了。 需要放在 <code>src/test/resources/contracts/ProductEndpoint.groovy</code> 中，注意资源包下的那个目录。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> contracts</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.contract.spec.Contract</span><br><span class="line"></span><br><span class="line">Contract.make &#123;</span><br><span class="line">    request &#123;</span><br><span class="line">        <span class="comment">// 请求方法</span></span><br><span class="line">        method <span class="string">&#x27;GET&#x27;</span></span><br><span class="line">        <span class="comment">// 路径</span></span><br><span class="line">        url(<span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            queryParameters &#123;</span><br><span class="line">                parameter(<span class="string">&quot;uuid&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    response &#123; <span class="comment">// 响应设置</span></span><br><span class="line">        status <span class="number">200</span></span><br><span class="line">        body(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">              &quot;uuid&quot;: &quot;1&quot;,</span></span><br><span class="line"><span class="string">              &quot;prodName&quot;: &quot;电视&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span>)</span><br><span class="line">        headers &#123;</span><br><span class="line">            header(<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json;charset=UTF-8&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-2-生成桩-2"><a href="#3-2-生成桩-2" class="headerlink" title="3.2 生成桩"></a>3.2 生成桩</h3><p>生成 <code>Mapping.json</code>，放在<code>product-server/target/stubs/META-INF/cn.liweidan.contract/product-server/1.0.0-SNAPSHOT/mappings/ProductEndpoint.json</code> 中，里面是对请求响应的设定</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd product-server # pom.xml 所在目录</span><br><span class="line">mvn spring-cloud-contract:convert # 转换成mapping.json</span><br><span class="line">mvn spring-cloud-contract:generateStubs # 生成 jar 包</span><br><span class="line">mvn install:install-file -DgroupId=cn.liweidan.contract \</span><br><span class="line">    -DartifactId=product-server -Dversion=1.0.0-SNAPSHOT \</span><br><span class="line">    -Dpackaging=jar -Dclassifier=stubs -Dfile=target/product-server-1.0.0-SNAPSHOT-stubs.jar # 安装到本地仓库</span><br></pre></td></tr></table></figure>

<p>OK，已经将 <code>product-server</code> 的桩打进 <code>maven</code> 仓库了，现在可以在消费者那边进行使用</p>
<h2 id="四-消费者使用contract包-2"><a href="#四-消费者使用contract包-2" class="headerlink" title="四. 消费者使用contract包"></a>四. 消费者使用contract包</h2><h3 id="4-1-引入相关包-2"><a href="#4-1-引入相关包-2" class="headerlink" title="4.1 引入相关包"></a>4.1 引入相关包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- SpringBoot 测试 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--契约测试服务提供端依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-contract-stub-runner&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-编写测试类-2"><a href="#4-2-编写测试类-2" class="headerlink" title="4.2 编写测试类"></a>4.2 编写测试类</h3><p>这里跟参考资料作者写的就有点区别了，可能是因为升级了版本 <code>@AutoConfigureStubRunner</code> 的 <code>stubsMode</code> 属性已经取消了。 这里是去 <code>maven</code> 仓库查找。 <code>ids</code> 属性指定的是刚刚打包的桩的坐标 格式是：<code>groupId:artifactId:version:classifier:port</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.liweidan.contract.order.endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.hamcrest.core.Is;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.contract.stubrunner.spring.AutoConfigureStubRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description：测试订单端口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liweidan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018-12-11 12:02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> toweidan@126.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="comment">// ids 指定需要打桩的服务，记住写 workOffline</span></span><br><span class="line"><span class="meta">@AutoConfigureStubRunner(ids = &#123;&quot;cn.liweidan.contract:product-server:1.0.0-SNAPSHOT:stubs:9080&quot;&#125;, workOffline = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderEndpointTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetOrder</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mvc.perform(MockMvcRequestBuilders.get(<span class="string">&quot;/&quot;</span>).param(<span class="string">&quot;productUuid&quot;</span>, <span class="string">&quot;1&quot;</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;productDesciption.prodName&quot;</span>, Is.is(<span class="string">&quot;电视&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-3-配置服务名称-2"><a href="#4-3-配置服务名称-2" class="headerlink" title="4.3 配置服务名称"></a>4.3 配置服务名称</h3><p>我已经顺便把测试的时候把 <code>eureka</code> 的链接关闭了。 完整配置（<code>test/resources</code>）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-server</span></span><br><span class="line"><span class="attr">stubrunner:</span></span><br><span class="line">  <span class="attr">idsToServiceIds:</span> <span class="comment"># 用于指定 feign 名字对应的 stubs 包。前面是 stubs 包的 artifactId，后面是  feign 名字</span></span><br><span class="line">    <span class="attr">product-server:</span> <span class="string">product-server</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-运行测试-2"><a href="#4-4-运行测试-2" class="headerlink" title="4.4 运行测试"></a>4.4 运行测试</h3><p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152411.png"></p>
<p>OK，单机测试可以用过了。 当然测试还包括数据库使用内存数据库等等，可以防止在 <code>maven</code> 编译的时候报错，这块其他文章再说</p>
<h2 id="参考资料-1"><a href="#参考资料-1" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-cloud-contract-demo">示例代码</a> <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015555626">基于Feign的微服务调用之契约测试 Spring Cloud Contract</a> <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-contract/single/spring-cloud-contract.html#contract-dsl">Contract-dsl</a> <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html">SpringCloudContractDocs</a></p>
<p>OK，单机测试可以用过了。 当然测试还包括数据库使用内存数据库等等，可以防止在 <code>maven</code> 编译的时候报错，这块其他文章再说</p>
<h2 id="参考资料-2"><a href="#参考资料-2" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/WeidanLi/spring-cloud-contract-demo">示例代码</a> <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015555626">基于Feign的微服务调用之契约测试 Spring Cloud Contract</a> <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-contract/single/spring-cloud-contract.html#contract-dsl">Contract-dsl</a> <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html">SpringCloudContractDocs</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/spring-boot-%E4%BD%BF%E7%94%A8-jpa-%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/spring-boot-%E4%BD%BF%E7%94%A8-jpa-%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE/" class="post-title-link" itemprop="url">spring-boot 使用 jpa 进行数据库访问</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-08-30 08:41:53" itemprop="dateCreated datePublished" datetime="2018-08-30T08:41:53+08:00">2018-08-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:34:56" itemprop="dateModified" datetime="2020-11-10T16:34:56+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>因为已经编写了 <code>web</code> 项目，此项目直接在 <code>web</code> 项目上新增数据库访问。此处使用的访问 <code>orm</code> 层是 <code>spring</code> 官方提供的 <code>spring-data-jpa</code>。 <code>spring-data-jpa</code> 是官方通过使用 <code>java</code> 规范中的 <code>jpa</code> 标准，使用 <code>hibernate</code> 框架作为 <code>orm</code> 层进行的数据库层面的请求访问。众所周知， <code>hibernate</code> 框架是针对数据库层面的面向对象框架，编写一次兼容所有数据库，不过前提是都使用他提供的 <code>hql</code> 或者接口进行编写。 <code>spring</code> 还对其新增了对领域驱动设计的友好支持。</p>
<h2 id="一-在项目中引入依赖"><a href="#一-在项目中引入依赖" class="headerlink" title="一. 在项目中引入依赖"></a>一. 在项目中引入依赖</h2><ol>
<li>引入 <code>spring-boot-starter-data-jpa</code> 框架，便已经让项目支持了数据库连接</li>
<li>数据库驱动</li>
<li>如若需要测试环境，再引入内存数据库以及测试驱动</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 测试支持，可以使用内存数据库 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.h2database&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;h2&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/frame/spring-boot/spring-boot-%E4%BD%BF%E7%94%A8-jpa-%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/frame/spring-boot/spring-boot-%E7%9A%84-web-%E5%BC%80%E5%8F%91%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/frame/spring-boot/spring-boot-%E7%9A%84-web-%E5%BC%80%E5%8F%91%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">spring-boot 的 web 开发项目</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-08-30 08:35:24" itemprop="dateCreated datePublished" datetime="2018-08-30T08:35:24+08:00">2018-08-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 16:30:58" itemprop="dateModified" datetime="2020-11-10T16:30:58+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/" itemprop="url" rel="index"><span itemprop="name">frame</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frame/spring-boot/" itemprop="url" rel="index"><span itemprop="name">spring-boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="spring-boot-的-web-开发项目"><a href="#spring-boot-的-web-开发项目" class="headerlink" title="spring-boot 的 web 开发项目"></a><code>spring-boot</code> 的 <code>web</code> 开发项目</h1><p>[toc]</p>
<h2 id="一-导入-spring-boot-父类依赖"><a href="#一-导入-spring-boot-父类依赖" class="headerlink" title="一. 导入 spring-boot 父类依赖"></a>一. 导入 <code>spring-boot</code> 父类依赖</h2><p>通常来说，使用 <a target="_blank" rel="noopener" href="https://start.spring.io/">官方脚手架</a> 生成的 <code>spring-boot</code> 的父类依赖都是 <code>spring</code> 官方提供的 <code>parent</code> 然而，在实际生产中，这种方法，很少使用。我们更多的时候依赖自己项目中的父类进行生成。所以我们需要在自己的 <code>pom.xml</code> 中导入 <code>spring</code> 官方提供的 <code>parent</code> 即使现在 <code>2.0.0</code> 版本已经出来了，新增了 <code>reactor</code> 功能，但是如果不使用这套功能的话，我依然推荐 <code>1.5.10.RELEASE</code> 版。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;!-- Import dependency management from Spring Boot --&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.5.10.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">            &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">&lt;&#x2F;dependencyManagement&gt;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/frame/spring-boot/spring-boot-%E7%9A%84-web-%E5%BC%80%E5%8F%91%E9%A1%B9%E7%9B%AE/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/computer-basic/asm/%E4%B8%80%E4%B8%AAjava%E7%A8%8B%E5%BA%8F%E7%8C%BF%E7%9C%BC%E4%B8%AD%E7%9A%84%E6%B1%87%E7%BC%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/computer-basic/asm/%E4%B8%80%E4%B8%AAjava%E7%A8%8B%E5%BA%8F%E7%8C%BF%E7%9C%BC%E4%B8%AD%E7%9A%84%E6%B1%87%E7%BC%96/" class="post-title-link" itemprop="url">一个Java程序猿眼中的汇编</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-02-12 17:04:40" itemprop="dateCreated datePublished" datetime="2018-02-12T17:04:40+08:00">2018-02-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-10 15:28:59" itemprop="dateModified" datetime="2020-11-10T15:28:59+08:00">2020-11-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/computer-basic/" itemprop="url" rel="index"><span itemprop="name">computer-basic</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/computer-basic/asm/" itemprop="url" rel="index"><span itemprop="name">asm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、介绍"><a href="#一、介绍" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>在计算机中，CPU只能识别二进制，当需要CPU做事情的时候，都需要通过二进制去指挥CPU做什么事情。古人觉得二进制实在是难以理解，所以才发明了汇编语言以及后面的高级语言，所以汇编语言可以称作为比较接近机器语言的语言了。 当然后面的古人依然觉得汇编语言难以理解，所以发明了C、C++、Java来解决难以理解的问题。所以后面的语言越来越偏于人类自然语言，并且使用面向对象的思想来设计程序。当然这期间经历的事情还挺多：C编译成汇编语言，汇编语言再翻译成二进制语言，这个过程即称为assembling。 学习汇编语言既需要下面两个概念的理解：<strong>内存模型</strong>和<strong>寄存器</strong></p>
<h2 id="二、内存模型"><a href="#二、内存模型" class="headerlink" title="二、内存模型"></a>二、内存模型</h2><h3 id="（一）内存模型的介绍"><a href="#（一）内存模型的介绍" class="headerlink" title="（一）内存模型的介绍"></a>（一）内存模型的介绍</h3><p>内存通常被程序分为两个部分：<strong>堆（Heap）</strong>和<strong>栈（Stack）</strong> 当一个程序开始运行的时候，系统通常会为改程序开辟一块内存空间，而这块内存空间在该程序运行的时候，也会被划分成为上面最常见的两块区域，通常他们的作用如下：</p>
<ol>
<li>堆（Heap）：通常被动态的划分，用来存储程序运行的时候需要存储的数据，当程序结束以后，这块内存将被系统重新回收。当C语言中调用</li>
<li>栈（Stack）：用于存储方法运行中需要使用到的临时变量的空间。Java中的栈，当需要的临时变量如果是对象的情况下，存储的是对象在堆中的引用地址，基本数据类型的话那就是直接存储数据了。</li>
</ol>
<h3 id="（二）堆空间的使用"><a href="#（二）堆空间的使用" class="headerlink" title="（二）堆空间的使用"></a>（二）堆空间的使用</h3><p>（内存模型引用阮老师的图片） 1.当一个程序被启动，系统中会在内存中为改程序划分一块空闲内存： </p>
<h2 id="一、介绍-1"><a href="#一、介绍-1" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>在计算机中，CPU只能识别二进制，当需要CPU做事情的时候，都需要通过二进制去指挥CPU做什么事情。古人觉得二进制实在是难以理解，所以才发明了汇编语言以及后面的高级语言，所以汇编语言可以称作为比较接近机器语言的语言了。 当然后面的古人依然觉得汇编语言难以理解，所以发明了C、C++、Java来解决难以理解的问题。所以后面的语言越来越偏于人类自然语言，并且使用面向对象的思想来设计程序。当然这期间经历的事情还挺多：C编译成汇编语言，汇编语言再翻译成二进制语言，这个过程即称为assembling。 学习汇编语言既需要下面两个概念的理解：<strong>内存模型</strong>和<strong>寄存器</strong></p>
<h2 id="二、内存模型-1"><a href="#二、内存模型-1" class="headerlink" title="二、内存模型"></a>二、内存模型</h2><h3 id="（一）内存模型的介绍-1"><a href="#（一）内存模型的介绍-1" class="headerlink" title="（一）内存模型的介绍"></a>（一）内存模型的介绍</h3><p>内存通常被程序分为两个部分：<strong>堆（Heap）</strong>和<strong>栈（Stack）</strong> 当一个程序开始运行的时候，系统通常会为改程序开辟一块内存空间，而这块内存空间在该程序运行的时候，也会被划分成为上面最常见的两块区域，通常他们的作用如下：</p>
<ol>
<li>堆（Heap）：通常被动态的划分，用来存储程序运行的时候需要存储的数据，当程序结束以后，这块内存将被系统重新回收。当C语言中调用</li>
<li>栈（Stack）：用于存储方法运行中需要使用到的临时变量的空间。Java中的栈，当需要的临时变量如果是对象的情况下，存储的是对象在堆中的引用地址，基本数据类型的话那就是直接存储数据了。</li>
</ol>
<h3 id="（二）堆空间的使用-1"><a href="#（二）堆空间的使用-1" class="headerlink" title="（二）堆空间的使用"></a>（二）堆空间的使用</h3><p>（内存模型引用阮老师的图片） 1.当一个程序被启动，系统中会在内存中为改程序划分一块空闲内存： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152551.jpg"> </p>
<p>这块内存是从低到高进行划分的，当该程序需要分配对象的时候（使用<code>malloc</code>命令），系统将从这块内存的低位开始，按照对象的大小划分一块内存供这个对象存放： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152616.jpg"></p>
<p> 图中的对象中用了32个字节： 具体计算（8进制）： <code>0x1000 + 32 = 0x1020</code> 堆空间必须手动释放或者通过程序的垃圾回收器，如果该对象被GC判定为无用的对象，那么GC将对这块内存进行释放。</p>
<h3 id="（三）栈空间的使用"><a href="#（三）栈空间的使用" class="headerlink" title="（三）栈空间的使用"></a>（三）栈空间的使用</h3><p>栈空间用于存储一个函数运行过程中需要用到的数据的内存。 栈和堆不同的是：栈是从高位开始占用内存的，而且遵从LIFO (Last-In-First-Out)原则。 为啥是先进后出：因为函数调用的时候，最后一个调用的函数是最先结束的： 举个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> a = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，main函数先入栈，其次调用了<code>add_a_and_b(a, b)</code>，该函数入栈。那么是不是<code>add_a_and_b(a, b)</code>函数先执行完成，再把结果返回给<code>main</code>方法，<code>main</code>再运行结束。 栈空间： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152642.jpg"></p>
<h2 id="三、寄存器"><a href="#三、寄存器" class="headerlink" title="三、寄存器"></a>三、寄存器</h2><h3 id="（一）寄存器的介绍"><a href="#（一）寄存器的介绍" class="headerlink" title="（一）寄存器的介绍"></a>（一）寄存器的介绍</h3><p>我们还要知道的另外一件事情是CPU只负责做事情，并不能够存储任何数据，包括运算过程中需要用到的临时数据，都需要通过缓存、内存以及寄存器来存储。 那么何为缓存：缓存是CPU能够够得到的第一级存储物质，再之是内存。为啥有内存了还需要这些东西呢，因为设计者认为，CPU的速度要远快于内存的速度，如果任何数据都通过去读取和写入内存操作的话，就会拖慢CPU的速度，所以在京东或者其他地方购买CPU的时候，是会出现缓存这个东西的： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152657.jpg"></p>
<p> 现在普通一点的CPU都会自带一级缓存二级缓存（图中还有三级缓存= =），说的就是这个事情，当然这个缓存也不是越大越好，仔细想想如果这个缓存过大，那么在同步缓存和内存的数据的时候，是不是也会变慢。这个东西和jvm虚拟机中的堆和栈大小是一致的，如果jvm中堆栈过大，放数据是爽很多了，但是在进行垃圾清理的时候就是悲剧了。 接下来还有寄存器的概念：设计者认为每次需要数据的时候去读取数据，都需要寻址读取，那么还是会变慢很多，那如果把数据的地址存放在一个地方，需要的时候直接取出这个地址，然后再在缓存中去取出来，就会快很多，这个过程就是寄存器需要做的事情了。寄存器相当于用于寄放地址的地方，当程序指示CPU去读取什么数据的时候，CPU优先从寄存器中取出数据的地址，然后从缓存读取数据进行运算。 那么计算机运行的过程相当于： 1. 用户告诉CPU启动一个程序 2. 程序把数据放入系统为其开辟的一块内存空间 3. CPU从内存读取数据放入缓存，以及在寄存器放入缓存数据的地址 4. CPU通过协调内存、寄存器、CPU缓存完成用户继续给予的指令。</p>
<h3 id="（二）寄存器的种类"><a href="#（二）寄存器的种类" class="headerlink" title="（二）寄存器的种类"></a>（二）寄存器的种类</h3><p>一个CPU都会提供多种寄存器，用于存储不同的数据（不同程序使用不同的寄存器），在早期的x86处理器当中，CPU提供9种不同的寄存器，但是程序中可用的只有7中，其中2中用于做特殊作用：</p>
<blockquote>
<p>现在的寄存器已经有100多个了，都变成通用寄存器，不特别指定用途了，但是早期寄存器的名字都被保存了下来。</p>
</blockquote>
<ol>
<li>EAX</li>
<li>EBX</li>
<li>ECX</li>
<li>EDX</li>
<li>EDI</li>
<li>ESI</li>
<li>EBP</li>
<li>ESP 记录内存中栈空间的地址</li>
<li>EIP 记录当前指令执行的位置</li>
</ol>
<p>汇编语言要做的事情就是指挥这些寄存器中做的动作。</p>
<h2 id="四、一个简单的程序"><a href="#四、一个简单的程序" class="headerlink" title="四、一个简单的程序"></a>四、一个简单的程序</h2><p>现在使用一个C语言的代码来表述计算机做了什么事情：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_a_and_b</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行编译，他将会被编译成以下的汇编语言：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_main:</span><br><span class="line">   push 3 ;                        把第二个参数&#39;3&#39;Push（推）进内存</span><br><span class="line">   push 2 ;                        把第一个参数&#39;2&#39;Push进内存</span><br><span class="line">   call _add_a_and_b ;     调用add_a_and_b 函数：并且让当前程序运行的指针（在EIP寄存器中）</span><br><span class="line">                                        指向函数的第一条指令（push %ebx）</span><br><span class="line">   add %esp, 8 ;              将esp指针在栈上向上移动8个字节，弹出我们上面压入的两个值，此时第一个值已经变成计算以后的值了。</span><br><span class="line">   ret ;                               返回到调用main函数的函数中。</span><br><span class="line"></span><br><span class="line">_add_a_and_b:</span><br><span class="line">   push %ebx ;                    程序准备修改ebx寄存器中的值, 所以程序需要将ebx推入栈中</span><br><span class="line">                                            以便让后面程序运行结束以后可以还原数据</span><br><span class="line">   mov %eax, [%esp+8] ;    将第一个参数移入EAX（详看下图可以知道为什么是+8）</span><br><span class="line">   mov %ebx, [%esp+12] ;  将第二个参数移入EBX</span><br><span class="line">   add %eax, %ebx ;           将eax和ebx中的值进行相加，并且把结果存储在eax中</span><br><span class="line">   pop %ebx ;                      将ebx中的值弹出，以便还原ebx中的数据</span><br><span class="line">   ret ;                                   返回到main函数. 这个步骤将会把下一步运行地址弹出到栈内存中</span><br><span class="line">                                             (当call执行完以后的下一步地址) 放入eip寄存器</span><br></pre></td></tr></table></figure>

<p>程序运行的时候，内存模型如下： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152710.jpg"> </p>
<p>第一步：当main开始运行的时候，需要先把临时的值压入栈内存中： 所以有两个参数<code>3和2</code>被压入占中，这就是栈内存中前两个的值的地址。 第二步：临时变量已经准备好了，我们要把main函数压入栈中，因为main函数一共有四条指令，而一条指令只用<code>4</code>个字节，所以一共有16个字节被压入栈中 第三步：因为在函数<code>_add_a_and_b</code>中，我们用到了中间寄存器用来计算ebx，所以ebx被压入栈中。 经过了这三个步骤，那么esp（程序运行指针）被多次往下移动了16个字节，其中包括main函数四条命令4个字节以及两个参数8个字节，还有一个临时寄存器使用了4个字节， 当然图中那么画还不够具体。</p>
<p>首先main函数入栈，将参数推入栈中。 然后运行到了<code>call _add_a_and_b</code>步骤，函数入栈，继续刚刚的操作 这里因为<code>call _add_a_and_b</code>中有个步骤是推入一个中间寄存器，所以esp在call部分又向下推一个4字节的空间。 所以在函数当中，需要访问第一个参数的时候，应该是通过<code>esp + 8</code>去获取，第二个就更需要<code>esp + 12</code>去获取了 这里有个重点，就是我们如何保证我们使用的寄存器不会被其他程序的执行而让我们的程序运行过程中遭到破坏。 很简单：当我们需要用到一个寄存器的时候，我们把一个寄存器的副本压入栈中，然后我们即可在函数中对这个寄存器进行使用以及清理。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html">阮一峰《汇编语言入门教程》</a> <a target="_blank" rel="noopener" href="http://kakaroto.homelinux.net/2017/11/introduction-to-reverse-engineering-and-assembly/">Introduction to reverse engineering and Assembly.</a> <a target="_blank" rel="noopener" href="http://blog.csdn.net/daleiwang/article/details/50579776">堆栈的工作原理</a>  </p>
<p>这块内存是从低到高进行划分的，当该程序需要分配对象的时候（使用<code>malloc</code>命令），系统将从这块内存的低位开始，按照对象的大小划分一块内存供这个对象存放： </p>
<h2 id="一、介绍-2"><a href="#一、介绍-2" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>在计算机中，CPU只能识别二进制，当需要CPU做事情的时候，都需要通过二进制去指挥CPU做什么事情。古人觉得二进制实在是难以理解，所以才发明了汇编语言以及后面的高级语言，所以汇编语言可以称作为比较接近机器语言的语言了。 当然后面的古人依然觉得汇编语言难以理解，所以发明了C、C++、Java来解决难以理解的问题。所以后面的语言越来越偏于人类自然语言，并且使用面向对象的思想来设计程序。当然这期间经历的事情还挺多：C编译成汇编语言，汇编语言再翻译成二进制语言，这个过程即称为assembling。 学习汇编语言既需要下面两个概念的理解：<strong>内存模型</strong>和<strong>寄存器</strong></p>
<h2 id="二、内存模型-2"><a href="#二、内存模型-2" class="headerlink" title="二、内存模型"></a>二、内存模型</h2><h3 id="（一）内存模型的介绍-2"><a href="#（一）内存模型的介绍-2" class="headerlink" title="（一）内存模型的介绍"></a>（一）内存模型的介绍</h3><p>内存通常被程序分为两个部分：<strong>堆（Heap）</strong>和<strong>栈（Stack）</strong> 当一个程序开始运行的时候，系统通常会为改程序开辟一块内存空间，而这块内存空间在该程序运行的时候，也会被划分成为上面最常见的两块区域，通常他们的作用如下：</p>
<ol>
<li>堆（Heap）：通常被动态的划分，用来存储程序运行的时候需要存储的数据，当程序结束以后，这块内存将被系统重新回收。当C语言中调用</li>
<li>栈（Stack）：用于存储方法运行中需要使用到的临时变量的空间。Java中的栈，当需要的临时变量如果是对象的情况下，存储的是对象在堆中的引用地址，基本数据类型的话那就是直接存储数据了。</li>
</ol>
<h3 id="（二）堆空间的使用-2"><a href="#（二）堆空间的使用-2" class="headerlink" title="（二）堆空间的使用"></a>（二）堆空间的使用</h3><p>（内存模型引用阮老师的图片） 1.当一个程序被启动，系统中会在内存中为改程序划分一块空闲内存： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152551.jpg"> </p>
<p>这块内存是从低到高进行划分的，当该程序需要分配对象的时候（使用<code>malloc</code>命令），系统将从这块内存的低位开始，按照对象的大小划分一块内存供这个对象存放： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152616.jpg"></p>
<p> 图中的对象中用了32个字节： 具体计算（8进制）： <code>0x1000 + 32 = 0x1020</code> 堆空间必须手动释放或者通过程序的垃圾回收器，如果该对象被GC判定为无用的对象，那么GC将对这块内存进行释放。</p>
<h3 id="（三）栈空间的使用-1"><a href="#（三）栈空间的使用-1" class="headerlink" title="（三）栈空间的使用"></a>（三）栈空间的使用</h3><p>栈空间用于存储一个函数运行过程中需要用到的数据的内存。 栈和堆不同的是：栈是从高位开始占用内存的，而且遵从LIFO (Last-In-First-Out)原则。 为啥是先进后出：因为函数调用的时候，最后一个调用的函数是最先结束的： 举个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> a = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，main函数先入栈，其次调用了<code>add_a_and_b(a, b)</code>，该函数入栈。那么是不是<code>add_a_and_b(a, b)</code>函数先执行完成，再把结果返回给<code>main</code>方法，<code>main</code>再运行结束。 栈空间： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152642.jpg"></p>
<h2 id="三、寄存器-1"><a href="#三、寄存器-1" class="headerlink" title="三、寄存器"></a>三、寄存器</h2><h3 id="（一）寄存器的介绍-1"><a href="#（一）寄存器的介绍-1" class="headerlink" title="（一）寄存器的介绍"></a>（一）寄存器的介绍</h3><p>我们还要知道的另外一件事情是CPU只负责做事情，并不能够存储任何数据，包括运算过程中需要用到的临时数据，都需要通过缓存、内存以及寄存器来存储。 那么何为缓存：缓存是CPU能够够得到的第一级存储物质，再之是内存。为啥有内存了还需要这些东西呢，因为设计者认为，CPU的速度要远快于内存的速度，如果任何数据都通过去读取和写入内存操作的话，就会拖慢CPU的速度，所以在京东或者其他地方购买CPU的时候，是会出现缓存这个东西的： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152657.jpg"></p>
<p> 现在普通一点的CPU都会自带一级缓存二级缓存（图中还有三级缓存= =），说的就是这个事情，当然这个缓存也不是越大越好，仔细想想如果这个缓存过大，那么在同步缓存和内存的数据的时候，是不是也会变慢。这个东西和jvm虚拟机中的堆和栈大小是一致的，如果jvm中堆栈过大，放数据是爽很多了，但是在进行垃圾清理的时候就是悲剧了。 接下来还有寄存器的概念：设计者认为每次需要数据的时候去读取数据，都需要寻址读取，那么还是会变慢很多，那如果把数据的地址存放在一个地方，需要的时候直接取出这个地址，然后再在缓存中去取出来，就会快很多，这个过程就是寄存器需要做的事情了。寄存器相当于用于寄放地址的地方，当程序指示CPU去读取什么数据的时候，CPU优先从寄存器中取出数据的地址，然后从缓存读取数据进行运算。 那么计算机运行的过程相当于： 1. 用户告诉CPU启动一个程序 2. 程序把数据放入系统为其开辟的一块内存空间 3. CPU从内存读取数据放入缓存，以及在寄存器放入缓存数据的地址 4. CPU通过协调内存、寄存器、CPU缓存完成用户继续给予的指令。</p>
<h3 id="（二）寄存器的种类-1"><a href="#（二）寄存器的种类-1" class="headerlink" title="（二）寄存器的种类"></a>（二）寄存器的种类</h3><p>一个CPU都会提供多种寄存器，用于存储不同的数据（不同程序使用不同的寄存器），在早期的x86处理器当中，CPU提供9种不同的寄存器，但是程序中可用的只有7中，其中2中用于做特殊作用：</p>
<blockquote>
<p>现在的寄存器已经有100多个了，都变成通用寄存器，不特别指定用途了，但是早期寄存器的名字都被保存了下来。</p>
</blockquote>
<ol>
<li>EAX</li>
<li>EBX</li>
<li>ECX</li>
<li>EDX</li>
<li>EDI</li>
<li>ESI</li>
<li>EBP</li>
<li>ESP 记录内存中栈空间的地址</li>
<li>EIP 记录当前指令执行的位置</li>
</ol>
<p>汇编语言要做的事情就是指挥这些寄存器中做的动作。</p>
<h2 id="四、一个简单的程序-1"><a href="#四、一个简单的程序-1" class="headerlink" title="四、一个简单的程序"></a>四、一个简单的程序</h2><p>现在使用一个C语言的代码来表述计算机做了什么事情：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_a_and_b</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行编译，他将会被编译成以下的汇编语言：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_main:</span><br><span class="line">   push 3 ;                        把第二个参数&#39;3&#39;Push（推）进内存</span><br><span class="line">   push 2 ;                        把第一个参数&#39;2&#39;Push进内存</span><br><span class="line">   call _add_a_and_b ;     调用add_a_and_b 函数：并且让当前程序运行的指针（在EIP寄存器中）</span><br><span class="line">                                        指向函数的第一条指令（push %ebx）</span><br><span class="line">   add %esp, 8 ;              将esp指针在栈上向上移动8个字节，弹出我们上面压入的两个值，此时第一个值已经变成计算以后的值了。</span><br><span class="line">   ret ;                               返回到调用main函数的函数中。</span><br><span class="line"></span><br><span class="line">_add_a_and_b:</span><br><span class="line">   push %ebx ;                    程序准备修改ebx寄存器中的值, 所以程序需要将ebx推入栈中</span><br><span class="line">                                            以便让后面程序运行结束以后可以还原数据</span><br><span class="line">   mov %eax, [%esp+8] ;    将第一个参数移入EAX（详看下图可以知道为什么是+8）</span><br><span class="line">   mov %ebx, [%esp+12] ;  将第二个参数移入EBX</span><br><span class="line">   add %eax, %ebx ;           将eax和ebx中的值进行相加，并且把结果存储在eax中</span><br><span class="line">   pop %ebx ;                      将ebx中的值弹出，以便还原ebx中的数据</span><br><span class="line">   ret ;                                   返回到main函数. 这个步骤将会把下一步运行地址弹出到栈内存中</span><br><span class="line">                                             (当call执行完以后的下一步地址) 放入eip寄存器</span><br></pre></td></tr></table></figure>

<p>程序运行的时候，内存模型如下： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152710.jpg"> </p>
<p>第一步：当main开始运行的时候，需要先把临时的值压入栈内存中： 所以有两个参数<code>3和2</code>被压入占中，这就是栈内存中前两个的值的地址。 第二步：临时变量已经准备好了，我们要把main函数压入栈中，因为main函数一共有四条指令，而一条指令只用<code>4</code>个字节，所以一共有16个字节被压入栈中 第三步：因为在函数<code>_add_a_and_b</code>中，我们用到了中间寄存器用来计算ebx，所以ebx被压入栈中。 经过了这三个步骤，那么esp（程序运行指针）被多次往下移动了16个字节，其中包括main函数四条命令4个字节以及两个参数8个字节，还有一个临时寄存器使用了4个字节， 当然图中那么画还不够具体。</p>
<p>首先main函数入栈，将参数推入栈中。 然后运行到了<code>call _add_a_and_b</code>步骤，函数入栈，继续刚刚的操作 这里因为<code>call _add_a_and_b</code>中有个步骤是推入一个中间寄存器，所以esp在call部分又向下推一个4字节的空间。 所以在函数当中，需要访问第一个参数的时候，应该是通过<code>esp + 8</code>去获取，第二个就更需要<code>esp + 12</code>去获取了 这里有个重点，就是我们如何保证我们使用的寄存器不会被其他程序的执行而让我们的程序运行过程中遭到破坏。 很简单：当我们需要用到一个寄存器的时候，我们把一个寄存器的副本压入栈中，然后我们即可在函数中对这个寄存器进行使用以及清理。</p>
<h2 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html">阮一峰《汇编语言入门教程》</a> <a target="_blank" rel="noopener" href="http://kakaroto.homelinux.net/2017/11/introduction-to-reverse-engineering-and-assembly/">Introduction to reverse engineering and Assembly.</a> <a target="_blank" rel="noopener" href="http://blog.csdn.net/daleiwang/article/details/50579776">堆栈的工作原理</a> </p>
<p> 图中的对象中用了32个字节： 具体计算（8进制）： <code>0x1000 + 32 = 0x1020</code> 堆空间必须手动释放或者通过程序的垃圾回收器，如果该对象被GC判定为无用的对象，那么GC将对这块内存进行释放。</p>
<h3 id="（三）栈空间的使用-2"><a href="#（三）栈空间的使用-2" class="headerlink" title="（三）栈空间的使用"></a>（三）栈空间的使用</h3><p>栈空间用于存储一个函数运行过程中需要用到的数据的内存。 栈和堆不同的是：栈是从高位开始占用内存的，而且遵从LIFO (Last-In-First-Out)原则。 为啥是先进后出：因为函数调用的时候，最后一个调用的函数是最先结束的： 举个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> a = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，main函数先入栈，其次调用了<code>add_a_and_b(a, b)</code>，该函数入栈。那么是不是<code>add_a_and_b(a, b)</code>函数先执行完成，再把结果返回给<code>main</code>方法，<code>main</code>再运行结束。 栈空间： </p>
<h2 id="一、介绍-3"><a href="#一、介绍-3" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>在计算机中，CPU只能识别二进制，当需要CPU做事情的时候，都需要通过二进制去指挥CPU做什么事情。古人觉得二进制实在是难以理解，所以才发明了汇编语言以及后面的高级语言，所以汇编语言可以称作为比较接近机器语言的语言了。 当然后面的古人依然觉得汇编语言难以理解，所以发明了C、C++、Java来解决难以理解的问题。所以后面的语言越来越偏于人类自然语言，并且使用面向对象的思想来设计程序。当然这期间经历的事情还挺多：C编译成汇编语言，汇编语言再翻译成二进制语言，这个过程即称为assembling。 学习汇编语言既需要下面两个概念的理解：<strong>内存模型</strong>和<strong>寄存器</strong></p>
<h2 id="二、内存模型-3"><a href="#二、内存模型-3" class="headerlink" title="二、内存模型"></a>二、内存模型</h2><h3 id="（一）内存模型的介绍-3"><a href="#（一）内存模型的介绍-3" class="headerlink" title="（一）内存模型的介绍"></a>（一）内存模型的介绍</h3><p>内存通常被程序分为两个部分：<strong>堆（Heap）</strong>和<strong>栈（Stack）</strong> 当一个程序开始运行的时候，系统通常会为改程序开辟一块内存空间，而这块内存空间在该程序运行的时候，也会被划分成为上面最常见的两块区域，通常他们的作用如下：</p>
<ol>
<li>堆（Heap）：通常被动态的划分，用来存储程序运行的时候需要存储的数据，当程序结束以后，这块内存将被系统重新回收。当C语言中调用</li>
<li>栈（Stack）：用于存储方法运行中需要使用到的临时变量的空间。Java中的栈，当需要的临时变量如果是对象的情况下，存储的是对象在堆中的引用地址，基本数据类型的话那就是直接存储数据了。</li>
</ol>
<h3 id="（二）堆空间的使用-3"><a href="#（二）堆空间的使用-3" class="headerlink" title="（二）堆空间的使用"></a>（二）堆空间的使用</h3><p>（内存模型引用阮老师的图片） 1.当一个程序被启动，系统中会在内存中为改程序划分一块空闲内存： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152551.jpg"> </p>
<p>这块内存是从低到高进行划分的，当该程序需要分配对象的时候（使用<code>malloc</code>命令），系统将从这块内存的低位开始，按照对象的大小划分一块内存供这个对象存放： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152616.jpg"></p>
<p> 图中的对象中用了32个字节： 具体计算（8进制）： <code>0x1000 + 32 = 0x1020</code> 堆空间必须手动释放或者通过程序的垃圾回收器，如果该对象被GC判定为无用的对象，那么GC将对这块内存进行释放。</p>
<h3 id="（三）栈空间的使用-3"><a href="#（三）栈空间的使用-3" class="headerlink" title="（三）栈空间的使用"></a>（三）栈空间的使用</h3><p>栈空间用于存储一个函数运行过程中需要用到的数据的内存。 栈和堆不同的是：栈是从高位开始占用内存的，而且遵从LIFO (Last-In-First-Out)原则。 为啥是先进后出：因为函数调用的时候，最后一个调用的函数是最先结束的： 举个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> a = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，main函数先入栈，其次调用了<code>add_a_and_b(a, b)</code>，该函数入栈。那么是不是<code>add_a_and_b(a, b)</code>函数先执行完成，再把结果返回给<code>main</code>方法，<code>main</code>再运行结束。 栈空间： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152642.jpg"></p>
<h2 id="三、寄存器-2"><a href="#三、寄存器-2" class="headerlink" title="三、寄存器"></a>三、寄存器</h2><h3 id="（一）寄存器的介绍-2"><a href="#（一）寄存器的介绍-2" class="headerlink" title="（一）寄存器的介绍"></a>（一）寄存器的介绍</h3><p>我们还要知道的另外一件事情是CPU只负责做事情，并不能够存储任何数据，包括运算过程中需要用到的临时数据，都需要通过缓存、内存以及寄存器来存储。 那么何为缓存：缓存是CPU能够够得到的第一级存储物质，再之是内存。为啥有内存了还需要这些东西呢，因为设计者认为，CPU的速度要远快于内存的速度，如果任何数据都通过去读取和写入内存操作的话，就会拖慢CPU的速度，所以在京东或者其他地方购买CPU的时候，是会出现缓存这个东西的： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152657.jpg"></p>
<p> 现在普通一点的CPU都会自带一级缓存二级缓存（图中还有三级缓存= =），说的就是这个事情，当然这个缓存也不是越大越好，仔细想想如果这个缓存过大，那么在同步缓存和内存的数据的时候，是不是也会变慢。这个东西和jvm虚拟机中的堆和栈大小是一致的，如果jvm中堆栈过大，放数据是爽很多了，但是在进行垃圾清理的时候就是悲剧了。 接下来还有寄存器的概念：设计者认为每次需要数据的时候去读取数据，都需要寻址读取，那么还是会变慢很多，那如果把数据的地址存放在一个地方，需要的时候直接取出这个地址，然后再在缓存中去取出来，就会快很多，这个过程就是寄存器需要做的事情了。寄存器相当于用于寄放地址的地方，当程序指示CPU去读取什么数据的时候，CPU优先从寄存器中取出数据的地址，然后从缓存读取数据进行运算。 那么计算机运行的过程相当于： 1. 用户告诉CPU启动一个程序 2. 程序把数据放入系统为其开辟的一块内存空间 3. CPU从内存读取数据放入缓存，以及在寄存器放入缓存数据的地址 4. CPU通过协调内存、寄存器、CPU缓存完成用户继续给予的指令。</p>
<h3 id="（二）寄存器的种类-2"><a href="#（二）寄存器的种类-2" class="headerlink" title="（二）寄存器的种类"></a>（二）寄存器的种类</h3><p>一个CPU都会提供多种寄存器，用于存储不同的数据（不同程序使用不同的寄存器），在早期的x86处理器当中，CPU提供9种不同的寄存器，但是程序中可用的只有7中，其中2中用于做特殊作用：</p>
<blockquote>
<p>现在的寄存器已经有100多个了，都变成通用寄存器，不特别指定用途了，但是早期寄存器的名字都被保存了下来。</p>
</blockquote>
<ol>
<li>EAX</li>
<li>EBX</li>
<li>ECX</li>
<li>EDX</li>
<li>EDI</li>
<li>ESI</li>
<li>EBP</li>
<li>ESP 记录内存中栈空间的地址</li>
<li>EIP 记录当前指令执行的位置</li>
</ol>
<p>汇编语言要做的事情就是指挥这些寄存器中做的动作。</p>
<h2 id="四、一个简单的程序-2"><a href="#四、一个简单的程序-2" class="headerlink" title="四、一个简单的程序"></a>四、一个简单的程序</h2><p>现在使用一个C语言的代码来表述计算机做了什么事情：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_a_and_b</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行编译，他将会被编译成以下的汇编语言：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_main:</span><br><span class="line">   push 3 ;                        把第二个参数&#39;3&#39;Push（推）进内存</span><br><span class="line">   push 2 ;                        把第一个参数&#39;2&#39;Push进内存</span><br><span class="line">   call _add_a_and_b ;     调用add_a_and_b 函数：并且让当前程序运行的指针（在EIP寄存器中）</span><br><span class="line">                                        指向函数的第一条指令（push %ebx）</span><br><span class="line">   add %esp, 8 ;              将esp指针在栈上向上移动8个字节，弹出我们上面压入的两个值，此时第一个值已经变成计算以后的值了。</span><br><span class="line">   ret ;                               返回到调用main函数的函数中。</span><br><span class="line"></span><br><span class="line">_add_a_and_b:</span><br><span class="line">   push %ebx ;                    程序准备修改ebx寄存器中的值, 所以程序需要将ebx推入栈中</span><br><span class="line">                                            以便让后面程序运行结束以后可以还原数据</span><br><span class="line">   mov %eax, [%esp+8] ;    将第一个参数移入EAX（详看下图可以知道为什么是+8）</span><br><span class="line">   mov %ebx, [%esp+12] ;  将第二个参数移入EBX</span><br><span class="line">   add %eax, %ebx ;           将eax和ebx中的值进行相加，并且把结果存储在eax中</span><br><span class="line">   pop %ebx ;                      将ebx中的值弹出，以便还原ebx中的数据</span><br><span class="line">   ret ;                                   返回到main函数. 这个步骤将会把下一步运行地址弹出到栈内存中</span><br><span class="line">                                             (当call执行完以后的下一步地址) 放入eip寄存器</span><br></pre></td></tr></table></figure>

<p>程序运行的时候，内存模型如下： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152710.jpg"> </p>
<p>第一步：当main开始运行的时候，需要先把临时的值压入栈内存中： 所以有两个参数<code>3和2</code>被压入占中，这就是栈内存中前两个的值的地址。 第二步：临时变量已经准备好了，我们要把main函数压入栈中，因为main函数一共有四条指令，而一条指令只用<code>4</code>个字节，所以一共有16个字节被压入栈中 第三步：因为在函数<code>_add_a_and_b</code>中，我们用到了中间寄存器用来计算ebx，所以ebx被压入栈中。 经过了这三个步骤，那么esp（程序运行指针）被多次往下移动了16个字节，其中包括main函数四条命令4个字节以及两个参数8个字节，还有一个临时寄存器使用了4个字节， 当然图中那么画还不够具体。</p>
<p>首先main函数入栈，将参数推入栈中。 然后运行到了<code>call _add_a_and_b</code>步骤，函数入栈，继续刚刚的操作 这里因为<code>call _add_a_and_b</code>中有个步骤是推入一个中间寄存器，所以esp在call部分又向下推一个4字节的空间。 所以在函数当中，需要访问第一个参数的时候，应该是通过<code>esp + 8</code>去获取，第二个就更需要<code>esp + 12</code>去获取了 这里有个重点，就是我们如何保证我们使用的寄存器不会被其他程序的执行而让我们的程序运行过程中遭到破坏。 很简单：当我们需要用到一个寄存器的时候，我们把一个寄存器的副本压入栈中，然后我们即可在函数中对这个寄存器进行使用以及清理。</p>
<h2 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html">阮一峰《汇编语言入门教程》</a> <a target="_blank" rel="noopener" href="http://kakaroto.homelinux.net/2017/11/introduction-to-reverse-engineering-and-assembly/">Introduction to reverse engineering and Assembly.</a> <a target="_blank" rel="noopener" href="http://blog.csdn.net/daleiwang/article/details/50579776">堆栈的工作原理</a> </p>
<h2 id="三、寄存器-3"><a href="#三、寄存器-3" class="headerlink" title="三、寄存器"></a>三、寄存器</h2><h3 id="（一）寄存器的介绍-3"><a href="#（一）寄存器的介绍-3" class="headerlink" title="（一）寄存器的介绍"></a>（一）寄存器的介绍</h3><p>我们还要知道的另外一件事情是CPU只负责做事情，并不能够存储任何数据，包括运算过程中需要用到的临时数据，都需要通过缓存、内存以及寄存器来存储。 那么何为缓存：缓存是CPU能够够得到的第一级存储物质，再之是内存。为啥有内存了还需要这些东西呢，因为设计者认为，CPU的速度要远快于内存的速度，如果任何数据都通过去读取和写入内存操作的话，就会拖慢CPU的速度，所以在京东或者其他地方购买CPU的时候，是会出现缓存这个东西的： </p>
<h2 id="一、介绍-4"><a href="#一、介绍-4" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>在计算机中，CPU只能识别二进制，当需要CPU做事情的时候，都需要通过二进制去指挥CPU做什么事情。古人觉得二进制实在是难以理解，所以才发明了汇编语言以及后面的高级语言，所以汇编语言可以称作为比较接近机器语言的语言了。 当然后面的古人依然觉得汇编语言难以理解，所以发明了C、C++、Java来解决难以理解的问题。所以后面的语言越来越偏于人类自然语言，并且使用面向对象的思想来设计程序。当然这期间经历的事情还挺多：C编译成汇编语言，汇编语言再翻译成二进制语言，这个过程即称为assembling。 学习汇编语言既需要下面两个概念的理解：<strong>内存模型</strong>和<strong>寄存器</strong></p>
<h2 id="二、内存模型-4"><a href="#二、内存模型-4" class="headerlink" title="二、内存模型"></a>二、内存模型</h2><h3 id="（一）内存模型的介绍-4"><a href="#（一）内存模型的介绍-4" class="headerlink" title="（一）内存模型的介绍"></a>（一）内存模型的介绍</h3><p>内存通常被程序分为两个部分：<strong>堆（Heap）</strong>和<strong>栈（Stack）</strong> 当一个程序开始运行的时候，系统通常会为改程序开辟一块内存空间，而这块内存空间在该程序运行的时候，也会被划分成为上面最常见的两块区域，通常他们的作用如下：</p>
<ol>
<li>堆（Heap）：通常被动态的划分，用来存储程序运行的时候需要存储的数据，当程序结束以后，这块内存将被系统重新回收。当C语言中调用</li>
<li>栈（Stack）：用于存储方法运行中需要使用到的临时变量的空间。Java中的栈，当需要的临时变量如果是对象的情况下，存储的是对象在堆中的引用地址，基本数据类型的话那就是直接存储数据了。</li>
</ol>
<h3 id="（二）堆空间的使用-4"><a href="#（二）堆空间的使用-4" class="headerlink" title="（二）堆空间的使用"></a>（二）堆空间的使用</h3><p>（内存模型引用阮老师的图片） 1.当一个程序被启动，系统中会在内存中为改程序划分一块空闲内存： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152551.jpg"> </p>
<p>这块内存是从低到高进行划分的，当该程序需要分配对象的时候（使用<code>malloc</code>命令），系统将从这块内存的低位开始，按照对象的大小划分一块内存供这个对象存放： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152616.jpg"></p>
<p> 图中的对象中用了32个字节： 具体计算（8进制）： <code>0x1000 + 32 = 0x1020</code> 堆空间必须手动释放或者通过程序的垃圾回收器，如果该对象被GC判定为无用的对象，那么GC将对这块内存进行释放。</p>
<h3 id="（三）栈空间的使用-4"><a href="#（三）栈空间的使用-4" class="headerlink" title="（三）栈空间的使用"></a>（三）栈空间的使用</h3><p>栈空间用于存储一个函数运行过程中需要用到的数据的内存。 栈和堆不同的是：栈是从高位开始占用内存的，而且遵从LIFO (Last-In-First-Out)原则。 为啥是先进后出：因为函数调用的时候，最后一个调用的函数是最先结束的： 举个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> a = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，main函数先入栈，其次调用了<code>add_a_and_b(a, b)</code>，该函数入栈。那么是不是<code>add_a_and_b(a, b)</code>函数先执行完成，再把结果返回给<code>main</code>方法，<code>main</code>再运行结束。 栈空间： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152642.jpg"></p>
<h2 id="三、寄存器-4"><a href="#三、寄存器-4" class="headerlink" title="三、寄存器"></a>三、寄存器</h2><h3 id="（一）寄存器的介绍-4"><a href="#（一）寄存器的介绍-4" class="headerlink" title="（一）寄存器的介绍"></a>（一）寄存器的介绍</h3><p>我们还要知道的另外一件事情是CPU只负责做事情，并不能够存储任何数据，包括运算过程中需要用到的临时数据，都需要通过缓存、内存以及寄存器来存储。 那么何为缓存：缓存是CPU能够够得到的第一级存储物质，再之是内存。为啥有内存了还需要这些东西呢，因为设计者认为，CPU的速度要远快于内存的速度，如果任何数据都通过去读取和写入内存操作的话，就会拖慢CPU的速度，所以在京东或者其他地方购买CPU的时候，是会出现缓存这个东西的： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152657.jpg"></p>
<p> 现在普通一点的CPU都会自带一级缓存二级缓存（图中还有三级缓存= =），说的就是这个事情，当然这个缓存也不是越大越好，仔细想想如果这个缓存过大，那么在同步缓存和内存的数据的时候，是不是也会变慢。这个东西和jvm虚拟机中的堆和栈大小是一致的，如果jvm中堆栈过大，放数据是爽很多了，但是在进行垃圾清理的时候就是悲剧了。 接下来还有寄存器的概念：设计者认为每次需要数据的时候去读取数据，都需要寻址读取，那么还是会变慢很多，那如果把数据的地址存放在一个地方，需要的时候直接取出这个地址，然后再在缓存中去取出来，就会快很多，这个过程就是寄存器需要做的事情了。寄存器相当于用于寄放地址的地方，当程序指示CPU去读取什么数据的时候，CPU优先从寄存器中取出数据的地址，然后从缓存读取数据进行运算。 那么计算机运行的过程相当于： 1. 用户告诉CPU启动一个程序 2. 程序把数据放入系统为其开辟的一块内存空间 3. CPU从内存读取数据放入缓存，以及在寄存器放入缓存数据的地址 4. CPU通过协调内存、寄存器、CPU缓存完成用户继续给予的指令。</p>
<h3 id="（二）寄存器的种类-3"><a href="#（二）寄存器的种类-3" class="headerlink" title="（二）寄存器的种类"></a>（二）寄存器的种类</h3><p>一个CPU都会提供多种寄存器，用于存储不同的数据（不同程序使用不同的寄存器），在早期的x86处理器当中，CPU提供9种不同的寄存器，但是程序中可用的只有7中，其中2中用于做特殊作用：</p>
<blockquote>
<p>现在的寄存器已经有100多个了，都变成通用寄存器，不特别指定用途了，但是早期寄存器的名字都被保存了下来。</p>
</blockquote>
<ol>
<li>EAX</li>
<li>EBX</li>
<li>ECX</li>
<li>EDX</li>
<li>EDI</li>
<li>ESI</li>
<li>EBP</li>
<li>ESP 记录内存中栈空间的地址</li>
<li>EIP 记录当前指令执行的位置</li>
</ol>
<p>汇编语言要做的事情就是指挥这些寄存器中做的动作。</p>
<h2 id="四、一个简单的程序-3"><a href="#四、一个简单的程序-3" class="headerlink" title="四、一个简单的程序"></a>四、一个简单的程序</h2><p>现在使用一个C语言的代码来表述计算机做了什么事情：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_a_and_b</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行编译，他将会被编译成以下的汇编语言：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_main:</span><br><span class="line">   push 3 ;                        把第二个参数&#39;3&#39;Push（推）进内存</span><br><span class="line">   push 2 ;                        把第一个参数&#39;2&#39;Push进内存</span><br><span class="line">   call _add_a_and_b ;     调用add_a_and_b 函数：并且让当前程序运行的指针（在EIP寄存器中）</span><br><span class="line">                                        指向函数的第一条指令（push %ebx）</span><br><span class="line">   add %esp, 8 ;              将esp指针在栈上向上移动8个字节，弹出我们上面压入的两个值，此时第一个值已经变成计算以后的值了。</span><br><span class="line">   ret ;                               返回到调用main函数的函数中。</span><br><span class="line"></span><br><span class="line">_add_a_and_b:</span><br><span class="line">   push %ebx ;                    程序准备修改ebx寄存器中的值, 所以程序需要将ebx推入栈中</span><br><span class="line">                                            以便让后面程序运行结束以后可以还原数据</span><br><span class="line">   mov %eax, [%esp+8] ;    将第一个参数移入EAX（详看下图可以知道为什么是+8）</span><br><span class="line">   mov %ebx, [%esp+12] ;  将第二个参数移入EBX</span><br><span class="line">   add %eax, %ebx ;           将eax和ebx中的值进行相加，并且把结果存储在eax中</span><br><span class="line">   pop %ebx ;                      将ebx中的值弹出，以便还原ebx中的数据</span><br><span class="line">   ret ;                                   返回到main函数. 这个步骤将会把下一步运行地址弹出到栈内存中</span><br><span class="line">                                             (当call执行完以后的下一步地址) 放入eip寄存器</span><br></pre></td></tr></table></figure>

<p>程序运行的时候，内存模型如下： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152710.jpg"> </p>
<p>第一步：当main开始运行的时候，需要先把临时的值压入栈内存中： 所以有两个参数<code>3和2</code>被压入占中，这就是栈内存中前两个的值的地址。 第二步：临时变量已经准备好了，我们要把main函数压入栈中，因为main函数一共有四条指令，而一条指令只用<code>4</code>个字节，所以一共有16个字节被压入栈中 第三步：因为在函数<code>_add_a_and_b</code>中，我们用到了中间寄存器用来计算ebx，所以ebx被压入栈中。 经过了这三个步骤，那么esp（程序运行指针）被多次往下移动了16个字节，其中包括main函数四条命令4个字节以及两个参数8个字节，还有一个临时寄存器使用了4个字节， 当然图中那么画还不够具体。</p>
<p>首先main函数入栈，将参数推入栈中。 然后运行到了<code>call _add_a_and_b</code>步骤，函数入栈，继续刚刚的操作 这里因为<code>call _add_a_and_b</code>中有个步骤是推入一个中间寄存器，所以esp在call部分又向下推一个4字节的空间。 所以在函数当中，需要访问第一个参数的时候，应该是通过<code>esp + 8</code>去获取，第二个就更需要<code>esp + 12</code>去获取了 这里有个重点，就是我们如何保证我们使用的寄存器不会被其他程序的执行而让我们的程序运行过程中遭到破坏。 很简单：当我们需要用到一个寄存器的时候，我们把一个寄存器的副本压入栈中，然后我们即可在函数中对这个寄存器进行使用以及清理。</p>
<h2 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html">阮一峰《汇编语言入门教程》</a> <a target="_blank" rel="noopener" href="http://kakaroto.homelinux.net/2017/11/introduction-to-reverse-engineering-and-assembly/">Introduction to reverse engineering and Assembly.</a> <a target="_blank" rel="noopener" href="http://blog.csdn.net/daleiwang/article/details/50579776">堆栈的工作原理</a> </p>
<p> 现在普通一点的CPU都会自带一级缓存二级缓存（图中还有三级缓存= =），说的就是这个事情，当然这个缓存也不是越大越好，仔细想想如果这个缓存过大，那么在同步缓存和内存的数据的时候，是不是也会变慢。这个东西和jvm虚拟机中的堆和栈大小是一致的，如果jvm中堆栈过大，放数据是爽很多了，但是在进行垃圾清理的时候就是悲剧了。 接下来还有寄存器的概念：设计者认为每次需要数据的时候去读取数据，都需要寻址读取，那么还是会变慢很多，那如果把数据的地址存放在一个地方，需要的时候直接取出这个地址，然后再在缓存中去取出来，就会快很多，这个过程就是寄存器需要做的事情了。寄存器相当于用于寄放地址的地方，当程序指示CPU去读取什么数据的时候，CPU优先从寄存器中取出数据的地址，然后从缓存读取数据进行运算。 那么计算机运行的过程相当于： 1. 用户告诉CPU启动一个程序 2. 程序把数据放入系统为其开辟的一块内存空间 3. CPU从内存读取数据放入缓存，以及在寄存器放入缓存数据的地址 4. CPU通过协调内存、寄存器、CPU缓存完成用户继续给予的指令。</p>
<h3 id="（二）寄存器的种类-4"><a href="#（二）寄存器的种类-4" class="headerlink" title="（二）寄存器的种类"></a>（二）寄存器的种类</h3><p>一个CPU都会提供多种寄存器，用于存储不同的数据（不同程序使用不同的寄存器），在早期的x86处理器当中，CPU提供9种不同的寄存器，但是程序中可用的只有7中，其中2中用于做特殊作用：</p>
<blockquote>
<p>现在的寄存器已经有100多个了，都变成通用寄存器，不特别指定用途了，但是早期寄存器的名字都被保存了下来。</p>
</blockquote>
<ol>
<li>EAX</li>
<li>EBX</li>
<li>ECX</li>
<li>EDX</li>
<li>EDI</li>
<li>ESI</li>
<li>EBP</li>
<li>ESP 记录内存中栈空间的地址</li>
<li>EIP 记录当前指令执行的位置</li>
</ol>
<p>汇编语言要做的事情就是指挥这些寄存器中做的动作。</p>
<h2 id="四、一个简单的程序-4"><a href="#四、一个简单的程序-4" class="headerlink" title="四、一个简单的程序"></a>四、一个简单的程序</h2><p>现在使用一个C语言的代码来表述计算机做了什么事情：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_a_and_b</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行编译，他将会被编译成以下的汇编语言：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_main:</span><br><span class="line">   push 3 ;                        把第二个参数&#39;3&#39;Push（推）进内存</span><br><span class="line">   push 2 ;                        把第一个参数&#39;2&#39;Push进内存</span><br><span class="line">   call _add_a_and_b ;     调用add_a_and_b 函数：并且让当前程序运行的指针（在EIP寄存器中）</span><br><span class="line">                                        指向函数的第一条指令（push %ebx）</span><br><span class="line">   add %esp, 8 ;              将esp指针在栈上向上移动8个字节，弹出我们上面压入的两个值，此时第一个值已经变成计算以后的值了。</span><br><span class="line">   ret ;                               返回到调用main函数的函数中。</span><br><span class="line"></span><br><span class="line">_add_a_and_b:</span><br><span class="line">   push %ebx ;                    程序准备修改ebx寄存器中的值, 所以程序需要将ebx推入栈中</span><br><span class="line">                                            以便让后面程序运行结束以后可以还原数据</span><br><span class="line">   mov %eax, [%esp+8] ;    将第一个参数移入EAX（详看下图可以知道为什么是+8）</span><br><span class="line">   mov %ebx, [%esp+12] ;  将第二个参数移入EBX</span><br><span class="line">   add %eax, %ebx ;           将eax和ebx中的值进行相加，并且把结果存储在eax中</span><br><span class="line">   pop %ebx ;                      将ebx中的值弹出，以便还原ebx中的数据</span><br><span class="line">   ret ;                                   返回到main函数. 这个步骤将会把下一步运行地址弹出到栈内存中</span><br><span class="line">                                             (当call执行完以后的下一步地址) 放入eip寄存器</span><br></pre></td></tr></table></figure>

<p>程序运行的时候，内存模型如下： </p>
<h2 id="一、介绍-5"><a href="#一、介绍-5" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>在计算机中，CPU只能识别二进制，当需要CPU做事情的时候，都需要通过二进制去指挥CPU做什么事情。古人觉得二进制实在是难以理解，所以才发明了汇编语言以及后面的高级语言，所以汇编语言可以称作为比较接近机器语言的语言了。 当然后面的古人依然觉得汇编语言难以理解，所以发明了C、C++、Java来解决难以理解的问题。所以后面的语言越来越偏于人类自然语言，并且使用面向对象的思想来设计程序。当然这期间经历的事情还挺多：C编译成汇编语言，汇编语言再翻译成二进制语言，这个过程即称为assembling。 学习汇编语言既需要下面两个概念的理解：<strong>内存模型</strong>和<strong>寄存器</strong></p>
<h2 id="二、内存模型-5"><a href="#二、内存模型-5" class="headerlink" title="二、内存模型"></a>二、内存模型</h2><h3 id="（一）内存模型的介绍-5"><a href="#（一）内存模型的介绍-5" class="headerlink" title="（一）内存模型的介绍"></a>（一）内存模型的介绍</h3><p>内存通常被程序分为两个部分：<strong>堆（Heap）</strong>和<strong>栈（Stack）</strong> 当一个程序开始运行的时候，系统通常会为改程序开辟一块内存空间，而这块内存空间在该程序运行的时候，也会被划分成为上面最常见的两块区域，通常他们的作用如下：</p>
<ol>
<li>堆（Heap）：通常被动态的划分，用来存储程序运行的时候需要存储的数据，当程序结束以后，这块内存将被系统重新回收。当C语言中调用</li>
<li>栈（Stack）：用于存储方法运行中需要使用到的临时变量的空间。Java中的栈，当需要的临时变量如果是对象的情况下，存储的是对象在堆中的引用地址，基本数据类型的话那就是直接存储数据了。</li>
</ol>
<h3 id="（二）堆空间的使用-5"><a href="#（二）堆空间的使用-5" class="headerlink" title="（二）堆空间的使用"></a>（二）堆空间的使用</h3><p>（内存模型引用阮老师的图片） 1.当一个程序被启动，系统中会在内存中为改程序划分一块空闲内存： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152551.jpg"> </p>
<p>这块内存是从低到高进行划分的，当该程序需要分配对象的时候（使用<code>malloc</code>命令），系统将从这块内存的低位开始，按照对象的大小划分一块内存供这个对象存放： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152616.jpg"></p>
<p> 图中的对象中用了32个字节： 具体计算（8进制）： <code>0x1000 + 32 = 0x1020</code> 堆空间必须手动释放或者通过程序的垃圾回收器，如果该对象被GC判定为无用的对象，那么GC将对这块内存进行释放。</p>
<h3 id="（三）栈空间的使用-5"><a href="#（三）栈空间的使用-5" class="headerlink" title="（三）栈空间的使用"></a>（三）栈空间的使用</h3><p>栈空间用于存储一个函数运行过程中需要用到的数据的内存。 栈和堆不同的是：栈是从高位开始占用内存的，而且遵从LIFO (Last-In-First-Out)原则。 为啥是先进后出：因为函数调用的时候，最后一个调用的函数是最先结束的： 举个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> a = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，main函数先入栈，其次调用了<code>add_a_and_b(a, b)</code>，该函数入栈。那么是不是<code>add_a_and_b(a, b)</code>函数先执行完成，再把结果返回给<code>main</code>方法，<code>main</code>再运行结束。 栈空间： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152642.jpg"></p>
<h2 id="三、寄存器-5"><a href="#三、寄存器-5" class="headerlink" title="三、寄存器"></a>三、寄存器</h2><h3 id="（一）寄存器的介绍-5"><a href="#（一）寄存器的介绍-5" class="headerlink" title="（一）寄存器的介绍"></a>（一）寄存器的介绍</h3><p>我们还要知道的另外一件事情是CPU只负责做事情，并不能够存储任何数据，包括运算过程中需要用到的临时数据，都需要通过缓存、内存以及寄存器来存储。 那么何为缓存：缓存是CPU能够够得到的第一级存储物质，再之是内存。为啥有内存了还需要这些东西呢，因为设计者认为，CPU的速度要远快于内存的速度，如果任何数据都通过去读取和写入内存操作的话，就会拖慢CPU的速度，所以在京东或者其他地方购买CPU的时候，是会出现缓存这个东西的： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152657.jpg"></p>
<p> 现在普通一点的CPU都会自带一级缓存二级缓存（图中还有三级缓存= =），说的就是这个事情，当然这个缓存也不是越大越好，仔细想想如果这个缓存过大，那么在同步缓存和内存的数据的时候，是不是也会变慢。这个东西和jvm虚拟机中的堆和栈大小是一致的，如果jvm中堆栈过大，放数据是爽很多了，但是在进行垃圾清理的时候就是悲剧了。 接下来还有寄存器的概念：设计者认为每次需要数据的时候去读取数据，都需要寻址读取，那么还是会变慢很多，那如果把数据的地址存放在一个地方，需要的时候直接取出这个地址，然后再在缓存中去取出来，就会快很多，这个过程就是寄存器需要做的事情了。寄存器相当于用于寄放地址的地方，当程序指示CPU去读取什么数据的时候，CPU优先从寄存器中取出数据的地址，然后从缓存读取数据进行运算。 那么计算机运行的过程相当于： 1. 用户告诉CPU启动一个程序 2. 程序把数据放入系统为其开辟的一块内存空间 3. CPU从内存读取数据放入缓存，以及在寄存器放入缓存数据的地址 4. CPU通过协调内存、寄存器、CPU缓存完成用户继续给予的指令。</p>
<h3 id="（二）寄存器的种类-5"><a href="#（二）寄存器的种类-5" class="headerlink" title="（二）寄存器的种类"></a>（二）寄存器的种类</h3><p>一个CPU都会提供多种寄存器，用于存储不同的数据（不同程序使用不同的寄存器），在早期的x86处理器当中，CPU提供9种不同的寄存器，但是程序中可用的只有7中，其中2中用于做特殊作用：</p>
<blockquote>
<p>现在的寄存器已经有100多个了，都变成通用寄存器，不特别指定用途了，但是早期寄存器的名字都被保存了下来。</p>
</blockquote>
<ol>
<li>EAX</li>
<li>EBX</li>
<li>ECX</li>
<li>EDX</li>
<li>EDI</li>
<li>ESI</li>
<li>EBP</li>
<li>ESP 记录内存中栈空间的地址</li>
<li>EIP 记录当前指令执行的位置</li>
</ol>
<p>汇编语言要做的事情就是指挥这些寄存器中做的动作。</p>
<h2 id="四、一个简单的程序-5"><a href="#四、一个简单的程序-5" class="headerlink" title="四、一个简单的程序"></a>四、一个简单的程序</h2><p>现在使用一个C语言的代码来表述计算机做了什么事情：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> add_a_and_b(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_a_and_b</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行编译，他将会被编译成以下的汇编语言：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_main:</span><br><span class="line">   push 3 ;                        把第二个参数&#39;3&#39;Push（推）进内存</span><br><span class="line">   push 2 ;                        把第一个参数&#39;2&#39;Push进内存</span><br><span class="line">   call _add_a_and_b ;     调用add_a_and_b 函数：并且让当前程序运行的指针（在EIP寄存器中）</span><br><span class="line">                                        指向函数的第一条指令（push %ebx）</span><br><span class="line">   add %esp, 8 ;              将esp指针在栈上向上移动8个字节，弹出我们上面压入的两个值，此时第一个值已经变成计算以后的值了。</span><br><span class="line">   ret ;                               返回到调用main函数的函数中。</span><br><span class="line"></span><br><span class="line">_add_a_and_b:</span><br><span class="line">   push %ebx ;                    程序准备修改ebx寄存器中的值, 所以程序需要将ebx推入栈中</span><br><span class="line">                                            以便让后面程序运行结束以后可以还原数据</span><br><span class="line">   mov %eax, [%esp+8] ;    将第一个参数移入EAX（详看下图可以知道为什么是+8）</span><br><span class="line">   mov %ebx, [%esp+12] ;  将第二个参数移入EBX</span><br><span class="line">   add %eax, %ebx ;           将eax和ebx中的值进行相加，并且把结果存储在eax中</span><br><span class="line">   pop %ebx ;                      将ebx中的值弹出，以便还原ebx中的数据</span><br><span class="line">   ret ;                                   返回到main函数. 这个步骤将会把下一步运行地址弹出到栈内存中</span><br><span class="line">                                             (当call执行完以后的下一步地址) 放入eip寄存器</span><br></pre></td></tr></table></figure>

<p>程序运行的时候，内存模型如下： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201110152710.jpg"> </p>
<p>第一步：当main开始运行的时候，需要先把临时的值压入栈内存中： 所以有两个参数<code>3和2</code>被压入占中，这就是栈内存中前两个的值的地址。 第二步：临时变量已经准备好了，我们要把main函数压入栈中，因为main函数一共有四条指令，而一条指令只用<code>4</code>个字节，所以一共有16个字节被压入栈中 第三步：因为在函数<code>_add_a_and_b</code>中，我们用到了中间寄存器用来计算ebx，所以ebx被压入栈中。 经过了这三个步骤，那么esp（程序运行指针）被多次往下移动了16个字节，其中包括main函数四条命令4个字节以及两个参数8个字节，还有一个临时寄存器使用了4个字节， 当然图中那么画还不够具体。</p>
<p>首先main函数入栈，将参数推入栈中。 然后运行到了<code>call _add_a_and_b</code>步骤，函数入栈，继续刚刚的操作 这里因为<code>call _add_a_and_b</code>中有个步骤是推入一个中间寄存器，所以esp在call部分又向下推一个4字节的空间。 所以在函数当中，需要访问第一个参数的时候，应该是通过<code>esp + 8</code>去获取，第二个就更需要<code>esp + 12</code>去获取了 这里有个重点，就是我们如何保证我们使用的寄存器不会被其他程序的执行而让我们的程序运行过程中遭到破坏。 很简单：当我们需要用到一个寄存器的时候，我们把一个寄存器的副本压入栈中，然后我们即可在函数中对这个寄存器进行使用以及清理。</p>
<h2 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html">阮一峰《汇编语言入门教程》</a> <a target="_blank" rel="noopener" href="http://kakaroto.homelinux.net/2017/11/introduction-to-reverse-engineering-and-assembly/">Introduction to reverse engineering and Assembly.</a> <a target="_blank" rel="noopener" href="http://blog.csdn.net/daleiwang/article/details/50579776">堆栈的工作原理</a>  </p>
<p>第一步：当main开始运行的时候，需要先把临时的值压入栈内存中： 所以有两个参数<code>3和2</code>被压入占中，这就是栈内存中前两个的值的地址。 第二步：临时变量已经准备好了，我们要把main函数压入栈中，因为main函数一共有四条指令，而一条指令只用<code>4</code>个字节，所以一共有16个字节被压入栈中 第三步：因为在函数<code>_add_a_and_b</code>中，我们用到了中间寄存器用来计算ebx，所以ebx被压入栈中。 经过了这三个步骤，那么esp（程序运行指针）被多次往下移动了16个字节，其中包括main函数四条命令4个字节以及两个参数8个字节，还有一个临时寄存器使用了4个字节， 当然图中那么画还不够具体。</p>
<p>首先main函数入栈，将参数推入栈中。 然后运行到了<code>call _add_a_and_b</code>步骤，函数入栈，继续刚刚的操作 这里因为<code>call _add_a_and_b</code>中有个步骤是推入一个中间寄存器，所以esp在call部分又向下推一个4字节的空间。 所以在函数当中，需要访问第一个参数的时候，应该是通过<code>esp + 8</code>去获取，第二个就更需要<code>esp + 12</code>去获取了 这里有个重点，就是我们如何保证我们使用的寄存器不会被其他程序的执行而让我们的程序运行过程中遭到破坏。 很简单：当我们需要用到一个寄存器的时候，我们把一个寄存器的副本压入栈中，然后我们即可在函数中对这个寄存器进行使用以及清理。</p>
<h2 id="参考-5"><a href="#参考-5" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html">阮一峰《汇编语言入门教程》</a> <a target="_blank" rel="noopener" href="http://kakaroto.homelinux.net/2017/11/introduction-to-reverse-engineering-and-assembly/">Introduction to reverse engineering and Assembly.</a> <a target="_blank" rel="noopener" href="http://blog.csdn.net/daleiwang/article/details/50579776">堆栈的工作原理</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Weidan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
