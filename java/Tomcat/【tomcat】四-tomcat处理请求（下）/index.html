<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="codeva-18Edjlpyk5">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weidanli.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

  <meta name="description" content="零上一节我们来到了 getAdapter().service(request, response); 这里，接下来需要看一个 连接器 -- Coyote框架 Coyote 的中文意思是 山狗 ，北美的一种狼，我想用这个名字应该是指他非常的迅猛。 它实现了自己的 Request 和 Response（不是 servlet 标准），主要用于将 byte数组 翻译成必要的 HTTP信息。">
<meta property="og:type" content="article">
<meta property="og:title" content="【Tomcat】四.Tomcat处理请求（下）">
<meta property="og:url" content="http://weidanli.github.io/java/Tomcat/%E3%80%90tomcat%E3%80%91%E5%9B%9B-tomcat%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%EF%BC%88%E4%B8%8B%EF%BC%89/index.html">
<meta property="og:site_name" content="丹崽的技术博客">
<meta property="og:description" content="零上一节我们来到了 getAdapter().service(request, response); 这里，接下来需要看一个 连接器 -- Coyote框架 Coyote 的中文意思是 山狗 ，北美的一种狼，我想用这个名字应该是指他非常的迅猛。 它实现了自己的 Request 和 Response（不是 servlet 标准），主要用于将 byte数组 翻译成必要的 HTTP信息。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201109161421.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201109161506.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201109161527.jpeg">
<meta property="article:published_time" content="2020-04-19T09:33:12.000Z">
<meta property="article:modified_time" content="2023-01-27T12:02:55.552Z">
<meta property="article:author" content="Weidan">
<meta property="article:tag" content="tomcat">
<meta property="article:tag" content="tomcat源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201109161421.png">


<link rel="canonical" href="http://weidanli.github.io/java/Tomcat/%E3%80%90tomcat%E3%80%91%E5%9B%9B-tomcat%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%EF%BC%88%E4%B8%8B%EF%BC%89/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"http://weidanli.github.io/java/Tomcat/%E3%80%90tomcat%E3%80%91%E5%9B%9B-tomcat%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%EF%BC%88%E4%B8%8B%EF%BC%89/","path":"java/Tomcat/【tomcat】四-tomcat处理请求（下）/","title":"【Tomcat】四.Tomcat处理请求（下）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【Tomcat】四.Tomcat处理请求（下） | 丹崽的技术博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">丹崽的技术博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">丹崽的计算机知识博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section">分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section">归档</a></li>
        <li class="menu-item menu-item-数据结构"><a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="section">数据结构</a></li>
        <li class="menu-item menu-item-spring源码"><a href="/spring-sources/" rel="section">Spring源码</a></li>
        <li class="menu-item menu-item-mysql底层"><a href="/mysql/" rel="section">MySQL底层</a></li>
        <li class="menu-item menu-item-tomcat源码"><a href="/tomcat-sources/" rel="section">Tomcat源码</a></li>
        <li class="menu-item menu-item-计算机网络"><a href="/network/" rel="section">计算机网络</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%B6"><span class="nav-number">1.</span> <span class="nav-text">零</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-CoyoteAdapter%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82"><span class="nav-number">2.</span> <span class="nav-text">一. CoyoteAdapter处理请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-CoyoteAdapter%E5%86%99%E5%87%BA%E5%93%8D%E5%BA%94"><span class="nav-number">3.</span> <span class="nav-text">二. CoyoteAdapter写出响应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E9%93%BE"><span class="nav-number">4.</span> <span class="nav-text">三.业务数据处理链</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Weidan</p>
  <div class="site-description" itemprop="description">计算机基础 计算机网络 Java Vue 前端 后端</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/WeidanLi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;WeidanLi" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:toweidan@126.com" title="E-Mail → mailto:toweidan@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/WeidanLi" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weidanli.github.io/java/Tomcat/%E3%80%90tomcat%E3%80%91%E5%9B%9B-tomcat%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%EF%BC%88%E4%B8%8B%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weidan">
      <meta itemprop="description" content="计算机基础 计算机网络 Java Vue 前端 后端">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丹崽的技术博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【Tomcat】四.Tomcat处理请求（下）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-19 17:33:12" itemprop="dateCreated datePublished" datetime="2020-04-19T17:33:12+08:00">2020-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-27 20:02:55" itemprop="dateModified" datetime="2023-01-27T20:02:55+08:00">2023-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>13 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="零"><a href="#零" class="headerlink" title="零"></a>零</h2><p>上一节我们来到了 <code>getAdapter().service(request, response);</code> 这里，接下来需要看一个 <code>连接器 -- Coyote框架</code> <code>Coyote</code> 的中文意思是 <code>山狗</code> ，北美的一种狼，我想用这个名字应该是指他非常的迅猛。 它实现了自己的 <code>Request</code> 和 <code>Response</code>（不是 <code>servlet</code> 标准），主要用于将 <code>byte数组</code> 翻译成必要的 <code>HTTP信息</code>。</p>
<a id="more"></a>
<h2 id="一-CoyoteAdapter处理请求"><a href="#一-CoyoteAdapter处理请求" class="headerlink" title="一. CoyoteAdapter处理请求"></a>一. CoyoteAdapter处理请求</h2><p><code>CoyoteAdapter</code> 会将 <code>Socket</code> 接收的 <code>byte数组</code> 包装成 <code>Request</code> 和 <code>Response</code>，这是一个 <code>Facade模式</code>，意将解析过程封装起来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoyoteAdapter</span> <span class="keyword">implements</span> <span class="title class_">Adapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(org.apache.coyote.Request req, org.apache.coyote.Response res)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建 Request对象 和 Response对象</span></span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) req.getNote(ADAPTER_NOTES);</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response) res.getNote(ADAPTER_NOTES);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Create objects</span></span><br><span class="line">      request = connector.createRequest();</span><br><span class="line">      request.setCoyoteRequest(req);</span><br><span class="line">      response = connector.createResponse();</span><br><span class="line">      response.setCoyoteResponse(res);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Link objects</span></span><br><span class="line">      request.setResponse(response);</span><br><span class="line">      response.setRequest(request);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set as notes</span></span><br><span class="line">      req.setNote(ADAPTER_NOTES, request);</span><br><span class="line">      res.setNote(ADAPTER_NOTES, response);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set query string encoding</span></span><br><span class="line">      req.getParameters().setQueryStringCharset(connector.getURICharset());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connector.getXpoweredBy()) &#123;</span><br><span class="line">      response.addHeader(<span class="string">&quot;X-Powered-By&quot;</span>, POWERED_BY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建 Request对象 和 Response对象END</span></span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">async</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">postParseSuccess</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    req.getRequestProcessor().setWorkerThreadName(THREAD_NAME.get());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 解析Request参数，主要为了寻找对应的容器进行处理</span></span><br><span class="line">      postParseSuccess = postParseRequest(req, request, res, response);</span><br><span class="line">      <span class="keyword">if</span> (postParseSuccess) &#123;</span><br><span class="line">        <span class="comment">//check valves if we support async</span></span><br><span class="line">        request.setAsyncSupported(</span><br><span class="line">          connector.getService().getContainer().getPipeline().isAsyncSupported());</span><br><span class="line">        <span class="comment">// 关键代码！！！！！！：拿到容器直行链的第一个处理器开始处理</span></span><br><span class="line">        <span class="comment">// 后续将是一个责任链一直连续下去</span></span><br><span class="line">        connector.getService().getContainer().getPipeline().getFirst().invoke(</span><br><span class="line">          request, response);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 异步的请求处理</span></span><br><span class="line">      <span class="keyword">if</span> (request.isAsync()) &#123;</span><br><span class="line">        async = <span class="literal">true</span>;</span><br><span class="line">        <span class="type">ReadListener</span> <span class="variable">readListener</span> <span class="operator">=</span> req.getReadListener();</span><br><span class="line">        <span class="keyword">if</span> (readListener != <span class="literal">null</span> &amp;&amp; request.isFinished()) &#123;</span><br><span class="line">          <span class="comment">// Possible the all data may have been read during service()</span></span><br><span class="line">          <span class="comment">// method so this needs to be checked here</span></span><br><span class="line">          <span class="type">ClassLoader</span> <span class="variable">oldCL</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            oldCL = request.getContext().bind(<span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (req.sendAllDataReadEvent()) &#123;</span><br><span class="line">              req.getReadListener().onAllDataRead();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            request.getContext().unbind(<span class="literal">false</span>, oldCL);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span></span><br><span class="line">          (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!request.isAsyncCompleting() &amp;&amp; throwable != <span class="literal">null</span>) &#123;</span><br><span class="line">          request.getAsyncContextInternal().setErrorState(throwable, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理完成数据以后，将响应数据刷新出去</span></span><br><span class="line">        request.finishRequest();</span><br><span class="line">        response.finishResponse();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="comment">// Ignore</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="type">AtomicBoolean</span> <span class="variable">error</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">      res.action(ActionCode.IS_ERROR, error);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (request.isAsyncCompleting() &amp;&amp; error.get()) &#123;</span><br><span class="line">        <span class="comment">// Connection will be forcibly closed which will prevent</span></span><br><span class="line">        <span class="comment">// completion happening at the usual point. Need to trigger</span></span><br><span class="line">        <span class="comment">// call to onComplete() here.</span></span><br><span class="line">        res.action(ActionCode.ASYNC_POST_PROCESS,  <span class="literal">null</span>);</span><br><span class="line">        async = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 记录请求日志</span></span><br><span class="line">      <span class="keyword">if</span> (!async &amp;&amp; postParseSuccess) &#123;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> request.getContext();</span><br><span class="line">        <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> request.getHost();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> System.currentTimeMillis() - req.getStartTime();</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">          context.logAccess(request, response, time, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response.isError()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (host != <span class="literal">null</span>) &#123;</span><br><span class="line">            host.logAccess(request, response, time, <span class="literal">false</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            connector.getService().getContainer().logAccess(</span><br><span class="line">              request, response, time, <span class="literal">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      req.getRequestProcessor().setWorkerThreadName(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 回收资源</span></span><br><span class="line">      <span class="keyword">if</span> (!async) &#123;</span><br><span class="line">        updateWrapperErrorCount(request, response);</span><br><span class="line">        request.recycle();</span><br><span class="line">        response.recycle();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在有必要祭出之前那副请求处理图了： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201109161421.png"> 我们现在来到了 <code>Connector</code> 这一步，他会将 <code>Request</code> 和 <code>Response</code> 开始传递给 <code>Engine</code> 的 <code>Pipeline</code> 进行处理，<code>Pipeline</code> 又会继续调用容器里面的子容器的 <code>Pipeline</code> 逐一处理完成以后，最后来到了我们 <code>webapp</code> 的 <code>service</code> 方法。当 <code>webapp</code> 都执行完成了以后，就会调用到 <code>request.finishRequest()</code> 和 <code>response.finishResponse();</code> 写出去。</p>
<h2 id="二-CoyoteAdapter写出响应"><a href="#二-CoyoteAdapter写出响应" class="headerlink" title="二. CoyoteAdapter写出响应"></a>二. CoyoteAdapter写出响应</h2><p>因为在这里完全可以拿到已经处理完成的 <code>Response</code> 数据，所以也是在这里写出数据的，我打算先看完 <code>请求</code> 和 <code>响应</code>，所以直接先看写出数据。 那么我们上面是 <code>response.finishResponse();</code> 这个方法来完成响应的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Response</span> <span class="keyword">implements</span> <span class="title class_">HttpServletResponse</span> &#123;  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">finishResponse</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    outputBuffer.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在上面 CoyoteAdapter#service 创建响应的时候，就会创建一个 outputBuffer</span></span><br><span class="line">  <span class="comment">// 然后再把这个 outputBuffer 跟 Connector 连起来，就可以将数据通过通道写出去了</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setConnector</span><span class="params">(Connector connector)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;AJP/1.3&quot;</span>.equals(connector.getProtocol())) &#123;</span><br><span class="line">      <span class="comment">// default size to size of one ajp-packet</span></span><br><span class="line">      outputBuffer = <span class="keyword">new</span> <span class="title class_">OutputBuffer</span>(<span class="number">8184</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      outputBuffer = <span class="keyword">new</span> <span class="title class_">OutputBuffer</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    outputStream = <span class="keyword">new</span> <span class="title class_">CoyoteOutputStream</span>(outputBuffer);</span><br><span class="line">    writer = <span class="keyword">new</span> <span class="title class_">CoyoteWriter</span>(outputBuffer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而这个 <code>OutputBuffer</code> 是由 <code>Tomcat</code> 提供的，接下来看看 <code>close</code> 做了哪些事情：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OutputBuffer</span> <span class="keyword">extends</span> <span class="title class_">Writer</span> &#123;  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (suspended) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cb.remaining() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      flushCharBuffer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试计算ContentLength</span></span><br><span class="line">    <span class="keyword">if</span> ((!coyoteResponse.isCommitted()) &amp;&amp; (coyoteResponse.getContentLengthLong() == -<span class="number">1</span>)</span><br><span class="line">        &amp;&amp; !coyoteResponse.getRequest().method().equals(<span class="string">&quot;HEAD&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!coyoteResponse.isCommitted()) &#123;</span><br><span class="line">        coyoteResponse.setContentLength(bb.remaining());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果需要是需要升级请求的话，flush出去</span></span><br><span class="line">    <span class="keyword">if</span> (coyoteResponse.getStatus() == HttpServletResponse.SC_SWITCHING_PROTOCOLS) &#123;</span><br><span class="line">      doFlush(<span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      doFlush(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    closed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应都要关闭了，请求肯定没东西了，所以这时候请求关闭请求的通道</span></span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) coyoteResponse.getRequest().getNote(CoyoteAdapter.ADAPTER_NOTES);</span><br><span class="line">    req.inputBuffer.close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 又要回到了上面Response对象里边操作</span></span><br><span class="line">    coyoteResponse.action(ActionCode.CLOSE, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Response</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">action</span><span class="params">(ActionCode actionCode, Object param)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hook != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (param == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ActionCode.CLOSE，hook是之前的 Http11Processor</span></span><br><span class="line">        hook.action(actionCode, <span class="built_in">this</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        hook.action(actionCode, param);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractProcessor</span> <span class="keyword">extends</span> <span class="title class_">AbstractProcessorLight</span> <span class="keyword">implements</span> <span class="title class_">ActionHook</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">action</span><span class="params">(ActionCode actionCode, Object param)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (actionCode) &#123;</span><br><span class="line">        <span class="comment">// &#x27;Normal&#x27; servlet support</span></span><br><span class="line">      <span class="keyword">case</span> COMMIT: &#123;</span><br><span class="line">        <span class="keyword">if</span> (!response.isCommitted()) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 准备响应头</span></span><br><span class="line">            prepareResponse();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            setErrorState(ErrorState.CLOSE_CONNECTION_NOW, e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> CLOSE: &#123;</span><br><span class="line">        action(ActionCode.COMMIT, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          finishResponse();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloseNowException cne) &#123;</span><br><span class="line">          setErrorState(ErrorState.CLOSE_NOW, cne);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          setErrorState(ErrorState.CLOSE_CONNECTION_NOW, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> ACK: &#123;&#125;</span><br><span class="line">      <span class="comment">// 省略其他Action动作处理...        </span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>case CLOSE</code> 会先递归调用 <code>Commit</code>，然后再调用完成响应的函数。 <code>prepareResponse</code> 包含了验证是否需要写 <code>body</code>，<code>Content-Type</code>，计算 <code>Content-Length</code> 等等一些必要的 <code>响应头</code>，然后一起写到客户端，代码过长就不放了。 <code>finishResponse</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Http11Processor</span> <span class="keyword">extends</span> <span class="title class_">AbstractProcessor</span> &#123;   </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">finishResponse</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    outputBuffer.end();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Http11OutputBuffer</span> <span class="keyword">implements</span> <span class="title class_">HttpOutputBuffer</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">end</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (responseFinished) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastActiveFilter == -<span class="number">1</span>) &#123;</span><br><span class="line">      outputStreamOutputBuffer.end();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// lastActiveFilter参数在上面的 prepareResponse 会根据响应头</span></span><br><span class="line">      <span class="comment">// 来调整，现在被创建了一个 IdentityOutputFilter 也就是将数据写出去</span></span><br><span class="line">      <span class="comment">// 其他类型的还有ChunkedOutputFilter、GzipOutputFilter、VoidOutputFilter</span></span><br><span class="line">      <span class="comment">// 分别处理 分批、压缩、以及没有响应体的。</span></span><br><span class="line">      activeFilters[lastActiveFilter].end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    responseFinished = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那现在就需要来观察 <code>IdentityOutputFilter</code> 的 <code>end</code> 函数，然而这个 <code>end</code> 函数会一步一步通过 <code>代理</code> 传递到对应的 <code>Socket</code> 的 <code>end</code> 函数来完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IdentityOutputFilter</span> <span class="keyword">implements</span> <span class="title class_">OutputFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">end</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    buffer.end();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">SocketOutputBuffer</span> <span class="keyword">implements</span> <span class="title class_">HttpOutputBuffer</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">end</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    socketWrapper.flush(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NioSocketWrapper</span> <span class="keyword">extends</span> <span class="title class_">SocketWrapperBase</span>&lt;NioChannel&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">flush</span><span class="params">(<span class="type">boolean</span> block)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (block) &#123;</span><br><span class="line">      <span class="comment">// A blocking flush will always empty the buffer.</span></span><br><span class="line">      flushBlocking();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = flushNonBlocking();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">flushBlocking</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    doWrite(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!nonBlockingWriteBuffer.isEmpty()) &#123;</span><br><span class="line">      nonBlockingWriteBuffer.write(<span class="built_in">this</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!socketBufferHandler.isWriteBufferEmpty()) &#123;</span><br><span class="line">        doWrite(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doWrite</span><span class="params">(<span class="type">boolean</span> block)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    socketBufferHandler.configureWriteBufferForRead();</span><br><span class="line">    doWrite(block, socketBufferHandler.getWriteBuffer());</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// 上面三个方法在SocketWrapperBase中 为了阅读方便就放一起了</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doWrite</span><span class="params">(<span class="type">boolean</span> block, ByteBuffer from)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">writeTimeout</span> <span class="operator">=</span> getWriteTimeout();</span><br><span class="line">    <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      selector = pool.get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 通过Socket定位到对应的通道，然后将数据写到通道里面</span></span><br><span class="line">      pool.write(from, getSocket(), selector, writeTimeout, block);</span><br><span class="line">      <span class="keyword">if</span> (block) &#123;</span><br><span class="line">        <span class="comment">// Make sure we are flushed</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">          <span class="comment">// 刷新出去，刷新成功返回true就停止循环</span></span><br><span class="line">          <span class="keyword">if</span> (getSocket().flush(<span class="literal">true</span>, selector, writeTimeout)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      updateLastWrite();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (selector != <span class="literal">null</span>) &#123;</span><br><span class="line">        pool.put(selector);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三-业务数据处理链"><a href="#三-业务数据处理链" class="headerlink" title="三.业务数据处理链"></a>三.业务数据处理链</h2><p>业务数据的处理主要发生在上面提到过的 <code>CoyoteAdapter</code> 中，我重新贴一下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoyoteAdapter</span> <span class="keyword">implements</span> <span class="title class_">Adapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(org.apache.coyote.Request req, org.apache.coyote.Response res)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建 Request对象 和 Response对象</span></span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) req.getNote(ADAPTER_NOTES);</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response) res.getNote(ADAPTER_NOTES);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Create objects</span></span><br><span class="line">      request = connector.createRequest();</span><br><span class="line">      request.setCoyoteRequest(req);</span><br><span class="line">      response = connector.createResponse();</span><br><span class="line">      response.setCoyoteResponse(res);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Link objects</span></span><br><span class="line">      request.setResponse(response);</span><br><span class="line">      response.setRequest(request);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set as notes</span></span><br><span class="line">      req.setNote(ADAPTER_NOTES, request);</span><br><span class="line">      res.setNote(ADAPTER_NOTES, response);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set query string encoding</span></span><br><span class="line">      req.getParameters().setQueryStringCharset(connector.getURICharset());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connector.getXpoweredBy()) &#123;</span><br><span class="line">      response.addHeader(<span class="string">&quot;X-Powered-By&quot;</span>, POWERED_BY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建 Request对象 和 Response对象END</span></span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">async</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">postParseSuccess</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    req.getRequestProcessor().setWorkerThreadName(THREAD_NAME.get());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 解析Request参数，主要为了寻找对应的容器进行处理</span></span><br><span class="line">      postParseSuccess = postParseRequest(req, request, res, response);</span><br><span class="line">      <span class="keyword">if</span> (postParseSuccess) &#123;</span><br><span class="line">        <span class="comment">//check valves if we support async</span></span><br><span class="line">        request.setAsyncSupported(</span><br><span class="line">          connector.getService().getContainer().getPipeline().isAsyncSupported());</span><br><span class="line">        <span class="comment">// 关键代码！！！！！！：拿到容器直行链的第一个处理器开始处理</span></span><br><span class="line">        <span class="comment">// 后续将是一个责任链一直连续下去</span></span><br><span class="line">        connector.getService().getContainer().getPipeline().getFirst().invoke(</span><br><span class="line">          request, response);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 异步的请求处理</span></span><br><span class="line">      <span class="keyword">if</span> (request.isAsync()) &#123;</span><br><span class="line">        async = <span class="literal">true</span>;</span><br><span class="line">        <span class="type">ReadListener</span> <span class="variable">readListener</span> <span class="operator">=</span> req.getReadListener();</span><br><span class="line">        <span class="keyword">if</span> (readListener != <span class="literal">null</span> &amp;&amp; request.isFinished()) &#123;</span><br><span class="line">          <span class="comment">// Possible the all data may have been read during service()</span></span><br><span class="line">          <span class="comment">// method so this needs to be checked here</span></span><br><span class="line">          <span class="type">ClassLoader</span> <span class="variable">oldCL</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            oldCL = request.getContext().bind(<span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (req.sendAllDataReadEvent()) &#123;</span><br><span class="line">              req.getReadListener().onAllDataRead();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            request.getContext().unbind(<span class="literal">false</span>, oldCL);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span></span><br><span class="line">          (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!request.isAsyncCompleting() &amp;&amp; throwable != <span class="literal">null</span>) &#123;</span><br><span class="line">          request.getAsyncContextInternal().setErrorState(throwable, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理完成数据以后，将响应数据刷新出去</span></span><br><span class="line">        request.finishRequest();</span><br><span class="line">        response.finishResponse();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="comment">// Ignore</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="type">AtomicBoolean</span> <span class="variable">error</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">      res.action(ActionCode.IS_ERROR, error);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (request.isAsyncCompleting() &amp;&amp; error.get()) &#123;</span><br><span class="line">        <span class="comment">// Connection will be forcibly closed which will prevent</span></span><br><span class="line">        <span class="comment">// completion happening at the usual point. Need to trigger</span></span><br><span class="line">        <span class="comment">// call to onComplete() here.</span></span><br><span class="line">        res.action(ActionCode.ASYNC_POST_PROCESS,  <span class="literal">null</span>);</span><br><span class="line">        async = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 记录请求日志</span></span><br><span class="line">      <span class="keyword">if</span> (!async &amp;&amp; postParseSuccess) &#123;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> request.getContext();</span><br><span class="line">        <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> request.getHost();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> System.currentTimeMillis() - req.getStartTime();</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">          context.logAccess(request, response, time, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response.isError()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (host != <span class="literal">null</span>) &#123;</span><br><span class="line">            host.logAccess(request, response, time, <span class="literal">false</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            connector.getService().getContainer().logAccess(</span><br><span class="line">              request, response, time, <span class="literal">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      req.getRequestProcessor().setWorkerThreadName(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 回收资源</span></span><br><span class="line">      <span class="keyword">if</span> (!async) &#123;</span><br><span class="line">        updateWrapperErrorCount(request, response);</span><br><span class="line">        request.recycle();</span><br><span class="line">        response.recycle();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</code> 就是调用处理链来处理请求和写响应数据的关键： </p>
<p><img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201109161506.png"> 那 <code>connector.getService().getContainer()</code> 就是拿到了 <code>Engine</code> 对象，再通过 <code>getPipeline().getFirst()</code> 拿到第一个 <code>Pipeline</code> 处理器，开始进行调用，也就是图中的 <code>StandardEngineValve</code>，图中还有 <code>ValveA</code> 和 <code>ValveB</code> 表示我们可以根据自己的需求进行 <code>Pipeline</code> 的组装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StandardEngineValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到当前请求需要使用到的 Host 对象，如果没有找到，则表示请求不到</span></span><br><span class="line">    <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> request.getHost();</span><br><span class="line">    <span class="keyword">if</span> (host == <span class="literal">null</span>) &#123;</span><br><span class="line">      response.sendError</span><br><span class="line">        (HttpServletResponse.SC_BAD_REQUEST,</span><br><span class="line">         sm.getString(<span class="string">&quot;standardEngine.noHost&quot;</span>,</span><br><span class="line">                      request.getServerName()));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">      request.setAsyncSupported(host.getPipeline().isAsyncSupported());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将请求交给 Host 进行处理</span></span><br><span class="line">    host.getPipeline().getFirst().invoke(request, response);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那我使用的是默认的配置，<code>Host</code> 的 <code>Pipeline</code> 第一个即是 <code>AccessLogValve</code> 来处理请求的记录信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAccessLogValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> <span class="keyword">implements</span> <span class="title class_">AccessLog</span> &#123;</span><br><span class="line">  <span class="comment">// 当前this=`AccessLogValue`，集成这个抽象类</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException,</span><br><span class="line">  ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (tlsAttributeRequired) &#123;</span><br><span class="line">      <span class="comment">// 如果开启了TLS，则需要先把属性缓存起来</span></span><br><span class="line">      request.getAttribute(Globals.CERTIFICATES_ATTR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理读取Request中，Socket包含的远程客户端的地址，目前是HostCache进行处理</span></span><br><span class="line">    <span class="keyword">for</span> (CachedElement element : cachedElements) &#123;</span><br><span class="line">      element.cache(request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Next是ErrorReportValve进行处理</span></span><br><span class="line">    getNext().invoke(request, response);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后交给 <code>ErrorReportValve</code> 处理，他是先将 <code>Request</code> 继续传递下去，如果 <code>Response</code> 响应的是错误的，那么会根据需求渲染错误的页面，也就是我们经常看到的 <code>Tomcat</code> 的错误页面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorReportValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Perform the request</span></span><br><span class="line">    getNext().invoke(request, response);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面是处理相应错误的时候，需要做的事情</span></span><br><span class="line">    <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (response.setErrorReported()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          response.flushBuffer();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          ExceptionUtils.handleThrowable(t);</span><br><span class="line">        &#125;</span><br><span class="line">        response.getCoyoteResponse().action(ActionCode.CLOSE_NOW,</span><br><span class="line">                                            request.getAttribute(RequestDispatcher.ERROR_EXCEPTION));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span> (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span><br><span class="line">        <span class="keyword">if</span> (request.isAsync() &amp;&amp; !request.isAsyncCompleting()) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (throwable != <span class="literal">null</span> &amp;&amp; !response.isError()) &#123;</span><br><span class="line">      response.reset();</span><br><span class="line">      response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response.setSuspended(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      report(request, response, throwable);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable tt) &#123;</span><br><span class="line">      ExceptionUtils.handleThrowable(tt);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ErrorReportValve</code> 的接下来一个是 <code>StandardHostValve</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StandardHostValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Select the Context to be used for this Request</span></span><br><span class="line">    <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> request.getContext();</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">      request.setAsyncSupported(context.getPipeline().isAsyncSupported());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">asyncAtStart</span> <span class="operator">=</span> request.isAsync();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      context.bind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!asyncAtStart &amp;&amp; !context.fireRequestInitEvent(request.getRequest())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 查找对应的Context进行处理</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</span><br><span class="line">          context.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        container.getLogger().error(<span class="string">&quot;Exception Processing &quot;</span> + request.getRequestURI(), t);</span><br><span class="line">        <span class="comment">// 处理失败，指的是查找我们容器的过程中的失败，则会抛出异常，渲染页面</span></span><br><span class="line">        <span class="comment">// 而如果我们的webapp处理失败了，没有做统一的监听返回响应处理的话，也算在这里</span></span><br><span class="line">        <span class="comment">// 一般建议我们的项目可以监听错误从而表示项目是正常运行的只不过是业务错误，返回业务错误信息即可</span></span><br><span class="line">        <span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</span><br><span class="line">          request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);</span><br><span class="line">          throwable(request, response, t);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 处理已经请求完成了，现在可以处理Response了，例如要刷出数据等工作</span></span><br><span class="line">      response.setSuspended(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">      <span class="type">Throwable</span> <span class="variable">t</span> <span class="operator">=</span> (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果相应出现了错误，根据需要，要渲染页面或者是要返回错误编码</span></span><br><span class="line">      <span class="keyword">if</span> (response.isErrorReportRequired()) &#123;</span><br><span class="line">        <span class="comment">// 判断Channel通道是否正常，如果非正常的，则不会继续收集错误</span></span><br><span class="line">        <span class="type">AtomicBoolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">        response.getCoyoteResponse().action(ActionCode.IS_IO_ALLOWED, result);</span><br><span class="line">        <span class="keyword">if</span> (result.get()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">            throwable(request, response, t);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            status(request, response);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Request已经完成他的使命，触发Request的销毁事件</span></span><br><span class="line">      <span class="keyword">if</span> (!request.isAsync() &amp;&amp; !asyncAtStart) &#123;</span><br><span class="line">        context.fireRequestDestroyEvent(request.getRequest());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// Access a session (if present) to update last accessed time, based</span></span><br><span class="line">      <span class="comment">// on a strict interpretation of the specification</span></span><br><span class="line">      <span class="keyword">if</span> (ACCESS_SESSION) &#123;</span><br><span class="line">        request.getSession(<span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      context.unbind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Host</code> 有了，接下来就是 <code>Context</code> 的 <code>Pipeline</code> 了吧，不过默认第一个是 <code>AuthenticatorValve</code> 但是我们没有配置什么鉴权的请求，所以我打算跳过他，接下来就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StandardContextValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;    </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保护敏感目录不被请求</span></span><br><span class="line">    <span class="type">MessageBytes</span> <span class="variable">requestPathMB</span> <span class="operator">=</span> request.getRequestPathMB();</span><br><span class="line">    <span class="keyword">if</span> ((requestPathMB.startsWithIgnoreCase(<span class="string">&quot;/META-INF/&quot;</span>, <span class="number">0</span>))</span><br><span class="line">         (requestPathMB.equalsIgnoreCase(<span class="string">&quot;/META-INF&quot;</span>))</span><br><span class="line">         (requestPathMB.startsWithIgnoreCase(<span class="string">&quot;/WEB-INF/&quot;</span>, <span class="number">0</span>))</span><br><span class="line">         (requestPathMB.equalsIgnoreCase(<span class="string">&quot;/WEB-INF&quot;</span>))) &#123;</span><br><span class="line">      response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到Servlet</span></span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> request.getWrapper();</span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="literal">null</span>  wrapper.isUnavailable()) &#123;</span><br><span class="line">      response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应100-continue，告诉客户端你可以继续发送消息了</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response.sendAcknowledgement();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">      container.getLogger().error(sm.getString(</span><br><span class="line">        <span class="string">&quot;standardContextValve.acknowledgeException&quot;</span>), ioe);</span><br><span class="line">      request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, ioe);</span><br><span class="line">      response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">      request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 拿到Servlet，开始进行调用，不过在这之前，还有个Filter要用到</span></span><br><span class="line">    wrapper.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StandardWrapperValve</code> 基本可以当成表示我们的 <code>webapp</code> 了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StandardWrapperValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize local variables we may need</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">unavailable</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// This should be a Request attribute...</span></span><br><span class="line">    <span class="type">long</span> t1=System.currentTimeMillis();</span><br><span class="line">    requestCount.incrementAndGet();</span><br><span class="line">    <span class="type">StandardWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (StandardWrapper) getContainer();</span><br><span class="line">    <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> (Context) wrapper.getParent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保证当前应用是否被停止，在manage页面上管理</span></span><br><span class="line">    <span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</span><br><span class="line">      response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</span><br><span class="line">                         sm.getString(<span class="string">&quot;standardContext.isUnavailable&quot;</span>));</span><br><span class="line">      unavailable = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保证servlet可用</span></span><br><span class="line">    <span class="keyword">if</span> (!unavailable &amp;&amp; wrapper.isUnavailable()) &#123;</span><br><span class="line">      container.getLogger().info(sm.getString(<span class="string">&quot;standardWrapper.isUnavailable&quot;</span>,</span><br><span class="line">                                              wrapper.getName()));</span><br><span class="line">      <span class="type">long</span> <span class="variable">available</span> <span class="operator">=</span> wrapper.getAvailable();</span><br><span class="line">      <span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</span><br><span class="line">        response.setDateHeader(<span class="string">&quot;Retry-After&quot;</span>, available);</span><br><span class="line">        response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</span><br><span class="line">                           sm.getString(<span class="string">&quot;standardWrapper.isUnavailable&quot;</span>,</span><br><span class="line">                                        wrapper.getName()));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</span><br><span class="line">        response.sendError(HttpServletResponse.SC_NOT_FOUND,</span><br><span class="line">                           sm.getString(<span class="string">&quot;standardWrapper.notFound&quot;</span>,</span><br><span class="line">                                        wrapper.getName()));</span><br><span class="line">      &#125;</span><br><span class="line">      unavailable = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 申请需要用到的servlet</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!unavailable) &#123;</span><br><span class="line">        servlet = wrapper.allocate();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</span><br><span class="line">      <span class="comment">// 省略异常处理代码...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">MessageBytes</span> <span class="variable">requestPathMB</span> <span class="operator">=</span> request.getRequestPathMB();</span><br><span class="line">    <span class="type">DispatcherType</span> <span class="variable">dispatcherType</span> <span class="operator">=</span> DispatcherType.REQUEST;</span><br><span class="line">    <span class="keyword">if</span> (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC;</span><br><span class="line">    request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</span><br><span class="line">    request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</span><br><span class="line">                         requestPathMB);</span><br><span class="line">    <span class="comment">// 创建webapp处理链，包含过滤器filter、servlet等</span></span><br><span class="line">    <span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span></span><br><span class="line">      ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((servlet != <span class="literal">null</span>) &amp;&amp; (filterChain != <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="comment">// Swallow output if needed</span></span><br><span class="line">        <span class="keyword">if</span> (context.getSwallowOutput()) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            SystemLogHandler.startCapture();</span><br><span class="line">            <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">              request.getAsyncContextInternal().doInternalDispatch();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              filterChain.doFilter(request.getRequest(),</span><br><span class="line">                                   response.getResponse());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">log</span> <span class="operator">=</span> SystemLogHandler.stopCapture();</span><br><span class="line">            <span class="keyword">if</span> (log != <span class="literal">null</span> &amp;&amp; log.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              context.getLogger().info(log);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">            request.getAsyncContextInternal().doInternalDispatch();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 重点进入的代码，调用处理链进行请求响应的处理</span></span><br><span class="line">            <span class="comment">// 并且在此时，Connector的Request和Response被转换为符合Servlet规范的对象</span></span><br><span class="line">            <span class="comment">// 在Tomcat里被包装成RequestFacade和ResponseFacade</span></span><br><span class="line">            filterChain.doFilter</span><br><span class="line">              (request.getRequest(), response.getResponse());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClientAbortException  CloseNowException e) &#123;</span><br><span class="line">      <span class="comment">// 省略调用webapp可能发生的错误异常处理代码......</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// 释放资源</span></span><br><span class="line">      <span class="keyword">if</span> (filterChain != <span class="literal">null</span>) &#123;</span><br><span class="line">        filterChain.release();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 释放servlet对象代码</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (servlet != <span class="literal">null</span>) &#123;</span><br><span class="line">          wrapper.deallocate(servlet);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(e);</span><br><span class="line">        container.getLogger().error(sm.getString(<span class="string">&quot;standardWrapper.deallocateException&quot;</span>,</span><br><span class="line">                                                 wrapper.getName()), e);</span><br><span class="line">        <span class="keyword">if</span> (throwable == <span class="literal">null</span>) &#123;</span><br><span class="line">          throwable = e;</span><br><span class="line">          exception(request, response, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If this servlet has been marked permanently unavailable,</span></span><br><span class="line">      <span class="comment">// unload it and release this instance</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((servlet != <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">            (wrapper.getAvailable() == Long.MAX_VALUE)) &#123;</span><br><span class="line">          wrapper.unload();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(e);</span><br><span class="line">        container.getLogger().error(sm.getString(<span class="string">&quot;standardWrapper.unloadException&quot;</span>,</span><br><span class="line">                                                 wrapper.getName()), e);</span><br><span class="line">        <span class="keyword">if</span> (throwable == <span class="literal">null</span>) &#123;</span><br><span class="line">          exception(request, response, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">long</span> t2=System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span> time=t2-t1;</span><br><span class="line">      processingTime += time;</span><br><span class="line">      <span class="keyword">if</span>( time &gt; maxTime) maxTime=time;</span><br><span class="line">      <span class="keyword">if</span>( time &lt; minTime) minTime=time;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，通过了一个 <code>Filter</code> 之后，就可以进入我们 <code>webapp</code> 的 <code>Servlet</code> 进行处理了，反正我们通常是使用 <code>SpringMVC</code>，<code>Servlet</code> 通常都是 <code>DispatchServlet</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ApplicationFilterChain</span> <span class="keyword">implements</span> <span class="title class_">FilterChain</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">// 没有开启安全策略</span></span><br><span class="line">    <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        java.security.AccessController.doPrivileged(</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">java</span>.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">              <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">              internalDoFilter(req,res);</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">catch</span>( PrivilegedActionException pe) &#123;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> pe.getException();</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException)</span><br><span class="line">          <span class="keyword">throw</span> (ServletException) e;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException)</span><br><span class="line">          <span class="keyword">throw</span> (IOException) e;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException)</span><br><span class="line">          <span class="keyword">throw</span> (RuntimeException) e;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(e.getMessage(), e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 直接调用</span></span><br><span class="line">      internalDoFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest request,</span></span><br><span class="line"><span class="params">                                ServletResponse response)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果存在过滤器，默认是有一个WsServerContainer，则调用过滤器的方法</span></span><br><span class="line">    <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">      <span class="comment">// 在下一个filter又会调用回来，但是此时 pos = n 了，所以不会再走一次</span></span><br><span class="line">      <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> filters[pos++];</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// WsServerContainer是当前的Filter</span></span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="string">&quot;false&quot;</span>.equalsIgnoreCase(</span><br><span class="line">          filterConfig.getFilterDef().getAsyncSupported())) &#123;</span><br><span class="line">          request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">          <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">          <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">          <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span></span><br><span class="line">            ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line"></span><br><span class="line">          Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;req, res, <span class="built_in">this</span>&#125;;</span><br><span class="line">          SecurityUtil.doAsPrivilege (<span class="string">&quot;doFilter&quot;</span>, filter, classType, args, principal);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          filter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException  ServletException  RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        e = ExceptionUtils.unwrapInvocationTargetException(e);</span><br><span class="line">        ExceptionUtils.handleThrowable(e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(sm.getString(<span class="string">&quot;filterChain.filter&quot;</span>), e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤器链处理完成，接下来交给servlet的service方法处理</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">        lastServicedRequest.set(request);</span><br><span class="line">        lastServicedResponse.set(response);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !servletSupportsAsync) &#123;</span><br><span class="line">        request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</span><br><span class="line">                             Boolean.FALSE);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Use potentially wrapped request from this point</span></span><br><span class="line">      <span class="keyword">if</span> ((request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp;</span><br><span class="line">          (response <span class="keyword">instanceof</span> HttpServletResponse) &amp;&amp;</span><br><span class="line">          Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">        <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span></span><br><span class="line">          ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line">        Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;req, res&#125;;</span><br><span class="line">        SecurityUtil.doAsPrivilege(<span class="string">&quot;service&quot;</span>,</span><br><span class="line">                                   servlet,</span><br><span class="line">                                   classTypeUsedInService,</span><br><span class="line">                                   args,</span><br><span class="line">                                   principal);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// MyServlet#service，此时是MyServlet，我在里面写了数据到Response，然后交给Connector写出去</span></span><br><span class="line">        <span class="comment">// 由于类加载器的隔离，在这里并不知道MyServlet的内容，只管调用即可</span></span><br><span class="line">        servlet.service(request, response);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException  ServletException  RuntimeException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      e = ExceptionUtils.unwrapInvocationTargetException(e);</span><br><span class="line">      ExceptionUtils.handleThrowable(e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(sm.getString(<span class="string">&quot;filterChain.servlet&quot;</span>), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">        lastServicedRequest.set(<span class="literal">null</span>);</span><br><span class="line">        lastServicedResponse.set(<span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那最后完善下那幅请求图： <img src="https://cdn.jsdelivr.net/gh/WeidanLi/image/20201109161527.jpeg"></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"9e1bc39d00e3c90593cb","clientSecret":"f6e987db19088f322e0923bb017b2a907c02bd5d","repo":"blog-gittalk","owner":"WeidanLi","admin":["WeidanLi"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/tomcat/" rel="tag"># tomcat</a>
              <a href="/tags/tomcat%E6%BA%90%E7%A0%81/" rel="tag"># tomcat源码</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/java/Tomcat/%E3%80%90tomcat%E3%80%91%E5%9B%9B-tomcat%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%EF%BC%88%E4%B8%8A%EF%BC%89/" rel="prev" title="【Tomcat】四.Tomcat处理请求（上）">
                  <i class="fa fa-chevron-left"></i> 【Tomcat】四.Tomcat处理请求（上）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/frame/Spring%E6%BA%90%E7%A0%81/%E3%80%90springcloud%E3%80%91spring-cloud-common%E8%A7%A3%E6%9E%90/" rel="next" title="【SpringCloud】Spring-Cloud-Common解析">
                  【SpringCloud】Spring-Cloud-Common解析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Weidan</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">218k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">13:12</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
