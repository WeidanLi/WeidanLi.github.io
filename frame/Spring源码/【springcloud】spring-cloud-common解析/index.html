<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          【SpringCloud】Spring-Cloud-Common解析 - 丹崽的技术博客
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-exp.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 5.2.0"></head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>丹崽的技术博客</span>
  </a>
</div>
    <div id="menu" class="book-menu hide">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="计算机碎碎念"><a href="#计算机碎碎念" class="headerlink" title="计算机碎碎念"></a>计算机碎碎念</h1><h2 id="计算机网络"><a href="#计算机网络" class="headerlink" title="计算机网络"></a>计算机网络</h2><ul>
<li><a href="/Computer/Network/1-Find-Computer-Network/">生活中的网络</a></li>
<li><a href="/Computer/Network/2-TCP-IP-PROTOCOL/">TCP/IP之数据链路层</a></li>
<li><a href="/Computer/Network/3-IP/">TCP/IP之网络层IP协议</a></li>
<li><a href="/Computer/Network/4-TCP-UDP/">TCP/IP之传输层TCP/UDP协议</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <h2 id="SpringCloud开篇"><a href="#SpringCloud开篇" class="headerlink" title="SpringCloud开篇"></a>SpringCloud开篇</h2><p>那么最近是想要来阅读一下 <code>SpringCloud</code> 的文章的，于是乎逗了几个圈子，又是去 <code>GitHub</code> 下 <code>原生 Eureka</code> 的源码，又是去 <code>Spring</code> 下 <code>spring-cloud-netflix</code> 的源码，最后也是基本锁定只要从 <code>spring-cloud-netflix</code> 进去了解 <code>SpringCloud</code> 组件即可，毕竟 <code>原生Eureka</code> 我没用过…</p>
<h2 id="spring-cloud-context项目"><a href="#spring-cloud-context项目" class="headerlink" title="spring-cloud-context项目"></a>spring-cloud-context项目</h2><p>那么为啥是从 <code>SpringCloudContext</code> 开始咧，是因为这样的，如果我们某个组织想要开发 <code>SpringCloud</code> 套件的话，就需要使用到 <code>Spring</code> 官方提供的 <code>spring-cloud-commons</code> 项目，这个项目是一个 <code>套件工具包</code>，提供的是官方已经写好的一些注解和工具包，比方说 <code>@EnableDiscoveryClient</code> <code>@LoadBalanced</code> 这些我们常用的 <code>SpringCloud</code> 注解，并且提供了一些少量的支持，其中最重要的莫过于 <code>SpringCloud</code> 的上下文。 那我们之前读过 <code>Spring</code> 的源码的时候了解到，无论是 <code>context</code> 还是 <code>application</code>，都是支持父级容器的，而从容器中取出 <code>Bean实例</code> 的时候，也是 <code>双亲加载机制</code>，如果父级容器有了，那么子级容器是不会重新去加载的，这样我们在设计我们的业务项目的时候，就可以把一些基础架构的 <code>Bean实例</code> 丢到父级容器，并且子级容器只需要加载业务相关的类就可以了，当需要对第三方服务（如：<code>MySQL</code> <code>Redis</code> 都可以称为第三方服务）进行访问的时候，让我们的子级业务容器去父级容器取出来进行使用。有什么好处呢，我感觉就是专业的容器，做专业事情，我们编码弄出那么多设计，不外乎就是为了让程序的 <strong>拓展性会更好</strong>，当我们的基础服务发生改变的时候，那就可以将父级容器换一个，而不需要去动我们的业务容器。 带着这个想法来了解一下 <code>spring-cloud-context</code> 项目，<code>spring-cloud-context</code> 项目提供了一个容器，名为 <code>bootstrap</code>，那使用过的 <code>spring-cloud</code> 组件搭建过项目的同学肯定想到了我们常见的 <code>bootstrap.yml</code>，没错，这个配置文件就是配置 <code>bootstrap</code> 容器的，当我们在我们的项目中加入类似于 <code>eureka</code> <code>zuul</code> 或者 <code>eureka-client</code> 的时候，我们的项目容器就发生了翻天覆地的变化。 <code>SpringApplication</code> 会先根据 <code>SPI</code> 协议加载 <code>BootstrapApplicationListener</code> 类，并且在初始化 <code>ConfigurableApplicationContext</code> 之前，先执行这个上面的 <code>ApplicationListener</code> 的回调方法，把 <code>Bootstrap容器</code> 给初始化出来，并且设置为当前容器的 <code>parent</code> （典型的 <code>我把你当朋友你居然要做我爸爸</code>）。而如果有 <code>SpringCloud</code> 架构经验的同学肯定也明白一个事情，为啥我们在整合 <code>spring-cloud-config-client</code> 的时候，<code>spring-cloud</code> 的配置内容需要写在 <code>bootstrap.yml</code> 中，当然是因为 <code>bootstrap.yml</code> 是第一个被加载的，然后他获取到了配置以后，再初始化我们自己的容器，这时候我们自己的容器如果需要一些 <code>远程配置</code> 的时候，就可以先从 <code>爸爸</code> 那里去命中了。</p>
<blockquote>
<p>而为啥要这样设计呢，说好听点，叫做我们可以随时替换符合 <code>spring-cloud-context</code> 规范的套件，说难听呢，就是为了让自己的市场份额，因为如果我们想替换微服务的提供商，那么符合 <code>spring-cloud-context</code> 规范的，都可以很简便的进行替换，而如果不符合我规范的，很抱歉，你需要自己重写很多东西。</p>
</blockquote>
<h2 id="Bootstrap容器的初始化"><a href="#Bootstrap容器的初始化" class="headerlink" title="Bootstrap容器的初始化"></a>Bootstrap容器的初始化</h2><h3 id="演示栗子"><a href="#演示栗子" class="headerlink" title="演示栗子"></a>演示栗子</h3><p>首先我们需要一个例子，那就用最简单的 <code>EurekaServer</code> 的例子来搭建吧： 首先，<code>pom.xml</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud.test&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;eureka-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.0.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jackson-datatype-jsr310&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.10.3&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.google.code.gson&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;gson&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.8.5&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;&#x2F;packaging&gt;</span><br><span class="line">        &lt;!-- 因为使用的是最新版的SpringCloud，还是快照版，很多包在央仓是找不到的，所以需要Spring的快照仓库来配合构建 --&gt;</span><br><span class="line">    &lt;profiles&gt;</span><br><span class="line">        &lt;profile&gt;</span><br><span class="line">            &lt;id&gt;spring&lt;&#x2F;id&gt;</span><br><span class="line">            &lt;repositories&gt;</span><br><span class="line">                &lt;repository&gt;</span><br><span class="line">                    &lt;id&gt;spring-snapshots&lt;&#x2F;id&gt;</span><br><span class="line">                    &lt;name&gt;Spring Snapshots&lt;&#x2F;name&gt;</span><br><span class="line">                    &lt;url&gt;https:&#x2F;&#x2F;repo.spring.io&#x2F;libs-snapshot-local&lt;&#x2F;url&gt;</span><br><span class="line">                    &lt;snapshots&gt;</span><br><span class="line">                        &lt;enabled&gt;true&lt;&#x2F;enabled&gt;</span><br><span class="line">                    &lt;&#x2F;snapshots&gt;</span><br><span class="line">                    &lt;releases&gt;</span><br><span class="line">                        &lt;enabled&gt;false&lt;&#x2F;enabled&gt;</span><br><span class="line">                    &lt;&#x2F;releases&gt;</span><br><span class="line">                &lt;&#x2F;repository&gt;</span><br><span class="line">                &lt;repository&gt;</span><br><span class="line">                    &lt;id&gt;spring-milestones&lt;&#x2F;id&gt;</span><br><span class="line">                    &lt;name&gt;Spring Milestones&lt;&#x2F;name&gt;</span><br><span class="line">                    &lt;url&gt;https:&#x2F;&#x2F;repo.spring.io&#x2F;libs-milestone-local&lt;&#x2F;url&gt;</span><br><span class="line">                    &lt;snapshots&gt;</span><br><span class="line">                        &lt;enabled&gt;false&lt;&#x2F;enabled&gt;</span><br><span class="line">                    &lt;&#x2F;snapshots&gt;</span><br><span class="line">                &lt;&#x2F;repository&gt;</span><br><span class="line">                &lt;repository&gt;</span><br><span class="line">                    &lt;id&gt;spring-releases&lt;&#x2F;id&gt;</span><br><span class="line">                    &lt;name&gt;Spring Releases&lt;&#x2F;name&gt;</span><br><span class="line">                    &lt;url&gt;https:&#x2F;&#x2F;repo.spring.io&#x2F;release&lt;&#x2F;url&gt;</span><br><span class="line">                    &lt;snapshots&gt;</span><br><span class="line">                        &lt;enabled&gt;false&lt;&#x2F;enabled&gt;</span><br><span class="line">                    &lt;&#x2F;snapshots&gt;</span><br><span class="line">                &lt;&#x2F;repository&gt;</span><br><span class="line">            &lt;&#x2F;repositories&gt;</span><br><span class="line">            &lt;pluginRepositories&gt;</span><br><span class="line">                &lt;pluginRepository&gt;</span><br><span class="line">                    &lt;id&gt;spring-snapshots&lt;&#x2F;id&gt;</span><br><span class="line">                    &lt;name&gt;Spring Snapshots&lt;&#x2F;name&gt;</span><br><span class="line">                    &lt;url&gt;https:&#x2F;&#x2F;repo.spring.io&#x2F;libs-snapshot-local&lt;&#x2F;url&gt;</span><br><span class="line">                    &lt;snapshots&gt;</span><br><span class="line">                        &lt;enabled&gt;true&lt;&#x2F;enabled&gt;</span><br><span class="line">                    &lt;&#x2F;snapshots&gt;</span><br><span class="line">                    &lt;releases&gt;</span><br><span class="line">                        &lt;enabled&gt;false&lt;&#x2F;enabled&gt;</span><br><span class="line">                    &lt;&#x2F;releases&gt;</span><br><span class="line">                &lt;&#x2F;pluginRepository&gt;</span><br><span class="line">                &lt;pluginRepository&gt;</span><br><span class="line">                    &lt;id&gt;spring-milestones&lt;&#x2F;id&gt;</span><br><span class="line">                    &lt;name&gt;Spring Milestones&lt;&#x2F;name&gt;</span><br><span class="line">                    &lt;url&gt;https:&#x2F;&#x2F;repo.spring.io&#x2F;libs-milestone-local&lt;&#x2F;url&gt;</span><br><span class="line">                    &lt;snapshots&gt;</span><br><span class="line">                        &lt;enabled&gt;false&lt;&#x2F;enabled&gt;</span><br><span class="line">                    &lt;&#x2F;snapshots&gt;</span><br><span class="line">                &lt;&#x2F;pluginRepository&gt;</span><br><span class="line">                &lt;pluginRepository&gt;</span><br><span class="line">                    &lt;id&gt;spring-releases&lt;&#x2F;id&gt;</span><br><span class="line">                    &lt;name&gt;Spring Releases&lt;&#x2F;name&gt;</span><br><span class="line">                    &lt;url&gt;https:&#x2F;&#x2F;repo.spring.io&#x2F;libs-release-local&lt;&#x2F;url&gt;</span><br><span class="line">                    &lt;snapshots&gt;</span><br><span class="line">                        &lt;enabled&gt;false&lt;&#x2F;enabled&gt;</span><br><span class="line">                    &lt;&#x2F;snapshots&gt;</span><br><span class="line">                &lt;&#x2F;pluginRepository&gt;</span><br><span class="line">            &lt;&#x2F;pluginRepositories&gt;</span><br><span class="line">        &lt;&#x2F;profile&gt;</span><br><span class="line">        &lt;profile&gt;</span><br><span class="line">            &lt;id&gt;sonar&lt;&#x2F;id&gt;</span><br><span class="line">            &lt;build&gt;</span><br><span class="line">                &lt;plugins&gt;</span><br><span class="line">                    &lt;plugin&gt;</span><br><span class="line">                        &lt;groupId&gt;org.jacoco&lt;&#x2F;groupId&gt;</span><br><span class="line">                        &lt;artifactId&gt;jacoco-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                        &lt;executions&gt;</span><br><span class="line">                            &lt;execution&gt;</span><br><span class="line">                                &lt;id&gt;pre-unit-test&lt;&#x2F;id&gt;</span><br><span class="line">                                &lt;goals&gt;</span><br><span class="line">                                    &lt;goal&gt;prepare-agent&lt;&#x2F;goal&gt;</span><br><span class="line">                                &lt;&#x2F;goals&gt;</span><br><span class="line">                                &lt;configuration&gt;</span><br><span class="line">                                    &lt;propertyName&gt;surefireArgLine&lt;&#x2F;propertyName&gt;</span><br><span class="line">                                    &lt;destFile&gt;$&#123;project.build.directory&#125;&#x2F;jacoco.exec&lt;&#x2F;destFile&gt;</span><br><span class="line">                                &lt;&#x2F;configuration&gt;</span><br><span class="line">                            &lt;&#x2F;execution&gt;</span><br><span class="line">                            &lt;execution&gt;</span><br><span class="line">                                &lt;id&gt;post-unit-test&lt;&#x2F;id&gt;</span><br><span class="line">                                &lt;phase&gt;test&lt;&#x2F;phase&gt;</span><br><span class="line">                                &lt;goals&gt;</span><br><span class="line">                                    &lt;goal&gt;report&lt;&#x2F;goal&gt;</span><br><span class="line">                                &lt;&#x2F;goals&gt;</span><br><span class="line">                                &lt;configuration&gt;</span><br><span class="line">                                    &lt;!-- Sets the path to the file which contains the execution data. --&gt;</span><br><span class="line">                                    &lt;dataFile&gt;$&#123;project.build.directory&#125;&#x2F;jacoco.exec&lt;&#x2F;dataFile&gt;</span><br><span class="line">                                &lt;&#x2F;configuration&gt;</span><br><span class="line">                            &lt;&#x2F;execution&gt;</span><br><span class="line">                        &lt;&#x2F;executions&gt;</span><br><span class="line">                    &lt;&#x2F;plugin&gt;</span><br><span class="line">                &lt;&#x2F;plugins&gt;</span><br><span class="line">            &lt;&#x2F;build&gt;</span><br><span class="line">        &lt;&#x2F;profile&gt;</span><br><span class="line">    &lt;&#x2F;profiles&gt;</span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<p><code>EurekaApplication.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> eureka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.StandardEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 需要给个标准的环境才能运行</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Environment <span class="title">environment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回顾下老朋友"><a href="#回顾下老朋友" class="headerlink" title="回顾下老朋友"></a>回顾下老朋友</h3><p>看过我 <code>SpringBoot</code> 源码解析的小朋友们应该对下面这个代码会有点熟悉感：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这是用来打印加载时间的工具类，暂时可以略过.</span></span><br><span class="line">    StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">    stopWatch.start();</span><br><span class="line">    ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">    Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 主要设置JVM虚拟机支持无设备情况下让awt可运行的属性</span></span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="comment">// 一. 加载所有SpringApplicationRunListeners并开始遍历所有Lintener启动监听回调函数</span></span><br><span class="line">    SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">    listeners.starting();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line">      <span class="comment">// 二. 开始准备ConfigurableEnvironment环境</span></span><br><span class="line">      <span class="comment">// ===&gt; 那么将要看的Bootstrap容器初始化就是在这里被执行的，先拿到所有的listener，然后调用onApplicationEvent方法</span></span><br><span class="line">      <span class="comment">// 在准备 ConfigurableApplicationContext，的时候，顺便准备一下Bootstrap</span></span><br><span class="line">      ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">      configureIgnoreBeanInfo(environment);</span><br><span class="line">      Banner printedBanner = printBanner(environment);</span><br><span class="line">      <span class="comment">// 三. 创建应用上下文</span></span><br><span class="line">      context = createApplicationContext();</span><br><span class="line">      exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,</span><br><span class="line">                                                       <span class="keyword">new</span> Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">      <span class="comment">// 四. 做一些准备工作</span></span><br><span class="line">      prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">      <span class="comment">// 五. 刷新上下文</span></span><br><span class="line">      refreshContext(context);</span><br><span class="line">      <span class="comment">// 六. 刷新完成后做的一些清理、回调工作</span></span><br><span class="line">      afterRefresh(context, applicationArguments);</span><br><span class="line">      stopWatch.stop();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">        <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 七. 启动完成后，调用所有SpringApplicationRunListener的完成启动的回调函数</span></span><br><span class="line">      listeners.started(context);</span><br><span class="line">      <span class="comment">// 八. 主要处理ApplicationRunner和CommandLineRunner的回调</span></span><br><span class="line">      callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 九. 运行时的SpringApplicationRunListener回调函数</span></span><br><span class="line">      listeners.running(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      handleRunFailure(context, ex, exceptionReporters, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么为什么那么确定就是 <code>Listener</code> 被调用呢，证据确凿：<code>spring-cloud-commons/spring-cloud-context/src/main/resources/META-INF/spring.factories</code>： 整合流程详见 Spring_Boot_与容器</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AutoConfiguration</span></span><br><span class="line"><span class="meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.LifecycleMvcEndpointAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.RefreshAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.RefreshEndpointAutoConfiguration,\</span><br><span class="line"><span class="attr">org.springframework.cloud.autoconfigure.WritableEnvironmentEndpointAutoConfiguration</span></span><br><span class="line"><span class="comment"># Application Listeners，在这里注册了SpringBoot的ApplicationListener</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationListener</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.bootstrap.BootstrapApplicationListener,\</span><br><span class="line">org.springframework.cloud.bootstrap.LoggingSystemShutdownListener,\</span><br><span class="line"><span class="attr">org.springframework.cloud.context.restart.RestartListener</span></span><br><span class="line"><span class="comment"># Bootstrap components</span></span><br><span class="line"><span class="meta">org.springframework.cloud.bootstrap.BootstrapConfiguration</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.bootstrap.config.PropertySourceBootstrapConfiguration,\</span><br><span class="line">org.springframework.cloud.bootstrap.encrypt.EncryptionBootstrapConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line"><span class="attr">org.springframework.cloud.util.random.CachedRandomPropertySourceAutoConfiguration</span></span><br></pre></td></tr></table></figure>

<p>当然我们需要重温一下 <code>ApplicationListener</code> 有什么生命周期函数以及观望一下 <code>BootstrapApplicationListener</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpringApplicationRunListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 项目开始时调用</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">starting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 环境准备好时，初始化 ConfigurableApplicationContext 的时候会调用到这里，</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 上下文准备好时</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 上下文读取完成</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">contextLoaded</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动完成</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">started</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 项目运行时调用</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">running</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 项目失败时</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(ConfigurableApplicationContext context, Throwable exception)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BootstrapApplicationListener</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEnvironmentPreparedEvent</span>&gt;, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>&#123;</span><br><span class="line">    ConfigurableEnvironment environment = event.getEnvironment();</span><br><span class="line">    <span class="comment">// spring.cloud.bootstrap.enabled配置容器的开关，默认是打开的</span></span><br><span class="line">    <span class="keyword">if</span> (!environment.getProperty(<span class="string">&quot;spring.cloud.bootstrap.enabled&quot;</span>, Boolean.class,</span><br><span class="line">                                 <span class="keyword">true</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Bootstrap的初始化同样会经过这里，那我们就不能让他递归创建，遇到Bootstrap直接跳过</span></span><br><span class="line">    <span class="keyword">if</span> (environment.getPropertySources().contains(BOOTSTRAP_PROPERTY_SOURCE_NAME)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 默认bootstrap的配置名：bootstrap</span></span><br><span class="line">    String configName = environment</span><br><span class="line">      .resolvePlaceholders(<span class="string">&quot;$&#123;spring.cloud.bootstrap.name:bootstrap&#125;&quot;</span>);</span><br><span class="line">    <span class="comment">// 如果我们初始化的时候已经存在父级容器了，则从父级容器中尝试命中BootstrapContext</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationContextInitializer&lt;?&gt; initializer : event.getSpringApplication()</span><br><span class="line">         .getInitializers()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> ParentContextApplicationContextInitializer) &#123;</span><br><span class="line">        context = findBootstrapContext(</span><br><span class="line">          (ParentContextApplicationContextInitializer) initializer,</span><br><span class="line">          configName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// ======&gt; 通过SpringApplicationBuilder来构建一个Context上下问</span></span><br><span class="line">      context = bootstrapServiceContext(environment, event.getSpringApplication(),</span><br><span class="line">                                        configName);</span><br><span class="line">      <span class="comment">// 添加一个主Context关闭的监听器，为了能够发生错误的时候同时关闭Bootstrap容器</span></span><br><span class="line">      event.getSpringApplication()</span><br><span class="line">        .addListeners(<span class="keyword">new</span> CloseContextOnFailureApplicationListener(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    apply(context, event.getSpringApplication(), environment);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> ConfigurableApplicationContext <span class="title">bootstrapServiceContext</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ConfigurableEnvironment environment, <span class="keyword">final</span> SpringApplication application,</span></span></span><br><span class="line"><span class="function"><span class="params">    String configName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个标准环境配置，带有systemProperties和systemEnvironment的相关配置信息</span></span><br><span class="line">    StandardEnvironment bootstrapEnvironment = <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">    MutablePropertySources bootstrapProperties = bootstrapEnvironment</span><br><span class="line">      .getPropertySources();</span><br><span class="line">    <span class="comment">// 开始整理Bootstrap所需要的配置，移除systemProperties和systemEnvironment</span></span><br><span class="line">    <span class="keyword">for</span> (PropertySource&lt;?&gt; source : bootstrapProperties) &#123;</span><br><span class="line">      bootstrapProperties.remove(source.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    String configLocation = environment</span><br><span class="line">      .resolvePlaceholders(<span class="string">&quot;$&#123;spring.cloud.bootstrap.location:&#125;&quot;</span>);</span><br><span class="line">    String configAdditionalLocation = environment</span><br><span class="line">      .resolvePlaceholders(<span class="string">&quot;$&#123;spring.cloud.bootstrap.additional-location:&#125;&quot;</span>);</span><br><span class="line">    Map&lt;String, Object&gt; bootstrapMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    bootstrapMap.put(<span class="string">&quot;spring.config.name&quot;</span>, configName);</span><br><span class="line">    bootstrapMap.put(<span class="string">&quot;spring.main.web-application-type&quot;</span>, <span class="string">&quot;none&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(configLocation)) &#123;</span><br><span class="line">      bootstrapMap.put(<span class="string">&quot;spring.config.location&quot;</span>, configLocation);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(configAdditionalLocation)) &#123;</span><br><span class="line">      bootstrapMap.put(<span class="string">&quot;spring.config.additional-location&quot;</span>,</span><br><span class="line">                       configAdditionalLocation);</span><br><span class="line">    &#125;</span><br><span class="line">    bootstrapProperties.addFirst(</span><br><span class="line">      <span class="keyword">new</span> MapPropertySource(BOOTSTRAP_PROPERTY_SOURCE_NAME, bootstrapMap));</span><br><span class="line">    <span class="keyword">for</span> (PropertySource&lt;?&gt; source : environment.getPropertySources()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (source <span class="keyword">instanceof</span> StubPropertySource) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      bootstrapProperties.addLast(source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过SpringApplicationBuilder构建一个船新的Context出来</span></span><br><span class="line">    SpringApplicationBuilder builder = <span class="keyword">new</span> SpringApplicationBuilder()</span><br><span class="line">      .profiles(environment.getActiveProfiles()).bannerMode(Mode.OFF)</span><br><span class="line">      .environment(bootstrapEnvironment)</span><br><span class="line">      <span class="comment">// Don&#x27;t use the default properties in this builder</span></span><br><span class="line">      .registerShutdownHook(<span class="keyword">false</span>).logStartupInfo(<span class="keyword">false</span>)</span><br><span class="line">      .web(WebApplicationType.NONE);</span><br><span class="line">    <span class="keyword">final</span> SpringApplication builderApplication = builder.application();</span><br><span class="line">    <span class="keyword">if</span> (builderApplication.getMainApplicationClass() == <span class="keyword">null</span>) &#123;</span><br><span class="line">      builder.main(application.getMainApplicationClass());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (environment.getPropertySources().contains(<span class="string">&quot;refreshArgs&quot;</span>)) &#123;</span><br><span class="line">      <span class="comment">// 过滤掉在刷新环境的时候，会影响到全局状态的Listener，如 LoggingApplicationListener</span></span><br><span class="line">      builderApplication</span><br><span class="line">        .setListeners(filterListeners(builderApplication.getListeners()));</span><br><span class="line">    &#125;</span><br><span class="line">    builder.sources(BootstrapImportSelectorConfiguration.class);</span><br><span class="line">    <span class="comment">// ====&gt; 构建BootstrapContext，这时候要重复我们上面说到的Context的加载过程</span></span><br><span class="line">    <span class="comment">// 我们必须清楚这一步加载了什么BeanDefinition</span></span><br><span class="line">    <span class="keyword">final</span> ConfigurableApplicationContext context = builder.run();</span><br><span class="line">    context.setId(<span class="string">&quot;bootstrap&quot;</span>);</span><br><span class="line">    <span class="comment">// 然后将BootstrapContext设置为当前context的父级容器</span></span><br><span class="line">    addAncestorInitializer(application, context);</span><br><span class="line">    <span class="comment">// 先移除掉Bootstrap的配置，后面会被加回去</span></span><br><span class="line">    bootstrapProperties.remove(BOOTSTRAP_PROPERTY_SOURCE_NAME);</span><br><span class="line">    mergeDefaultProperties(environment.getPropertySources(), bootstrapProperties);</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里我们需要用一点言语来概括一下上下文初始化的过程：</p>
<ol>
<li>我们所启动的 <code>ApplicationContext</code>，在准备加载的时候，调用了模块中定义的 <code>ApplicationListener</code>，也就是 <code>spring-cloud-context</code> 包中定义的 <code>BootstrapApplicationListener</code>；</li>
<li><code>BootstrapApplicationListener</code> 开始根据 <code>ApplicationContext</code> 获取的一系列配置，使用 <code>SpringApplicationBuilder</code> 构建开始 <code>BootstrapContext</code>，并且通过 <code>AncestorInitializer</code> 配置好两个上下文的父子关系；</li>
<li><code>SpringApplicationBuilder</code> 调用 <code>run()</code> 函数，刷新容器中的 <code>Bean实例</code>。</li>
<li>那接下来我们就需要重新进入 <code>SpringBoot</code> 容器的加载流程来瞅一瞅到底加载了什么</li>
</ol>
<h3 id="Bootstrap容器的加载"><a href="#Bootstrap容器的加载" class="headerlink" title="Bootstrap容器的加载"></a>Bootstrap容器的加载</h3><p>那之前在说 <code>Spring</code> 的时候有说过，<code>Spring</code> 加载 <code>Bean</code> 的时候是会根据一些规则，比如 <code>@Configuration</code> 或者 <code>ImportSelector子类</code>，用于查询需要导入的 <code>配置Bean</code>，整合进框架的方法莫过于 <code>spring.factories</code> 文件去定义。对应的生命周期子类将会在不同的时期被执行。 那么上面使用 <code>SpringApplicationBuilder</code> 构造 <code>BootstrapContext</code> 之前呢，通过 <code>builder.sources(BootstrapImportSelectorConfiguration.class);</code> 把 <code>Bootstrap</code> 配置信息给加载进去，而这个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Import(BootstrapImportSelector.class)</span> <span class="comment">// 导入了一个BootstrapImportSelector的 ImportSelector 处理器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BootstrapImportSelectorConfiguration</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入Bootstrap配置类的选择器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BootstrapImportSelector</span> <span class="keyword">implements</span> <span class="title">EnvironmentAware</span>, <span class="title">DeferredImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MetadataReaderFactory metadataReaderFactory = <span class="keyword">new</span> CachingMetadataReaderFactory();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="comment">// Use names and ensure unique to protect against duplicates</span></span><br><span class="line">        List&lt;String&gt; names = <span class="keyword">new</span> ArrayList&lt;&gt;(SpringFactoriesLoader</span><br><span class="line">                .loadFactoryNames(BootstrapConfiguration.class, classLoader));</span><br><span class="line">        names.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(</span><br><span class="line">                <span class="keyword">this</span>.environment.getProperty(<span class="string">&quot;spring.cloud.bootstrap.sources&quot;</span>, <span class="string">&quot;&quot;</span>))));</span><br><span class="line"></span><br><span class="line">        List&lt;OrderedAnnotatedElement&gt; elements = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                elements.add(</span><br><span class="line">                        <span class="keyword">new</span> OrderedAnnotatedElement(<span class="keyword">this</span>.metadataReaderFactory, name));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        AnnotationAwareOrderComparator.sort(elements);</span><br><span class="line"></span><br><span class="line">        String[] classNames = elements.stream().map(e -&gt; e.name).toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> classNames;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先需要先来聊聊 <code>ImportSelector</code>，这个后处理器会在解析配置的时候被调用到，而调用他主要是用来加载我们整合框架的时候，需要使用到的一些特殊配置，那么看到上面的 <code>BootstrapImportSelector</code>，他支持将 <code>BootstrapConfiguration</code> 类（实际上使用了最简单的 <code>注解</code> 来表示一个类），所以 <code>spring.factories</code> 写了 <code>org.springframework.cloud.bootstrap.BootstrapConfiguration=/xxx</code> 的类即可被 <code>SpringFactoriesLoader</code> 读取到。 那这个类呢，就是将 <code>spring.factories</code> 定义的 <code>BootstrapConfiguration</code> 类加载到容器中，并且应用其中的设置。 那么目前加载的 <code>Bean</code> 就有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.cloud.bootstrap.config.PropertySourceBootstrapConfiguration,\</span><br><span class="line">org.springframework.cloud.bootstrap.encrypt.EncryptionBootstrapConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.util.random.CachedRandomPropertySourceAutoConfiguration, \</span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration</span><br></pre></td></tr></table></figure>

<p>最后一个是 <code>Eureka</code> 加载的发现服务的客户端配置类。 那为啥我依赖个 <code>@EnableEurekaServer</code> 而给我注入的是一个 <code>客户端</code> 的配置呢，那是因为，<code>Eureka</code> 的设计中，<code>Core</code> 是用来存储实例的，而服务端和客户端存储的实例设计都是一样，那在 <code>SpringCloud</code> 项目中，服务端又可以相互注册，所以 <code>EurekaServer</code> 实际也是一个 <code>EurekaClient</code>。 那么上面加载到容器中的类，那么很明显，在加载 <code>Bootstrap</code> 容器的时候，会被读取到上面那些类，上面那些类，有 <code>ApplicationContextInitializer</code> <code>@Configuration</code> 等等，应有尽有，主要都是用于在不同容器生命周期发光发亮的处理类。然后我们也说过，在 <code>SpringBoot</code> 使用的 <code>AnnotationConfigApplicationContext</code> 上下文中，所有的非惰性 <code>Bean</code> 在刷新的最后都会被进行一次 <code>加载</code>，所以上面配置中所有的 <code>Bean</code> 都会被初始化。 而这些 <code>Bean</code>，就是我们常用的 <code>配置从config-server读取</code> <code>配置解密</code> 的关键，这些放在后面再来阅读。 那么现在总结一下，<code>spring-cloud-context</code> 有什么用呢，最主要的一点就是提供了一个 <code>Bootstrap上下文</code>，<code>SpringCloud</code> 的组件们，就是在这个上下文中进行工作的，而我们的 <code>业务上下文</code>，依然存在于我们创建的上下文中，当需要用到一些比如调用第三方服务的工具类的时候，就会从 <code>spring-cloud-context</code> 中取出来使用，而 <code>套件</code> 则会利用这个上下文的工具类，来提供更加便利的使用。</p>
<h2 id="spring-cloud-commons项目"><a href="#spring-cloud-commons项目" class="headerlink" title="spring-cloud-commons项目"></a>spring-cloud-commons项目</h2><p>这个包，提供了一系列的关于微服务的 <code>类定义</code>，如果 <code>SpringCloud</code> 套件的开发者遵守这套规范的话，那我们是可以在不同的 <code>套件</code> 之间来回切换的，比方说目前市面上存在 <code>SpringCloudNetflix</code> 和 <code>SpringCloudAlibaba</code>，而我们在使用其中一套的时候，如果注解用的是 <code>spring-cloud-commons</code> 的规范注解，则切换套件的任务将会变得十分简单。 下一节聊一聊 <code>eureka-server</code> 了。</p>

</div>




<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure
          class="avatar avatar-lg"
          data-initial="W"
          style="background-color: #3b4351;">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>Weidan</div>
      <div>2020-05-10</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/frame/">frame</a> <a class="category-link" href="/categories/frame/Spring%E6%BA%90%E7%A0%81/">Spring源码</a>

      <a class="tag-none-link" href="/tags/spring/" rel="tag">#spring</a> <a class="tag-none-link" href="/tags/spring-cloud/" rel="tag">#spring-cloud</a> <a class="tag-none-link" href="/tags/spring-cloud-common/" rel="tag">#spring-cloud-common</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
